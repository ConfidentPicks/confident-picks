<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Confident Picks - Expert Sports Betting Analysis</title>

<link rel="icon" href="/favicon.ico" sizes="any">
<link rel="icon" href="/logo.svg" type="image/svg+xml">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#0B0F14">

<meta name="description" content="Get confident sports betting picks with real-time results tracking. Expert analysis and performance metrics to improve your betting strategy.">
<meta property="og:title" content="Confident Picks - Expert Sports Betting Analysis">
<meta property="og:description" content="Get confident sports betting picks with real-time results tracking. Expert analysis and performance metrics to improve your betting strategy.">
<meta property="og:type" content="website">
<meta property="og:image" content="/og-image.png">
<meta property="og:url" content="https://confident-picks.com">
<meta name="twitter:card" content="summary_large_image">

<!-- Stripe SDK -->
<script src="https://js.stripe.com/v3/"></script>

<!-- Firebase SDK v9+ (modular approach - won't break existing code) -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js';
import { getFirestore, collection, addDoc, doc, deleteDoc, getDoc, serverTimestamp, query, getDocs, where, updateDoc, limit, setDoc } from 'https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js';
import { getAuth } from 'https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js';

const firebaseConfig = {
  apiKey: "AIzaSyA48rKRZiwka1h3_GA3hVNxk8WjOAKpM6U",
  authDomain: "confident-picks-app-8-25.firebaseapp.com",
  projectId: "confident-picks-app-8-25",
  storageBucket: "confident-picks-app-8-25.firebasestorage.app",
  messagingSenderId: "560353454758",
  appId: "1:560353454758:web:0d0a6eb9f1892669ab2267",
  measurementId: "G-PDFMST5FZW"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// Make Firebase available globally
window.db = db;
window.auth = auth;
window.collection = collection;
window.addDoc = addDoc;
window.doc = doc;
window.deleteDoc = deleteDoc;
window.getDoc = getDoc;
window.serverTimestamp = serverTimestamp;
window.query = query;
window.getDocs = getDocs;
window.where = where;
window.updateDoc = updateDoc;
window.limit = limit;
window.setDoc = setDoc;
window.firebaseReady = true;

console.log('üî• Firebase initialized successfully');

// Start auto-scoring for completed games
startAutoScoring();

// Auto-create collections if they don't exist
async function ensureCollectionsExist() {
  if (!window.db) {
    console.log('‚ö†Ô∏è Firebase not ready, skipping collection check');
    return;
  }

  const requiredCollections = [
    { name: 'qa_picks', description: 'QA workflow picks (draft, rejected)' },
    { name: 'live_picks', description: 'Approved picks for website display' },
    { name: 'scoring', description: 'Concluded games for hit/miss tracking' },
    { name: 'deleted_picks', description: 'Soft-deleted picks archive' },
    { name: 'backups', description: 'System backup metadata' }
  ];

  console.log('üîç Checking required collections...');
  
  for (const collection of requiredCollections) {
    try {
      // Try to read from collection - if it fails, it doesn't exist
      const testQuery = query(collection(window.db, collection.name), limit(1));
      await getDocs(testQuery);
      console.log(`‚úÖ Collection '${collection.name}' exists`);
    } catch (error) {
      console.log(`üìÅ Creating collection '${collection.name}'...`);
      try {
        // Create collection by adding a dummy document then deleting it
        const dummyDoc = await addDoc(collection(window.db, collection.name), {
          _created: new Date().toISOString(),
          _dummy: true,
          _description: collection.description,
          _autoCreated: true
        });
        await deleteDoc(dummyDoc);
        console.log(`‚úÖ Collection '${collection.name}' created successfully`);
      } catch (createError) {
        console.error(`‚ùå Failed to create collection '${collection.name}':`, createError);
      }
    }
  }
  
  console.log('üéØ Collection check completed');
}

// Backup all data to JSON file
async function exportAllData() {
  if (!window.db) {
    alert('‚ùå Firebase not available');
    return;
  }

  try {
    console.log('üì¶ Starting full data backup...');
    const collections = ['qa_picks', 'live_picks', 'scoring', 'deleted_picks', 'users'];
    const allData = {
      exportDate: new Date().toISOString(),
      version: '1.0',
      collections: {}
    };
    
    let totalDocuments = 0;
    
    for (const collectionName of collections) {
      try {
        const snapshot = await getDocs(collection(window.db, collectionName));
        allData.collections[collectionName] = [];
        
        snapshot.forEach(doc => {
          allData.collections[collectionName].push({ 
            id: doc.id, 
            ...doc.data() 
          });
        });
        
        totalDocuments += snapshot.size;
        console.log(`üìÑ Exported ${snapshot.size} documents from '${collectionName}'`);
      } catch (error) {
        console.warn(`‚ö†Ô∏è Could not export '${collectionName}':`, error);
        allData.collections[collectionName] = [];
      }
    }
    
    // Create backup metadata
    const backupMetadata = {
      id: `backup_${Date.now()}`,
      exportDate: new Date().toISOString(),
      totalDocuments: totalDocuments,
      collections: Object.keys(allData.collections),
      createdBy: 'admin'
    };
    
    // Save backup metadata to Firebase
    await addDoc(collection(window.db, 'backups'), backupMetadata);
    
    // Download as JSON
    const dataStr = JSON.stringify(allData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `confident-picks-backup-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    URL.revokeObjectURL(url);
    
    console.log(`‚úÖ Backup completed: ${totalDocuments} documents exported`);
    alert(`‚úÖ Backup completed!\n\nExported ${totalDocuments} documents from ${Object.keys(allData.collections).length} collections.\n\nFile: confident-picks-backup-${new Date().toISOString().split('T')[0]}.json`);
    
  } catch (error) {
    console.error('‚ùå Backup failed:', error);
    alert(`‚ùå Backup failed: ${error.message}`);
  }
}

// Restore data from JSON backup
async function restoreFromBackup(jsonData) {
  if (!window.db) {
    alert('‚ùå Firebase not available');
    return;
  }

  try {
    console.log('üîÑ Starting data restore...');
    
    if (!jsonData.collections) {
      throw new Error('Invalid backup format: missing collections');
    }
    
    let totalRestored = 0;
    const results = {};
    
    for (const [collectionName, documents] of Object.entries(jsonData.collections)) {
      if (!Array.isArray(documents)) continue;
      
      results[collectionName] = { success: 0, failed: 0 };
      
      for (const docData of documents) {
        try {
          const { id, ...data } = docData;
          
          // Remove auto-created fields
          delete data._created;
          delete data._dummy;
          delete data._autoCreated;
          
          await setDoc(doc(window.db, collectionName, id), data);
          results[collectionName].success++;
          totalRestored++;
        } catch (error) {
          console.error(`Failed to restore document in ${collectionName}:`, error);
          results[collectionName].failed++;
        }
      }
      
      console.log(`üìÑ Restored ${results[collectionName].success} documents to '${collectionName}'`);
    }
    
    console.log(`‚úÖ Restore completed: ${totalRestored} documents restored`);
    
    // Show detailed results
    let resultMessage = `‚úÖ Restore completed!\n\nTotal documents restored: ${totalRestored}\n\n`;
    for (const [collection, result] of Object.entries(results)) {
      resultMessage += `${collection}: ${result.success} restored, ${result.failed} failed\n`;
    }
    
    alert(resultMessage);
    
    // Reload data after restore
    await loadQAPicks();
    await loadFirebaseData();
    
  } catch (error) {
    console.error('‚ùå Restore failed:', error);
    alert(`‚ùå Restore failed: ${error.message}`);
  }
}

// Handle file upload for restore
function handleBackupFileUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  if (!file.name.endsWith('.json')) {
    alert('‚ùå Please select a JSON backup file');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const jsonData = JSON.parse(e.target.result);
      const confirmed = confirm(
        `‚ö†Ô∏è This will restore data from backup file: ${file.name}\n\n` +
        `Export date: ${jsonData.exportDate || 'Unknown'}\n` +
        `Collections: ${Object.keys(jsonData.collections || {}).join(', ')}\n\n` +
        `This will overwrite existing data. Continue?`
      );
      
      if (confirmed) {
        restoreFromBackup(jsonData);
      }
    } catch (error) {
      alert(`‚ùå Invalid backup file: ${error.message}`);
    }
  };
  reader.readAsText(file);
}

// Scoring System Functions
async function moveCompletedGamesToScoring() {
  if (!window.db) {
    console.log('‚ùå Firebase not available');
    return;
  }

  try {
    console.log('üîÑ Moving completed games to scoring collection...');
    
    // Get all live picks
    const livePicksSnapshot = await getDocs(collection(window.db, 'live_picks'));
    const completedPicks = [];
    
    livePicksSnapshot.forEach(doc => {
      const data = doc.data();
      const gameTime = new Date(data.startTime || data.commenceTime);
      const now = new Date();
      
      // If game time has passed, mark as completed
      if (gameTime < now) {
        completedPicks.push({
          id: doc.id,
          data: data
        });
      }
    });
    
    console.log(`üìä Found ${completedPicks.length} completed games`);
    
    for (const pick of completedPicks) {
      try {
        // Move to scoring collection with pending status
        const scoringData = {
          ...pick.data,
          status: 'pending',
          movedToScoring: new Date().toISOString(),
          originalCollection: 'live_picks',
          originalId: pick.id
        };
        
        await addDoc(collection(window.db, 'scoring'), scoringData);
        console.log(`‚úÖ Moved pick ${pick.id} to scoring collection`);
        
        // Remove from live_picks
        await deleteDoc(doc(window.db, 'live_picks', pick.id));
        console.log(`üóëÔ∏è Removed pick ${pick.id} from live_picks`);
        
      } catch (error) {
        console.error(`‚ùå Error moving pick ${pick.id}:`, error);
      }
    }
    
    if (completedPicks.length > 0) {
      alert(`‚úÖ Moved ${completedPicks.length} completed games to scoring collection`);
      // Reload data
      await loadQAPicks();
      await loadFirebaseData();
    } else {
      console.log('‚ÑπÔ∏è No completed games found');
    }
    
  } catch (error) {
    console.error('‚ùå Error moving completed games:', error);
    alert(`‚ùå Error moving completed games: ${error.message}`);
  }
}

async function updateGameResults(gameId, result) {
  if (!window.db) {
    console.log('‚ùå Firebase not available');
    return;
  }

  try {
    console.log(`üèÜ Updating game result: ${gameId} ‚Üí ${result}`);
    
    // Update the pick in scoring collection
    await updateDoc(doc(window.db, 'scoring', gameId), {
      status: result, // 'hit' or 'miss'
      resultUpdated: new Date().toISOString(),
      result: result
    });
    
    console.log(`‚úÖ Updated game ${gameId} result to ${result}`);
    
    // Reload scoring data if we're viewing it
    if (currentQAFilter === 'scoring') {
      await loadQAPicks();
    }
    
  } catch (error) {
    console.error(`‚ùå Error updating game result:`, error);
    alert(`‚ùå Error updating game result: ${error.message}`);
  }
}

async function calculateScoringStats() {
  if (!window.db) {
    console.log('‚ùå Firebase not available');
    return;
  }

  try {
    console.log('üìä Calculating scoring statistics...');
    
    const scoringSnapshot = await getDocs(collection(window.db, 'scoring'));
    const stats = {
      total: 0,
      hits: 0,
      misses: 0,
      pending: 0,
      accuracy: 0
    };
    
    scoringSnapshot.forEach(doc => {
      const data = doc.data();
      stats.total++;
      
      if (data.status === 'hit') stats.hits++;
      else if (data.status === 'miss') stats.misses++;
      else if (data.status === 'pending') stats.pending++;
    });
    
    // Calculate accuracy (hits / (hits + misses))
    const completed = stats.hits + stats.misses;
    stats.accuracy = completed > 0 ? Math.round((stats.hits / completed) * 100) : 0;
    
    console.log('üìà Scoring Statistics:', stats);
    
    // Display stats
    const statsMessage = `
üìä Scoring Statistics:

Total Games: ${stats.total}
‚úÖ Hits: ${stats.hits}
‚ùå Misses: ${stats.misses}
‚è≥ Pending: ${stats.pending}
üéØ Accuracy: ${stats.accuracy}%

Completed Games: ${completed}
    `;
    
    alert(statsMessage);
    
    return stats;
    
  } catch (error) {
    console.error('‚ùå Error calculating stats:', error);
    alert(`‚ùå Error calculating stats: ${error.message}`);
  }
}

// Debug function to check scoring system status
async function debugScoringSystem() {
  if (!window.db) {
    console.log('‚ùå Firebase not available');
    return;
  }

  try {
    console.log('üîç Debugging scoring system...');
    
    // Check live_picks collection
    const livePicksSnapshot = await getDocs(collection(window.db, 'live_picks'));
    console.log(`üìä Live picks count: ${livePicksSnapshot.size}`);
    
    const now = new Date();
    const completedPicks = [];
    const futurePicks = [];
    
    livePicksSnapshot.forEach(doc => {
      const data = doc.data();
      const gameTime = new Date(data.startTime || data.commenceTime);
      
      if (gameTime < now) {
        completedPicks.push({
          id: doc.id,
          teams: `${data.awayTeam || 'Away'} vs ${data.homeTeam || 'Home'}`,
          startTime: data.startTime || data.commenceTime,
          gameTime: gameTime.toISOString(),
          now: now.toISOString()
        });
      } else {
        futurePicks.push({
          id: doc.id,
          teams: `${data.awayTeam || 'Away'} vs ${data.homeTeam || 'Home'}`,
          startTime: data.startTime || data.commenceTime,
          gameTime: gameTime.toISOString()
        });
      }
    });
    
    // Check scoring collection
    const scoringSnapshot = await getDocs(collection(window.db, 'scoring'));
    console.log(`üìä Scoring picks count: ${scoringSnapshot.size}`);
    
    const scoringPicks = [];
    scoringSnapshot.forEach(doc => {
      const data = doc.data();
      scoringPicks.push({
        id: doc.id,
        teams: `${data.awayTeam || 'Away'} vs ${data.homeTeam || 'Home'}`,
        status: data.status,
        startTime: data.startTime || data.commenceTime
      });
    });
    
    const debugMessage = `
üîç Scoring System Debug:

üìä Live Picks: ${livePicksSnapshot.size}
  ‚úÖ Completed (ready to move): ${completedPicks.length}
  ‚è≥ Future games: ${futurePicks.length}

üìä Scoring Collection: ${scoringSnapshot.size}
  ‚è≥ Pending: ${scoringPicks.filter(p => p.status === 'pending').length}
  ‚úÖ Hits: ${scoringPicks.filter(p => p.status === 'hit').length}
  ‚ùå Misses: ${scoringPicks.filter(p => p.status === 'miss').length}

${completedPicks.length > 0 ? `
üéØ Completed Games Ready to Move:
${completedPicks.map(p => `  ‚Ä¢ ${p.teams} (${p.startTime})`).join('\n')}
` : ''}

${scoringPicks.length > 0 ? `
üìà Current Scoring Picks:
${scoringPicks.map(p => `  ‚Ä¢ ${p.teams} (${p.status})`).join('\n')}
` : ''}
    `;
    
    console.log(debugMessage);
    alert(debugMessage);
    
  } catch (error) {
    console.error('‚ùå Error debugging scoring system:', error);
    alert(`‚ùå Error debugging scoring system: ${error.message}`);
  }
}
</script>

<style>
:root{
  --bg:#0B0F14; --card:#121820; --text:#E6EDF3; --sub:#98A6B3;
  --blue:#4DA3FF; --blue-hover:#6BB5FF; --green:#22C55E; --red:#FF6B6B; --border:#ffffff18; --r:12px;

  --select-popup-bg:#0B0F14;
  --select-popup-text:#E6EDF3;
}
:root[data-theme="light"]{
  --bg:#ffffff; --card:#F4F6F8; --text:#0B0F14; --sub:#475569; --border:#00000014;
  --select-popup-bg:#ffffff;
  --select-popup-text:#0B0F14;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial;background:var(--bg);color:var(--text); color-scheme: dark;}
:root[data-theme="light"] body{ color-scheme: light; }

.container{max-width:1024px;margin:0 auto;padding:16px}
.hidden{display:none}
.header{position:sticky;top:0;background:rgba(0,0,0,.2);backdrop-filter:blur(8px);border-bottom:1px solid var(--border);z-index:1000}
.row{display:flex;gap:12px;align-items:center;justify-content:space-between}
.logo{display:flex;align-items:center;gap:8px}
.logo .brandmark{ width:28px; height:28px; display:inline-block; }
.logo strong{ letter-spacing:.2px; }

.btn{padding:8px 12px;border-radius:var(--r);border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--text);cursor:pointer}
.btn.primary{background:var(--blue);color:#0B0F14;border-color:transparent}
.btn.danger{border-color:var(--red);color:var(--red);background:transparent}
.btn.ghost{background:transparent}
.btn:disabled{opacity:.5;cursor:not-allowed;}

/* Loading states */
.btn.loading{position:relative;pointer-events:none}
.btn.loading::after{content:'';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:16px;height:16px;border:2px solid currentColor;border-top:2px solid transparent;border-radius:50%;animation:spin 1s linear infinite}
.btn.loading .btn-text{opacity:0}
@keyframes spin{to{transform:translate(-50%,-50%) rotate(360deg)}}

/* Theme toggle icon styling */
.theme-icon {
  font-size: 18px;
  line-height: 1;
}
.theme-icon::before {
  content: '‚òΩ';
  color: #ffffff;
}
:root[data-theme="light"] .theme-icon::before {
  content: '‚òÄ';
  color: #0B0F14;
}

/* Help modal styling */
.help-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 3000;
  padding: 20px;
}
.help-modal.active {
  display: flex;
}
.help-content {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 24px;
  max-width: 500px;
  width: 100%;
  max-height: 80vh;
  overflow-y: auto;
}
.help-shortcuts {
  display: grid;
  gap: 12px;
  margin-top: 16px;
}
.help-shortcut {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
}
.help-shortcut:last-child {
  border-bottom: none;
}
.kbd {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 2px 8px;
  font-family: monospace;
  font-size: 12px;
  font-weight: 600;
}

/* Enhanced button styling for key actions */
.btn.enhanced {
  border-radius: 999px;
  transition: all 0.2s ease;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  font-weight: 600;
}
.btn.enhanced:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}
.btn.enhanced.primary {
  box-shadow: 0 3px 8px rgba(77,163,255,0.3);
}
.btn.enhanced.primary:hover {
  box-shadow: 0 4px 12px rgba(77,163,255,0.4);
}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;margin-left:6px}
.badge.win{color:var(--green);border-color:var(--green)}
.badge.loss{color:var(--red);border-color:var(--red)}
.badge.push{color:var(--sub)}
.card{background:var(--card);border-radius:var(--r);border:1px solid var(--border);padding:12px}
.grid{display:grid;gap:12px}
.chip{position:relative; padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border)}
.chip.safe{color:var(--green);border-color:var(--green)}
.chip.degen{color:var(--red);border-color:var(--red)}
.text-sub{color:var(--sub);font-size:14px}
.kbd{font-family:ui-monospace, Menlo, Monaco, Consolas, "Courier New", monospace; background:rgba(255,255,255,.06); padding:2px 6px; border-radius:6px; border:1px solid var(--border);}
.star{
  width:20px;height:20px;display:inline-block;border-radius:8px;
  border:1px solid var(--border);background:rgba(255,255,255,.06);cursor:pointer;
  transition: all 0.2s ease;
  transform: scale(1);
}
.star:hover{
  background:rgba(255,255,255,.12);
  transform: scale(1.1);
}
.star:active{
  transform: scale(0.95);
}
.star.on{
  background:var(--blue);
  box-shadow: 0 2px 8px rgba(77,163,255,0.3);
}
.tabs,.smalltabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{
  padding:8px 12px;border:1px solid var(--border);border-radius:999px;
  background:rgba(255,255,255,.06);cursor:pointer;
  transition: all 0.2s ease;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.tab:hover{
  background:rgba(255,255,255,.12);
  transform: translateY(-1px);
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}
.tab.active{
  background:var(--blue);color:#0B0F14;border-color:transparent;
  box-shadow: 0 3px 8px rgba(77,163,255,0.3);
}
.nav a{color:var(--text); text-decoration:none; opacity:.85}
.nav a.active{opacity:1; font-weight:600; text-decoration:underline; text-decoration-color: var(--blue)}

/* üî≤ Section frame */
.panel{
  background: var(--card);
  border: 1px solid #ffffff26;
  border-radius: 16px;
  padding: 16px;
  box-shadow: 0 0 0 1px rgba(255,255,255,0.03) inset;
}
:root[data-theme="light"] .panel{
  background:#ffffff;
  border-color:#00000022;
  box-shadow:none;
}

/* Filters */
.filters{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
@media (max-width:800px){
  .filters{grid-template-columns:1fr 1fr}
  .filters input, .filters select { padding: 14px; font-size: 16px; }
  
  /* Enhanced mobile touch targets */
  .btn { padding: 12px 16px; min-height: 44px; }
  .tab { padding: 12px 16px; min-height: 44px; }
  .star { width: 32px; height: 32px; }
  .minconf .step { width: 32px; height: 20px; font-size: 14px; }
  input, select, textarea { padding: 14px; min-height: 44px; }
}
input,select,textarea{width:100%;padding:10px;border-radius:var(--r);border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--text);font-family:inherit}
.filters input, .filters select{ background: rgba(255,255,255,.12); border-color: #ffffff2e; color: var(--text); font-weight: 600; }
.filters input::placeholder{ color: var(--text); opacity:.9; }
.filters .text-sub{ color: var(--text); opacity:.9; font-weight:600; }

/* dropdown popup legibility */
.filters select{ color-scheme: dark; }
:root[data-theme="light"] .filters select{ color-scheme: light; }
.filters select option, .filters select optgroup{
  background-color: var(--select-popup-bg) !important;
  color: var(--select-popup-text) !important;
  font-weight:600;
}

/* Settings dropdowns - match filters styling */
.settings-select{ 
  background: rgba(255,255,255,.12) !important; 
  border-color: #ffffff2e !important; 
  color: var(--text) !important; 
  font-weight: 600 !important;
  color-scheme: dark;
}
:root[data-theme="light"] .settings-select{ color-scheme: light; }
.settings-select option, .settings-select optgroup{
  background-color: var(--select-popup-bg) !important;
  color: var(--select-popup-text) !important;
  font-weight:600;
}

/* Contact form dropdown styling */
#contactSubject { 
  background: rgba(255,255,255,.12) !important; 
  border-color: #ffffff2e !important; 
  color: var(--text) !important; 
  font-weight: 600 !important;
  color-scheme: dark;
}
:root[data-theme="light"] #contactSubject { color-scheme: light; }
#contactSubject option, #contactSubject optgroup {
  background-color: var(--select-popup-bg) !important;
  color: var(--select-popup-text) !important;
  font-weight: 600;
}
:focus-visible { outline:2px solid var(--blue); outline-offset:2px; border-radius:6px; }

/* Min Confidence ‚Äî slider format */
.minconf {
  position: relative;
  display: inline-block;
  min-width: 180px;
}
.minconf input[type="range"] {
  width: 100%;
  height: 6px;
  border-radius: 3px;
  background: rgba(255,255,255,.12);
  outline: none;
  -webkit-appearance: none;
  appearance: none;
}
.minconf input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: var(--blue);
  cursor: pointer;
  border: 2px solid var(--bg);
}
.minconf input[type="range"]::-moz-range-thumb {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: var(--blue);
  cursor: pointer;
  border: 2px solid var(--bg);
}
.minconf input[type="range"]:hover::-webkit-slider-thumb {
  background: var(--blue-hover);
}
.minconf input[type="range"]:hover::-moz-range-thumb {
  background: var(--blue-hover);
}
.minconf .caption {
  font-size: 11px;
  color: var(--sub);
  margin-top: 6px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.minconf .value-display {
  font-weight: 600;
  color: var(--text);
  font-size: 13px;
}
:root[data-theme="light"] .minconf input[type="range"] {
  background: #e0e0e0;
  border-color: #00000022;
}

/* keep native spinners hidden for other inputs */
input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button{ -webkit-appearance:none; margin:0; }
input[type=number]{ -moz-appearance:textfield; appearance:textfield; }

/* Scorecard metrics side-by-side */
.metrics{ display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin:12px 0; }
.metrics .card{ background: rgba(255,255,255,.04); border: 1px solid var(--border); border-radius: 12px; }
.metrics .label{ color: var(--sub); font-size: 14px; margin-bottom: 6px; }
.metrics .value{ font-size: 28px; font-weight: 800; letter-spacing: .3px; }
@media (max-width: 720px){ .metrics{ grid-template-columns: 1fr; } }

/* locked teaser */
.locked-card{ position:relative; overflow:hidden; border:1px solid var(--border); border-radius:var(--r); background:var(--card); }
.locked-inner{ filter: blur(6px); opacity:.65; pointer-events:none; z-index:1; position:relative; }
.locked-veil{ position:absolute; inset:0; background:linear-gradient(180deg, rgba(11,15,20,0.25), rgba(11,15,20,0.55)); backdrop-filter: blur(2px); z-index:2; pointer-events:none; }
.locked-cta{ position:absolute; inset:auto 12px 12px 12px; display:flex; gap:8px; align-items:center; justify-content:space-between; z-index:3; }
.locked-label{ font-size:12px; color:var(--sub); position:absolute; top:8px; left:12px; padding:2px 6px; border:1px solid var(--border); border-radius:999px; background:rgba(255,255,255,.06); z-index:3; }

/* mobile banner */
.mobile-banner{ display:none; position:fixed; bottom:0; left:0; right:0; z-index:10; background:var(--card); border-top:1px solid var(--border); padding:12px; }
@media (max-width:800px){ .mobile-banner.visible{ display:flex; align-items:center; justify-content:space-between; gap:12px; } body{ padding-bottom:70px; } }

/* Financial Dashboard */
.financial-dashboard .label{ font-size:12px; color:var(--sub); margin-bottom:4px; }
.financial-dashboard .value{ font-size:18px; font-weight:700; color:var(--primary); }
.financial-dashboard .grid > div{ text-align:center; padding:8px; background:rgba(255,255,255,.02); border-radius:8px; border:1px solid var(--border); }

/* maintenance banner */
.site-banner{ display:flex; align-items:center; gap:12px; background:linear-gradient(180deg, rgba(77,163,255,.18), rgba(34,197,94,.18)); border:1px solid var(--border); border-radius:10px; padding:10px 12px; margin:12px 0; }
.site-banner .label{ font-weight:700; }
.site-banner .dismiss{ margin-left:auto; }

/* Account page small bits */
.account-wrap{ max-width:720px; margin: 0 auto; }
.authTabs{ display:flex; gap:8px; margin-top:8px; }
.authTabs .tab{ flex:0 0 auto; }
.divider{ display:flex; align-items:center; gap:10px; margin:10px 0; }
.divider:before, .divider:after{ content:""; height:1px; background:var(--border); flex:1; }
.helper{ font-size:12px; color:var(--sub); margin-top:6px; }

.result-list{margin-top:12px}
.result-row,.out-row{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 12px;border:1px solid var(--border);border-radius:10px;margin-top:8px;background:rgba(255,255,255,.04)}
.reasoning{margin-top:6px;color:var(--sub);font-size:14px;line-height:1.35}

footer{color:var(--sub);font-size:14px;padding:24px 0;text-align:center}
footer a{ color:var(--sub); text-decoration:underline }
/* Password gate (temporary) */
#gate{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.6); z-index:2000; }
#gate .box{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; width:min(420px,92vw); }
#gate .title{ font-weight:700; margin-bottom:8px; }
#gate .sub{ color:var(--sub); font-size:14px; margin-bottom:12px; }
html.gated #gate{ display:flex; }
html.gated body > *:not(#gate){ display:none !important; }

/* Admin Portal Styles */
.tabs {
  display: flex;
  gap: 4px;
  border-bottom: 1px solid rgba(255,255,255,.1);
  margin-bottom: 16px;
}

.tab {
  background: none;
  border: none;
  color: var(--text-sub);
  padding: 8px 16px;
  cursor: pointer;
  border-radius: 8px 8px 0 0;
  transition: all 0.2s ease;
  border-bottom: 2px solid transparent;
}

.tab:hover {
  background: rgba(255,255,255,.05);
  color: var(--text);
}

.tab.active {
  background: rgba(255,255,255,.1);
  color: var(--text);
  border-bottom-color: var(--primary);
}

.admin-tab-content {
  animation: fadeIn 0.3s ease;
}

.metrics {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 12px;
}

.metrics .card {
  padding: 12px;
  text-align: center;
  background: rgba(255,255,255,.02);
}

.metrics .label {
  font-size: 12px;
  color: var(--text-sub);
  margin-bottom: 4px;
}

.metrics .value {
  font-size: 24px;
  font-weight: bold;
  color: var(--primary);
}

/* Navigation Tab Highlighting */
.nav a[data-nav] {
  position: relative;
  transition: all 0.2s ease;
  border-radius: 6px;
  padding: 6px 12px;
}

.nav a[data-nav]:hover {
  background: rgba(255,255,255,.08);
  color: var(--text);
}

.nav a[data-nav].active {
  background: rgba(77,163,255,.15);
  color: var(--primary);
  font-weight: 600;
}

.nav a[data-nav].active::before {
  content: '';
  position: absolute;
  bottom: -2px;
  left: 50%;
  transform: translateX(-50%);
  width: 20px;
  height: 2px;
  background: var(--primary);
  border-radius: 1px;
}

/* Enhanced Tooltips */
.tooltip {
  position: relative;
  cursor: help;
  border-bottom: 1px dotted var(--text-sub);
}

.tooltip:hover::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.9);
  color: white;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 12px;
  white-space: nowrap;
  z-index: 1000;
  pointer-events: none;
  margin-bottom: 4px;
}

.tooltip:hover::before {
  content: '';
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  border: 4px solid transparent;
  border-top-color: rgba(0,0,0,0.9);
  z-index: 1000;
  pointer-events: none;
}

/* Better confidence display */
.confidence-badge {
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: 600;
  font-size: 12px;
}

.confidence-high { background: rgba(34,197,94,0.2); color: var(--green); }
.confidence-medium { background: rgba(77,163,255,0.2); color: var(--blue); }
.confidence-low { background: rgba(255,193,7,0.2); color: #ffa500; }




</style>
<script>
(function(){
  try {
    var ok = localStorage.getItem('cp_gate_ok') === '1';
    if (!ok) document.documentElement.classList.add('gated');
  } catch(e){ document.documentElement.classList.add('gated'); }
})();
</script>
</head>
<body>

<div id="gate">
	<div class="box">
		<div class="title">Enter site password</div>
		<div class="sub">Temporary access while we finish up.</div>
		<div class="grid" style="grid-template-columns:1fr auto; gap:8px">
			<input id="gateInput" type="password" autocomplete="current-password" placeholder="Password"/>
			<button id="gateBtn" class="btn primary">Enter</button>
		</div>
	</div>
</div>

<div class="header">
  <div class="container row">
    <div class="logo" id="logoHome" style="cursor: pointer;" aria-label="Return to home">
      <img src="logo.png" alt="Confident Picks Logo" class="brandmark" style="width: 48px; height: 48px; object-fit: contain;">
      <strong>Confident Picks</strong>
    </div>
    <div class="row nav" style="gap:12px">
      <a href="#picks" data-nav>Picks</a>
      <a href="#scorecard" data-nav>Scorecard</a>
      <a href="#outcomes" data-nav>Outcomes</a>
      <a href="#favorites" data-nav>Favorites</a>
      <a href="#account" data-nav id="navAccount">Account</a>
      <a href="#admin" data-nav id="navAdmin" class="hidden">Admin</a>
      <button type="button" id="themeBtn" class="btn enhanced" aria-label="Toggle theme"><span class="theme-icon" aria-hidden="true"></span></button>
      <button type="button" id="authBtn" class="btn primary enhanced">Sign up for free</button>
      <button type="button" id="upgradeBtn" class="btn primary enhanced hidden">Upgrade</button>
    </div>
  </div>
</div>

<div class="container">

  <div id="maintBanner" class="site-banner" role="status" aria-live="polite">
    <div class="label">Maintenance:</div>
    <div class="text-sub">Scheduled maintenance tonight 1:00‚Äì2:00am ET. Features may be limited.</div>
    <button type="button" class="btn dismiss" aria-label="Dismiss maintenance notice" onclick="dismissMaintBanner()">Dismiss</button>
  </div>

  <!-- PICKS -->
  <section id="view-picks">
    <div class="filters">
      <select id="leagueSel">
        <option value="">All Leagues</option>
        <option>MLB</option>
        <option>NFL</option>
        <option>NBA</option>
        <option>NHL</option>
        <option>CFB</option>
        <option>CBB</option>
        <option>MLS</option>
        <option>UFC</option>
      </select>
      
      <select id="marketSel">
        <option value="">All Markets</option>
        <option value="moneyline">Moneyline</option>
        <option value="spread">Spread</option>
        <option value="totals">Totals</option>
        <option value="parlay">Parlays</option>
        <option value="props">Props</option>
        <option value="player-props">Player Props</option>
        <option value="team-props">Team Props</option>
        <option value="alt-lines">Alt Lines</option>
      </select>
      
      <select id="sortSel">
        <option value="commence">Sort: Commence Time</option>
        <option value="confidence">Sort: Confidence</option>
      </select>
      <input id="searchInp" placeholder="Search team/player‚Ä¶" autocomplete="off"/>

      <!-- Min Confidence slider -->
      <div class="minconf">
        <input id="minConf" type="range" min="0" max="100" value="70" step="5" aria-label="Minimum confidence threshold"/>
        <div class="caption">
          <span>Min Confidence</span>
          <span class="value-display" id="minConfValue">70%</span>
        </div>
      </div>
    </div>

    <div id="gatingNote" class="card text-sub" style="margin-top:12px"></div>

    <div id="verifyBanner" class="card hidden" style="margin-top:8px; align-items:center; justify-content:space-between; gap:8px">
      <div><strong>Verify your email</strong> to unlock free extras.</div>
      <div style="display:flex; gap:8px">
        <button id="sendVerifyBtn" class="btn" aria-label="Send email verification">Send verification</button>
        <button id="markVerifiedBtn" class="btn primary" aria-label="Mark email as verified">Mark verified</button>
      </div>
    </div>

    <div id="list" class="grid" style="margin-top:12px"></div>
  </section>

  <!-- SCORECARD -->
  <section id="view-scorecard" class="hidden">
    <div class="panel">
      <div class="row" style="gap:8px">
        <div><strong>Scorecard</strong> <span id="gradeBadge" class="grade">‚Äî</span></div>
        <div class="tabs" role="tablist" aria-label="Scorecard Timeframe">
          <button type="button" class="tab score-tab active" role="tab" aria-selected="true" data-tf="7">Last 7 Days</button>
          <button type="button" class="tab score-tab" role="tab" aria-selected="false" data-tf="30">Last 30 Days</button>
          <button type="button" class="tab score-tab" role="tab" aria-selected="false" data-tf="180">Last 180 Days</button>
          <button type="button" class="tab score-tab" role="tab" aria-selected="false" data-tf="all">All-Time</button>
        </div>
      </div>

      <div class="metrics">
        <div class="card"><div class="label">Record</div><div class="value" id="mRecord">‚Äî</div></div>
        <div class="card"><div class="label">Win %</div><div class="value" id="mWinpct">‚Äî</div></div>
      </div>

      <div id="resultsWrap" class="result-list"></div>
      <div id="resultsNote" class="text-sub" style="margin-top:10px"></div>

      <details id="scoreHelp" class="text-sub" style="margin-top:12px">
        <summary style="cursor:pointer">Grading guide</summary>
        <div class="helper">
          <strong>F</strong> &lt; 45% ‚Ä¢ <strong>D</strong> 45‚Äì49.9% ‚Ä¢ <strong>C</strong> 50‚Äì54.9% ‚Ä¢
          <strong>B</strong> 55‚Äì64.9% ‚Ä¢ <strong>A</strong> ‚â• 65%.
          For A-tier, add a <strong>+</strong> every +8% above 65 (capped at A+++):
          <strong>A+</strong> 73‚Äì80.9%, <strong>A++</strong> 81‚Äì88.9%, <strong>A+++</strong> ‚â• 89%.
        </div>
      </details>
    </div>
  </section>

  <!-- OUTCOMES -->
  <section id="view-outcomes" class="hidden">
    <div class="panel" id="outcomesContainer">
      <!-- Content will be populated by renderOutcomes() -->
    </div>
  </section>

  <!-- Favorites -->
  <section id="view-favorites" class="hidden">
    <div class="panel">
      <div class="row" style="gap:8px; justify-content:space-between; align-items:center">
        <div><strong>My Favorites</strong></div>
        <button id="readFavoritesBtn" class="btn">üîä <span id="readFavoritesText">Read Favorites Aloud</span></button>
      </div>
      <div id="favGate" style="margin-top:8px"></div>
      <div id="favList" class="grid" style="margin-top:12px"></div>
    </div>
  </section>

  <!-- ACCOUNT -->
  <section id="view-account" class="hidden">
    <div class="account-wrap" id="accountContainer"></div>
  </section>

  <!-- ADMIN PORTAL -->
  <section id="view-admin" class="hidden">
    <!-- Admin Navigation Tabs -->
    <div class="tabs" style="margin-bottom: 16px;">
      <button class="tab active" id="adminTabOverview" data-admin-tab="overview">Overview</button>
      <button class="tab" id="adminTabQA" data-admin-tab="qa">QA Dashboard</button>
      <button class="tab" id="adminTabBanners" data-admin-tab="banners">Banners</button>
      <button class="tab" id="adminTabContent" data-admin-tab="content">Content</button>
      <button class="tab" id="adminTabData" data-admin-tab="data">Data & N8N</button>
      <button class="tab" id="adminTabUsers" data-admin-tab="users">üí∞ Financial</button>
      <button class="tab" id="adminTabSystem" data-admin-tab="system">System</button>
    </div>

    <!-- Overview Tab -->
    <div id="adminOverview" class="admin-tab-content">
    <div class="card">
        <h3 style="margin:0 0 16px 0">Admin Dashboard</h3>
      <div id="profileInfo"></div>
        
        <div class="metrics" style="margin-top: 16px;">
          <div class="card">
            <div class="label">Total Users</div>
            <div class="value" id="adminUserCount">1</div>
      </div>
          <div class="card">
            <div class="label">Active Subscriptions</div>
            <div class="value" id="adminSubCount">0</div>
      </div>
      </div>
        
        <div class="text-sub" style="margin-top: 16px;">Quick Actions:</div>
        <div class="grid" style="grid-template-columns:repeat(3,1fr);margin-top:8px;gap:8px">
          <button type="button" class="btn enhanced" id="btnAnon">Switch to Anon</button>
          <button type="button" class="btn enhanced" id="btnFree">Switch to Free</button>
          <button type="button" class="btn enhanced" id="btnPaid">Switch to Paid</button>
        </div>
        <div class="grid" style="grid-template-columns:repeat(3,1fr);margin-top:8px;gap:8px">
          <button type="button" class="btn enhanced" id="btnAdmin">Switch to Admin</button>
          <button id="adminOffBtn" class="btn danger enhanced">Exit Admin</button>
        <div></div>
      </div>
      </div>
    </div>

    <!-- QA Dashboard Tab -->
    <div id="adminQA" class="admin-tab-content hidden" style="flex-direction:column;height:100%;">
      <div class="card" style="flex:1;display:flex;flex-direction:column;">
        <h4 style="margin:0 0 16px 0">Pick QA Dashboard</h4>
        
        <!-- QA Stats -->
        <div class="grid" style="grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px">
          <div class="card" style="background: rgba(255,255,255,.04);">
            <div class="label">Draft Picks</div>
            <div class="value" id="qaDraftCount">0</div>
          </div>
          <div class="card" style="background: rgba(255,255,255,.04);">
            <div class="label">Live Picks</div>
            <div class="value" id="qaLiveCount">0</div>
          </div>
          <div class="card" style="background: rgba(255,255,255,.04);">
            <div class="label">Rejected</div>
            <div class="value" id="qaRejectedCount">0</div>
          </div>
          <div class="card" style="background: rgba(255,255,255,.04);">
            <div class="label">Scoring</div>
            <div class="value" id="qaScoringCount">0</div>
          </div>
        </div>

        <!-- Filter Controls -->
        <div class="card" style="background: rgba(255,255,255,.04); margin-bottom: 16px;">
          <h5 style="margin:0 0 12px 0">Filter Picks</h5>
             <div class="grid" style="grid-template-columns:repeat(6,1fr);gap:8px">
               <button type="button" class="btn enhanced" id="qaFilterAll">All</button>
               <button type="button" class="btn enhanced" id="qaFilterDraft">üìù Draft</button>
               <button type="button" class="btn enhanced" id="qaFilterLive">üî¥ Live</button>
               <button type="button" class="btn enhanced" id="qaFilterRejected">‚ùå Rejected</button>
               <button type="button" class="btn enhanced" id="qaFilterScoring">üèÜ Scoring</button>
               <button type="button" class="btn enhanced" id="qaFilterDeleted">üóëÔ∏è Deleted</button>
             </div>
             
             <!-- Scoring Actions -->
             <div id="scoringActions" class="hidden" style="margin-top:16px;padding:12px;background:rgba(255,255,255,.04);border-radius:8px;">
               <h5 style="margin:0 0 12px 0">üéØ Mark Results</h5>
               <div class="grid" style="grid-template-columns:repeat(3,1fr);gap:8px">
                 <button type="button" class="btn success" id="markSelectedHits">‚úÖ Mark Selected as Hits</button>
                 <button type="button" class="btn danger" id="markSelectedMisses">‚ùå Mark Selected as Misses</button>
                 <button type="button" class="btn enhanced" id="clearScoringSelections">üóëÔ∏è Clear Selections</button>
               </div>
             </div>
             
             <!-- Completed Scores Dropdown -->
             <div id="completedScoresSection" class="hidden" style="margin-top:16px;padding:12px;background:rgba(255,255,255,.04);border-radius:8px;">
               <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                 <h5 style="margin:0">üèÜ Completed Scores</h5>
                 <button type="button" class="btn enhanced" id="toggleCompletedScores" style="padding:4px 8px;font-size:12px;">‚ñº Show</button>
               </div>
               <div id="completedScoresList" class="hidden" style="max-height:300px;overflow-y:auto;border:1px solid rgba(255,255,255,.1);border-radius:6px;padding:8px;">
                 <div style="text-align:center;color:#888;padding:20px;">Loading completed scores...</div>
               </div>
             </div>
        </div>

        <!-- Bulk Selection Controls -->
        <div class="card" style="background: rgba(255,255,255,.04); margin-bottom: 16px;">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:16px;">
            <div style="display:flex;align-items:center;gap:12px;">
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer;user-select:none;">
                <input type="checkbox" id="qaSelectAll" style="width:18px;height:18px;cursor:pointer;">
                <span style="font-weight:600;color:#fff;">Select All</span>
              </label>
              <span id="qaSelectionCount" style="color:#888;font-size:14px;">0 selected</span>
            </div>
            <div style="display:flex;gap:8px;">
              <button type="button" class="btn primary enhanced" id="qaBulkApprove" disabled>‚úì Approve Selected</button>
              <button type="button" class="btn secondary enhanced" id="qaBulkReject" disabled>‚úó Reject Selected</button>
              <button type="button" class="btn secondary enhanced" id="qaBulkDelete" disabled>üóëÔ∏è Delete Selected</button>
            </div>
          </div>
        </div>

        <!-- Create New Pick (Collapsible) -->
        <div class="card" style="background: rgba(255,255,255,.04); margin-bottom: 16px;">
          <div style="display:flex;justify-content:space-between;align-items:center;cursor:pointer;" onclick="toggleCreatePickPanel()">
            <h5 style="margin:0">Create New Pick</h5>
            <span id="createPickToggle" style="font-size:18px;color:#666;transition:transform 0.3s ease;">‚ñº</span>
          </div>
          <div id="createPickForm" style="display:none;margin-top:12px;">
            <div class="grid" style="grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:12px">
              <div>
                <label class="text-sub">Away Team</label>
                <input type="text" id="qaAwayTeam" placeholder="e.g., Yankees" style="width:100%;padding:8px;border-radius:4px;border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.3);color:white;">
              </div>
              <div>
                <label class="text-sub">Home Team</label>
                <input type="text" id="qaHomeTeam" placeholder="e.g., Red Sox" style="width:100%;padding:8px;border-radius:4px;border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.3);color:white;">
              </div>
              <div>
                <label class="text-sub">Pick</label>
                <input type="text" id="qaPick" placeholder="e.g., Yankees ML" style="width:100%;padding:8px;border-radius:4px;border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.3);color:white;">
              </div>
              <div>
                <label class="text-sub">Odds</label>
                <input type="text" id="qaOdds" placeholder="e.g., -110" style="width:100%;padding:8px;border-radius:4px;border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.3);color:white;">
              </div>
              <div>
                <label class="text-sub">Confidence %</label>
                <input type="number" id="qaConfidence" placeholder="85" min="1" max="100" style="width:100%;padding:8px;border-radius:4px;border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.3);color:white;">
              </div>
              <div>
                <label class="text-sub">Game Start Time</label>
                <input type="datetime-local" id="qaGameTime" style="width:100%;padding:8px;border-radius:4px;border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.3);color:white;">
              </div>
            </div>
            <div style="margin-bottom:12px">
              <label class="text-sub">Reasoning</label>
              <textarea id="qaReasoning" placeholder="Enter your reasoning for this pick..." style="width:100%;padding:8px;border-radius:4px;border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.3);color:white;height:60px;resize:vertical;"></textarea>
            </div>
            <div style="margin-bottom:12px">
              <label class="text-sub">Injury Alerts (optional)</label>
              <input type="text" id="qaInjuryAlerts" placeholder="e.g., Key player questionable" style="width:100%;padding:8px;border-radius:4px;border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.3);color:white;">
            </div>
            <button type="button" class="btn primary enhanced" id="qaCreatePick">Create Pick</button>
          </div>
        </div>

        <!-- JSON Upload Section -->
        <div class="card" style="background: rgba(255,255,255,.04); margin-bottom: 16px;">
          <div style="display:flex;justify-content:space-between;align-items:center;cursor:pointer;" onclick="toggleJSONUploadPanel()">
            <h5 style="margin:0">üìÅ Upload JSON Picks</h5>
            <span id="jsonUploadToggle" style="font-size:18px;color:#666;transition:transform 0.3s ease;">‚ñº</span>
          </div>
          <div id="jsonUploadForm" style="display:none;margin-top:12px;">
            <div style="margin-bottom:12px">
              <label class="text-sub">Paste NDJSON Data (one pick per line)</label>
              <textarea id="jsonUploadTextarea" placeholder="Paste your NDJSON data here..." style="width:100%;height:200px;padding:8px;border-radius:4px;border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.3);color:white;font-family:monospace;font-size:12px;resize:vertical;"></textarea>
            </div>
            <div style="margin-bottom:12px">
              <label class="text-sub">Or Upload File</label>
              <input type="file" id="jsonFileInput" accept=".json,.ndjson,.txt" style="width:100%;padding:8px;border-radius:4px;border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.3);color:white;">
            </div>
            <div style="display:flex;gap:8px;margin-bottom:12px">
              <button type="button" class="btn secondary enhanced" id="previewJSONUpload">üëÅÔ∏è Preview</button>
              <button type="button" class="btn primary enhanced" id="uploadJSONPicks">üì§ Upload to Firebase</button>
              <button type="button" class="btn secondary enhanced" id="clearJSONUpload">üóëÔ∏è Clear</button>
            </div>
            <div id="jsonUploadPreview" style="display:none;margin-top:12px;padding:12px;background:rgba(0,0,0,.2);border-radius:4px;border:1px solid rgba(255,255,255,.1);">
              <h6 style="margin:0 0 8px 0;color:#4CAF50;">üìã Preview (First 3 picks):</h6>
              <div id="jsonPreviewContent" style="font-family:monospace;font-size:11px;color:#ccc;max-height:150px;overflow-y:auto;"></div>
            </div>
            <div id="jsonUploadStatus" style="display:none;margin-top:12px;padding:8px;border-radius:4px;font-size:12px;"></div>
          </div>
        </div>

        <!-- Picks List -->
        <div class="card" style="background: rgba(255,255,255,.04); flex:1; display:flex; flex-direction:column;">
          <h5 style="margin:0 0 12px 0">Picks Review</h5>
          <div id="qaPicksList" style="flex:1; overflow-y:auto; min-height:0;">
            <!-- Picks will be loaded here -->
          </div>
      </div>
      </div>
    </div>

    <!-- Banner Management Tab -->
    <div id="adminBanners" class="admin-tab-content hidden">
      <div class="card">
        <h4 style="margin:0 0 16px 0">Banner Management</h4>
        
        <!-- Current Banner Status -->
        <div class="card" style="background: rgba(255,255,255,.04); margin-bottom: 16px;">
          <div class="text-sub">Current Banner Status:</div>
          <div id="bannerStatus" style="margin-top: 8px;">
            <strong id="bannerStatusText">No active banner</strong>
          </div>
        </div>
        
        <!-- Banner Creator -->
        <div style="margin-bottom: 16px;">
          <div class="text-sub" style="margin-bottom: 8px;">Create/Edit Banner:</div>
          <select id="bannerType" class="input enhanced" style="margin-bottom: 8px;">
            <option value="maintenance">Maintenance Notice</option>
            <option value="announcement">Announcement</option>
            <option value="warning">Warning</option>
            <option value="info">Information</option>
          </select>
          <input id="bannerTitle" class="input" placeholder="Banner title..." style="margin-bottom: 8px;"/>
          <textarea id="bannerMessage" class="input" placeholder="Banner message..." style="min-height: 80px; margin-bottom: 8px;"></textarea>
          <div class="row" style="gap: 8px;">
            <button id="previewBannerBtn" class="btn enhanced">Preview</button>
            <button id="activateBannerBtn" class="btn primary enhanced">Activate Banner</button>
            <button id="hideBannerBtn" class="btn danger enhanced">Hide Banner</button>
          </div>
        </div>
        
        <!-- Banner Templates -->
        <div class="text-sub" style="margin-bottom: 8px;">Quick Templates:</div>
        <div class="grid" style="grid-template-columns:repeat(2,1fr);gap:8px">
          <button class="btn enhanced" id="maintenanceTemplateBtn">Maintenance Template</button>
          <button class="btn enhanced" id="updateTemplateBtn">Update Announcement</button>
        </div>
      </div>
    </div>

    <!-- Content Management Tab -->
    <div id="adminContent" class="admin-tab-content hidden">
      <div class="card">
        <h4 style="margin:0 0 16px 0">Content Management</h4>
        
        <!-- Legal Pages Editor -->
        <div style="margin-bottom: 20px;">
          <div class="text-sub" style="margin-bottom: 8px;">Legal Pages:</div>
          <div class="row" style="gap: 8px; margin-bottom: 12px;">
            <button class="btn enhanced" id="editTermsBtn">Edit Terms of Service</button>
            <button class="btn enhanced" id="editPrivacyBtn">Edit Privacy Policy</button>
          </div>
          
          <div id="legalEditor" class="hidden">
            <div class="text-sub" style="margin-bottom: 8px;">Editing: <span id="editingPageTitle">Terms of Service</span></div>
            <textarea id="legalContent" class="input" style="min-height: 200px; margin-bottom: 8px;" placeholder="Legal page content..."></textarea>
            <div class="row" style="gap: 8px;">
              <button id="saveLegalBtn" class="btn primary enhanced">Save Changes</button>
              <button id="cancelLegalBtn" class="btn enhanced">Cancel</button>
            </div>
          </div>
        </div>
        
        <!-- System Messages -->
        <div>
          <div class="text-sub" style="margin-bottom: 8px;">System Messages:</div>
          <div class="grid" style="grid-template-columns:1fr 1fr;gap:12px;">
            <div>
              <label class="text-sub" style="font-size: 12px;">Gate Message:</label>
              <textarea id="gateMessage" class="input" placeholder="Enter site password message..." style="min-height: 60px;"></textarea>
            </div>
            <div>
              <label class="text-sub" style="font-size: 12px;">Upgrade CTA:</label>
              <textarea id="upgradeCTA" class="input" placeholder="Upgrade call-to-action text..." style="min-height: 60px;"></textarea>
            </div>
          </div>
          <button id="saveMessagesBtn" class="btn primary enhanced" style="margin-top: 8px;">Save Messages</button>
        </div>
      </div>
    </div>

    <!-- Data & N8N Management Tab -->
    <div id="adminData" class="admin-tab-content hidden">
      <div class="card">
        <h4 style="margin:0 0 16px 0">Data & N8N Management</h4>
        
        <!-- Firebase Data Status -->
        <div class="card" style="background: rgba(255,255,255,.04); margin-bottom: 16px;">
          <h5 style="margin:0 0 12px 0">Firebase Data Status</h5>
          <div class="grid" style="grid-template-columns:repeat(2,1fr);gap:12px">
            <div>
              <div class="label">Current Picks</div>
              <div class="value" id="adminPicksCount">Loading...</div>
            </div>
            <div>
              <div class="label">Last Updated</div>
              <div class="value" id="adminLastUpdate">Loading...</div>
            </div>
          </div>
        </div>

        <!-- N8N Controls -->
        <div class="card" style="background: rgba(255,255,255,.04); margin-bottom: 16px;">
          <h5 style="margin:0 0 12px 0">N8N Workflow Controls</h5>
          <div class="grid" style="grid-template-columns:repeat(2,1fr);gap:8px">
            <button type="button" class="btn enhanced" id="btnTriggerN8NUpdate">
              üîÑ Trigger N8N Update
            </button>
            <button type="button" class="btn enhanced" id="btnReloadFirebase">
              üîÑ Reload Firebase Data
            </button>
            <button type="button" class="btn enhanced" id="btnTestN8NConnection">
              üîó Test N8N Connection
            </button>
            <button type="button" class="btn enhanced" id="btnViewN8NLogs">
              üìã View N8N Logs
            </button>
          </div>
        </div>

        <!-- Data Management -->
        <div class="card" style="background: rgba(255,255,255,.04); margin-bottom: 16px;">
          <h5 style="margin:0 0 12px 0">Data Management</h5>
          <div class="grid" style="grid-template-columns:repeat(2,1fr);gap:8px">
            <button type="button" class="btn enhanced" id="btnExportData">
              üì§ Export Data
            </button>
            <button type="button" class="btn enhanced" id="btnImportData">
              üì• Import Data
            </button>
            <button type="button" class="btn enhanced" id="btnBackupData">
              üíæ Backup Data
            </button>
            <button type="button" class="btn enhanced" id="btnClearOldData">
              üóëÔ∏è Clear Old Data
            </button>
          </div>
        </div>

        <!-- N8N Configuration -->
        <div class="card" style="background: rgba(255,255,255,.04);">
          <h5 style="margin:0 0 12px 0">N8N Configuration</h5>
          <div class="text-sub" style="margin-bottom: 8px;">Webhook Endpoints:</div>
          <div style="font-family: monospace; font-size: 12px; background: rgba(0,0,0,.3); padding: 8px; border-radius: 4px; margin-bottom: 12px;">
            <div>Picks: <span id="n8nPicksEndpoint">Not configured</span></div>
            <div>Analytics: <span id="n8nAnalyticsEndpoint">Not configured</span></div>
            <div>Contact: <span id="n8nContactEndpoint">Not configured</span></div>
          </div>
          <button type="button" class="btn enhanced" id="btnConfigureN8N">
            ‚öôÔ∏è Configure N8N Endpoints
          </button>
        </div>
      </div>
    </div>

    <!-- Financial Dashboard Tab -->
    <div id="adminUsers" class="admin-tab-content hidden">
      <div class="card financial-dashboard">
        <h4 style="margin:0 0 16px 0">üí∞ Financial Dashboard</h4>
        
        <!-- Revenue Overview -->
        <div class="card" style="background: rgba(255,255,255,.04); margin-bottom: 16px;">
          <h5 style="margin:0 0 12px 0">üìä Revenue Overview</h5>
          <div class="grid" style="grid-template-columns:repeat(4,1fr);gap:12px">
            <div>
              <div class="label">Total Users</div>
              <div class="value" id="totalUsersCount">Loading...</div>
            </div>
            <div>
              <div class="label">Paid Subscribers</div>
              <div class="value" id="paidUsersCount">Loading...</div>
            </div>
            <div>
              <div class="label">Monthly Revenue</div>
              <div class="value" id="monthlyRevenue">Loading...</div>
            </div>
            <div>
              <div class="label">Conversion Rate</div>
              <div class="value" id="conversionRate">Loading...</div>
            </div>
          </div>
        </div>

        <!-- Subscription Analytics -->
        <div class="card" style="background: rgba(255,255,255,.04); margin-bottom: 16px;">
          <h5 style="margin:0 0 12px 0">üìà Subscription Analytics</h5>
          <div class="grid" style="grid-template-columns:repeat(3,1fr);gap:12px">
            <div>
              <div class="label">Free Users</div>
              <div class="value" id="freeUsersCount">Loading...</div>
            </div>
            <div>
              <div class="label">Trial Users</div>
              <div class="value" id="trialUsersCount">Loading...</div>
            </div>
            <div>
              <div class="label">Churn Rate</div>
              <div class="value" id="churnRate">Loading...</div>
            </div>
          </div>
        </div>

        <!-- Team Payout Projections -->
        <div class="card" style="background: rgba(255,255,255,.04); margin-bottom: 16px;">
          <h5 style="margin:0 0 12px 0">üë• Team Payout Projections</h5>
          <div class="grid" style="grid-template-columns:repeat(2,1fr);gap:12px">
            <div>
              <div class="label">This Month's Revenue</div>
              <div class="value" id="currentMonthRevenue">$0</div>
            </div>
            <div>
              <div class="label">Projected Annual</div>
              <div class="value" id="annualProjection">$0</div>
            </div>
          </div>
          
          <div style="margin-top: 16px;">
            <div class="text-sub" style="margin-bottom: 8px;">Team Split Configuration:</div>
            <div class="grid" style="grid-template-columns:repeat(2,1fr);gap:12px">
              <div>
                <label style="display: block; margin-bottom: 4px;">Your Share (%)</label>
                <input type="number" id="ownerShare" value="70" min="0" max="100" class="input" style="width: 100%;">
              </div>
              <div>
                <label style="display: block; margin-bottom: 4px;">Team Share (%)</label>
                <input type="number" id="teamShare" value="30" min="0" max="100" class="input" style="width: 100%;">
              </div>
            </div>
          </div>
          
          <div style="margin-top: 16px;">
            <div class="text-sub" style="margin-bottom: 8px;">Projected Payouts:</div>
            <div class="grid" style="grid-template-columns:repeat(2,1fr);gap:12px">
              <div>
                <div class="label">Your Monthly Share</div>
                <div class="value" id="ownerMonthlyPayout">$0</div>
              </div>
              <div>
                <div class="label">Team Monthly Share</div>
                <div class="value" id="teamMonthlyPayout">$0</div>
              </div>
            </div>
          </div>
        </div>

        <!-- User Management Actions -->
        <div style="margin-bottom: 16px;">
          <div class="text-sub" style="margin-bottom: 8px;">Financial Tools:</div>
          <div class="grid" style="grid-template-columns:repeat(3,1fr);gap:8px">
            <button id="refreshUserData" class="btn enhanced">üîÑ Refresh Data</button>
            <button id="exportUserReport" class="btn enhanced">üìä Export Report</button>
            <button id="viewUserDetails" class="btn enhanced">üë• View Details</button>
          </div>
        </div>

        <!-- Subscription Price Configuration -->
        <div class="card" style="background: rgba(255,255,255,.04); margin-bottom: 16px;">
          <h5 style="margin:0 0 12px 0">‚öôÔ∏è Subscription Configuration</h5>
          <div class="grid" style="grid-template-columns:repeat(2,1fr);gap:12px">
            <div>
              <label style="display: block; margin-bottom: 4px;">Monthly Price ($)</label>
              <input type="number" id="monthlyPrice" value="15" min="1" step="0.01" class="input" style="width: 100%;">
            </div>
            <div>
              <label style="display: block; margin-bottom: 4px;">Annual Price ($)</label>
              <input type="number" id="annualPrice" value="150" min="1" step="0.01" class="input" style="width: 100%;">
            </div>
          </div>
          <button id="updatePricing" class="btn primary enhanced" style="margin-top: 12px;">üíæ Update Pricing</button>
        </div>

        <!-- Development Tools (Moved from old Users tab) -->
        <div>
          <div class="text-sub" style="margin-bottom: 8px;">Development Tools:</div>
          <div class="grid" style="grid-template-columns:repeat(3,1fr);gap:8px">
            <button id="seedOutcomesBtn" class="btn enhanced">Seed Demo Data</button>
            <button id="clearFavsBtn" class="btn danger enhanced">Clear All Favorites</button>
            <button id="resetAllDataBtn" class="btn danger enhanced">Reset All Data</button>
          </div>
        </div>
      </div>
    </div>

    <!-- System Management Tab -->
    <div id="adminSystem" class="admin-tab-content hidden">
      <div class="card">
        <h4 style="margin:0 0 16px 0">System Management</h4>
        
        <!-- Feature Flags -->
        <div style="margin-bottom: 20px;">
          <div class="text-sub" style="margin-bottom: 8px;">Feature Flags:</div>
          <div class="grid" style="grid-template-columns:1fr 1fr;gap:12px;">
            <div>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="gateEnabledFlag" checked>
                <span>Password Gate Enabled</span>
              </label>
            </div>
            <div>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="subscriptionEnabledFlag" checked>
                <span>Subscriptions Enabled</span>
              </label>
            </div>
            <div>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="contactEnabledFlag" checked>
                <span>Contact Form Enabled</span>
              </label>
            </div>
            <div>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="favoritesEnabledFlag" checked>
                <span>Favorites Enabled</span>
              </label>
            </div>
          </div>
          <button id="saveFlagsBtn" class="btn primary enhanced" style="margin-top: 8px;">Save Feature Flags</button>
        </div>
        
        <!-- System Info -->
        <div style="margin-bottom: 20px;">
          <div class="text-sub" style="margin-bottom: 8px;">System Information:</div>
          <div class="card" style="background: rgba(255,255,255,.04);">
            <div><strong>Version:</strong> 1.0.0</div>
            <div><strong>Environment:</strong> Development</div>
            <div><strong>Last Updated:</strong> <span id="lastUpdateTime">Just now</span></div>
            <div><strong>Storage Used:</strong> <span id="storageUsed">~50KB</span></div>
          </div>
        </div>
        
        <!-- System Actions -->
        <div>
          <div class="text-sub" style="margin-bottom: 8px;">System Actions:</div>
          <div class="grid" style="grid-template-columns:repeat(3,1fr);gap:8px">
            <button id="clearCacheBtn" class="btn enhanced">Clear Cache</button>
            <button id="exportDataBtn" class="btn enhanced">Export Data</button>
            <button id="importDataBtn" class="btn enhanced">Import Data</button>
          </div>
          <div class="grid" style="grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px">
            <button id="systemResetBtn" class="btn danger enhanced">System Reset</button>
            <button id="backupDataBtn" class="btn enhanced">Backup Data</button>
            <div>        </div>

        <!-- Backup & Restore Section -->
        <div class="card" style="background: rgba(255,255,255,.04); margin-bottom: 16px;">
          <div style="display:flex;justify-content:space-between;align-items:center;cursor:pointer;" onclick="toggleBackupPanel()">
            <h5 style="margin:0">üíæ Backup & Restore</h5>
            <span id="backupToggle" style="font-size:18px;color:#666;transition:transform 0.3s ease;">‚ñº</span>
          </div>
          <div id="backupForm" style="display:none;margin-top:12px;">
            <div style="margin-bottom:16px;">
              <h6 style="margin:0 0 8px 0;color:#4CAF50;">üì¶ Export All Data</h6>
              <p style="margin:0 0 12px 0;color:#ccc;font-size:14px;">Download complete backup of all collections as JSON file</p>
              <button type="button" class="btn primary enhanced" id="exportAllData">üì• Export Backup</button>
            </div>
            
            <div style="margin-bottom:16px;">
              <h6 style="margin:0 0 8px 0;color:#FF9800;">üîÑ Restore from Backup</h6>
              <p style="margin:0 0 12px 0;color:#ccc;font-size:14px;">Upload JSON backup file to restore all data</p>
              <input type="file" id="backupFileInput" accept=".json" style="width:100%;padding:8px;border-radius:4px;border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.3);color:white;margin-bottom:8px;">
              <button type="button" class="btn secondary enhanced" id="restoreFromBackup" disabled>üì§ Restore Backup</button>
            </div>
            
            <div style="margin-bottom:16px;">
              <h6 style="margin:0 0 8px 0;color:#2196F3;">üîß System Maintenance</h6>
              <p style="margin:0 0 12px 0;color:#ccc;font-size:14px;">Auto-create missing collections and check system health</p>
              <button type="button" class="btn secondary enhanced" id="checkCollections">üîç Check Collections</button>
            </div>
            
           <div style="margin-bottom:16px;">
             <h6 style="margin:0 0 8px 0;color:#FF5722;">üèÜ Scoring Management</h6>
             <p style="margin:0 0 12px 0;color:#ccc;font-size:14px;">Move completed games to scoring and calculate statistics</p>
             <div style="display:flex;gap:8px;flex-wrap:wrap;">
               <button type="button" class="btn secondary enhanced" id="moveCompletedGames">‚è∞ Move Completed</button>
               <button type="button" class="btn secondary enhanced" id="calculateStats">üìä Calculate Stats</button>
               <button type="button" class="btn secondary enhanced" id="debugScoring">üîç Debug Scoring</button>
             </div>
           </div>
            
            <div id="backupStatus" style="display:none;margin-top:12px;padding:8px;border-radius:4px;font-size:12px;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
  </section>

  <!-- Subscribe -->
  <section id="view-subscribe" class="hidden">
    <div class="card">
      <div class="row" style="justify-content:space-between; align-items:flex-end">
        <div>
          <h3 style="margin:0 0 6px 0">Become a Subscriber</h3>
          <div class="text-sub">Unlock full picks, Favorites, and Outcomes.</div>
        </div>
        <div class="chip">21+</div>
      </div>
      <div class="row" style="gap:10px; margin-top:12px">
        <div class="row" style="gap:8px; align-items:baseline">
          <div id="planName"><strong>Confident Picks ‚Äî Monthly</strong></div>
          <div class="h1" id="planPrice" style="font-size:22px">$15</div>
          <div id="planInterval" class="text-sub">USD / month</div>
        </div>
        <div class="space"></div>
        <div class="row" style="gap:8px">
          <button id="planMonthlyBtn" class="btn primary">Monthly</button>
          <button id="planYearlyBtn" class="btn">Yearly</button>
        </div>
      </div>
      <div class="row" style="gap:8px; margin-top:8px">
        <input id="couponCode" class="input" placeholder="Have a code? (try SAVE20)"/>
        <button id="applyCouponBtn" class="btn">Apply</button>
      </div>
      <div id="subscribeNote" class="text-sub" style="margin-top:8px"></div>
      <div class="row" style="gap:10px; margin-top:12px">
        <button id="upgradeNowBtn" class="btn primary">Complete subscription ‚Äî $15/mo</button>
        <button id="backToPicksBtn" class="btn">Back to picks</button>
      </div>
    </div>
  </section>

  <!-- Legal pages -->


  

  <!-- Contact Form -->
  <section id="view-contact" class="hidden">
    <div class="card">
      <h3 style="margin:0 0 8px 0" id="contactTitle">Contact Us</h3>
      <div class="text-sub" style="margin-bottom:12px">Have questions or feedback? We'd love to hear from you!</div>
      
      <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px">
        <div>
          <div class="text-sub" id="nameLabel">Name</div>
          <input id="contactName" class="input" style="margin-top:4px" placeholder="Your name"/>
        </div>
        <div>
          <div class="text-sub" id="emailLabel">Email</div>
          <input id="contactEmail" type="email" class="input" style="margin-top:4px; background:var(--card); opacity:0.7" placeholder="Auto-filled from your account" readonly/>
        </div>
      </div>
      
      <div style="margin-bottom:12px">
        <div class="text-sub" id="subjectLabel">Subject</div>
        <select id="contactSubject" class="input" style="margin-top:4px">
          <option value="">Select a topic...</option>
          <option value="general">General Inquiry</option>
          <option value="account">Account Issues</option>
          <option value="billing">Billing/Subscription</option>
          <option value="picks">Picks/Data Questions</option>
          <option value="technical">Technical Support</option>
          <option value="feedback">Feedback/Suggestions</option>
          <option value="partnership">Partnership/Business</option>
          <option value="other">Other</option>
        </select>
      </div>
      
      <div style="margin-bottom:12px">
        <div class="text-sub" id="messageLabel">Message</div>
        <textarea id="contactMessage" class="input" style="margin-top:4px; min-height:100px; resize:vertical" placeholder="Tell us more..."></textarea>
      </div>
      
      <div class="row" style="gap:8px">
        <button id="sendContactBtn" class="btn primary enhanced" id="sendBtn">Send Message</button>
        <button id="clearContactBtn" class="btn enhanced">Clear Form</button>
      </div>
    </div>
  </section>

  <!-- RESPONSIBLE GAMING -->
  <section id="view-responsible" class="hidden">
    <div class="container">
      <h2>Responsible Gambling</h2>
      
      <div class="card" style="margin-bottom: 20px;">
        <h3>Our Commitment</h3>
        <p>Confident Picks is committed to promoting responsible gambling practices. Our content is provided for entertainment and educational purposes only.</p>
      </div>
      
      <div class="card" style="margin-bottom: 20px;">
        <h3>Important Guidelines</h3>
        <ul style="margin: 12px 0; padding-left: 20px; color: var(--text);">
          <li>Never bet more than you can afford to lose</li>
          <li>Set limits on time and money spent on gambling activities</li>
          <li>Don't chase losses with bigger bets</li>
          <li>Take regular breaks from gambling activities</li>
          <li>Seek help if gambling becomes problematic</li>
        </ul>
      </div>
      
      <div class="card" style="margin-bottom: 20px;">
        <h3>Age Restrictions</h3>
        <p>You must be 21 years or older (or the legal gambling age in your jurisdiction) to use our services. We do not knowingly provide services to minors.</p>
      </div>
      
      <div class="card" style="margin-bottom: 20px;">
        <h3>Problem Gambling Resources</h3>
        <p>If you or someone you know has a gambling problem, help is available:</p>
        <ul style="margin: 12px 0; padding-left: 20px; color: var(--text);">
          <li><strong>National Problem Gambling Helpline:</strong> 1-800-522-4700</li>
          <li><strong>Gamblers Anonymous:</strong> <a href="https://www.gamblersanonymous.org" target="_blank" style="color: var(--blue);">gamblersanonymous.org</a></li>
          <li><strong>National Council on Problem Gambling:</strong> <a href="https://www.ncpgambling.org" target="_blank" style="color: var(--blue);">ncpgambling.org</a></li>
          <li><strong>Gam-Anon (for families):</strong> <a href="https://www.gam-anon.org" target="_blank" style="color: var(--blue);">gam-anon.org</a></li>
        </ul>
      </div>
      
      <div class="card">
        <h3>Self-Exclusion</h3>
        <p>If you wish to exclude yourself from our services, please contact us at support@confident-picks.com. We will process your request within 24 hours.</p>
      </div>
    </div>
  </section>

  <!-- TERMS OF SERVICE -->
  <section id="view-terms" class="hidden">
    <div class="container">
      <h2>Terms of Service</h2>
      
      <div class="card" style="margin-bottom: 20px;">
        <h3>1. Acceptance of Terms</h3>
        <p>By accessing and using Confident Picks, you accept and agree to be bound by the terms and provision of this agreement.</p>
      </div>
      
      <div class="card" style="margin-bottom: 20px;">
        <h3>2. Service Description</h3>
        <p>Confident Picks provides sports betting analysis, predictions, and educational content for entertainment purposes only. We do not operate as a sportsbook or gambling platform.</p>
      </div>
      
      <div class="card" style="margin-bottom: 20px;">
        <h3>3. Disclaimer</h3>
        <p>All predictions and analysis are for entertainment and educational purposes only. Past performance does not guarantee future results. We are not responsible for any losses incurred from following our analysis.</p>
      </div>
      
      <div class="card" style="margin-bottom: 20px;">
        <h3>4. User Responsibilities</h3>
        <ul style="margin: 12px 0; padding-left: 20px; color: var(--text);">
          <li>You must be 21+ or the legal age in your jurisdiction</li>
          <li>You are responsible for complying with local laws</li>
          <li>You agree to use the service responsibly</li>
          <li>You will not share account credentials</li>
        </ul>
      </div>
      
      <div class="card" style="margin-bottom: 20px;">
        <h3>5. Intellectual Property</h3>
        <p>All content, analysis, and materials on Confident Picks are proprietary and protected by copyright laws. Unauthorized reproduction or distribution is prohibited.</p>
      </div>
      
      <div class="card" style="margin-bottom: 20px;">
        <h3>6. Limitation of Liability</h3>
        <p>Confident Picks shall not be liable for any direct, indirect, incidental, or consequential damages arising from the use of our service.</p>
      </div>
      
      <div class="card">
        <h3>7. Contact Information</h3>
        <p>For questions about these terms, contact us at legal@confident-picks.com</p>
        <p><strong>Last updated:</strong> January 2025</p>
      </div>
    </div>
  </section>

  <!-- PRIVACY POLICY -->
  <section id="view-privacy" class="hidden">
    <div class="container">
      <h2>Privacy Policy</h2>
      
      <div class="card" style="margin-bottom: 20px;">
        <h3>1. Information We Collect</h3>
        <p>We collect information you provide directly to us, such as when you create an account, subscribe to our service, or contact us for support.</p>
        <ul style="margin: 12px 0; padding-left: 20px; color: var(--text);">
          <li>Email address and account credentials</li>
          <li>Payment information (processed securely by third parties)</li>
          <li>Communication preferences</li>
          <li>Usage data and analytics</li>
        </ul>
      </div>
      
      <div class="card" style="margin-bottom: 20px;">
        <h3>2. How We Use Your Information</h3>
        <ul style="margin: 12px 0; padding-left: 20px; color: var(--text);">
          <li>Provide and improve our services</li>
          <li>Send you updates and promotional content</li>
          <li>Process payments and subscriptions</li>
          <li>Respond to your inquiries and support requests</li>
          <li>Comply with legal obligations</li>
        </ul>
      </div>
      
      <div class="card" style="margin-bottom: 20px;">
        <h3>3. Information Sharing</h3>
        <p>We do not sell, trade, or rent your personal information to third parties. We may share information in these limited circumstances:</p>
        <ul style="margin: 12px 0; padding-left: 20px; color: var(--text);">
          <li>With service providers who assist in our operations</li>
          <li>When required by law or to protect our rights</li>
          <li>In connection with a business transfer or merger</li>
        </ul>
      </div>
      
      <div class="card" style="margin-bottom: 20px;">
        <h3>4. Data Security</h3>
        <p>We implement appropriate security measures to protect your personal information against unauthorized access, alteration, disclosure, or destruction.</p>
      </div>
      
      <div class="card" style="margin-bottom: 20px;">
        <h3>5. Cookies and Tracking</h3>
        <p>We use cookies and similar technologies to improve your experience, analyze usage patterns, and provide personalized content.</p>
      </div>
      
      <div class="card" style="margin-bottom: 20px;">
        <h3>6. Your Rights</h3>
        <ul style="margin: 12px 0; padding-left: 20px; color: var(--text);">
          <li>Access and review your personal information</li>
          <li>Request corrections to inaccurate data</li>
          <li>Delete your account and associated data</li>
          <li>Opt out of marketing communications</li>
        </ul>
      </div>
      
      <div class="card">
        <h3>7. Contact Us</h3>
        <p>For questions about this privacy policy or to exercise your rights, contact us at privacy@confident-picks.com</p>
        <p><strong>Last updated:</strong> January 2025</p>
      </div>
    </div>
  </section>

  <footer>
    For entertainment and educational purposes only. Not gambling advice. If you or someone you know has a gambling problem, seek help.
    <br><br>
    <a href="#responsible" data-nav>Responsible gambling</a> ¬∑
    <a href="#terms" data-nav>Terms</a> ¬∑
    <a href="#privacy" data-nav>Privacy</a> ¬∑
    <a href="#contact" data-nav>Contact</a> ¬∑
    <strong>21+ where applicable</strong>
    <br><br>
    ¬© <span id="copyrightYear">2024</span> Confident Picks. All rights reserved.
</footer>
</div>

<div id="mobileBanner" class="mobile-banner">
  <div>
    <div id="mobileBannerTitle"><strong>Upgrade to unlock all picks</strong></div>
    <div id="mobileBannerSubtext" class="text-sub">$15 USD / month</div>
  </div>
  <button id="mobileUpgradeBtn" class="btn primary enhanced">Upgrade</button>
</div>

<!-- Keyboard Shortcuts Help Modal -->
<div id="helpModal" class="help-modal">
  <div class="help-content">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
      <h3 style="margin: 0;">Keyboard Shortcuts</h3>
      <button id="closeHelpBtn" class="btn" style="padding: 4px 8px;">‚úï</button>
    </div>
    <div class="text-sub" style="margin-bottom: 16px;">Use these shortcuts to navigate faster:</div>
    
    <div class="help-shortcuts">
      <div class="help-shortcut">
        <span>Focus search</span>
        <kbd>/</kbd>
      </div>
      <div class="help-shortcut">
        <span>Toggle theme</span>
        <kbd>t</kbd>
      </div>
      <div class="help-shortcut">
        <span>Navigate to Picks</span>
        <kbd>1</kbd>
      </div>
      <div class="help-shortcut">
        <span>Navigate to Scorecard</span>
        <kbd>2</kbd>
      </div>
      <div class="help-shortcut">
        <span>Navigate to Outcomes</span>
        <kbd>3</kbd>
      </div>
      <div class="help-shortcut">
        <span>Navigate to Favorites</span>
        <kbd>4</kbd>
      </div>
      <div class="help-shortcut">
        <span>Navigate to Account</span>
        <kbd>5</kbd>
      </div>
      <div class="help-shortcut">
        <span>Navigate to Admin</span>
        <kbd>6</kbd>
      </div>
      <div class="help-shortcut">
        <span>Clear search</span>
        <kbd>Esc</kbd>
      </div>
      <div class="help-shortcut">
        <span>Show this help</span>
        <kbd>?</kbd>
      </div>
      <div class="help-shortcut">
        <span>Toggle favorite (on pick card)</span>
        <kbd>Enter</kbd> or <kbd>Space</kbd>
      </div>
    </div>
    
    <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border); text-align: center;">
      <div class="text-sub" style="font-size: 12px;">
        Press <kbd>Esc</kbd> or click outside to close
      </div>
    </div>
  </div>
</div>

<script>
// PASSWORD GATE (temporary)
(function(){
	var PASS = 'getmoney'; // change this to your temporary password
	var gate = document.getElementById('gate');
	if (!gate) return;
	var ok = false;
	try { ok = localStorage.getItem('cp_gate_ok') === '1'; } catch(e){}
	if (ok){
		document.documentElement.classList.remove('gated');
		gate.remove();
		return;
	}
	function unlock(){
		try { localStorage.setItem('cp_gate_ok','1'); } catch(e){}
		document.documentElement.classList.remove('gated');
		gate.remove();
		try{ render(); route(); }catch(e){}
	}
	var btn = document.getElementById('gateBtn');
	var inp = document.getElementById('gateInput');
	if (btn && inp){
		btn.addEventListener('click', function(){
			var v = (inp.value||'').trim();
			if (v === PASS) unlock();
			else alert('Incorrect password.');
		});
		inp.addEventListener('keydown', function(e){ if (e.key==='Enter') btn.click(); });
	}
})();

// THEME
(function(){
  var saved = localStorage.getItem('theme') || 'dark';
  if(saved==='light') document.documentElement.setAttribute('data-theme','light');
  document.getElementById('themeBtn').addEventListener('click', function () {
    var cur = document.documentElement.getAttribute('data-theme');
    var next = (cur==='light') ? '' : 'light';
    if (next) document.documentElement.setAttribute('data-theme', next);
    else document.documentElement.removeAttribute('data-theme');
    localStorage.setItem('theme', next||'dark');
    render();
  });
})();

// ROUTER + ADMIN NAV
var navLinks = Array.prototype.slice.call(document.querySelectorAll('[data-nav]'));
function show(el, on){ if(!el) return; if(on) el.classList.remove('hidden'); else el.classList.add('hidden'); }

function updateHeaderUI(){
  var upg = document.getElementById('upgradeBtn');
  if (upg) (state.auth === 'free') ? upg.classList.remove('hidden') : upg.classList.add('hidden');
  updateMobileBanner();
  updateAdminUI();
}
function updateAdminUI(){
  var navAdmin = document.getElementById('navAdmin');
  show(navAdmin, state.auth === 'admin');
}
function route(){
  var hash = location.hash || '#picks';
  navLinks.forEach(function(a){ a.classList.toggle('active', a.getAttribute('href')===hash); });
  document.getElementById('view-picks').classList.toggle('hidden', hash !== '#picks');
  document.getElementById('view-scorecard').classList.toggle('hidden', hash !== '#scorecard');
  document.getElementById('view-outcomes').classList.toggle('hidden', hash !== '#outcomes');
  document.getElementById('view-favorites').classList.toggle('hidden', hash !== '#favorites');
  document.getElementById('view-account').classList.toggle('hidden', hash !== '#account');
  document.getElementById('view-admin').classList.toggle('hidden', hash !== '#admin');
  document.getElementById('view-subscribe').classList.toggle('hidden', hash !== '#subscribe');
  document.getElementById('view-terms').classList.toggle('hidden', hash !== '#terms');
  document.getElementById('view-privacy').classList.toggle('hidden', hash !== '#privacy');
  document.getElementById('view-responsible').classList.toggle('hidden', hash !== '#responsible');
  document.getElementById('view-contact').classList.toggle('hidden', hash !== '#contact');

  if (hash === '#admin' && state.auth !== 'admin'){
    alert('Admin access required. Please sign in as admin.');
    location.hash = '#account';
    return;
  }

  if (hash === '#favorites') renderFavorites();
  if (hash === '#account') renderAccount();
  if (hash === '#admin') renderProfile();
  if (hash === '#scorecard') renderScorecard();
  if (hash === '#outcomes') renderOutcomes();
  if (hash === '#subscribe') renderSubscribe();
  if (hash === '#contact') renderContact();
  maybeShowVerifyBanner();
}
window.addEventListener('hashchange', route);

// Clear search input on page load to prevent browser autofill
setTimeout(() => {
  const searchInp = document.getElementById('searchInp');
  if (searchInp && searchInp.value) {
    searchInp.value = '';
  }
}, 100);

// Auto-create collections on app load
setTimeout(async () => {
  if (window.firebaseReady) {
    await ensureCollectionsExist();
  }
}, 2000);

  // JSON file upload listener
  setTimeout(() => {
    const fileInput = document.getElementById('jsonFileInput');
    if (fileInput) {
      fileInput.addEventListener('change', handleJSONFileUpload);
    }
  }, 1000);

  // Backup file upload listener
  setTimeout(() => {
    const backupFileInput = document.getElementById('backupFileInput');
    const restoreBtn = document.getElementById('restoreFromBackup');
    if (backupFileInput && restoreBtn) {
      backupFileInput.addEventListener('change', function(event) {
        if (event.target.files.length > 0) {
          restoreBtn.disabled = false;
          restoreBtn.textContent = 'üì§ Restore Backup';
        } else {
          restoreBtn.disabled = true;
          restoreBtn.textContent = 'üì§ Restore Backup';
        }
      });
    }
  }, 1000);

// TRANSLATION DATA (Top 4 Languages)
var translations = {
  en: {
    picks: 'Picks', scorecard: 'Scorecard', outcomes: 'Outcomes', 
    favorites: 'Favorites', account: 'Account', admin: 'Admin',
    signUp: 'Sign up for free', signOut: 'Sign out', upgrade: 'Upgrade',
    resetSettings: 'Reset to Default',
    readFavorites: 'Read Favorites Aloud', stopReading: 'Stop Reading',
    settings: 'Settings', language: 'Language', theme: 'Theme', 
    voiceSpeed: 'Voice Speed', currency: 'Currency', voiceEnabled: 'Enable Voice Reading',
    darkTheme: 'Dark', lightTheme: 'Light', autoTheme: 'Auto',
    saveSettings: 'Save Settings', resetToDefault: 'Reset to Default',
    contact: 'Contact', contactUs: 'Contact Us', name: 'Name', email: 'Email',
    subject: 'Subject', message: 'Message', sendMessage: 'Send Message'
  },
  es: {
    picks: 'Selecciones', scorecard: 'Puntuaci√≥n', outcomes: 'Resultados',
    favorites: 'Favoritos', account: 'Cuenta', admin: 'Administrador',
    signUp: 'Registrarse gratis', signOut: 'Cerrar sesi√≥n', upgrade: 'Actualizar',
    resetSettings: 'Restablecer por Defecto',
    readFavorites: 'Leer Favoritos en Voz Alta', stopReading: 'Detener Lectura',
    settings: 'Configuraci√≥n', language: 'Idioma', theme: 'Tema',
    voiceSpeed: 'Velocidad de Voz', currency: 'Moneda', voiceEnabled: 'Habilitar Lectura de Voz',
    darkTheme: 'Oscuro', lightTheme: 'Claro', autoTheme: 'Autom√°tico',
    saveSettings: 'Guardar Configuraci√≥n', resetToDefault: 'Restablecer por Defecto',
    contact: 'Contacto', contactUs: 'Cont√°ctanos', name: 'Nombre', email: 'Correo',
    subject: 'Asunto', message: 'Mensaje', sendMessage: 'Enviar Mensaje'
  },
  fr: {
    picks: 'S√©lections', scorecard: 'Tableau de Bord', outcomes: 'R√©sultats',
    favorites: 'Favoris', account: 'Compte', admin: 'Administrateur',
    signUp: 'Inscription gratuite', signOut: 'D√©connexion', upgrade: 'Am√©liorer',
    resetSettings: 'R√©initialiser par D√©faut',
    readFavorites: 'Lire les Favoris √† Voix Haute', stopReading: 'Arr√™ter la Lecture',
    settings: 'Param√®tres', language: 'Langue', theme: 'Th√®me',
    voiceSpeed: 'Vitesse de la Voix', currency: 'Devise', voiceEnabled: 'Activer la Lecture Vocale',
    darkTheme: 'Sombre', lightTheme: 'Clair', autoTheme: 'Automatique',
    saveSettings: 'Sauvegarder les Param√®tres', resetToDefault: 'R√©initialiser par D√©faut',
    contact: 'Contact', contactUs: 'Nous Contacter', name: 'Nom', email: 'Email',
    subject: 'Sujet', message: 'Message', sendMessage: 'Envoyer le Message'
  },
  de: {
    picks: 'Auswahl', scorecard: 'Bewertung', outcomes: 'Ergebnisse',
    favorites: 'Favoriten', account: 'Konto', admin: 'Administrator',
    signUp: 'Kostenlos anmelden', signOut: 'Abmelden', upgrade: 'Upgrade',
    resetSettings: 'Auf Standard Zur√ºcksetzen',
    readFavorites: 'Favoriten Vorlesen', stopReading: 'Vorlesen Stoppen',
    settings: 'Einstellungen', language: 'Sprache', theme: 'Design',
    voiceSpeed: 'Sprachgeschwindigkeit', currency: 'W√§hrung', voiceEnabled: 'Sprachausgabe Aktivieren',
    darkTheme: 'Dunkel', lightTheme: 'Hell', autoTheme: 'Automatisch',
    saveSettings: 'Einstellungen Speichern', resetToDefault: 'Auf Standard Zur√ºcksetzen',
    contact: 'Kontakt', contactUs: 'Kontaktieren Sie uns', name: 'Name', email: 'E-Mail',
    subject: 'Betreff', message: 'Nachricht', sendMessage: 'Nachricht Senden'
  }
};

// TRANSLATION FUNCTION
function t(key) {
  var lang = state.settings.language || 'en';
  return translations[lang] && translations[lang][key] ? translations[lang][key] : translations.en[key] || key;
}

// STATE
var state = {
  auth: safeGetStorage('auth', 'anon'),
  favorites: (function() {
    try {
      return JSON.parse(safeGetStorage('favorites', '[]'));
    } catch (e) {
      console.warn('Invalid favorites data in localStorage, resetting to empty array');
      return [];
    }
  })(),
  tf: safeGetStorage('tf', '7'),
  otf: safeGetStorage('otf', '30'),
  selectedOut: [],
  // Admin state is now handled through auth state
  accTab: safeGetStorage('accTab', 'signup'),
  settings: (function() {
    try {
      return JSON.parse(safeGetStorage('userSettings', '{"language":"en","theme":"dark","voiceSpeed":"1.0","currency":"USD","voiceEnabled":"false"}'));
    } catch (e) {
      console.warn('Invalid settings data in localStorage, using defaults');
      return {"language":"en","theme":"dark","voiceSpeed":"1.0","currency":"USD","voiceEnabled":"false"};
    }
  })(),
  isReading: false
};
// Normalize any legacy favorites (ids -> {id})
(function normalizeFavorites(){
  var changed = false;
  state.favorites = (state.favorites || []).map(function(f){
    if (typeof f === 'string') { changed = true; return { id: f }; }
    if (f && typeof f === 'object' && f.id) return f;
    return null;
  }).filter(Boolean);
  if (changed) localStorage.setItem('favorites', JSON.stringify(state.favorites));
})();

var authBtn = document.getElementById('authBtn');
function setAuth(mode){
  state.auth = mode;
  localStorage.setItem('auth', mode);
  authBtn.textContent = mode==='anon' ? 'Sign up for free' : 'Sign out';
  render(); renderAccount(); renderProfile(); reflectAuthButtons(); updateHeaderUI();
}
authBtn.addEventListener('click', function(){
  if (state.auth==='anon'){ location.hash = '#account'; route(); }
  else { setAuth('anon'); location.hash = '#picks'; route(); }
});
var _upgEl = document.getElementById('upgradeBtn'); if (_upgEl) { _upgEl.addEventListener('click', function(){ handleUpgrade(); }); }

// Admin is now handled through authentication state, not a separate flag
function setAdmin(on){
  // This function is kept for compatibility but admin state is now tied to auth
  if (on) {
    setAuth('admin');
  } else {
    setAuth('anon');
  }
}

// DATA
function daysAgo(n){ var d = new Date(Date.now() - n*86400000); return d.toISOString(); }
var picksLive = [
  // Static picks will be replaced by Firebase data
];
var picksResults = [
  // Results will be loaded from Firebase or added manually
];
var picksAll = picksLive.concat(picksResults);

// HELPERS
function formatDate(iso){ 
  // If already formatted with EST/PST etc, return as-is
  if (typeof iso === 'string' && (iso.includes(' EST') || iso.includes(' PST') || iso.includes(' EDT') || iso.includes(' PDT'))) {
    return iso;
  }
  var d = new Date(iso); 
  return d.toLocaleString([], { dateStyle:'medium', timeStyle:'short' }); 
}
function byCommence(a,b){ return new Date(a.commenceTime) - new Date(b.commenceTime); }
function byConfidence(a,b){ return (b.modelConfidence - a.modelConfidence) || (b.oddsAmerican - a.oddsAmerican); }
function oddsString(a){ return a >= 0 ? ('+'+a) : String(a); }
function esc(s){ if (s==null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;'); }
function isVerified(){ return localStorage.getItem('emailVerified') === 'true'; }
function nowIso(){ return new Date().toISOString(); }
function addMonthsISO(iso, n){ var d = new Date(iso); d.setMonth(d.getMonth()+n); return d.toISOString(); }
function fmt(iso){ return iso ? new Date(iso).toLocaleString([], {dateStyle:'medium', timeStyle:'short'}) : '‚Äî'; }

// Better message system to replace alert()
function showMessage(message, type = 'info') {
  // Remove existing messages
  var existing = document.querySelector('.app-message');
  if (existing) existing.remove();
  
  var msgEl = document.createElement('div');
  msgEl.className = 'app-message';
  msgEl.style.cssText = 
    'position: fixed; top: 20px; right: 20px; z-index: 10000;' +
    'padding: 12px 16px; border-radius: 8px; color: white;' +
    'background: ' + (type === 'error' ? '#FF6B6B' : type === 'success' ? '#22C55E' : '#4DA3FF') + ';' +
    'box-shadow: 0 4px 12px rgba(0,0,0,0.3);' +
    'transform: translateX(100%); transition: transform 0.3s ease;' +
    'max-width: 300px; word-wrap: break-word;';
  msgEl.textContent = message;
  document.body.appendChild(msgEl);
  
  // Animate in
  setTimeout(function() { msgEl.style.transform = 'translateX(0)'; }, 10);
  
  // Auto remove after 4 seconds
  setTimeout(function() {
    msgEl.style.transform = 'translateX(100%)';
    setTimeout(function() { msgEl.remove(); }, 300);
  }, 4000);
}

// Loading state helpers
function setButtonLoading(buttonId, loading) {
  var btn = document.getElementById(buttonId);
  if (!btn) return;
  
  if (loading) {
    btn.classList.add('loading');
    btn.disabled = true;
    // Wrap existing text in span for fade effect
    if (!btn.querySelector('.btn-text')) {
      btn.innerHTML = '<span class="btn-text">' + btn.textContent + '</span>';
    }
  } else {
    btn.classList.remove('loading');
    btn.disabled = false;
  }
}

// Safe localStorage helpers
function safeGetStorage(key, fallback) {
  try {
    return localStorage.getItem(key) || fallback || null;
  } catch (e) {
    console.warn('localStorage access failed for key:', key, e);
    return fallback || null;
  }
}

function safeSetStorage(key, value) {
  try {
    localStorage.setItem(key, value);
    return true;
  } catch (e) {
    console.warn('localStorage write failed for key:', key, e);
    return false;
  }
}

function getUserEmail() {
  var email = safeGetStorage('userEmail');
  if (!email && state.auth !== 'anon') {
    console.warn('User appears logged in but no email found in storage');
  }
  return email;
}

// SETTINGS HELPER FUNCTIONS
function updateAllTranslations() {
  var navLinks = document.querySelectorAll('[data-nav]');
  navLinks.forEach(function(link) {
    var href = link.getAttribute('href');
    if (href === '#picks') link.textContent = t('picks');
    else if (href === '#scorecard') link.textContent = t('scorecard');
    else if (href === '#outcomes') link.textContent = t('outcomes');
    else if (href === '#favorites') link.textContent = t('favorites');
    else if (href === '#account') link.textContent = t('account');
    else if (href === '#admin') link.textContent = t('admin');
  });
  
  var authBtn = document.getElementById('authBtn');
  if (authBtn) {
    authBtn.textContent = state.auth === 'anon' ? t('signUp') : t('signOut');
  }
  
  // Update read button text
  updateReadButton();
  
  renderAccount();
  renderContact();
}

function readFavoritesAloud() {
  // If currently reading, stop it
  if (state.isReading) {
    speechSynthesis.cancel();
    state.isReading = false;
    updateReadButton();
    return;
  }
  
  if (state.settings.voiceEnabled !== 'true') {
    alert('Voice reading is disabled. Enable it in Settings first.');
    return;
  }
  
  if (state.favorites.length === 0) {
    alert('No favorites to read!');
    return;
  }
  
  if (!window.speechSynthesis) {
    alert('Speech synthesis not supported in this browser.');
    return;
  }
  
  var textToRead = t('favorites') + ': ';
  
  // Get favorites in the same order as displayed (sorted by commence time)
  var ids = state.favorites.map(function(f){ return f.id; });
  var favs = picksAll.filter(function(p){ return ids.indexOf(p.id) >= 0 && canSee(p); });
  var sortedFavs = favs.sort(byCommence);
  
  sortedFavs.forEach(function(pick, index) {
    textToRead += (index + 1) + '. ' + pick.pickDesc + '. ';
  });
  
  var utterance = new SpeechSynthesisUtterance(textToRead);
  utterance.rate = parseFloat(state.settings.voiceSpeed) || 1.0;
  utterance.lang = state.settings.language === 'es' ? 'es-ES' : 
                   state.settings.language === 'fr' ? 'fr-FR' :
                   state.settings.language === 'de' ? 'de-DE' : 'en-US';
  
  // Set reading state
  state.isReading = true;
  updateReadButton();
  
  // Handle when reading finishes
  utterance.onend = function() {
    state.isReading = false;
    updateReadButton();
  };
  
  utterance.onerror = function() {
    state.isReading = false;
    updateReadButton();
  };
  
  speechSynthesis.speak(utterance);
}

function updateReadButton() {
  var btn = document.getElementById('readFavoritesBtn');
  if (btn) {
    if (state.isReading) {
      btn.innerHTML = '‚èπÔ∏è ' + t('stopReading');
      btn.classList.add('danger');
    } else {
      btn.innerHTML = 'üîä ' + t('readFavorites');
      btn.classList.remove('danger');
    }
  }
}

function toggleAutoRenew() {
  var currentRenew = localStorage.getItem('autoRenew') === 'true';
  var newRenew = !currentRenew;
  localStorage.setItem('autoRenew', newRenew.toString());
  alert('Auto-renew ' + (newRenew ? 'enabled' : 'disabled') + ' (mock)');
  renderAccount();
}

function loadSettingsValues() {
  setTimeout(function() {
    var languageSelect = document.getElementById('languageSelect');
    var themeSelect = document.getElementById('themeSelect');
    var voiceSpeedSelect = document.getElementById('voiceSpeedSelect');
    var currencySelect = document.getElementById('currencySelect');
    var voiceEnabledSelect = document.getElementById('voiceEnabledSelect');
    
    if (languageSelect) languageSelect.value = state.settings.language || 'en';
    if (themeSelect) themeSelect.value = state.settings.theme || 'dark';
    if (voiceSpeedSelect) voiceSpeedSelect.value = state.settings.voiceSpeed || '1.0';
    if (currencySelect) currencySelect.value = state.settings.currency || 'USD';
    if (voiceEnabledSelect) voiceEnabledSelect.value = state.settings.voiceEnabled || 'false';
  }, 100);
}

// LOGIC
function maybeShowVerifyBanner(){
  var banner = document.getElementById('verifyBanner');
  if (!banner) return;
  if (state.auth === 'free' && !isVerified()){
    banner.classList.remove('hidden'); banner.style.display = 'flex';
  } else {
    banner.classList.add('hidden'); banner.style.display = 'none';
  }
}
function letterFromWins(wins, n){
  var p = n>0 ? wins/n : 0;
  if (p < 0.45) return ['F','f'];
  if (p < 0.50) return ['D','d'];
  if (p < 0.55) return ['C','c'];
  if (p < 0.65) return ['B','b'];
  var pluses = Math.max(0, Math.floor((p - 0.65)/0.08));
  var capped = Math.min(pluses, 3);
  return ['A' + new Array(capped+1).join('+'), 'a'];
}
function canSee(p){
  if (state.auth==='admin' || state.auth==='paid') return true;
  if (state.auth==='free') return p.tier==='public' || p.tier==='free';
  return p.tier==='public';
}
function updateMobileBanner(){
  var banner = document.getElementById('mobileBanner');
  var title = document.getElementById('mobileBannerTitle');
  var subtext = document.getElementById('mobileBannerSubtext');
  var button = document.getElementById('mobileUpgradeBtn');
  
  if (!banner || !title || !subtext || !button) return;
  
  if (state.auth === 'anon') {
    // Anonymous user - show sign up (they don't have top upgrade button)
    title.innerHTML = '<strong>Sign up for free picks</strong>';
    subtext.textContent = 'Get started with confident picks';
    button.textContent = 'Sign Up Free';
    button.onclick = function() { location.hash = '#account'; };
    banner.classList.add('visible');
  } else {
    // Free and paid users - hide banner (upgrade button available at top)
    banner.classList.remove('visible');
  }
}

// FAVORITES (paid only)
function toggleFavorite(id){
  if (state.auth !== 'paid') {
    alert('Favorites are for subscribers (prototype).');
    location.hash = '#subscribe';
    route();
    return;
  }
  var idx = state.favorites.findIndex(function(f){ return f && f.id === id; });
  if (idx === -1) {
    var snap = picksAll.find(function(p){ return p.id === id; }) || {};
    state.favorites.push({ id: id, snap: snap });
  } else {
    state.favorites.splice(idx, 1);
  }
  localStorage.setItem('favorites', JSON.stringify(state.favorites));
  render(); renderFavorites(); renderOutcomes();
}

// RENDERERS
function cardHTML(p){
  var confColor, confClass, confLevel;
  if (p.modelConfidence >= 80) {
    confColor = 'var(--green)';
    confClass = 'confidence-high';
    confLevel = 'Very High';
  } else if (p.modelConfidence >= 65) {
    confColor = 'var(--blue)';
    confClass = 'confidence-medium';
    confLevel = 'High';
  } else {
    confColor = '#ffa500';
    confClass = 'confidence-low';
    confLevel = 'Medium';
  }
  
  var on = state.favorites.find(function(f){ return f.id===p.id; }) ? 'on' : '';
  var star = (state.auth==='paid' || state.auth==='admin')
    ? ('<div class="star '+on+'" title="Favorite" role="button" aria-pressed="'+(on?'true':'false')+'" tabindex="0" data-fav="'+p.id+'"></div>')
    : '<div class="text-sub">(Favorites for subscribers)</div>';
  return '<div class="card">'
    + '<div class="text-sub">'+p.league+' ‚Ä¢ <span class="market-type">'+p.marketType+'</span></div>'
    + '<div class="row"><div><strong>'+p.pickDesc+'</strong></div></div>'
    + '<div class="text-sub">Confidence: <span class="tooltip confidence-badge ' + confClass + '" data-tooltip="Model confidence: ' + p.modelConfidence + '% (' + confLevel + ')" style="color:'+confColor+'">' + p.modelConfidence + '%</span> ‚Ä¢ Odds: '+oddsString(p.oddsAmerican)+'</div>'
    + '<div class="reasoning">Reasoning: '+esc(p.reasoning || '‚Äî')+'</div>'
    + '<div class="row" style="margin-top:6px;gap:8px"><div class="text-sub">Commences: '+formatDate(p.commenceTime)+'</div>'+star+'</div>'
    + '</div>';
}
function resultRowHTML(x){
  var badge = x.result==='W'?'win':(x.result==='L'?'loss':'push');
  var right = (x.commenceTime ? formatDate(x.commenceTime) : '');
  var checked = state.selectedOut.indexOf(x.id) >= 0 ? 'checked' : '';
  return '<div class="out-row" data-row="'+x.id+'">'
    + '<div>'
    +   '<div><strong>'+esc(x.pickDesc||'‚Äî')+'</strong> <span class="badge '+badge+'">'+x.result+'</span></div>'
    +   '<div class="text-sub">'+esc(x.league||'‚Äî')+' ‚Ä¢ '+esc(x.marketType||'‚Äî')+' ‚Ä¢ Odds '+oddsString(x.oddsAmerican||0)+' ‚Ä¢ '+(x.settledAt?formatDate(x.settledAt):'')+'</div>'
    +   (x.reasoning ? '<div class="reasoning">Reasoning: '+esc(x.reasoning)+'</div>' : '')
    + '</div>'
    + '<div class="row" style="gap:8px">'
    +   '<input type="checkbox" data-sel="'+x.id+'" '+checked+' />'
    +   '<div class="text-sub">'+right+'</div>'
    + '</div>'
    + '</div>';
}
function scoreRowHTML(x){
  var badge = x.result==='W'?'win':(x.result==='L'?'loss':'push');
  var right = (x.commenceTime ? formatDate(x.commenceTime) : '');
  
  // Get proper pick description
  var pickDesc = getPickDescription(x);
  
  // Get proper odds display
  var oddsDisplay = getDisplayOdds(x);
  
  return '<div class="out-row" data-row="'+x.id+'">'
    + '<div>'
    +   '<div><strong>'+esc(pickDesc)+'</strong> <span class="badge '+badge+'">'+x.result+'</span></div>'
    +   '<div class="text-sub">'+esc(x.league||x.sport||'‚Äî')+' ‚Ä¢ '+esc(x.marketType||x.market||'‚Äî')+' ‚Ä¢ Odds '+oddsString(oddsDisplay)+' ‚Ä¢ '+(x.settledAt?formatDate(x.settledAt):'')+'</div>'
    +   (x.reasoning ? '<div class="reasoning">Reasoning: '+esc(x.reasoning)+'</div>' : '')
    + '</div>'
    + '<div class="text-sub">'+right+'</div>'
    + '</div>';
}
function teaserCardHTML(i){
  var isAnon = state.auth === 'anon';
  var ctaText = isAnon ? 'Sign up to unlock' : 'Upgrade to unlock';
  var btnText = isAnon ? 'Sign up for free' : 'Upgrade';
  var btnAction = isAnon ? 'data-goto-signup' : 'data-goto-subscribe';
  
  // Dynamic teaser content for variety
  var leagues = ['MLB', 'NFL', 'NBA', 'NHL'];
  var markets = ['moneyline', 'spread', 'totals', 'props'];
  var risks = ['SAFE', 'DEGEN'];
  var teams = ['‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà vs ‚ñà‚ñà‚ñà‚ñà‚ñà', '‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà vs ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà', '‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà vs ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà', '‚ñà‚ñà‚ñà‚ñà‚ñà vs ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà'];
  
  var league = leagues[i % leagues.length];
  var market = markets[Math.floor(Math.random() * markets.length)];
  var risk = risks[Math.floor(Math.random() * risks.length)];
  var team = teams[i % teams.length];
  var confidence = 70 + Math.floor(Math.random() * 20); // 70-89
  var odds = Math.floor(Math.random() * 300) - 150; // -150 to +150
  
  return '<div class="locked-card card">'
    + '<div class="locked-label">Locked pick</div>'
    + '<div class="locked-inner">'
    +   '<div class="text-sub">' + league + ' ‚Ä¢ ' + market + '</div>'
    +   '<div class="row" style="gap:8px"><div><strong>' + team + '</strong></div><div class="chip ' + (risk==='SAFE'?'safe':'degen') + '">' + risk + '</div></div>'
    +   '<div class="text-sub">Confidence: ' + confidence + '‚ñà ‚Ä¢ Odds: ' + (odds >= 0 ? '+' : '') + odds + '‚ñà</div>'
    +   '<div class="reasoning">Reasoning: ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</div>'
    +   '<div class="row" style="margin-top:6px;gap:8px"><div class="text-sub">Commences: ‚ñà‚ñà‚ñà ‚ñà‚ñà, ‚ñà‚ñà‚ñà‚ñà</div></div>'
    + '</div>'
    + '<div class="locked-veil"></div>'
    + '<div class="locked-cta"><div class="text-sub">' + ctaText + '</div><button type="button" class="btn primary" ' + btnAction + '>' + btnText + '</button></div>'
    + '</div>';
}

// VIEW RENDERERS
function render(){
  var note = document.getElementById('gatingNote');
  if (state.auth==='anon') {
    note.textContent = 'Sign up for free to see 3 more picks.';
    note.classList.remove('hidden');
  } else if (state.auth==='free') {
    note.innerHTML = 'Upgrade to see all picks & unlock Favorites/Outcomes <strong>($15/mo)</strong>. <button type="button" class="btn primary enhanced" data-goto-subscribe>Upgrade</button>';
    note.classList.remove('hidden');
  } else {
    note.classList.add('hidden');
  }
  var league = (document.getElementById('leagueSel')).value;
  var market = (document.getElementById('marketSel')).value;
  
  var sort = (document.getElementById('sortSel')).value;
  var min = Number((document.getElementById('minConf')).value || 0);
  var search = (document.getElementById('searchInp')).value.trim().toLowerCase();

  var arr = picksAll.filter(function(p){ return canSee(p); });
  
  if (league) arr = arr.filter(function(p){ return p.league===league; });
  if (market) arr = arr.filter(function(p){ return p.marketType===market; });
  
  if (min>0) arr = arr.filter(function(p){ return p.modelConfidence >= min; });
  if (search) arr = arr.filter(function(p){ return p.pickDesc.toLowerCase().includes(search); });
  arr.sort(sort==='confidence' ? byConfidence : byCommence);

  // Limit picks per league based on account type (only when no specific league filter is applied)
  if (!league) {
    var maxPerLeague;
    if (state.auth === 'paid' || state.auth === 'admin') {
      maxPerLeague = 999; // Show all picks for paid/admin users
    } else {
      maxPerLeague = 3; // Show 3 picks per league for free/anon users
    }
    
    var leagueCounts = {};
    arr = arr.filter(function(p) {
      var pickLeague = p.league || 'Unknown';
      leagueCounts[pickLeague] = (leagueCounts[pickLeague] || 0) + 1;
      return leagueCounts[pickLeague] <= maxPerLeague;
    });
  }

  var list = document.getElementById('list');
  if (arr.length > 0) list.innerHTML = arr.map(cardHTML).join('');
  else {
    var hasFilters = league || market || min > 0;
    var message = search ? 
      'No picks found for "' + search + '". Try different keywords or <button onclick="clearSearch()" class="btn ghost" style="padding:2px 6px;font-size:inherit;">clear search</button>.' :
      hasFilters ? 
        'No picks match your current filters. Try <button onclick="clearAllFilters()" class="btn ghost" style="padding:2px 6px;font-size:inherit;">clearing filters</button> or adjusting your criteria.' :
        'No picks available right now. Check back soon for expert analysis! üèÜ';
    
    list.innerHTML = '<div class="card text-sub" style="text-align:center;padding:32px;">' +
                    '<div style="font-size:48px;margin-bottom:16px;">üèà</div>' +
                    '<div>' + message + '</div>' +
                    '</div>';
  }

  var _authBtn = document.getElementById('authBtn');
  if (_authBtn) _authBtn.textContent = state.auth==='anon' ? 'Sign up for free' : 'Sign out';

  if (state.auth==='anon'){
    var teasers = 5;
    list.innerHTML += Array.from({length:teasers}, function(_,_i){ return teaserCardHTML(_i); }).join('');
  } else if (state.auth==='free'){
    var teasers = 3;
    list.innerHTML += Array.from({length:teasers}, function(_,_i){ return teaserCardHTML(_i); }).join('');
  }
  maybeShowVerifyBanner();
}

function inTimeframeRes(p, tf){ if (tf==='all') return true; var cutoff = Date.now() - Number(tf)*86400000; return p.settledAt && new Date(p.settledAt).getTime() >= cutoff; }

// Load scoring data from Firebase for scorecard
async function loadScoringData() {
  if (!window.firebaseReady || !window.db) {
    console.log('Firebase not ready for scoring data');
    return [];
  }

  try {
    console.log('üîÑ Loading scoring data for scorecard...');
    const { collection, getDocs, query, where } = await import('https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js');
    
    // Get all scored picks (hit or miss) from scoring collection
    const scoringQuery = query(collection(window.db, 'scoring'), where('status', 'in', ['hit', 'miss']));
    const snapshot = await getDocs(scoringQuery);
    
    const scoringData = [];
    snapshot.forEach(doc => {
      const data = doc.data();
      scoringData.push({
        id: doc.id,
        ...data,
        result: data.status === 'hit' ? 'W' : 'L', // Convert hit/miss to W/L for compatibility
        settledAt: data.scoredAt || data.movedToScoringAt || data.startTime
      });
    });
    
    console.log(`‚úÖ Loaded ${scoringData.length} scored picks`);
    return scoringData;
    
  } catch (error) {
    console.error('‚ùå Error loading scoring data:', error);
    return [];
  }
}

function computeStats(tf){
  // Use Firebase scoring data instead of picksResults
  var graded = window.scoringData ? window.scoringData.filter(function(p){ return inTimeframeRes(p, tf); }) : [];
  var w=0,l=0,pu=0;
  graded.forEach(function(p){ if (p.result==='W') w++; else if (p.result==='L') l++; else pu++; });
  var n = w+l; var winPct = n ? (w*100/n) : 0;
  var res = letterFromWins(w,n);
  return { w:w,l:l,pu:pu, winPct:winPct, letter:res[0], cls:res[1], graded:graded };
}
async function renderScorecard(){
  var tf = state.tf;
  Array.prototype.forEach.call(document.querySelectorAll('.score-tab'), function(t){
    var isActive = t.getAttribute('data-tf') === tf;
    t.classList.toggle('active', isActive);
    t.setAttribute('aria-selected', isActive);
  });
  
  // Load scoring data from Firebase
  window.scoringData = await loadScoringData();
  
  var stats = computeStats(tf);
  document.getElementById('mRecord').textContent = stats.w+'-'+stats.l+'-'+stats.pu;
  document.getElementById('mWinpct').textContent = (stats.winPct||0).toFixed(1)+'%';
  var grade = document.getElementById('gradeBadge');
  grade.textContent = 'Grade: ' + stats.letter;
  grade.className = 'grade ' + stats.cls;

  var wrap = document.getElementById('resultsWrap');
  var note = document.getElementById('resultsNote');
  if (tf==='7' || tf==='30'){
    wrap.innerHTML = stats.graded.sort(function(a,b){ return new Date(b.settledAt) - new Date(a.settledAt); }).map(scoreRowHTML).join('') || '<div class="text-sub">No graded picks yet.</div>';
    note.textContent = '';
  } else {
    wrap.innerHTML = '';
    note.textContent = 'Detailed picks are hidden for longer ranges (180d/All-Time).';
  }
}

function renderFavorites(){
  var gate = document.getElementById('favGate');
  var wrap = document.getElementById('favList');
  if (state.auth !== 'paid' && state.auth !== 'admin') { 
    gate.innerHTML = (state.auth==='free' ? '<div class="card">Subscribers only. Upgrade to save favorites <strong>($15/mo)</strong>. <div style="margin-top:8px"><button type="button" class="btn primary enhanced" data-goto-subscribe>Upgrade</button></div></div>' : '<div class="card">Subscribers only. <a href="#account" data-nav>Sign up</a> to get started.</div>'); 
    wrap.innerHTML=''; 
    return; 
  }
  gate.innerHTML = '';
  var ids = state.favorites.map(function(f){ return f.id; });
  var favs = picksAll.filter(function(p){ return ids.indexOf(p.id) >= 0 && canSee(p); });
  wrap.innerHTML = favs.length ? favs.sort(byCommence).map(cardHTML).join('') : '<div class="text-sub">No favorites yet.</div>';
}

function inOutTf(iso, tf){ if (tf==='all' || !iso) return true; var cutoff = Date.now()-Number(tf)*86400000; return new Date(iso).getTime() >= cutoff; }
function updateSelectionUI(){ var btn = document.getElementById('clearSelectedBtn'); if(btn) btn.disabled = (state.selectedOut.length===0); }
function renderOutcomes(){
  var container = document.getElementById('outcomesContainer');
  if (!container) return;
  
  var tf = state.otf;
  
  // For non-subscribers, show only the upgrade message
  if (state.auth !== 'paid' && state.auth !== 'admin') {
    container.innerHTML = '<div><strong>My Outcomes</strong> <span class="text-sub">‚Äî results for your favorited picks</span></div>' +
      '<div style="margin-top:12px">' + 
      (state.auth==='free' ? 
        '<div class="card">Subscribers only. Upgrade to view your outcomes <strong>($15/mo)</strong>. <div style="margin-top:8px"><button type="button" class="btn primary enhanced" data-goto-subscribe>Upgrade</button></div></div>' : 
        '<div class="card">Subscribers only. <a href="#account" data-nav>Sign up</a> to get started.</div>') +
      '</div>';
    return;
  }
  
  // For subscribers, build the full interface
  var tabsHTML = '<div class="row" style="gap:8px; justify-content:space-between; align-items:center">' +
    '<div><strong>My Outcomes</strong> <span class="text-sub">‚Äî results for your favorited picks</span></div>' +
    '<div class="smalltabs" role="tablist" aria-label="Outcomes Timeframe">' +
    '<button type="button" class="tab out-tab' + (tf==='7'?' active':'') + '" role="tab" aria-selected="' + (tf==='7') + '" data-otf="7">7d</button>' +
    '<button type="button" class="tab out-tab' + (tf==='30'?' active':'') + '" role="tab" aria-selected="' + (tf==='30') + '" data-otf="30">30d</button>' +
    '<button type="button" class="tab out-tab' + (tf==='180'?' active':'') + '" role="tab" aria-selected="' + (tf==='180') + '" data-otf="180">180d</button>' +
    '<button type="button" class="tab out-tab' + (tf==='all'?' active':'') + '" role="tab" aria-selected="' + (tf==='all') + '" data-otf="all">All</button>' +
    '</div></div>';
    
  var summaryHTML = '<div id="outSummary" class="text-sub" style="margin-top:8px"></div>';
  
  var actionsHTML = '<div class="row" id="outActions" style="gap:8px;margin-top:8px">' +
    '<button type="button" id="selectAllBtn" class="btn">Select all</button>' +
    '<button type="button" id="clearSelectedBtn" class="btn danger" disabled>Delete selected</button>' +
    '<button type="button" id="clearVisibleBtn" class="btn danger">Delete visible</button>' +
    '</div>';
    
  var listHTML = '<div id="outList" class="result-list"></div>';
  
  container.innerHTML = tabsHTML + summaryHTML + actionsHTML + listHTML;
  
  // Now populate the data
  state.selectedOut = [];
  var merged = state.favorites.map(function(f){
    var latest = picksResults.find(function(p){ return p.id===f.id; }) || {};
    var result = latest.result || f.result || null;
    var settledAt = latest.settledAt || f.settledAt || null;
    var snap = f.snap || picksAll.find(function(p){ return p.id===f.id; }) || {};
    var base = (snap && typeof snap==='object') ? snap : {};
    return Object.assign({}, base, { id:f.id, result:result, settledAt:settledAt });
  });
  var filtered = merged.filter(function(x){ return x.result && inOutTf(x.settledAt, tf); }).sort(function(a,b){ return new Date(b.settledAt)-new Date(a.settledAt); });
  var w=0,l=0,p=0; filtered.forEach(function(x){ if (x.result==='W') w++; else if (x.result==='L') l++; else p++; });
  var n = w+l, winPct = n ? (w*100/n).toFixed(1)+'%' : '‚Äî';
  
  var outSummary = document.getElementById('outSummary');
  var outList = document.getElementById('outList');
  if (outSummary) outSummary.textContent = 'Record: '+w+'-'+l+'-'+p+' ‚Ä¢ Win%: '+winPct;
  if (outList) outList.innerHTML = filtered.length ? filtered.map(resultRowHTML).join('') : '<div class="text-sub">No settled favorites yet for this range.</div>';
  updateSelectionUI();
}

// ACCOUNT views
function accountSignedOutHTML(){
  return '<div class="card account-wrap">'
    + '<h3 style="margin:0 0 6px 0">Account</h3>'
    + '<div class="text-sub">Create an account or sign in.</div>'
    + '<div class="authTabs" role="tablist" aria-label="Auth tabs">'
    + '  <button id="accTabSignup" class="tab '+(state.accTab==='signup'?'active':'')+'" role="tab" aria-selected="'+(state.accTab==='signup')+'">Sign up</button>'
    + '  <button id="accTabSignin" class="tab '+(state.accTab==='signin'?'active':'')+'" role="tab" aria-selected="'+(state.accTab==='signin')+'">Sign in</button>'
    + '</div>'
    + (state.accTab==='signup'
        ? ('<div style="margin-top:10px">'
          + '<button id="googleSignup" class="btn enhanced">Sign up with Google</button>'
          + '<div class="divider"><span class="text-sub">or</span></div>'
          + '<input id="emailInp" class="input" placeholder="Email" aria-label="Email for signup"/>'
          + '<input id="pwInp" class="input" placeholder="Password (8+ chars, letters & numbers)" type="password" aria-label="Password for signup"/>'
          + '<button id="emailSignupBtn" class="btn primary enhanced">Sign up with email</button>'
          + '<div class="helper">By creating an account you agree to our <a href="#terms" data-nav>Terms</a> and <a href="#privacy" data-nav>Privacy Policy</a>.</div>'
          + '</div>')
        : ('<div style="margin-top:10px">'
          + '<button id="googleSignin" class="btn enhanced">Sign in with Google</button>'
          + '<div class="divider"><span class="text-sub">or</span></div>'
          + '<input id="emailInpLogin" class="input" placeholder="Email" aria-label="Email for signin"/>'
          + '<input id="pwInpLogin" class="input" placeholder="Password" type="password" aria-label="Password for signin"/>'
          + '<button id="emailSigninBtn" class="btn enhanced">Sign in with email</button>'
          + '<button id="forgotBtn" class="btn ghost enhanced">Forgot password (mock)</button>'
          + '<div class="divider"><span class="text-sub">or</span></div>'
          + '<button id="adminSigninBtn" class="btn enhanced" style="background:#ff6b6b;border-color:#ff6b6b;">Sign in as Admin</button>'
          + '</div>')
      )
    + '</div>'
    + '<div id="turnstileSignin" class="card hidden" style="margin-top:8px">Bot check failed ‚Äî try again (mock)</div>'
    + '<div class="card" style="margin-top:12px">'
    + '  <div class="text-sub">Dev shortcut (local-only):</div>'
    + '  <button id="enableAdminBtn" class="btn">Enable Admin on this device (mock)</button>'
    + '  <button id="disableAdminBtn" class="btn hidden">Disable Admin on this device</button>'
    + '</div>';
}
function accountSignedInHTML(){
  var email = getUserEmail();
  var verified = isVerified();
  var createdAt = safeGetStorage('userCreatedAt');
  var lastLoginAt = safeGetStorage('lastLoginAt');
  var plan = safeGetStorage('subPlan', 'free');
  var renew = safeGetStorage('subCurrentPeriodEnd');
  var autoRenew = safeGetStorage('autoRenew') === 'true';
  var status = (state.auth==='admin') ? 'Administrator' : (state.auth==='paid') ? 'Subscriber' : 'Signed-in (Free)';
  
  // Handle missing email case
  if (!email && state.auth !== 'anon') {
    email = 'Error: Email not found';
    console.error('User is logged in but email is missing from localStorage');
  }

  var planCards = (state.auth==='paid')
    ? ('<div class="card"><div class="text-sub">Plan</div><div><strong>'+ (plan==='yearly'?'Yearly':'Monthly') +'</strong></div></div>'
      + '<div class="card"><div class="text-sub">'+(autoRenew?'Renews on':'Ends on')+'</div><div><strong>'+fmt(renew)+'</strong></div></div>')
    : '';

  return '<div class="card account-wrap">'
    + '<h3 style="margin:0 0 6px 0">Account</h3>'
    + '<div class="text-sub">You are signed in.</div>'
    + (email ? '<div class="text-sub">Email: '+email+' ('+(verified?'verified':'unverified')+')</div>' : '')
    + '<div style="margin-top:8px"><strong>Status:</strong> '+status+'</div>'
    + '<div class="grid" style="grid-template-columns:1fr 1fr; gap:8px; margin-top:8px">'
    +   '<div class="card"><div class="text-sub">Member since</div><div><strong>'+fmt(createdAt)+'</strong></div></div>'
    +   '<div class="card"><div class="text-sub">Last sign-in</div><div><strong>'+fmt(lastLoginAt)+'</strong></div></div>'
    +   planCards
    + '</div>'
    + '<div class="row" style="gap:8px; margin-top:12px">'
    +   (state.auth==='free' ? '<button id="goUpgradeBtn" class="btn primary enhanced">Upgrade ‚Äî $15/mo</button>' : '')
    +   (state.auth==='admin' ? '<button id="goAdminBtn" class="btn enhanced" onclick="location.hash=\'#admin\'">Go to Admin Panel</button>' : '')
    +   '<button id="goPicksBtn" class="btn enhanced">Back to picks</button>'
    +   '<button id="signOutBtn" class="btn danger enhanced">Sign out</button>'
    + '</div>'
    + '</div>'
    + '<div class="card" style="margin-top:12px">'
    + '  <h4 style="margin:0 0 8px 0">' + t('settings') + '</h4>'
    + '  <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px">'
    + '    <div>'
    + '      <div class="text-sub">' + t('language') + '</div>'
    + '      <select id="languageSelect" class="input settings-select" style="margin-top:4px">'
    + '        <option value="en">English</option>'
    + '        <option value="es">Espa√±ol</option>'
    + '        <option value="fr">Fran√ßais</option>'
    + '        <option value="de">Deutsch</option>'
    + '      </select>'
    + '    </div>'
    + '    <div>'
    + '      <div class="text-sub">' + t('theme') + '</div>'
    + '      <select id="themeSelect" class="input settings-select" style="margin-top:4px">'
    + '        <option value="dark">' + t('darkTheme') + '</option>'
    + '        <option value="light">' + t('lightTheme') + '</option>'
    + '        <option value="auto">' + t('autoTheme') + '</option>'
    + '      </select>'
    + '    </div>'
    + '  </div>'
    + '  <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px">'
    + '    <div>'
    + '      <div class="text-sub">' + t('voiceSpeed') + '</div>'
    + '      <select id="voiceSpeedSelect" class="input settings-select" style="margin-top:4px">'
    + '        <option value="0.8">Slow</option>'
    + '        <option value="1.0" selected>Normal</option>'
    + '        <option value="1.2">Fast</option>'
    + '        <option value="1.4">Very Fast</option>'
    + '      </select>'
    + '    </div>'
    + '    <div>'
    + '      <div class="text-sub">' + t('currency') + '</div>'
    + '      <select id="currencySelect" class="input settings-select" style="margin-top:4px">'
    + '        <option value="USD">USD ($)</option>'
    + '        <option value="EUR">EUR (‚Ç¨)</option>'
    + '        <option value="GBP">GBP (¬£)</option>'
    + '        <option value="CAD">CAD (C$)</option>'
    + '      </select>'
    + '    </div>'
    + '  </div>'
    + '  <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px">'
    + '    <div>'
    + '      <div class="text-sub">' + t('voiceEnabled') + '</div>'
    + '      <select id="voiceEnabledSelect" class="input settings-select" style="margin-top:4px">'
    + '        <option value="false">Disabled</option>'
    + '        <option value="true">Enabled</option>'
    + '      </select>'
    + '    </div>'
    + '    <div></div>'
    + '  </div>'
    + '  <div class="row" style="gap:8px">'
    + '    <button id="saveSettingsBtn" class="btn primary enhanced">' + t('saveSettings') + '</button>'
    + '    <button id="resetSettingsBtn" class="btn enhanced">Reset to Default</button>'
    + '  </div>'
    + '</div>';
}
function renderAccount(){
  var wrap = document.getElementById('accountContainer');
  if (!wrap) return;
  wrap.innerHTML = (state.auth==='anon') ? accountSignedOutHTML() : accountSignedInHTML();
  
  // Load settings values after rendering
  loadSettingsValues();
}

function reflectAuthButtons(){
  ['btnAnon','btnFree','btnPaid','btnAdmin'].forEach(function(id){ var el = document.getElementById(id); if (el) el.classList.remove('primary'); });
  ({ anon:['btnAnon'], free:['btnFree'], paid:['btnPaid'], admin:['btnAdmin'] }[state.auth]||[]).forEach(function(id){ var el = document.getElementById(id); if (el) el.classList.add('primary'); });
}
function renderProfile(){
  var el = document.getElementById('profileInfo');
  var map = { anon:'Anonymous', free:'Signed-in (Free)', paid:'Subscriber', admin:'Administrator' };
  var email = getUserEmail();
  var emailRow = email ? '<div class="text-sub">Email: '+email+'</div>' : '';
  
  // Show warning if user appears logged in but no email
  if (!email && state.auth !== 'anon') {
    emailRow = '<div class="text-sub" style="color: var(--red);">Email: Missing (localStorage error)</div>';
  }
  
  var ver = (state.auth!=='anon') ? ('<div class="text-sub">Verified: '+(isVerified()?'Yes':'No')+'</div>') : '';
  el.innerHTML = '<div class="row"><div><strong>Status:</strong> '+map[state.auth]+'</div></div>' + emailRow + ver;
  reflectAuthButtons();
}
function renderSubscribe(){}

function renderContact(){
  var title = document.getElementById('contactTitle');
  var nameLabel = document.getElementById('nameLabel');
  var emailLabel = document.getElementById('emailLabel');
  var subjectLabel = document.getElementById('subjectLabel');
  var messageLabel = document.getElementById('messageLabel');
  var sendBtn = document.getElementById('sendContactBtn');
  var clearBtn = document.getElementById('clearContactBtn');
  
  if (title) title.textContent = t('contactUs');
  if (nameLabel) nameLabel.textContent = t('name');
  if (emailLabel) emailLabel.textContent = t('email');
  if (subjectLabel) subjectLabel.textContent = t('subject');
  if (messageLabel) messageLabel.textContent = t('message');
  if (sendBtn) sendBtn.textContent = t('sendMessage');
  
  // Auto-fill email from logged-in account
  var emailInput = document.getElementById('contactEmail');
  var userEmail = getUserEmail();
  if (emailInput) {
    if (userEmail) {
      emailInput.value = userEmail;
    } else if (state.auth !== 'anon') {
      emailInput.placeholder = 'Email missing from storage';
      emailInput.style.color = 'var(--red)';
    }
  }
  if (clearBtn) clearBtn.textContent = 'Clear Form';
}

// DELEGATED CLICKS
document.addEventListener('click', function(e){
  var target = e.target;
  
  // Debug upgrade button clicks
  if (target.id === 'upgradeNowBtn' || target.closest('[data-goto-subscribe]')) {
    console.log('üîç Click detected on upgrade button:', target.id, target);
  }

  // Favorite toggle
  var favEl = target.closest && target.closest('[data-fav]');
  if (favEl){ toggleFavorite(favEl.getAttribute('data-fav')); return; }

  // Account tabs
  if (target.id==='accTabSignup'){ state.accTab='signup'; localStorage.setItem('accTab','signup'); renderAccount(); }
  if (target.id==='accTabSignin'){ state.accTab='signin'; localStorage.setItem('accTab','signin'); renderAccount(); }

  // tabs
  var scoreTab = target.closest && target.closest('.score-tab');
  if (scoreTab){ state.tf = scoreTab.getAttribute('data-tf'); localStorage.setItem('tf', state.tf); renderScorecard(); }

  var outTab = target.closest && target.closest('.out-tab');
  if (outTab){ state.otf = outTab.getAttribute('data-otf'); localStorage.setItem('otf', state.otf); renderOutcomes(); }

  // Admin sign-in button
  if (target.id==='adminSigninBtn'){ 
    setAuth('admin'); 
    alert('Signed in as Admin!'); 
    location.hash = '#admin'; 
  }

  // admin page actions
  if (target.id==='btnAnon') setAuth('anon');
  if (target.id==='btnFree') setAuth('free');
  if (target.id==='btnPaid') setAuth('paid');
  if (target.id==='btnAdmin') {
    setAuth('admin');
    checkAdminAccess();
  }

  // N8N Admin Controls
  if (target.id==='btnTriggerN8NUpdate') {
    console.log('üîÑ Triggering N8N update from admin panel...');
    triggerN8NPicksUpdate()
      .then(result => {
        console.log('‚úÖ N8N update completed:', result);
        showMessage('N8N update triggered successfully!', 'success');
      })
      .catch(error => {
        console.error('‚ùå N8N update failed:', error);
        showMessage('N8N update failed. Check console for details.', 'error');
      });
  }

  if (target.id==='btnReloadFirebase') {
    console.log('üîÑ Reloading Firebase data from admin panel...');
    loadFirebaseData()
      .then(() => {
        console.log('‚úÖ Firebase data reloaded');
        showMessage('Firebase data reloaded successfully!', 'success');
        updateAdminDataStatus();
      })
      .catch(error => {
        console.error('‚ùå Firebase reload failed:', error);
        showMessage('Firebase reload failed. Check console for details.', 'error');
      });
  }

  if (target.id==='btnTestN8NConnection') {
    console.log('üîó Testing N8N connection...');
    testN8NConnection()
      .then(result => {
        console.log('‚úÖ N8N connection test result:', result);
        showMessage('N8N connection test completed. Check console for details.', 'success');
      })
      .catch(error => {
        console.error('‚ùå N8N connection test failed:', error);
        showMessage('N8N connection test failed. Check console for details.', 'error');
      });
  }

  if (target.id==='btnViewN8NLogs') {
    console.log('üìã Viewing N8N logs...');
    viewN8NLogs();
  }

  if (target.id==='btnExportData') {
    console.log('üì§ Exporting data...');
    exportData();
  }

  if (target.id==='btnImportData') {
    console.log('üì• Importing data...');
    importData();
  }

  if (target.id==='btnBackupData') {
    console.log('üíæ Backing up data...');
    backupData();
  }

  if (target.id==='btnClearOldData') {
    console.log('üóëÔ∏è Clearing old data...');
    clearOldData();
  }

  if (target.id==='btnConfigureN8N') {
    console.log('‚öôÔ∏è Configuring N8N endpoints...');
    configureN8NEndpoints();
  }

  // QA Dashboard Controls
  if (target.id==='qaCreatePick') {
    console.log('üìù Creating new pick...');
    createNewPick();
  }

  if (target.id==='qaFilterAll') {
    console.log('üìã Showing all picks...');
    filterQAPicks('all');
  }

  if (target.id==='qaFilterDraft') {
    console.log('üìù Filtering draft picks...');
    filterQAPicks('draft');
  }

  if (target.id==='qaFilterLive') {
    console.log('üî¥ Filtering live picks...');
    filterQAPicks('live');
  }

  if (target.id==='qaFilterRejected') {
    console.log('‚ùå Filtering rejected picks...');
    filterQAPicks('rejected');
  }

  if (target.id==='qaFilterScoring') {
    console.log('üèÜ Filtering scoring picks...');
    filterQAPicks('scoring');
  }

  if (target.id==='qaFilterDeleted') {
    console.log('üóëÔ∏è Filtering deleted picks...');
    filterQAPicks('deleted');
  }

  if (target.id==='qaRefreshPicks') {
    console.log('üîÑ Refreshing QA picks...');
    loadQAPicks();
  }

  // Bulk Selection Controls
  if (target.id==='qaSelectAll') {
    toggleSelectAll(target.checked);
  }

  if (target.classList && target.classList.contains('pick-select-checkbox')) {
    togglePickSelection(target.dataset.pickId, target.checked);
  }

  if (target.id==='qaBulkApprove') {
    bulkApprove();
  }

  if (target.id==='qaBulkReject') {
    bulkReject();
  }

  if (target.id==='qaBulkDelete') {
    bulkDelete();
  }
  
  if (target.id==='markSelectedHits') {
    markSelectedHits();
  }
  
  if (target.id==='markSelectedMisses') {
    markSelectedMisses();
  }
  
  if (target.id==='clearScoringSelections') {
    clearScoringSelections();
  }
  
  if (target.id==='toggleCompletedScores') {
    toggleCompletedScores();
  }

  // JSON Upload Controls
  if (target.id==='previewJSONUpload') {
    console.log('üëÅÔ∏è Previewing JSON upload...');
    previewJSONUpload();
  }

  if (target.id==='uploadJSONPicks') {
    console.log('üì§ Uploading JSON picks...');
    uploadJSONPicks();
  }

  if (target.id==='clearJSONUpload') {
    console.log('üóëÔ∏è Clearing JSON upload...');
    clearJSONUpload();
  }

  // Backup & Restore Controls
  if (target.id==='exportAllData') {
    console.log('üì¶ Exporting all data...');
    exportAllData();
  }

  if (target.id==='restoreFromBackup') {
    console.log('üîÑ Restoring from backup...');
    const fileInput = document.getElementById('backupFileInput');
    if (fileInput.files.length > 0) {
      handleBackupFileUpload({ target: fileInput });
    } else {
      alert('‚ùå Please select a backup file first');
    }
  }

  if (target.id==='checkCollections') {
    console.log('üîç Checking collections...');
    ensureCollectionsExist();
  }

  // Scoring Management Controls
  if (target.id==='moveCompletedGames') {
    console.log('‚è∞ Moving completed games to scoring...');
    moveCompletedGamesToScoring();
  }

  if (target.id==='calculateStats') {
    console.log('üìä Calculating scoring statistics...');
    calculateScoringStats();
  }

  if (target.id==='debugScoring') {
    console.log('üîç Debugging scoring system...');
    debugScoringSystem();
  }

  // Admin Portal Tab Navigation
  if (target.dataset && target.dataset.adminTab) {
    switchAdminTab(target.dataset.adminTab);
  }
  
  // Banner Management
  if (target.id==='previewBannerBtn') previewBanner();
  if (target.id==='activateBannerBtn') activateBanner();
  if (target.id==='hideBannerBtn') hideBanner();
  if (target.id==='maintenanceTemplateBtn') loadMaintenanceTemplate();
  if (target.id==='updateTemplateBtn') loadUpdateTemplate();
  
  // Content Management
  if (target.id==='editTermsBtn') editLegalPage('terms');
  if (target.id==='editPrivacyBtn') editLegalPage('privacy');
  if (target.id==='saveLegalBtn') saveLegalPage();
  if (target.id==='cancelLegalBtn') cancelLegalEdit();
  if (target.id==='saveMessagesBtn') saveSystemMessages();
  
  // User Management - Legacy handlers
  if (target.id==='markVerifiedBtn'){ alert('Email marked as verified (mock)'); render(); }
  if (target.id==='unverifyBtn'){ alert('Email marked as unverified (mock)'); render(); }
  if (target.id==='clearFavsBtn'){ if(confirm('Clear favorites?')){ state.favorites=[]; setStorage('favorites',state.favorites); render(); } }
  if (target.id==='seedOutcomesBtn') seedTestOutcomes();
  
  // Logo click to return home
  if (target.id==='logoHome' || target.closest('#logoHome')) {
    location.hash = '#picks';
    route();
    return;
  }
  
  // Multi-select filter handlers removed (no longer needed)
  
  // Financial Dashboard handlers
  if (target.id==='refreshUserData') refreshFinancialData();
  if (target.id==='exportUserReport') exportFinancialReport();
  if (target.id==='viewUserDetails') viewUserDetails();
  if (target.id==='updatePricing') updateSubscriptionPricing();
  if (target.id==='ownerShare' || target.id==='teamShare') calculateTeamPayouts();
  if (target.id==='monthlyPrice' || target.id==='annualPrice') calculateTeamPayouts();
  
  // Legacy User Management handlers (moved to Development Tools)
  if (target.id==='grantSubBtn') grantSubscription();
  if (target.id==='revokeSubBtn') revokeSubscription();
  if (target.id==='resetUserBtn') resetUserData();
  if (target.id==='resetAllDataBtn') resetAllData();
  
  // System Management
  if (target.id==='saveFlagsBtn') saveFeatureFlags();
  if (target.id==='clearCacheBtn') clearSystemCache();
  if (target.id==='exportDataBtn') exportSystemData();
  if (target.id==='importDataBtn') importSystemData();
  if (target.id==='systemResetBtn') performSystemReset();
  if (target.id==='backupDataBtn') backupSystemData();
  
  // Auth buttons with loading states
  if (target.id==='googleSignup' || target.id==='googleSignin') {
    setButtonLoading(target.id, true);
    setTimeout(function() {
      setButtonLoading(target.id, false);
      setAuth('free');
      showMessage('Signed in with Google! (mock)', 'success');
    }, 2000);
  }
  
  if (target.id==='emailSignupBtn') {
    var email = document.getElementById('emailInp');
    var pw = document.getElementById('pwInp');
    if (!email || !pw || !email.value.trim() || !pw.value.trim()) {
      alert('Please fill in email and password.');
      return;
    }
    setButtonLoading('emailSignupBtn', true);
    setTimeout(function() {
      setButtonLoading('emailSignupBtn', false);
      if (!safeSetStorage('userEmail', email.value.trim())) {
        showMessage('Warning: Could not save email to storage', 'error');
      }
      setAuth('free');
      showMessage('Account created successfully!', 'success');
    }, 2500);
  }
  
  if (target.id==='emailSigninBtn') {
    var email = document.getElementById('emailInpLogin');
    var pw = document.getElementById('pwInpLogin');
    if (!email || !pw || !email.value.trim() || !pw.value.trim()) {
      alert('Please fill in email and password.');
      return;
    }
    setButtonLoading('emailSigninBtn', true);
    
    // Use Firebase authentication
    signIn(email.value.trim(), pw.value.trim())
      .then((user) => {
      setButtonLoading('emailSigninBtn', false);
      if (!safeSetStorage('userEmail', email.value.trim())) {
        showMessage('Warning: Could not save email to storage', 'error');
      }
      setAuth('free');
      showMessage('Signed in successfully!', 'success');
        location.hash = '#picks';
        route();
      })
      .catch((error) => {
        setButtonLoading('emailSigninBtn', false);
        console.error('Sign in error:', error);
        alert('Check your email or password.');
      });
  }

  if (target.id==='seedOutcomesBtn' || target.id==='seedDemoBtn'){
    if (state.auth!=='paid') return alert('Subscriber required (mock)');
    var demo = picksResults.slice(0,4).map(function(p){ return ({ id: p.id, snap: p, result: p.result, settledAt: p.settledAt }); });
    state.favorites = demo;
    localStorage.setItem('favorites', JSON.stringify(state.favorites));
    renderFavorites(); renderOutcomes(); render();
  }
  if (target.id==='clearFavsBtn'){
    state.favorites = [];
    localStorage.setItem('favorites', JSON.stringify(state.favorites));
    renderFavorites(); renderOutcomes(); render();
    alert('Favorites cleared.');
  }
  // Admin off button removed - admin is now handled through auth state

  // outcomes select/delete
  var sel = target.closest && target.closest('input[type="checkbox"][data-sel]');
  if (sel){
    var sid = sel.getAttribute('data-sel');
    if (sel.checked) { if (state.selectedOut.indexOf(sid)===-1) state.selectedOut.push(sid); }
    else { state.selectedOut = state.selectedOut.filter(function(x){ return x !== sid; }); }
    updateSelectionUI();
  }
  if (target.id==='selectAllBtn'){
    var boxes = Array.prototype.slice.call(document.querySelectorAll('#outList [data-sel]'));
    state.selectedOut = boxes.map(function(b){ return b.getAttribute('data-sel'); });
    boxes.forEach(function(b){ b.checked = true; });
    updateSelectionUI();
  }
  if (target.id==='clearSelectedBtn'){
    if (state.auth!=='paid') return;
    if (state.selectedOut.length===0) return;
    if (!confirm('Delete all selected outcomes from your saved favorites?')) return;
    state.favorites = state.favorites.filter(function(f){ return state.selectedOut.indexOf(f.id)===-1; });
    state.selectedOut = [];
    localStorage.setItem('favorites', JSON.stringify(state.favorites));
    renderFavorites(); renderOutcomes(); render();
  }
  if (target.id==='clearVisibleBtn'){
    if (state.auth!=='paid') return;
    if (!confirm('Delete ONLY outcomes in the current timeframe view? This cannot be undone.')) return;
    var tf = state.otf;
    state.favorites = state.favorites.filter(function(f){
      var t = f.settledAt ? new Date(f.settledAt).getTime() : 0;
      var keep = (tf==='all') ? false : (Date.now() - t) > Number(tf)*86400000;
      return keep;
    });
    state.selectedOut = [];
    localStorage.setItem('favorites', JSON.stringify(state.favorites));
    renderFavorites(); renderOutcomes(); render();
  }

  // CTAs
  var toSignup = target.closest && target.closest('[data-goto-signup]');
  if (toSignup){ location.hash = '#account'; route(); }
  var toSubscribe = target.closest && target.closest('[data-goto-subscribe]');
  if (toSubscribe){ handleUpgrade(); }
  if (target.id==='upgradeBtn' || target.id==='mobileUpgradeBtn' || target.id==='goUpgradeBtn'){ handleUpgrade(); }

  if (target.id==='upgradeNowBtn'){
    // Use Stripe integration instead of localStorage
    handleUpgrade();
  }

  if (target.id==='backToPicksBtn' || target.id==='goPicksBtn'){ location.hash = '#picks'; route(); }

  // coupons
  if (target.id==='applyCouponBtn'){
    var inp = document.getElementById('couponCode');
    var code = (inp && inp.value ? inp.value : '').trim().toUpperCase();
    var note = document.getElementById('subscribeNote');
    var upgBtn = document.getElementById('upgradeNowBtn');
    if (!code){ alert('Enter a code first.'); return; }
    if (code === 'SAVE20'){
      if (note) note.textContent = 'Coupon applied: SAVE20 ‚Äî New price $12 USD / month';
      if (upgBtn) upgBtn.textContent = 'Complete subscription ‚Äî $12/mo';
      alert('Coupon applied.');
    } else {
      alert('Invalid code (mock). Try SAVE20.');
    }
  }
  if (target.id==='planMonthlyBtn') {
    target.classList.add('primary');
    document.getElementById('planYearlyBtn').classList.remove('primary');
    document.getElementById('planPrice').textContent = '$15';
    document.getElementById('planInterval').textContent = 'USD / month';
    document.getElementById('planName').innerHTML = '<strong>Confident Picks ‚Äî Monthly</strong>';
    document.getElementById('upgradeNowBtn').textContent = 'Complete subscription ‚Äî $15/mo';
  }
  if (target.id==='planYearlyBtn') {
    target.classList.add('primary');
    document.getElementById('planMonthlyBtn').classList.remove('primary');
    document.getElementById('planPrice').textContent = '$150';
    document.getElementById('planInterval').textContent = 'USD / year';
    document.getElementById('planName').innerHTML = '<strong>Confident Picks ‚Äî Yearly</strong>';
    document.getElementById('upgradeNowBtn').textContent = 'Complete subscription ‚Äî $150/yr';
  }

  // auth (Account)
  if (target.id==='googleSignup'){
    // Real Firebase Google Sign-In (Modern SDK - same as sign-in, Firebase handles new users automatically)
    (async () => {
      try {
        const { GoogleAuthProvider, signInWithPopup } = await import('https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js');
        const provider = new GoogleAuthProvider();
        const result = await signInWithPopup(window.auth, provider);
        const user = result.user;
        const isNewUser = result.additionalUserInfo?.isNewUser;
        console.log('‚úÖ Google sign-up successful:', user.email, 'New user:', isNewUser);
        // Firebase auth state listener will handle the rest
        location.hash = '#picks';
        route();
      } catch (error) {
        console.error('‚ùå Google sign-up error:', error);
        alert('Sign-up failed: ' + error.message);
      }
    })();
    return; // Prevent default mock behavior
  }
  if (target.id==='googleSignin'){
    // Real Firebase Google Sign-In (Modern SDK)
    (async () => {
      try {
        const { GoogleAuthProvider, signInWithPopup } = await import('https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js');
        const provider = new GoogleAuthProvider();
        const result = await signInWithPopup(window.auth, provider);
        const user = result.user;
        console.log('‚úÖ Google sign-in successful:', user.email);
        // Firebase auth state listener will handle the rest
        location.hash = '#picks';
        route();
      } catch (error) {
        console.error('‚ùå Google sign-in error:', error);
        alert('Sign-in failed: ' + error.message);
      }
    })();
    return; // Prevent default mock behavior
  }
  if (target.id==='emailSignupBtn'){
    var email = (document.getElementById('emailInp')||{}).value || '';
    var pw = (document.getElementById('pwInp')||{}).value || '';
    if (!email || email.indexOf('@')===-1) { alert('Please enter a valid email.'); return; }
    if (!pw || pw.length < 8 || !/[A-Za-z]/.test(pw) || !/[0-9]/.test(pw)) { alert('Password must be 8+ chars, include letters and numbers.'); return; }
    localStorage.setItem('userEmail', email);
    localStorage.setItem('userPw', pw);
    localStorage.setItem('emailVerified','false');
    localStorage.setItem('userCreatedAt', localStorage.getItem('userCreatedAt') || nowIso());
    localStorage.setItem('lastLoginAt', nowIso());
    setAuth('free');
    alert('Account created! Please verify your email to unlock extras (mock).');
    location.hash = '#picks'; route();
  }
  if (target.id==='emailSigninBtn'){
    var email2 = (document.getElementById('emailInpLogin')||{}).value || '';
    var pw2 = (document.getElementById('pwInpLogin')||{}).value || '';
    var savedEmail = localStorage.getItem('userEmail');
    var savedPw = localStorage.getItem('userPw');
    var fails = Number(localStorage.getItem('loginFails')||'0');
    if (!email2 || !pw2) { alert('Check your email or password.'); return; }
    if (email2===savedEmail && pw2===savedPw){
      setAuth('free');
      localStorage.setItem('loginFails','0');
      localStorage.setItem('lastLoginAt', nowIso());
      alert('Signed in!');
      location.hash = '#picks'; route();
    } else {
      fails += 1;
      localStorage.setItem('loginFails', String(fails));
      if (fails >= 3){
        var t = document.getElementById('turnstileSignin'); if (t) t.classList.remove('hidden');
      }
      alert('Check your email or password.');
    }
  }
  if (target.id==='forgotBtn'){ alert('Password reset link sent (mock).'); }
  if (target.id==='signOutBtn'){ setAuth('anon'); location.hash = '#picks'; route(); }

  // email verify controls
  if (target.id==='sendVerifyBtn'){ alert('Verification email sent (mock).'); }
  if (target.id==='markVerifiedBtn'){
    localStorage.setItem('emailVerified','true');
    alert('Email marked as verified (mock). Your account is now active.');
    renderAccount(); maybeShowVerifyBanner();
  }
  if (target.id==='unverifyBtn'){
    localStorage.setItem('emailVerified','false');
    alert('Marked unverified (mock).');
    renderProfile(); maybeShowVerifyBanner();
  }

  // Reset maintenance banner
  if (target.id==='resetBannerBtn'){
    try { localStorage.removeItem(BANNER_KEY); } catch (e) {}
    var b = document.getElementById('maintBanner'); if (b) b.style.display = 'flex';
    alert('Banner reset (v2).');
  }



  // Settings functionality
  if (target.id==='saveSettingsBtn'){
    var newSettings = {
      language: document.getElementById('languageSelect').value,
      theme: document.getElementById('themeSelect').value,
      voiceSpeed: document.getElementById('voiceSpeedSelect').value,
      currency: document.getElementById('currencySelect').value,
      voiceEnabled: document.getElementById('voiceEnabledSelect').value
    };
    state.settings = newSettings;
    localStorage.setItem('userSettings', JSON.stringify(newSettings));
    
    // Apply theme immediately
    if (newSettings.theme === 'light') {
      document.documentElement.setAttribute('data-theme', 'light');
    } else if (newSettings.theme === 'dark') {
      document.documentElement.removeAttribute('data-theme');
    }
    localStorage.setItem('theme', newSettings.theme);
    
    updateAllTranslations();
    alert(t('saveSettings') + ' - Settings saved successfully!');
  }

  if (target.id==='resetSettingsBtn'){
    if (confirm('Reset all settings to default (English)? This cannot be undone.')) {
      var defaultSettings = {"language":"en","theme":"dark","voiceSpeed":"1.0","currency":"USD","voiceEnabled":"false"};
      state.settings = defaultSettings;
      localStorage.setItem('userSettings', JSON.stringify(defaultSettings));
      document.documentElement.removeAttribute('data-theme');
      localStorage.setItem('theme', 'dark');
      updateAllTranslations();
      renderAccount();
      alert('Settings reset to default!');
    }
  }

  if (target.id==='readFavoritesBtn'){
    readFavoritesAloud();
  }

  // Min Confidence slider - no longer needed (handled by input event listener)
});

// keyboard support for star toggle
document.addEventListener('keydown', function(e){
  var tgt = e.target;
  if (tgt && tgt.hasAttribute && tgt.hasAttribute('data-fav') && (e.key==='Enter' || e.key===' ')){
    e.preventDefault();
    var id = tgt.getAttribute('data-fav');
    if (id) toggleFavorite(id);
  }
});

// Global keyboard shortcuts
document.addEventListener('keydown', function(e){
  // Skip if user is typing in input
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
  
  switch(e.key.toLowerCase()) {
    case '/':
      e.preventDefault();
      var searchInput = document.getElementById('searchInp');
      if (searchInput) searchInput.focus();
      break;
    case 't':
      if (e.ctrlKey || e.metaKey) return; // Don't interfere with browser shortcuts
      e.preventDefault();
      document.getElementById('themeBtn').click();
      break;
    case '1': case '2': case '3': case '4': case '5': case '6':
      var navIndex = parseInt(e.key) - 1;
      var navLinks = document.querySelectorAll('[data-nav]');
      if (navLinks[navIndex]) navLinks[navIndex].click();
      break;
    case '?':
      e.preventDefault();
      document.getElementById('helpModal').classList.add('active');
      break;
    case 'escape':
      // Close help modal first, then clear search
      var helpModal = document.getElementById('helpModal');
      if (helpModal && helpModal.classList.contains('active')) {
        helpModal.classList.remove('active');
        break;
      }
      // Clear any active modals or reset search
      var searchInput = document.getElementById('searchInp');
      if (searchInput && searchInput.value) {
        searchInput.value = '';
        render();
      }
      break;
  }
});

// Help modal handlers
document.addEventListener('click', function(e){
  var helpModal = document.getElementById('helpModal');
  
  // Close help modal
  if (e.target.id === 'closeHelpBtn' || 
      (e.target === helpModal && helpModal.classList.contains('active'))) {
    helpModal.classList.remove('active');
    return;
  }
});

// Contact form handlers
document.addEventListener('click', function(e){
  if (e.target.id === 'sendContactBtn') {
    // Check if user is logged in first
    if (state.auth === 'anon') {
      alert('Please log in to submit a support ticket.\n\nThis helps us:\n‚Ä¢ Track your request\n‚Ä¢ Provide better support\n‚Ä¢ Follow up with updates\n\nClick "Account" to sign in or create an account.');
      return;
    }
    
    // Show loading state
    setButtonLoading('sendContactBtn', true);
    
    var name = document.getElementById('contactName').value.trim();
    var email = document.getElementById('contactEmail').value.trim();
    var subject = document.getElementById('contactSubject').value;
    var message = document.getElementById('contactMessage').value.trim();
    
    // Auto-fill email from logged-in account
    var userEmail = getUserEmail();
    if (userEmail && email !== userEmail) {
      document.getElementById('contactEmail').value = userEmail;
      email = userEmail;
    } else if (!userEmail && state.auth !== 'anon') {
      setButtonLoading('sendContactBtn', false);
      alert('Error: Your email address is missing from storage. Please sign out and sign back in.');
      return;
    }
    
    // Validation
    if (!name || !subject || !message) {
      setButtonLoading('sendContactBtn', false);
      alert('Please fill in all required fields.');
      return;
    }
    
    // Email is auto-filled from account, so no manual validation needed
    
    // Gather user data for support context
    var supportData = {
      userMessage: {
        name: name,
        email: email,
        subject: subject,
        message: message,
        accountStatus: 'logged-in'
      },
      userContext: {
        auth: state.auth,
        favoritesCount: state.favorites.length,
        settings: state.settings,
        userAgent: navigator.userAgent,
        timestamp: nowIso(),
        currentPage: location.hash || '#picks'
      },
      localStorage: {
        userEmail: safeGetStorage('userEmail'),
        emailVerified: safeGetStorage('emailVerified'),
        subPlan: safeGetStorage('subPlan'),
        theme: safeGetStorage('theme')
      }
    };
    
    // In real app, this would POST supportData to your server
    console.log('Support Request Data:', supportData);
    
    // Simulate async operation
    setTimeout(function() {
      setButtonLoading('sendContactBtn', false);
    alert('Thank you for your message! We\'ll get back to you soon.\n\n(Debug: Check console for support data)');
    
    // Clear form
    document.getElementById('contactName').value = '';
    document.getElementById('contactEmail').value = '';
    document.getElementById('contactSubject').value = '';
    document.getElementById('contactMessage').value = '';
    }, 1500); // 1.5 second delay to show loading state
  }
  
  if (e.target.id === 'clearContactBtn') {
    document.getElementById('contactName').value = '';
    document.getElementById('contactEmail').value = '';
    document.getElementById('contactSubject').value = '';
    document.getElementById('contactMessage').value = '';
  }
});

// Collapsible guide persistence
(function(){
  var sh = document.getElementById('scoreHelp');
  if (!sh) return;
  var saved = localStorage.getItem('scoreHelpOpen');
  if (saved !== null) sh.open = saved === '1';
  sh.addEventListener('toggle', function(){
    localStorage.setItem('scoreHelpOpen', sh.open ? '1' : '0');
  });
})();

// Maintenance banner v2
var BANNER_KEY = 'maintBannerDismissed_v2';
(function(){
  var banner = document.getElementById('maintBanner');
  if (!banner) return;
  var params = new URLSearchParams(location.search);
  var forceShow = params.get('showBanner') === '1';
  var forceHide = params.get('showBanner') === '0';
  var dismissed = false;
  try { dismissed = localStorage.getItem(BANNER_KEY) === '1'; } catch (e) {}
  banner.style.display = (forceHide ? 'none' : ((forceShow || !dismissed) ? 'flex' : 'none'));
})();
function dismissMaintBanner(){
  var banner = document.getElementById('maintBanner');
  if (banner) banner.style.display = 'none';
  try { localStorage.setItem(BANNER_KEY,'1'); } catch (e) {}
}

/* Min Confidence helpers */
function clampMinConf(val){
  val = Math.round(Number(val) || 0);
  if (val < 0) val = 0; if (val > 100) val = 100;
  return val;
}
function changeMinConf(delta){
  var el = document.getElementById('minConf'); if (!el) return;
  el.value = clampMinConf((Number(el.value)||0) + delta);
  render();
}

/* filter listeners */
['leagueSel','marketSel','sortSel'].forEach(function(id){
  var el = document.getElementById(id);
  if (el) el.addEventListener('change', render);
});
['searchInp','minConf'].forEach(function(id){
  var el = document.getElementById(id);
  if (el) el.addEventListener('input', function(){
    if (id==='minConf') {
      this.value = clampMinConf(this.value);
      // Update the value display
      var valueDisplay = document.getElementById('minConfValue');
      if (valueDisplay) valueDisplay.textContent = this.value + '%';
    }
    render();
  });
});

/* ADMIN PORTAL FUNCTIONS */

// Admin Tab Management
function switchAdminTab(tabName) {
  console.log('üîÑ Switching to admin tab:', tabName);
  
  // Hide all tab contents
  document.querySelectorAll('.admin-tab-content').forEach(function(el) {
    el.classList.add('hidden');
    // Remove any inline display styles to ensure hidden class works
    if (el.style.display) {
      el.style.display = '';
    }
    console.log('  Hiding tab:', el.id);
  });
  
  // Show selected tab content - handle special cases
  var targetTab;
  if (tabName === 'qa') {
    targetTab = document.getElementById('adminQA');
  } else if (tabName === 'users') {
    targetTab = document.getElementById('adminUsers');
  } else if (tabName === 'banners') {
    targetTab = document.getElementById('adminBanners');
  } else if (tabName === 'content') {
    targetTab = document.getElementById('adminContent');
  } else if (tabName === 'data') {
    targetTab = document.getElementById('adminData');
  } else if (tabName === 'system') {
    targetTab = document.getElementById('adminSystem');
  } else {
    targetTab = document.getElementById('admin' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
  }
  
  console.log('Target tab ID for "' + tabName + '":', targetTab ? targetTab.id : 'NOT FOUND');
  console.log('Target tab element:', targetTab);
  
  if (targetTab) {
    targetTab.classList.remove('hidden');
    
    // Special case for QA tab - needs display:flex for layout
    if (tabName === 'qa') {
      targetTab.style.display = 'flex';
    }
    
    console.log('‚úÖ Tab content shown:', tabName);
    console.log('‚úÖ Tab has hidden class?', targetTab.classList.contains('hidden'));
    console.log('‚úÖ Tab inner HTML length:', targetTab.innerHTML.length);
  } else {
    console.error('‚ùå Tab content not found for:', tabName);
    console.log('Available tab content elements:');
    document.querySelectorAll('.admin-tab-content').forEach(function(el) {
      console.log('  - ' + el.id);
    });
  }
  
  // Update tab button states
  document.querySelectorAll('.tab').forEach(function(el) {
    el.classList.remove('active');
  });
  
  var activeButton = document.querySelector('[data-admin-tab="' + tabName + '"]');
  if (activeButton) {
    activeButton.classList.add('active');
    console.log('‚úÖ Tab button activated:', tabName);
  } else {
    console.error('‚ùå Tab button not found:', tabName);
  }
  
  // Update admin dashboard data when switching to overview
  if (tabName === 'overview') updateAdminMetrics();
  
  // Load QA picks when switching to QA tab
  if (tabName === 'qa') {
    console.log('üîÑ Loading QA picks for QA tab...');
    loadQAPicks();
  }
  
  // Initialize Financial Dashboard when switching to users tab
  if (tabName === 'users') {
    console.log('üí∞ Initializing Financial Dashboard...');
    setTimeout(function() {
      initializeFinancialDashboard();
    }, 100);
  }
  
  // Update banner status when switching to banners tab
  if (tabName === 'banners') {
    console.log('üè∑Ô∏è Updating banner status...');
    updateBannerStatus();
    updateLiveBanner();
  }
}

// Update admin overview metrics
function updateAdminMetrics() {
  var userCount = 1; // Mock data - would come from Firebase
  var subCount = (state.auth === 'paid') ? 1 : 0;
  
  var userCountEl = document.getElementById('adminUserCount');
  var subCountEl = document.getElementById('adminSubCount');
  
  if (userCountEl) userCountEl.textContent = userCount;
  if (subCountEl) subCountEl.textContent = subCount;
}

// Banner Management Functions
function previewBanner() {
  var type = document.getElementById('bannerType').value;
  var title = document.getElementById('bannerTitle').value || 'Sample Title';
  var message = document.getElementById('bannerMessage').value || 'Sample message text';
  
  alert('BANNER PREVIEW\\n\\nType: ' + type + '\\nTitle: ' + title + '\\nMessage: ' + message);
}

function activateBanner() {
  var type = document.getElementById('bannerType').value;
  var title = document.getElementById('bannerTitle').value;
  var message = document.getElementById('bannerMessage').value;
  
  if (!title || !message) {
    alert('Please enter both title and message');
    return;
  }
  
  // Store banner data
  var bannerData = { type: type, title: title, message: message, active: true };
  safeSetStorage('adminBanner', JSON.stringify(bannerData));
  
  // Update the actual banner on the page
  updateLiveBanner();
  
  // Update status display
  updateBannerStatus();
  alert('Banner activated successfully!');
}

function hideBanner() {
  safeSetStorage('adminBanner', JSON.stringify({ active: false }));
  
  // Hide the actual banner on the page
  updateLiveBanner();
  
  updateBannerStatus();
  alert('Banner hidden successfully!');
}

// Update the actual visible banner on the page
function updateLiveBanner() {
  var bannerData = JSON.parse(safeGetStorage('adminBanner', '{"active":false}'));
  var banner = document.getElementById('maintBanner');
  
  if (!banner) return;
  
  if (bannerData.active && bannerData.title && bannerData.message) {
    // Show and update banner content
    var labelEl = banner.querySelector('.label');
    var textEl = banner.querySelector('.text-sub');
    
    if (labelEl) labelEl.textContent = bannerData.title + ':';
    if (textEl) textEl.textContent = bannerData.message;
    
    // Apply styling based on banner type
    var bgClass = {
      'maintenance': 'linear-gradient(180deg, rgba(255,193,7,.18), rgba(255,87,34,.18))',
      'announcement': 'linear-gradient(180deg, rgba(77,163,255,.18), rgba(34,197,94,.18))',
      'warning': 'linear-gradient(180deg, rgba(255,87,34,.18), rgba(244,67,54,.18))',
      'info': 'linear-gradient(180deg, rgba(77,163,255,.18), rgba(156,39,176,.18))'
    };
    
    banner.style.background = bgClass[bannerData.type] || bgClass.announcement;
    banner.style.display = 'flex';
    
    // Clear any dismissed state
    try { localStorage.removeItem(BANNER_KEY); } catch (e) {}
  } else {
    // Hide banner
    banner.style.display = 'none';
  }
}

function updateBannerStatus() {
  var bannerData = JSON.parse(safeGetStorage('adminBanner', '{"active":false}'));
  var statusEl = document.getElementById('bannerStatusText');
  
  if (statusEl) {
    if (bannerData.active) {
      statusEl.textContent = 'Active: ' + (bannerData.title || 'Untitled Banner');
      statusEl.style.color = 'var(--green)';
    } else {
      statusEl.textContent = 'No active banner';
      statusEl.style.color = 'var(--text-sub)';
    }
  }
}

function loadMaintenanceTemplate() {
  document.getElementById('bannerType').value = 'maintenance';
  document.getElementById('bannerTitle').value = 'Scheduled Maintenance';
  document.getElementById('bannerMessage').value = 'We are performing scheduled maintenance. The site will be back online shortly. Thank you for your patience.';
}

function loadUpdateTemplate() {
  document.getElementById('bannerType').value = 'announcement';
  document.getElementById('bannerTitle').value = 'New Features Available';
  document.getElementById('bannerMessage').value = 'We have exciting new features and improvements available! Check out the latest updates to enhance your experience.';
}

// Content Management Functions
var currentEditingPage = '';

function editLegalPage(pageType) {
  currentEditingPage = pageType;
  var editor = document.getElementById('legalEditor');
  var titleEl = document.getElementById('editingPageTitle');
  var contentEl = document.getElementById('legalContent');
  
  var titles = { terms: 'Terms of Service', privacy: 'Privacy Policy' };
  var defaultContent = {
    terms: 'TERMS OF SERVICE\\n\\nLast updated: ' + new Date().toDateString() + '\\n\\n1. Acceptance of Terms\\nBy using this service, you agree to these terms...\\n\\n2. Use License\\nPermission is granted to temporarily use this service...\\n\\n3. Disclaimer\\nThis service is provided as-is for entertainment purposes...',
    privacy: 'PRIVACY POLICY\\n\\nLast updated: ' + new Date().toDateString() + '\\n\\n1. Information We Collect\\nWe collect information you provide directly...\\n\\n2. How We Use Information\\nWe use the information to provide and improve...\\n\\n3. Information Sharing\\nWe do not sell or rent personal information...'
  };
  
  if (titleEl) titleEl.textContent = titles[pageType] || pageType;
  if (contentEl) contentEl.value = safeGetStorage('legal_' + pageType, defaultContent[pageType] || '');
  if (editor) editor.classList.remove('hidden');
}

function saveLegalPage() {
  if (!currentEditingPage) return;
  
  var content = document.getElementById('legalContent').value;
  safeSetStorage('legal_' + currentEditingPage, content);
  
  alert('Legal page saved successfully!');
  cancelLegalEdit();
}

function cancelLegalEdit() {
  var editor = document.getElementById('legalEditor');
  if (editor) editor.classList.add('hidden');
  currentEditingPage = '';
}

function saveSystemMessages() {
  var gateMsg = document.getElementById('gateMessage').value;
  var upgradeMsg = document.getElementById('upgradeCTA').value;
  
  if (gateMsg) safeSetStorage('gateMessage', gateMsg);
  if (upgradeMsg) safeSetStorage('upgradeCTA', upgradeMsg);
  
  alert('System messages saved successfully!');
}

// User Management Functions
function grantSubscription() {
  if (confirm('Grant subscription to current user?')) {
    setAuth('paid');
    alert('Subscription granted successfully!');
  }
}

function revokeSubscription() {
  if (confirm('Revoke subscription from current user?')) {
    setAuth('free');
    alert('Subscription revoked successfully!');
  }
}

function resetUserData() {
  if (confirm('Reset current user data? This will clear favorites and settings.')) {
    state.favorites = [];
    safeSetStorage('favorites', JSON.stringify(state.favorites));
    safeSetStorage('userSettings', '{}');
    render();
    alert('User data reset successfully!');
  }
}

function resetAllData() {
  if (confirm('DANGER: Reset ALL system data? This cannot be undone!')) {
    if (confirm('Are you absolutely sure? This will clear everything!')) {
      ['favorites', 'userSettings', 'adminBanner', 'legal_terms', 'legal_privacy', 'gateMessage', 'upgradeCTA'].forEach(function(key) {
        localStorage.removeItem(key);
      });
      state.favorites = [];
      render();
      alert('All system data reset successfully!');
    }
  }
}

// System Management Functions
function saveFeatureFlags() {
  var flags = {
    gateEnabled: document.getElementById('gateEnabledFlag').checked,
    subscriptionEnabled: document.getElementById('subscriptionEnabledFlag').checked,
    contactEnabled: document.getElementById('contactEnabledFlag').checked,
    favoritesEnabled: document.getElementById('favoritesEnabledFlag').checked
  };
  
  safeSetStorage('featureFlags', JSON.stringify(flags));
  alert('Feature flags saved successfully!');
}

function clearSystemCache() {
  // Clear any cached data (mock implementation)
  alert('System cache cleared successfully!');
}

function exportSystemData() {
  var data = {
    favorites: state.favorites,
    settings: JSON.parse(safeGetStorage('userSettings', '{}')),
    flags: JSON.parse(safeGetStorage('featureFlags', '{}')),
    legal: {
      terms: safeGetStorage('legal_terms', ''),
      privacy: safeGetStorage('legal_privacy', '')
    },
    messages: {
      gate: safeGetStorage('gateMessage', ''),
      upgrade: safeGetStorage('upgradeCTA', '')
    },
    banner: JSON.parse(safeGetStorage('adminBanner', '{}'))
  };
  
  var blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'confident-picks-data-' + new Date().toISOString().split('T')[0] + '.json';
  a.click();
  URL.revokeObjectURL(url);
}

function importSystemData() {
  var input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = function(e) {
    var file = e.target.files[0];
    if (file) {
      var reader = new FileReader();
      reader.onload = function(e) {
        try {
          var data = JSON.parse(e.target.result);
          
          if (data.favorites) { state.favorites = data.favorites; safeSetStorage('favorites', JSON.stringify(data.favorites)); }
          if (data.settings) safeSetStorage('userSettings', JSON.stringify(data.settings));
          if (data.flags) safeSetStorage('featureFlags', JSON.stringify(data.flags));
          if (data.legal) {
            if (data.legal.terms) safeSetStorage('legal_terms', data.legal.terms);
            if (data.legal.privacy) safeSetStorage('legal_privacy', data.legal.privacy);
          }
          if (data.messages) {
            if (data.messages.gate) safeSetStorage('gateMessage', data.messages.gate);
            if (data.messages.upgrade) safeSetStorage('upgradeCTA', data.messages.upgrade);
          }
          if (data.banner) safeSetStorage('adminBanner', JSON.stringify(data.banner));
          
          render();
          alert('Data imported successfully!');
        } catch (err) {
          alert('Error importing data: ' + err.message);
        }
      };
      reader.readAsText(file);
    }
  };
  input.click();
}

function performSystemReset() {
  if (confirm('DANGER: Perform complete system reset? This will delete everything!')) {
    if (confirm('Final confirmation: Delete all data and settings?')) {
      localStorage.clear();
      location.reload();
    }
  }
}

function backupSystemData() {
  exportSystemData(); // Same as export for now
  alert('Backup created and downloaded!');
}

// Initialize admin portal when page loads
if (typeof initAdminPortal === 'undefined') {
  var initAdminPortal = function() {
    // Set up initial admin state
    updateBannerStatus();
    updateAdminMetrics();
    
    // Update live banner from stored data
    updateLiveBanner();
    
    // Update N8N data status
    updateAdminDataStatus();
    
    // Load QA picks
    loadQAPicks();
    
    // Ensure QA tab is properly initialized
    console.log('üîß Initializing QA Dashboard...');
    const qaTab = document.getElementById('adminQA');
    if (qaTab) {
      console.log('‚úÖ QA tab element found');
    } else {
      console.error('‚ùå QA tab element not found');
    }
    
    // Load current system messages
    var gateEl = document.getElementById('gateMessage');
    var upgradeEl = document.getElementById('upgradeCTA');
    if (gateEl) gateEl.value = safeGetStorage('gateMessage', '');
    if (upgradeEl) upgradeEl.value = safeGetStorage('upgradeCTA', '');
    
    // Load feature flags
    var flags = JSON.parse(safeGetStorage('featureFlags', '{}'));
    if (document.getElementById('gateEnabledFlag')) document.getElementById('gateEnabledFlag').checked = flags.gateEnabled !== false;
    if (document.getElementById('subscriptionEnabledFlag')) document.getElementById('subscriptionEnabledFlag').checked = flags.subscriptionEnabled !== false;
    if (document.getElementById('contactEnabledFlag')) document.getElementById('contactEnabledFlag').checked = flags.contactEnabled !== false;
    if (document.getElementById('favoritesEnabledFlag')) document.getElementById('favoritesEnabledFlag').checked = flags.favoritesEnabled !== false;
  };
  
  // Call on page load and when switching to admin
  setTimeout(initAdminPortal, 100);
}

// Initialize banner system on page load
setTimeout(function() {
  updateLiveBanner();
}, 200);

/* NAVIGATION HIGHLIGHTING & ADMIN PROTECTION */

// Track current view and update navigation highlights
function updateNavHighlights() {
  // Get current view from URL hash or default to 'picks'
  var currentView = location.hash.replace('#', '') || 'picks';
  
  // Update nav link highlights
  document.querySelectorAll('.nav a[data-nav]').forEach(function(link) {
    var linkView = link.getAttribute('href').replace('#', '');
    if (linkView === currentView) {
      link.classList.add('active');
    } else {
      link.classList.remove('active');
    }
  });
}

// Admin protection system
var adminPassword = 'getmoney'; // [[memory:6876140]] For consistency with site password
var adminUnlocked = false;

function checkAdminAccess() {
  var navAdmin = document.getElementById('navAdmin');
  if (!navAdmin) return;
  
  // Admin access is now tied to authentication state
  if (state.auth === 'admin') {
    navAdmin.classList.remove('hidden');
  } else {
    navAdmin.classList.add('hidden');
  }
}

function promptAdminPassword() {
  var password = prompt('Enter admin password:');
  if (password === adminPassword) {
    adminUnlocked = true;
    checkAdminAccess();
    alert('Admin access granted!');
    return true;
  } else if (password !== null) {
    alert('Incorrect password!');
  }
  return false;
}

// Handle navigation clicks
document.addEventListener('click', function(e) {
  var target = e.target;
  
  // Handle navigation links
  if (target.matches('.nav a[data-nav]')) {
    var view = target.getAttribute('href').replace('#', '');
    
    // Special handling for admin view
    if (view === 'admin' && state.auth !== 'admin') {
      e.preventDefault();
      alert('Admin access required. Please sign in as admin.');
      location.hash = '#account';
      return;
    }
    
    // Update highlights after a brief delay to let hash change
    setTimeout(updateNavHighlights, 10);
  }
});

// Handle hash changes (back/forward buttons, direct URL access)
window.addEventListener('hashchange', function() {
  var view = location.hash.replace('#', '');
  
  // Protect admin view access - use authentication state
  if (view === 'admin' && state.auth !== 'admin') {
    alert('Admin access required. Please sign in as admin.');
    location.hash = '#account';
      return;
  }
  
  updateNavHighlights();
});

// Initialize navigation on page load
setTimeout(function() {
  updateNavHighlights();
  checkAdminAccess();
}, 300);

// Helper functions for better UX
function clearSearch() {
  document.getElementById('searchInp').value = '';
  render();
}

function clearFilters() {
  document.getElementById('leagueSel').value = '';
  document.getElementById('marketSel').value = '';
  document.getElementById('minConf').value = '0';
  render();
}

function clearAllFilters() {
  clearFilters();
  clearSearch();
}

// Enhanced confidence calculation
function calculateRealisticConfidence(league, marketType, riskTag, odds) {
  var baseConfidence = 50;
  
  // League reliability bonus
  var leagueBonus = {
    'NFL': 12, 'NBA': 8, 'NHL': 7, 'MLB': 6,
    'CFB': 5, 'CBB': 4, 'MLS': 3, 'UFC': 10
  };
  baseConfidence += leagueBonus[league] || 0;
  
  // Market type difficulty
  var marketBonus = {
    'moneyline': 15, 'spread': 10, 'totals': 8,
    'props': 5, 'player-props': 3, 'team-props': 6, 'alt-lines': 4
  };
  baseConfidence += marketBonus[marketType] || 0;
  
  // Risk assessment (removed for now until criteria is defined)
  // if (riskTag === 'safe') baseConfidence += 12;
  // if (riskTag === 'degen') baseConfidence -= 8;
  
  // Odds impact (favorites vs underdogs)
  if (odds <= -150) baseConfidence += 8;
  if (odds >= 200) baseConfidence -= 5;
  
  // Add realistic variance (¬±7%)
  var variance = Math.floor(Math.random() * 15) - 7;
  
  return Math.max(45, Math.min(95, baseConfidence + variance));
}

// Apply realistic confidence to existing picks on page load
setTimeout(function() {
  picksLive.forEach(function(pick) {
    pick.modelConfidence = calculateRealisticConfidence(
      pick.league, pick.marketType, pick.riskTag, pick.oddsAmerican
    );
  });
  
  picksResults.forEach(function(pick) {
    pick.modelConfidence = calculateRealisticConfidence(
      pick.league, pick.marketType, pick.riskTag, pick.oddsAmerican
    );
  });
  
  // Re-render picks if we're on the picks view
  if (location.hash === '#picks' || location.hash === '') {
    render();
  }
}, 1000);





/* FIREBASE & N8N INTEGRATION READY */

// N8N webhook endpoints (replace with your URLs)
var n8nEndpoints = {
  contact: 'https://your-n8n-instance.com/webhook/contact',
  picks: 'https://your-n8n-instance.com/webhook/picks',
  analytics: 'https://your-n8n-instance.com/webhook/analytics',
  // Add your actual N8N webhook URLs here
  // Example: picks: 'https://your-n8n.com/webhook/mlb-picks'
};

// Firebase initialization (uncomment when ready)
/*
if (typeof firebase !== 'undefined' && firebaseConfig.apiKey) {
  firebase.initializeApp(firebaseConfig);
  var db = firebase.firestore();
  var auth = firebase.auth();
  
  // Replace mock auth with real Firebase Auth
  function authenticateWithGoogle() {
    var provider = new firebase.auth.GoogleAuthProvider();
    return auth.signInWithPopup(provider);
  }
  
  function authenticateWithEmail(email, password) {
    return auth.signInWithEmailAndPassword(email, password);
  }
  
  function createUserWithEmail(email, password) {
    return auth.createUserWithEmailAndPassword(email, password);
  }
}
*/

// N8N webhook functions (ready to use)
async function sendToN8N(endpoint, data) {
  if (!n8nEndpoints[endpoint]) {
    console.warn('N8N endpoint not configured:', endpoint);
    // Fallback for contact form
    if (endpoint === 'contact') {
      alert('Thank you for your message! We\'ll get back to you soon.');
    }
    return null;
  }
  
  try {
    var response = await fetch(n8nEndpoints[endpoint], {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    });
    return await response.json();
  } catch (error) {
    console.error('N8N webhook error:', error);
    showMessage('Connection error. Please try again.', 'error');
    return null;
  }
}

// Ready for real data feeds
async function fetchPicksFromAPI() {
  // Replace static data with real API calls
  return sendToN8N('picks', {action: 'fetch'});
}

async function submitContactToN8N(formData) {
  return sendToN8N('contact', formData);
}

// Enhanced N8N Data Management Functions
async function triggerN8NPicksUpdate() {
  try {
    console.log('üîÑ Triggering N8N picks update...');
    const result = await sendToN8N('picks', {
      action: 'update',
      timestamp: new Date().toISOString(),
      source: 'admin-panel'
    });
    
    if (result.success) {
      console.log('‚úÖ N8N picks update triggered successfully');
      // Reload Firebase data after N8N update
      setTimeout(() => {
        loadFirebaseData();
      }, 2000); // Wait 2 seconds for N8N to process
    }
    
    return result;
  } catch (error) {
    console.error('Error triggering N8N update:', error);
    throw error;
  }
}

async function sendAnalyticsToN8N(analyticsData) {
  try {
    console.log('üìä Sending analytics to N8N...');
    const result = await sendToN8N('analytics', {
      ...analyticsData,
      timestamp: new Date().toISOString(),
      userId: window.auth?.currentUser?.uid || 'anonymous'
    });
    
    return result;
  } catch (error) {
    console.error('Error sending analytics to N8N:', error);
    throw error;
  }
}

// Make N8N functions available globally
window.triggerN8NPicksUpdate = triggerN8NPicksUpdate;
window.sendAnalyticsToN8N = sendAnalyticsToN8N;

// N8N Admin Functions
async function testN8NConnection() {
  try {
    console.log('üîó Testing N8N connection...');
    
    // Test each endpoint
    const results = {};
    for (const [key, endpoint] of Object.entries(n8nEndpoints)) {
      if (endpoint && !endpoint.includes('your-n8n-instance.com')) {
        try {
          const response = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'test', timestamp: new Date().toISOString() })
          });
          results[key] = { status: response.status, ok: response.ok };
        } catch (error) {
          results[key] = { error: error.message };
        }
      } else {
        results[key] = { status: 'not_configured' };
      }
    }
    
    console.log('N8N connection test results:', results);
    return results;
  } catch (error) {
    console.error('N8N connection test failed:', error);
    throw error;
  }
}

function viewN8NLogs() {
  console.log('üìã N8N Logs:');
  console.log('Recent N8N activities:');
  console.log('- Last Firebase data load:', new Date().toLocaleString());
  console.log('- Current picks count:', picksLive.length);
  console.log('- Firebase connection status:', window.firebaseReady ? 'Connected' : 'Disconnected');
  console.log('- N8N endpoints configured:', Object.keys(n8nEndpoints).filter(k => n8nEndpoints[k] && !n8nEndpoints[k].includes('your-n8n-instance.com')));
  
  // Show in UI
  showMessage('N8N logs displayed in console. Check browser console for details.', 'info');
}

function exportData() {
  try {
    const exportData = {
      picks: picksLive,
      results: picksResults,
      timestamp: new Date().toISOString(),
      version: '1.0'
    };
    
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = `confident-picks-export-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    
    URL.revokeObjectURL(url);
    console.log('üì§ Data exported successfully');
    showMessage('Data exported successfully!', 'success');
  } catch (error) {
    console.error('Export failed:', error);
    showMessage('Export failed. Check console for details.', 'error');
  }
}

function importData() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = function(e) {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          console.log('üì• Importing data:', data);
          
          if (data.picks) {
            picksLive = data.picks;
            picksResults = data.results || [];
            picksAll = picksLive.concat(picksResults);
            render();
            console.log('‚úÖ Data imported successfully');
            showMessage('Data imported successfully!', 'success');
            updateAdminDataStatus();
          } else {
            throw new Error('Invalid data format');
          }
        } catch (error) {
          console.error('Import failed:', error);
          showMessage('Import failed. Invalid file format.', 'error');
        }
      };
      reader.readAsText(file);
    }
  };
  input.click();
}

function backupData() {
  try {
    const backupData = {
      picks: picksLive,
      results: picksResults,
      timestamp: new Date().toISOString(),
      backup: true,
      version: '1.0'
    };
    
    // Store in localStorage as backup
    localStorage.setItem('confident-picks-backup', JSON.stringify(backupData));
    
    console.log('üíæ Data backed up to localStorage');
    showMessage('Data backed up to localStorage successfully!', 'success');
  } catch (error) {
    console.error('Backup failed:', error);
    showMessage('Backup failed. Check console for details.', 'error');
  }
}

function clearOldData() {
  const confirmed = confirm(
    'üóëÔ∏è Clear Old Data\n\n' +
    'This will remove old results and keep only recent picks.\n\n' +
    'Are you sure you want to continue?'
  );
  
  if (confirmed) {
    try {
      // Keep only last 30 days of results
      const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
      picksResults = picksResults.filter(pick => {
        const pickDate = new Date(pick.commenceTime);
        return pickDate > thirtyDaysAgo;
      });
      
      picksAll = picksLive.concat(picksResults);
      render();
      
      console.log('üóëÔ∏è Old data cleared successfully');
      showMessage('Old data cleared successfully!', 'success');
      updateAdminDataStatus();
    } catch (error) {
      console.error('Clear old data failed:', error);
      showMessage('Clear old data failed. Check console for details.', 'error');
    }
  }
}

function configureN8NEndpoints() {
  const currentEndpoints = { ...n8nEndpoints };
  
  const picksEndpoint = prompt('Enter N8N Picks Webhook URL:', currentEndpoints.picks);
  const analyticsEndpoint = prompt('Enter N8N Analytics Webhook URL:', currentEndpoints.analytics);
  const contactEndpoint = prompt('Enter N8N Contact Webhook URL:', currentEndpoints.contact);
  
  if (picksEndpoint) n8nEndpoints.picks = picksEndpoint;
  if (analyticsEndpoint) n8nEndpoints.analytics = analyticsEndpoint;
  if (contactEndpoint) n8nEndpoints.contact = contactEndpoint;
  
  // Update UI
  updateN8NEndpointDisplay();
  
  console.log('‚öôÔ∏è N8N endpoints configured:', n8nEndpoints);
  showMessage('N8N endpoints configured successfully!', 'success');
}

function updateN8NEndpointDisplay() {
  const picksEl = document.getElementById('n8nPicksEndpoint');
  const analyticsEl = document.getElementById('n8nAnalyticsEndpoint');
  const contactEl = document.getElementById('n8nContactEndpoint');
  
  if (picksEl) picksEl.textContent = n8nEndpoints.picks || 'Not configured';
  if (analyticsEl) analyticsEl.textContent = n8nEndpoints.analytics || 'Not configured';
  if (contactEl) contactEl.textContent = n8nEndpoints.contact || 'Not configured';
}

function updateAdminDataStatus() {
  const picksCountEl = document.getElementById('adminPicksCount');
  const lastUpdateEl = document.getElementById('adminLastUpdate');
  
  if (picksCountEl) picksCountEl.textContent = picksLive.length;
  if (lastUpdateEl) lastUpdateEl.textContent = new Date().toLocaleString();
  
  updateN8NEndpointDisplay();
}

// Make admin functions available globally
window.testN8NConnection = testN8NConnection;
window.viewN8NLogs = viewN8NLogs;
window.exportData = exportData;
window.importData = importData;
window.backupData = backupData;
window.clearOldData = clearOldData;
window.configureN8NEndpoints = configureN8NEndpoints;
window.updateAdminDataStatus = updateAdminDataStatus;

// QA Dashboard Functions
let qaPicks = []; // Store all picks for QA
let currentQAFilter = 'all';
let selectedPickIds = new Set(); // Track selected picks for bulk actions

async function createNewPick() {
  try {
    console.log('üìù Creating new pick...');
    
    const awayTeam = document.getElementById('qaAwayTeam').value.trim();
    const homeTeam = document.getElementById('qaHomeTeam').value.trim();
    const pick = document.getElementById('qaPick').value.trim();
    const odds = document.getElementById('qaOdds').value.trim();
    const confidence = parseInt(document.getElementById('qaConfidence').value);
    const gameTime = document.getElementById('qaGameTime').value;
    const reasoning = document.getElementById('qaReasoning').value.trim();
    const injuryAlerts = document.getElementById('qaInjuryAlerts').value.trim();

    console.log('Form data:', { awayTeam, homeTeam, pick, odds, confidence, gameTime, reasoning, injuryAlerts });

    // Validation
    if (!awayTeam || !homeTeam || !pick || !odds || !confidence || !gameTime || !reasoning) {
      alert('Please fill in all required fields');
      console.error('‚ùå Validation failed: missing required fields');
      return;
    }

    if (confidence < 1 || confidence > 100) {
      alert('Confidence must be between 1 and 100');
      console.error('‚ùå Validation failed: invalid confidence');
      return;
    }

    const newPick = {
      id: 'qa_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
      awayTeam: awayTeam,
      homeTeam: homeTeam,
      pick: pick,
      odds: odds,
      confidence: confidence,
      gameTime: gameTime,
      reasoning: reasoning,
      injuryAlerts: injuryAlerts,
      status: 'draft', // draft, approved, live, completed, rejected
      createdAt: new Date().toISOString(),
      createdBy: 'manual',
      tier: 'public',
      riskTag: 'safe'
    };

    // Add to local array
    qaPicks.push(newPick);

    // Save to Firebase (use qa_picks collection)
    if (window.db) {
      const { collection, addDoc } = await import('https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js');
      
      // Save to qa_picks collection (QA workflow)
      try {
        const qaPick = {
          awayTeam: newPick.awayTeam,
          homeTeam: newPick.homeTeam,
          prediction: newPick.pick,
          confidence: newPick.confidence / 100,
          reasoning: newPick.reasoning,
          startTime: newPick.gameTime,
          status: 'draft',
          sport: 'MLB',
          market: 'h2h',
          timestamp: new Date().toISOString(),
          createdAt: newPick.createdAt,
          updatedAt: new Date().toISOString(),
          injuryAlerts: newPick.injuryAlerts || '',
          odds: newPick.odds || '-110'
        };
        await addDoc(collection(window.db, 'qa_picks'), qaPick);
        console.log('‚úÖ Pick saved to qa_picks collection');
      } catch (scoringError) {
        console.error('‚ùå Could not save to scoring collection:', scoringError);
        // Still add to local array for testing
        console.log('‚ö†Ô∏è Pick saved locally only (Firebase write failed)');
      }
    } else {
      console.log('‚ö†Ô∏è Firebase not available, pick saved locally only');
    }

    // Clear form
    document.getElementById('qaAwayTeam').value = '';
    document.getElementById('qaHomeTeam').value = '';
    document.getElementById('qaPick').value = '';
    document.getElementById('qaOdds').value = '';
    document.getElementById('qaConfidence').value = '';
    document.getElementById('qaGameTime').value = '';
    document.getElementById('qaReasoning').value = '';
    document.getElementById('qaInjuryAlerts').value = '';

    // Refresh QA dashboard
    updateQAStats();
    loadQAPicks();

    console.log('‚úÖ New pick created:', newPick);
    showMessage('Pick created successfully!', 'success');

  } catch (error) {
    console.error('Error creating pick:', error);
    showMessage('Error creating pick. Check console for details.', 'error');
  }
}

async function loadQAPicks() {
  try {
    if (!window.db) {
      console.log('Firebase not available, using local data');
      renderQAPicks();
      return;
    }

    console.log(`üîÑ Loading QA picks from Firebase (filter: ${currentQAFilter})...`);
    
    qaPicks = [];
    
    if (currentQAFilter === 'all') {
      // Load from ALL collections for "all" filter
      console.log('üìã Loading picks from all collections...');
      
      // Load from qa_picks collection (draft, rejected)
      const qaSnapshot = await getDocs(collection(window.db, 'qa_picks'));
      qaSnapshot.forEach(doc => {
        const data = doc.data();
        const pick = mapFirebaseDataToQAPick(doc.id, data, 'qa_picks');
        qaPicks.push(pick);
      });
      console.log(`‚úÖ Loaded ${qaSnapshot.size} picks from qa_picks collection`);
      
      // Load from live_picks collection
      const liveSnapshot = await getDocs(collection(window.db, 'live_picks'));
      liveSnapshot.forEach(doc => {
        const data = doc.data();
        const pick = mapFirebaseDataToQAPick(doc.id, data, 'live_picks');
        qaPicks.push(pick);
      });
      console.log(`‚úÖ Loaded ${liveSnapshot.size} picks from live_picks collection`);
      
      // Load from scoring collection
      const scoringSnapshot = await getDocs(collection(window.db, 'scoring'));
      scoringSnapshot.forEach(doc => {
        const data = doc.data();
        const pick = mapFirebaseDataToQAPick(doc.id, data, 'scoring');
        qaPicks.push(pick);
      });
      console.log(`‚úÖ Loaded ${scoringSnapshot.size} picks from scoring collection`);
      
      console.log(`üìä Total picks loaded for "all" filter: ${qaPicks.length}`);
      
    } else if (currentQAFilter === 'deleted') {
      // Load from deleted_picks collection
      const snapshot = await getDocs(collection(window.db, 'deleted_picks'));
      snapshot.forEach(doc => {
        const data = doc.data();
        const pick = mapFirebaseDataToQAPick(doc.id, data, 'deleted_picks');
        qaPicks.push(pick);
      });
      console.log(`‚úÖ Loaded ${qaPicks.length} picks from deleted_picks collection`);
    } else if (currentQAFilter === 'live') {
      // Load from live_picks collection
      const snapshot = await getDocs(collection(window.db, 'live_picks'));
      snapshot.forEach(doc => {
        const data = doc.data();
        const pick = mapFirebaseDataToQAPick(doc.id, data, 'live_picks');
        qaPicks.push(pick);
      });
      console.log(`‚úÖ Loaded ${qaPicks.length} picks from live_picks collection`);
    } else if (currentQAFilter === 'scoring') {
      // Load from scoring collection (pending, hit, miss)
      const snapshot = await getDocs(collection(window.db, 'scoring'));
      snapshot.forEach(doc => {
        const data = doc.data();
        const pick = mapFirebaseDataToQAPick(doc.id, data, 'scoring');
        qaPicks.push(pick);
      });
      console.log(`‚úÖ Loaded ${qaPicks.length} picks from scoring collection`);
    } else {
      // Load from qa_picks collection (draft, rejected)
      const snapshot = await getDocs(collection(window.db, 'qa_picks'));
      snapshot.forEach(doc => {
        const data = doc.data();
        const pick = mapFirebaseDataToQAPick(doc.id, data, 'qa_picks');
        qaPicks.push(pick);
      });
      console.log(`‚úÖ Loaded ${qaPicks.length} picks from qa_picks collection`);
    }

    updateQAStats();
    renderQAPicks();

  } catch (error) {
    console.error('Error loading QA picks:', error);
    showMessage('Error loading picks. Check console for details.', 'error');
  }
}

// Helper function to map Firebase data to QA pick format
function mapFirebaseDataToQAPick(docId, data, collectionName) {
  return {
    id: docId,
    awayTeam: data.awayTeam || 'Away Team',
    homeTeam: data.homeTeam || 'Home Team',
    pick: data.prediction || 'Pick',
    odds: data.vegasOdds?.[0]?.price || data.odds || '-110',
    confidence: Math.round((data.confidence || 0) * 100),
    gameTime: data.startTime || data.commenceTime || new Date().toISOString(),
    reasoning: data.reasoning || data.consensus?.prediction || 'No reasoning available',
    injuryAlerts: data.injuryAlerts || '',
    status: data.status || 'draft',
    createdAt: data.timestamp || data.createdAt || new Date().toISOString(),
    createdBy: 'firebase',
    // Preserve original Firebase fields
    sport: data.sport || 'MLB',
    market: data.market || 'h2h',
    originalCollection: collectionName,
    // For deleted picks, preserve deletion metadata
    deletedAt: data.deletedAt,
    originalId: data.originalId,
    deletedBy: data.deletedBy,
    deletionReason: data.deletionReason
  };
}

function renderQAPicks() {
  console.log('üé® Rendering QA picks...');
  console.log('QA picks array:', qaPicks);
  console.log('Current filter:', currentQAFilter);
  
  const picksList = document.getElementById('qaPicksList');
  console.log('Picks list element:', picksList);
  
  if (!picksList) {
    console.error('‚ùå qaPicksList element not found!');
    return;
  }

  let filteredPicks = qaPicks;
  if (currentQAFilter !== 'all') {
    if (currentQAFilter === 'draft') {
      // Show both draft and pending picks (but not scoring pending)
      filteredPicks = qaPicks.filter(pick => 
        (pick.status === 'draft' || pick.status === 'pending') && 
        pick.originalCollection !== 'scoring'
      );
    } else if (currentQAFilter === 'live') {
      // Show live picks
      filteredPicks = qaPicks.filter(pick => pick.status === 'live' || pick.originalCollection === 'live_picks');
    } else if (currentQAFilter === 'rejected') {
      // Show rejected picks
      filteredPicks = qaPicks.filter(pick => pick.status === 'rejected');
    } else if (currentQAFilter === 'scoring') {
      // Show only pending picks in scoring (not already scored)
      filteredPicks = qaPicks.filter(pick => 
        pick.originalCollection === 'scoring' && 
        (pick.status === 'pending' || pick.status === 'draft')
      );
    } else if (currentQAFilter === 'deleted') {
      // Show deleted picks
      filteredPicks = qaPicks.filter(pick => pick.originalCollection === 'deleted_picks');
    } else {
      // Default: filter by status
      filteredPicks = qaPicks.filter(pick => pick.status === currentQAFilter);
    }
  }

  console.log('Filtered picks:', filteredPicks);

  if (filteredPicks.length === 0) {
    picksList.innerHTML = '<div style="text-align:center;padding:20px;color:#888;">No picks found</div>';
    console.log('üìù No picks to display');
    return;
  }

  const html = filteredPicks.map(pick => {
    console.log('Rendering pick:', pick);
    const isEditing = window.editingPickId === pick.id;
    const isSelected = selectedPickIds.has(pick.id);
    
    return `
      <div class="card pick-card-selectable" data-pick-id="${pick.id}" style="margin-bottom:16px;border:2px solid ${isSelected ? '#4CAF50' : 'rgba(255,255,255,0.1)'};border-radius:8px;padding:16px;background:${isSelected ? 'rgba(76,175,80,0.05)' : 'transparent'};transition:all 0.2s ease;">
        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;">
          <div style="display:flex;gap:12px;align-items:start;flex:1;">
            <label style="display:flex;align-items:center;cursor:pointer;margin-top:4px;">
              <input type="checkbox" class="pick-select-checkbox" data-pick-id="${pick.id}" ${isSelected ? 'checked' : ''} style="width:18px;height:18px;cursor:pointer;accent-color:#4CAF50;">
            </label>
            <div style="flex:1;">
              <h4 style="margin:0 0 4px 0;color:#fff;">${pick.awayTeam || 'Unknown'} vs ${pick.homeTeam || 'Unknown'}</h4>
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                <span style="padding:4px 8px;border-radius:4px;font-size:11px;font-weight:500;background:${getStatusColor(pick.status)};color:white;">${pick.status.toUpperCase()}</span>
                <span style="padding:2px 6px;border-radius:3px;font-size:10px;font-weight:400;background:rgba(255,255,255,0.1);color:#ccc;font-family:monospace;">ID: ${pick.id}</span>
                ${isEditing ? '<span style="padding:2px 6px;border-radius:3px;font-size:10px;font-weight:500;background:rgba(255,193,7,0.2);color:#ffc107;border:1px solid #ffc107;">‚úèÔ∏è EDITING</span>' : ''}
              </div>
            </div>
          </div>
          <div style="font-size:12px;color:#999;">${new Date(pick.createdAt).toLocaleString()}</div>
        </div>
        
        ${isEditing ? `
          <!-- Edit Form -->
          <div style="margin-bottom:16px;">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
              <div>
                <label style="display:block;color:#888;font-size:12px;margin-bottom:4px;">Away Team</label>
                <input type="text" id="editAwayTeam_${pick.id}" value="${pick.awayTeam || ''}" style="width:100%;padding:8px;border-radius:4px;border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.3);color:white;">
              </div>
              <div>
                <label style="display:block;color:#888;font-size:12px;margin-bottom:4px;">Home Team</label>
                <input type="text" id="editHomeTeam_${pick.id}" value="${pick.homeTeam || ''}" style="width:100%;padding:8px;border-radius:4px;border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.3);color:white;">
              </div>
              <div>
                <label style="display:block;color:#888;font-size:12px;margin-bottom:4px;">Pick</label>
                <input type="text" id="editPick_${pick.id}" value="${pick.pick || ''}" style="width:100%;padding:8px;border-radius:4px;border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.3);color:white;">
              </div>
              <div>
                <label style="display:block;color:#888;font-size:12px;margin-bottom:4px;">Odds</label>
                <input type="text" id="editOdds_${pick.id}" value="${pick.odds || ''}" style="width:100%;padding:8px;border-radius:4px;border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.3);color:white;">
              </div>
              <div>
                <label style="display:block;color:#888;font-size:12px;margin-bottom:4px;">Confidence %</label>
                <input type="number" id="editConfidence_${pick.id}" value="${pick.confidence || ''}" min="1" max="100" style="width:100%;padding:8px;border-radius:4px;border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.3);color:white;">
              </div>
              <div>
                <label style="display:block;color:#888;font-size:12px;margin-bottom:4px;">Game Time</label>
                <input type="datetime-local" id="editGameTime_${pick.id}" value="${new Date(pick.gameTime).toISOString().slice(0, 16)}" style="width:100%;padding:8px;border-radius:4px;border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.3);color:white;">
              </div>
            </div>
            <div style="margin-bottom:12px;">
              <label style="display:block;color:#888;font-size:12px;margin-bottom:4px;">Reasoning</label>
              <textarea id="editReasoning_${pick.id}" style="width:100%;padding:8px;border-radius:4px;border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.3);color:white;height:60px;resize:vertical;">${pick.reasoning || ''}</textarea>
            </div>
            <div style="margin-bottom:12px;">
              <label style="display:block;color:#888;font-size:12px;margin-bottom:4px;">Injury Alerts (optional)</label>
              <input type="text" id="editInjuryAlerts_${pick.id}" value="${pick.injuryAlerts || ''}" style="width:100%;padding:8px;border-radius:4px;border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.3);color:white;">
            </div>
            <div style="display:flex;gap:8px;">
              <button type="button" class="btn enhanced" style="background:#2d5a2d;border:1px solid #4caf50;" onclick="savePickEdit('${pick.id}')">Save Changes</button>
              <button type="button" class="btn enhanced" style="background:#3a3a3a;border:1px solid #666;" onclick="cancelPickEdit('${pick.id}')">Cancel</button>
            </div>
          </div>
        ` : `
          <!-- Display Mode -->
          <div style="margin-bottom:8px;color:#ccc;">
            <span style="color:#888;">Pick:</span> <strong>${pick.pick || 'No pick'}</strong> | 
            <span style="color:#888;">Odds:</span> <strong>${pick.odds || 'N/A'}</strong> | 
            <span style="color:#888;">Confidence:</span> <strong>${pick.confidence || 0}%</strong>
          </div>
          
          <div style="margin-bottom:8px;color:#ccc;">
            <span style="color:#888;">Game Time:</span> ${new Date(pick.gameTime).toLocaleString()}
          </div>
          
          <div style="margin-bottom:12px;color:#ccc;">
            <span style="color:#888;">Reasoning:</span> ${pick.reasoning || 'No reasoning provided'}
          </div>
          
          ${pick.injuryAlerts ? `<div style="margin-bottom:12px;padding:8px;background:rgba(255,107,107,0.1);border-left:3px solid #ff6b6b;color:#ff6b6b;"><strong>Injury Alert:</strong> ${pick.injuryAlerts}</div>` : ''}
        `}
        
        <!-- Action Checkboxes -->
        <div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap;">
          ${pick.originalCollection === 'scoring' ? `
            <!-- Scoring Actions -->
            <label style="display:flex;align-items:center;gap:6px;color:#ccc;cursor:pointer;padding:4px 8px;border-radius:4px;background:${pick.status === 'hit' ? 'rgba(76,175,80,0.1)' : 'transparent'};border:1px solid ${pick.status === 'hit' ? '#4caf50' : 'transparent'};">
              <input type="checkbox" id="hit_${pick.id}" onchange="handleScoringCheckbox('${pick.id}', 'hit', this.checked)" ${pick.status === 'hit' ? 'checked' : ''} style="accent-color:#4caf50;transform:scale(1.2);">
              <span style="color:${pick.status === 'hit' ? '#4caf50' : '#4caf50'};font-weight:${pick.status === 'hit' ? 'bold' : 'normal'};">‚úÖ Hit</span>
            </label>
            <label style="display:flex;align-items:center;gap:6px;color:#ccc;cursor:pointer;padding:4px 8px;border-radius:4px;background:${pick.status === 'miss' ? 'rgba(244,67,54,0.1)' : 'transparent'};border:1px solid ${pick.status === 'miss' ? '#f44336' : 'transparent'};">
              <input type="checkbox" id="miss_${pick.id}" onchange="handleScoringCheckbox('${pick.id}', 'miss', this.checked)" ${pick.status === 'miss' ? 'checked' : ''} style="accent-color:#f44336;transform:scale(1.2);">
              <span style="color:${pick.status === 'miss' ? '#f44336' : '#f44336'};font-weight:${pick.status === 'miss' ? 'bold' : 'normal'};">‚ùå Miss</span>
            </label>
            <label style="display:flex;align-items:center;gap:6px;color:#ccc;cursor:pointer;padding:4px 8px;border-radius:4px;">
              <input type="checkbox" id="edit_${pick.id}" onchange="handleActionCheckbox('${pick.id}', 'edit', this.checked)" style="accent-color:#666;transform:scale(1.2);">
              <span style="color:#666;">‚úèÔ∏è Edit</span>
            </label>
          ` : `
            <!-- Regular QA Actions -->
            <label style="display:flex;align-items:center;gap:6px;color:#ccc;cursor:pointer;padding:4px 8px;border-radius:4px;background:${pick.status === 'live' ? 'rgba(76,175,80,0.1)' : 'transparent'};border:1px solid ${pick.status === 'live' ? '#4caf50' : 'transparent'};">
              <input type="checkbox" id="approve_${pick.id}" onchange="handleActionCheckbox('${pick.id}', 'approve', this.checked)" ${pick.status === 'live' ? 'checked' : ''} style="accent-color:#4caf50;transform:scale(1.2);">
              <span style="color:${pick.status === 'live' ? '#4caf50' : '#4caf50'};font-weight:${pick.status === 'live' ? 'bold' : 'normal'};">‚úì Approve</span>
            </label>
            <label style="display:flex;align-items:center;gap:6px;color:#ccc;cursor:pointer;padding:4px 8px;border-radius:4px;background:${pick.status === 'rejected' ? 'rgba(244,67,54,0.1)' : 'transparent'};border:1px solid ${pick.status === 'rejected' ? '#f44336' : 'transparent'};">
              <input type="checkbox" id="reject_${pick.id}" onchange="handleActionCheckbox('${pick.id}', 'reject', this.checked)" ${pick.status === 'rejected' ? 'checked' : ''} style="accent-color:#f44336;transform:scale(1.2);">
              <span style="color:${pick.status === 'rejected' ? '#f44336' : '#f44336'};font-weight:${pick.status === 'rejected' ? 'bold' : 'normal'};">‚úó Reject</span>
            </label>
            <label style="display:flex;align-items:center;gap:6px;color:#ccc;cursor:pointer;padding:4px 8px;border-radius:4px;">
              <input type="checkbox" id="edit_${pick.id}" onchange="handleActionCheckbox('${pick.id}', 'edit', this.checked)" style="accent-color:#666;transform:scale(1.2);">
              <span style="color:#666;">‚úèÔ∏è Edit</span>
            </label>
          `}
          <button type="button" class="btn enhanced" style="background:#5a2d2d;border:1px solid #f44336;padding:4px 8px;font-size:12px;" onclick="deletePick('${pick.id}')">üóëÔ∏è Delete</button>
          <button type="button" class="btn enhanced" style="background:#3a3a3a;border:1px solid #666;padding:4px 8px;font-size:10px;" onclick="debugSaveEdit('${pick.id}')">üîç Debug</button>
        </div>
      </div>
    `;
  }).join('');

  console.log('Generated HTML length:', html.length);
  picksList.innerHTML = html;
  console.log('‚úÖ QA picks rendered successfully');
  
  // Update selection UI after rendering
  updateSelectionUI();
}

function getStatusColor(status) {
  const colors = {
    draft: '#8b5a2b',      // Muted orange
    pending: '#8b5a2b',    // Same as draft (muted orange)
    approved: '#2d5a2d',   // Muted green
    live: '#5a2d2d',       // Muted red
    completed: '#2d3d5a',  // Muted blue
    rejected: '#4a4a4a'    // Muted gray
  };
  return colors[status] || '#4a4a4a';
}

function filterQAPicks(status) {
  currentQAFilter = status;
  
  // Clear selections when filter changes
  selectedPickIds.clear();
  
  // Show/hide scoring actions panel
  const scoringActions = document.getElementById('scoringActions');
  if (scoringActions) {
    if (status === 'scoring') {
      scoringActions.classList.remove('hidden');
    } else {
      scoringActions.classList.add('hidden');
    }
  }
  
  // Show/hide completed scores section
  const completedScoresSection = document.getElementById('completedScoresSection');
  if (completedScoresSection) {
    if (status === 'scoring') {
      completedScoresSection.classList.remove('hidden');
      loadCompletedScores(); // Load completed scores when showing scoring tab
    } else {
      completedScoresSection.classList.add('hidden');
    }
  }
  
  // Hide unnecessary sections for scoring tab
  const bulkActions = document.querySelector('.card:nth-of-type(3)'); // Bulk actions card
  const createPickSection = document.getElementById('createPickForm')?.closest('.card');
  const uploadSection = document.querySelector('[id*="json"]')?.closest('.card');
  
  if (status === 'scoring') {
    if (bulkActions) bulkActions.style.display = 'none';
    if (createPickSection) createPickSection.style.display = 'none';
    if (uploadSection) uploadSection.style.display = 'none';
  } else {
    if (bulkActions) bulkActions.style.display = 'block';
    if (createPickSection) createPickSection.style.display = 'block';
    if (uploadSection) uploadSection.style.display = 'block';
  }
  
  // Update button states
  document.querySelectorAll('[id^="qaFilter"]').forEach(btn => {
    btn.classList.remove('primary');
  });
  
  // Handle 'all' filter separately as it doesn't have a specific status name
  const filterButtonId = status === 'all' ? 'qaFilterAll' : `qaFilter${status.charAt(0).toUpperCase() + status.slice(1)}`;
  const filterButton = document.getElementById(filterButtonId);
  if (filterButton) {
    filterButton.classList.add('primary');
  }
  
  loadQAPicks(); // Reload picks based on the new filter
}

function updateQAStats() {
  const stats = {
    draft: qaPicks.filter(p => p.status === 'draft' || p.status === 'pending').length,
    live: qaPicks.filter(p => p.status === 'live').length,
    rejected: qaPicks.filter(p => p.status === 'rejected').length,
    scoring: qaPicks.filter(p => p.status === 'hit' || p.status === 'miss' || (p.status === 'pending' && p.originalCollection === 'scoring')).length
  };

  document.getElementById('qaDraftCount').textContent = stats.draft;
  document.getElementById('qaLiveCount').textContent = stats.live;
  document.getElementById('qaRejectedCount').textContent = stats.rejected;
  document.getElementById('qaScoringCount').textContent = stats.scoring;
}

// New function: Approve and make live in one step
async function approveAndMakeLive(pickId) {
  try {
    const pick = qaPicks.find(p => p.id === pickId);
    if (!pick) return;

    console.log('‚úÖ Approving and making live pick:', pickId);

    // Update local pick
    pick.status = 'live';
    pick.approvedAt = new Date().toISOString();
    pick.liveAt = new Date().toISOString();

    // Move pick from scoring to live_picks collection
    if (window.db) {
      const { doc, updateDoc, addDoc, deleteDoc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js');
      
      try {
        // 1. Get the pick data from qa_picks collection
        const qaPickRef = doc(window.db, 'qa_picks', pickId);
        const qaPickSnap = await getDoc(qaPickRef);
        
        if (qaPickSnap.exists()) {
          const pickData = qaPickSnap.data();
          
          // 2. Add to live_picks collection with live status
          const livePickData = {
            ...pickData,
            status: 'live',
            approvedAt: pick.approvedAt,
            liveAt: pick.liveAt,
            movedToLive: new Date().toISOString()
          };
          
          await addDoc(collection(window.db, 'live_picks'), livePickData);
          console.log('‚úÖ Pick moved to live_picks collection');
          
          // 3. Delete from qa_picks collection
          await deleteDoc(qaPickRef);
          console.log('‚úÖ Pick removed from qa_picks collection');
        } else {
          console.warn(`Pick ${pickId} not found in qa_picks collection`);
        }
      } catch (error) {
        console.error('Error moving pick to live_picks:', error);
        // Fallback: just update status in scoring collection
        await updateDoc(doc(window.db, 'scoring', pickId), { 
          status: 'live', 
          approvedAt: pick.approvedAt,
          liveAt: pick.liveAt
        });
      }
    }

    updateQAStats();
    renderQAPicks();
    console.log('‚úÖ Pick approved and made live successfully');
    showMessage('Pick approved and is now live!', 'success');

  } catch (error) {
    console.error('Error approving and making live pick:', error);
    showMessage('Error approving pick. Check console for details.', 'error');
  }
}

// Legacy function - now redirects to approveAndMakeLive
async function approvePick(pickId) {
  console.log('‚ö†Ô∏è approvePick called - redirecting to approveAndMakeLive');
  await approveAndMakeLive(pickId);
}

async function rejectPick(pickId) {
  try {
    const pick = qaPicks.find(p => p.id === pickId);
    if (!pick) {
      console.error('‚ùå Pick not found:', pickId);
      alert('Pick not found in current view');
      return;
    }

    console.log('‚ùå Rejecting pick:', pickId);
    console.log('Pick details:', pick);
    console.log('Original collection:', pick.originalCollection);
    
    pick.status = 'rejected';
    pick.rejectedAt = new Date().toISOString();

    // Update Firebase - determine correct collection based on originalCollection
    if (window.db) {
      const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js');
      
      // Use the original collection to update the correct document
      const collectionName = pick.originalCollection || 'qa_picks';
      console.log(`Updating pick ${pickId} in collection: ${collectionName}`);
      
      await updateDoc(doc(window.db, collectionName, pickId), { 
        status: 'rejected', 
        rejectedAt: pick.rejectedAt
      });
      
      console.log(`‚úÖ Pick ${pickId} rejected in ${collectionName} collection`);
    }

    updateQAStats();
    renderQAPicks();
    console.log('‚úÖ Pick rejected successfully');
    showMessage('Pick rejected!', 'success');

  } catch (error) {
    console.error('‚ùå Error rejecting pick:', error);
    console.error('Error details:', error.message);
    console.error('Stack trace:', error.stack);
    showMessage('Error rejecting pick. Check console for details.', 'error');
  }
}

// Legacy function - no longer needed since approve directly makes live
async function makeLive(pickId) {
  console.log('‚ö†Ô∏è makeLive called - this function is deprecated. Use approveAndMakeLive instead.');
  await approveAndMakeLive(pickId);
}

// Legacy editPick function - now handled by inline editing system
async function editPick(pickId) {
  console.log('‚ö†Ô∏è editPick called - use checkbox edit instead');
  startEditPick(pickId);
}

async function deletePick(pickId, skipConfirm = false) {
  console.log(`üóëÔ∏è deletePick called with skipConfirm=${skipConfirm} for pick ${pickId}`);
  if (!skipConfirm && !confirm('Are you sure you want to delete this pick?')) {
    console.log('‚ùå User cancelled deletion');
    return;
  }

  try {
    console.log('üóëÔ∏è Soft-deleting pick:', pickId);
    
    // Find the pick in the current QA picks to determine which collection it's in
    const currentPick = qaPicks.find(p => p.id === pickId);
    if (!currentPick) {
      alert(`‚ö†Ô∏è Pick ${pickId} not found in current view`);
      return;
    }
    
    const sourceCollection = currentPick.originalCollection || 'qa_picks';
    console.log(`üìç Pick is in collection: ${sourceCollection}`);
    
    // 1. Fetch the pick data from the correct collection
    const pickRef = doc(window.db, sourceCollection, pickId);
    const pickSnap = await getDoc(pickRef);

    if (pickSnap.exists()) {
      const pickData = pickSnap.data();
      
      // 2. Add to deleted_picks collection with deletion metadata
      await addDoc(collection(window.db, 'deleted_picks'), {
        ...pickData,
        deletedAt: serverTimestamp(),
        originalId: pickId,
        originalCollection: sourceCollection,
        deletedBy: 'admin',
        deletionReason: `Manual deletion via QA Dashboard (from ${sourceCollection})`
      });
      console.log(`üóëÔ∏è Moved pick ${pickId} from ${sourceCollection} to deleted_picks collection`);

      // 3. Delete from source collection
      await deleteDoc(pickRef);
      console.log(`üóëÔ∏è Deleted pick ${pickId} from ${sourceCollection} collection`);
      
      // Only show alert for individual deletions, not bulk operations
      if (!skipConfirm) {
        alert(`‚úÖ Pick moved to deleted items`);
      }
    } else {
      console.warn(`Pick ${pickId} not found in ${sourceCollection} collection`);
      if (!skipConfirm) {
        alert(`‚ö†Ô∏è Pick ${pickId} not found in ${sourceCollection}`);
      }
    }

    // 4. Reload QA picks to reflect changes
    await loadQAPicks();

  } catch (error) {
    console.error('Error soft-deleting pick:', error);
    if (!skipConfirm) {
      alert(`‚ùå Failed to delete pick: ${error.message}`);
    }
  }
}

// Make QA functions available globally
window.createNewPick = createNewPick;
window.loadQAPicks = loadQAPicks;
window.filterQAPicks = filterQAPicks;
window.approvePick = approvePick;
window.rejectPick = rejectPick;
window.makeLive = makeLive;
window.editPick = editPick;
window.deletePick = deletePick;

// Handle checkbox actions
window.handleActionCheckbox = function(pickId, action, isChecked) {
  if (!isChecked) return; // Only handle when checked
  
  // For approve/reject, uncheck the opposite action
  if (action === 'approve') {
    const rejectCheckbox = document.getElementById(`reject_${pickId}`);
    if (rejectCheckbox) rejectCheckbox.checked = false;
  } else if (action === 'reject') {
    const approveCheckbox = document.getElementById(`approve_${pickId}`);
    if (approveCheckbox) approveCheckbox.checked = false;
  }
  
  // For edit, uncheck all other checkboxes
  if (action === 'edit') {
    const checkboxes = document.querySelectorAll(`input[type="checkbox"][id$="_${pickId}"]`);
    checkboxes.forEach(cb => {
      if (cb.id !== `${action}_${pickId}`) {
        cb.checked = false;
      }
    });
  }
  
  // Handle the action
  switch(action) {
    case 'approve':
      approveAndMakeLive(pickId);
      break;
    case 'reject':
      rejectPick(pickId);
      break;
    case 'edit':
      startEditPick(pickId);
      break;
  }
};

// Handle scoring checkbox changes (hit/miss)
window.handleScoringCheckbox = async function(pickId, action, isChecked) {
  console.log(`üéØ Scoring checkbox changed: ${pickId} - ${action} - ${isChecked}`);
  
  if (!isChecked) return; // Only handle when checked
  
  try {
    // Clear other checkboxes for the same pick
    if (action === 'hit') {
      const missCheckbox = document.getElementById(`miss_${pickId}`);
      const editCheckbox = document.getElementById(`edit_${pickId}`);
      if (missCheckbox) missCheckbox.checked = false;
      if (editCheckbox) editCheckbox.checked = false;
    } else if (action === 'miss') {
      const hitCheckbox = document.getElementById(`hit_${pickId}`);
      const editCheckbox = document.getElementById(`edit_${pickId}`);
      if (hitCheckbox) hitCheckbox.checked = false;
      if (editCheckbox) editCheckbox.checked = false;
    }
    
    // Update the pick status in Firebase
    const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js');
    
    await updateDoc(doc(window.db, 'scoring', pickId), {
      status: action, // 'hit' or 'miss'
      scoredAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    });
    
    console.log(`‚úÖ Pick ${pickId} marked as ${action}`);
    showMessage(`Pick marked as ${action}!`, 'success');
    
    // Reload QA picks to reflect the change
    loadQAPicks();
    
    // Refresh scorecard if it's currently visible
    refreshScorecard();
    
    // Refresh completed scores if scoring tab is active
    if (currentQAFilter === 'scoring') {
      loadCompletedScores();
    }
    
  } catch (error) {
    console.error('‚ùå Error updating scoring:', error);
    showMessage('Error updating pick result. Check console for details.', 'error');
  }
};

// Start editing a pick
window.startEditPick = function(pickId) {
  window.editingPickId = pickId;
  renderQAPicks(); // Re-render to show edit form
};

// Save pick edit
window.savePickEdit = async function(pickId) {
  try {
    console.log('üíæ Starting to save pick edit for:', pickId);
    
    // Check if we're in edit mode
    if (window.editingPickId !== pickId) {
      alert('Please check the "‚úèÔ∏è Edit" checkbox first to enter edit mode, then make your changes and save.');
      console.error('‚ùå Not in edit mode. Current editing ID:', window.editingPickId, 'Requested ID:', pickId);
      return;
    }
    
    // Get form values
    const awayTeam = document.getElementById(`editAwayTeam_${pickId}`)?.value;
    const homeTeam = document.getElementById(`editHomeTeam_${pickId}`)?.value;
    const pick = document.getElementById(`editPick_${pickId}`)?.value;
    const odds = document.getElementById(`editOdds_${pickId}`)?.value;
    const confidence = parseInt(document.getElementById(`editConfidence_${pickId}`)?.value);
    const gameTime = document.getElementById(`editGameTime_${pickId}`)?.value;
    const reasoning = document.getElementById(`editReasoning_${pickId}`)?.value;
    const injuryAlerts = document.getElementById(`editInjuryAlerts_${pickId}`)?.value;

    console.log('üìù Form values:', { awayTeam, homeTeam, pick, odds, confidence, gameTime, reasoning, injuryAlerts });

    if (!awayTeam || !homeTeam || !pick || !odds || !confidence || !gameTime) {
      alert('Please fill in all required fields');
      console.error('‚ùå Missing required fields');
      return;
    }

    const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js');
    
    // Map to Firebase field names (matching the original structure)
    const updateData = {
      awayTeam,
      homeTeam,
      prediction: pick, // Firebase uses 'prediction' not 'pick'
      odds,
      confidence: confidence / 100, // Firebase stores as decimal (0.8 not 80)
      gameTime: new Date(gameTime).toISOString(),
      consensus: { prediction: reasoning }, // Firebase uses nested structure
      injuryAlerts: injuryAlerts || null,
      updatedAt: new Date().toISOString()
    };

    console.log('üî• Firebase update data:', updateData);

    // Update in the correct collection based on pick's original collection
    const currentPick = qaPicks.find(p => p.id === pickId);
    const targetCollection = currentPick?.originalCollection || 'qa_picks';
    
    try {
      await updateDoc(doc(window.db, targetCollection, pickId), updateData);
      console.log(`‚úÖ Pick updated in ${targetCollection} collection`);
    } catch (error) {
      console.error(`‚ùå Failed to update pick in ${targetCollection} collection:`, error);
      throw error;
    }

    // Update local array with the same field mapping
    const pickIndex = qaPicks.findIndex(p => p.id === pickId);
    if (pickIndex !== -1) {
      qaPicks[pickIndex] = { 
        ...qaPicks[pickIndex], 
        awayTeam,
        homeTeam,
        pick, // Keep local field as 'pick' for display
        odds,
        confidence,
        gameTime: new Date(gameTime).toISOString(),
        reasoning,
        injuryAlerts: injuryAlerts || null,
        updatedAt: new Date().toISOString()
      };
      console.log('‚úÖ Local array updated');
    }

    // Exit edit mode
    window.editingPickId = null;
    renderQAPicks();
    updateQAStats();
    
    console.log('‚úÖ Pick updated successfully');
    showMessage('Pick updated successfully!', 'success');
  } catch (error) {
    console.error('‚ùå Error updating pick:', error);
    alert('Error updating pick: ' + error.message);
  }
};

// Cancel pick edit
window.cancelPickEdit = function(pickId) {
  window.editingPickId = null;
  renderQAPicks(); // Re-render to hide edit form
};

// Toggle create pick panel
window.toggleCreatePickPanel = function() {
  const form = document.getElementById('createPickForm');
  const toggle = document.getElementById('createPickToggle');
  
  if (form.style.display === 'none') {
    form.style.display = 'block';
    toggle.textContent = '‚ñ≤';
    toggle.style.transform = 'rotate(0deg)';
  } else {
    form.style.display = 'none';
    toggle.textContent = '‚ñº';
    toggle.style.transform = 'rotate(0deg)';
  }
};

// Toggle JSON upload panel
window.toggleJSONUploadPanel = function() {
  const form = document.getElementById('jsonUploadForm');
  const toggle = document.getElementById('jsonUploadToggle');
  
  if (form.style.display === 'none') {
    form.style.display = 'block';
    toggle.textContent = '‚ñ≤';
    toggle.style.transform = 'rotate(0deg)';
  } else {
    form.style.display = 'none';
    toggle.textContent = '‚ñº';
    toggle.style.transform = 'rotate(0deg)';
  }
};

// Toggle backup panel
window.toggleBackupPanel = function() {
  const form = document.getElementById('backupForm');
  const toggle = document.getElementById('backupToggle');
  
  if (form.style.display === 'none') {
    form.style.display = 'block';
    toggle.textContent = '‚ñ≤';
    toggle.style.transform = 'rotate(0deg)';
  } else {
    form.style.display = 'none';
    toggle.textContent = '‚ñº';
    toggle.style.transform = 'rotate(0deg)';
  }
};

// Parse NDJSON data
function parseNDJSONData(text) {
  try {
    const lines = text.trim().split('\n').filter(line => line.trim());
    const picks = [];
    
    for (const line of lines) {
      try {
        const pick = JSON.parse(line);
        picks.push(pick);
      } catch (e) {
        console.warn('‚ö†Ô∏è Skipping invalid JSON line:', line);
      }
    }
    
    return picks;
  } catch (e) {
    throw new Error('Invalid NDJSON format: ' + e.message);
  }
}

// Convert UFC pick to improved Firebase format
function convertUFCPickToAppFormat(ufcPick) {
  console.log('üîÑ Converting UFC pick:', ufcPick);
  
  // Extract fighter names from fight string
  const fightParts = ufcPick.fight ? ufcPick.fight.split(' vs ') : ['Fighter 1', 'Fighter 2'];
  const [fighter1, fighter2] = fightParts;
  
  console.log('üë• Extracted fighters:', { fighter1, fighter2 });
  console.log('üéØ Confidence conversion:', ufcPick.confidence, '‚Üí', (ufcPick.confidence || 50) / 100);
  console.log('üí≠ Reasoning source:', ufcPick.llmPredictions?.openai?.reasoning || ufcPick.reasoning);
  console.log('üìÖ Original startTime:', ufcPick.startTime);
  console.log('üí∞ Original odds:', ufcPick.odds);
  console.log('üè∑Ô∏è Market type:', ufcPick.market);
  
  // Convert odds format from your structure to our format
  let convertedOdds = [];
  if (ufcPick.odds && Array.isArray(ufcPick.odds)) {
    // Handle array format: [{"name":"Fighter 1","price":-250},{"name":"Fighter 2","price":205}]
    // For H2H markets
    if (ufcPick.market === 'h2h') {
      const fighter1Odd = ufcPick.odds.find(odd => odd.name === fighter1);
      const fighter2Odd = ufcPick.odds.find(odd => odd.name === fighter2);
      
      convertedOdds = [{
        bookmaker: 'DraftKings',
        awayOdds: fighter1Odd ? fighter1Odd.price : null,
        homeOdds: fighter2Odd ? fighter2Odd.price : null,
        drawOdds: null
      }];
    } else if (ufcPick.market === 'total') {
      // For totals: [{"name":"Over 1.5","price":-145},{"name":"Under 1.5","price":114}]
      const overOdd = ufcPick.odds.find(odd => odd.name.startsWith('Over'));
      const underOdd = ufcPick.odds.find(odd => odd.name.startsWith('Under'));
      
      convertedOdds = [{
        bookmaker: 'DraftKings',
        awayOdds: overOdd ? overOdd.price : null,
        homeOdds: underOdd ? underOdd.price : null,
        drawOdds: null
      }];
    } else {
      // Fallback for other markets
      convertedOdds = ufcPick.odds.map(odd => ({
        bookmaker: 'DraftKings',
        name: odd.name,
        price: odd.price
      }));
    }
  } else if (ufcPick.odds && ufcPick.odds.leg1) {
    // Handle SGP format
    convertedOdds = [{
      bookmaker: 'DraftKings',
      sgp: true,
      leg1: ufcPick.odds.leg1,
      leg2: ufcPick.odds.leg2,
      combinedUS: ufcPick.odds.combinedUS,
      combinedDecimal: ufcPick.odds.combinedDecimal
    }];
  }
  
  console.log('‚úÖ Converted odds:', convertedOdds);
  
  // Improved Firebase format (what gets stored in qa_picks collection)
  const convertedPick = {
    id: ufcPick.id || `ufc_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
    awayTeam: fighter1,
    homeTeam: fighter2,
    fight: ufcPick.fight || `${fighter1} vs ${fighter2}`,
    prediction: ufcPick.prediction || 'Unknown',
    confidence: (ufcPick.confidence || 50) / 100, // Convert percentage to decimal (65% -> 0.65)
    startTime: ufcPick.startTime || new Date().toISOString(),
    market: ufcPick.market || 'h2h',
    odds: convertedOdds,
    reasoning: ufcPick.llmPredictions?.openai?.reasoning || ufcPick.reasoning || 'No reasoning provided',
    methodLean: ufcPick.methodLean || null,
    status: 'draft', // All uploaded picks start as draft
    sport: ufcPick.sport || 'UFC',
    league: ufcPick.sport || 'UFC',
    event: ufcPick.event || 'Unknown Event',
    gameId: ufcPick.gameId || null,
    tier: 'public',
    riskTag: 'safe',
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
    createdBy: 'json_upload'
  };
  
  console.log('‚úÖ Converted pick:', convertedPick);
  return convertedPick;
}

// Preview JSON upload
window.previewJSONUpload = function() {
  const textarea = document.getElementById('jsonUploadTextarea');
  const preview = document.getElementById('jsonUploadPreview');
  const content = document.getElementById('jsonPreviewContent');
  
  if (!textarea.value.trim()) {
    alert('Please paste NDJSON data first');
    return;
  }
  
  try {
    console.log('üëÅÔ∏è Parsing NDJSON data...');
    console.log('Raw text length:', textarea.value.length);
    console.log('Raw text preview:', textarea.value.substring(0, 200));
    
    const picks = parseNDJSONData(textarea.value);
    console.log('Parsed picks count:', picks.length);
    console.log('Parsed picks:', picks);
    
    if (picks.length === 0) {
      content.innerHTML = '<div style="color:#ff6b6b;">‚ùå No valid picks found. Check your JSON format.</div>';
      preview.style.display = 'block';
      const status = document.getElementById('jsonUploadStatus');
      status.innerHTML = '<div style="color:#ff6b6b;">‚ùå Found 0 picks ready to upload</div>';
      status.style.display = 'block';
      return;
    }
    
    console.log('Converting picks to app format...');
    const appPicks = picks.slice(0, 3).map(convertUFCPickToAppFormat);
    console.log('Converted picks:', appPicks);
    
           content.innerHTML = appPicks.map((pick, i) => {
             // Format start time
             const startTime = new Date(pick.startTime).toLocaleString('en-US', {
               weekday: 'short',
               month: 'short', 
               day: 'numeric',
               hour: 'numeric',
               minute: '2-digit',
               timeZoneName: 'short'
             });
             
             // Format odds display
             let oddsDisplay = '';
             if (pick.odds && pick.odds.length > 0) {
               const odds = pick.odds[0];
               if (pick.market === 'h2h') {
                 oddsDisplay = `<strong>Odds:</strong> ${pick.awayTeam} ${odds.awayOdds || 'N/A'} | ${pick.homeTeam} ${odds.homeOdds || 'N/A'}`;
               } else if (pick.market === 'total') {
                 const overUnder = pick.prediction.includes('Over') ? 'Over' : 'Under';
                 const overOdds = overUnder === 'Over' ? odds.awayOdds : odds.homeOdds;
                 oddsDisplay = `<strong>Odds:</strong> ${pick.prediction} ${overOdds || 'N/A'}`;
               } else if (odds.sgp) {
                 oddsDisplay = `<strong>SGP Odds:</strong> ${odds.combinedUS || 'N/A'} (${odds.combinedDecimal || 'N/A'}x)`;
               } else {
                 oddsDisplay = `<strong>Odds:</strong> ${JSON.stringify(odds).substring(0, 50)}...`;
               }
             } else {
               oddsDisplay = '<strong>Odds:</strong> Not available';
             }
             
             return `
               <div style="margin-bottom:12px;padding:12px;background:rgba(255,255,255,.05);border-radius:6px;border-left:3px solid var(--primary);">
                 <strong style="color:var(--primary);">Pick ${i + 1}:</strong> ${pick.awayTeam} vs ${pick.homeTeam}<br>
                 <strong>Fight:</strong> ${pick.fight}<br>
                 <strong>Prediction:</strong> ${pick.prediction}<br>
                 <strong>Confidence:</strong> ${Math.round(pick.confidence * 100)}%<br>
                 <strong>Market:</strong> ${pick.market.toUpperCase()}<br>
                 <strong>Start Time:</strong> ${startTime}<br>
                 ${oddsDisplay}<br>
                 <strong>Reasoning:</strong> ${pick.reasoning ? pick.reasoning.substring(0, 80) + '...' : 'No reasoning provided'}<br>
                 <strong>Event:</strong> ${pick.event}
               </div>
             `;
           }).join('');
    
    preview.style.display = 'block';
    
    // Show total count
    const status = document.getElementById('jsonUploadStatus');
    status.innerHTML = `<div style="color:#4CAF50;">‚úÖ Found ${picks.length} picks ready to upload</div>`;
    status.style.display = 'block';
    
  } catch (e) {
    console.error('‚ùå Error in preview:', e);
    console.error('Error details:', e.message);
    console.error('Stack trace:', e.stack);
    
    const status = document.getElementById('jsonUploadStatus');
    status.innerHTML = `<div style="color:#f44336;">‚ùå Error: ${e.message}</div>`;
    status.style.display = 'block';
    preview.style.display = 'none';
  }
};

// Upload JSON picks to Firebase
window.uploadJSONPicks = async function() {
  const textarea = document.getElementById('jsonUploadTextarea');
  const status = document.getElementById('jsonUploadStatus');
  
  if (!textarea.value.trim()) {
    alert('Please paste NDJSON data first');
    return;
  }
  
  try {
    status.innerHTML = '<div style="color:#2196F3;">‚è≥ Checking for duplicates...</div>';
    status.style.display = 'block';
    
    const picks = parseNDJSONData(textarea.value);
    const appPicks = picks.map(convertUFCPickToAppFormat);
    
    console.log(`üìä Checking ${appPicks.length} picks for duplicates...`);
    
    // Check for existing picks to prevent duplicates
    const existingPicks = [];
    const { collection, getDocs } = await import('https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js');
    
    // Get all existing picks from qa_picks collection
    const qaSnapshot = await getDocs(collection(window.db, 'qa_picks'));
    qaSnapshot.forEach(doc => {
      const data = doc.data();
      existingPicks.push({
        id: doc.id,
        fight: data.fight,
        awayTeam: data.awayTeam,
        homeTeam: data.homeTeam,
        event: data.event
      });
    });
    
    console.log(`üìä Found ${existingPicks.length} existing picks in database`);
    
    // Filter out duplicates based on fight matchup and event
    const newPicks = [];
    const duplicates = [];
    
    for (const pick of appPicks) {
      const isDuplicate = existingPicks.some(existing => 
        existing.fight === pick.fight || 
        (existing.awayTeam === pick.awayTeam && 
         existing.homeTeam === pick.homeTeam && 
         existing.event === pick.event)
      );
      
      if (isDuplicate) {
        duplicates.push(pick);
        console.log(`‚ö†Ô∏è Skipping duplicate: ${pick.fight}`);
      } else {
        newPicks.push(pick);
        console.log(`‚úÖ New pick: ${pick.fight}`);
      }
    }
    
    console.log(`üìä New picks: ${newPicks.length}, Duplicates skipped: ${duplicates.length}`);
    
    if (newPicks.length === 0) {
      status.innerHTML = `<div style="color:#ff9800;">‚ö†Ô∏è No new picks to upload. ${duplicates.length} duplicates found and skipped.</div>`;
      return;
    }
    
    status.innerHTML = `<div style="color:#2196F3;">‚è≥ Uploading ${newPicks.length} new picks to Firebase...</div>`;
    
    let successCount = 0;
    let errorCount = 0;
    
    for (const pick of newPicks) {
      try {
        await addDoc(collection(window.db, 'qa_picks'), pick);
        successCount++;
      } catch (e) {
        console.error('Error uploading pick:', pick.id, e);
        errorCount++;
      }
    }
    
    // Show comprehensive results
    let resultMessage = `<div style="color:#4CAF50;">‚úÖ Upload complete!</div>`;
    resultMessage += `<div style="color:#4CAF50;">‚Ä¢ ${successCount} new picks uploaded</div>`;
    if (errorCount > 0) {
      resultMessage += `<div style="color:#f44336;">‚Ä¢ ${errorCount} uploads failed</div>`;
    }
    if (duplicates.length > 0) {
      resultMessage += `<div style="color:#ff9800;">‚Ä¢ ${duplicates.length} duplicates skipped</div>`;
    }
    
    status.innerHTML = resultMessage;
    
    // Clear form and refresh QA picks
    textarea.value = '';
    document.getElementById('jsonUploadPreview').style.display = 'none';
    loadQAPicks();
    
  } catch (e) {
    console.error('‚ùå Upload error:', e);
    status.innerHTML = `<div style="color:#f44336;">‚ùå Upload failed: ${e.message}</div>`;
  }
};

// Clear JSON upload form
window.clearJSONUpload = function() {
  document.getElementById('jsonUploadTextarea').value = '';
  document.getElementById('jsonFileInput').value = '';
  document.getElementById('jsonUploadPreview').style.display = 'none';
  document.getElementById('jsonUploadStatus').style.display = 'none';
};

// Handle file upload
window.handleJSONFileUpload = function(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    document.getElementById('jsonUploadTextarea').value = e.target.result;
  };
  reader.readAsText(file);
};

// Bulk Selection Functions
function togglePickSelection(pickId, isChecked) {
  console.log(`üìã Selection changed: ${pickId} ‚Üí ${isChecked ? 'SELECTED' : 'DESELECTED'}`);
  if (isChecked) {
    selectedPickIds.add(pickId);
  } else {
    selectedPickIds.delete(pickId);
  }
  console.log(`Current selection count: ${selectedPickIds.size}`);
  updateSelectionUI();
}

function toggleSelectAll(isChecked) {
  console.log(`üìã Select All: ${isChecked ? 'SELECTING' : 'DESELECTING'} all visible picks`);
  if (isChecked) {
    // Select all visible (filtered) picks
    const filteredPicks = filterQAPicksArray();
    console.log(`Filtered picks to select: ${filteredPicks.length}`);
    filteredPicks.forEach(pick => {
      console.log(`  Adding to selection: ${pick.id}`);
      selectedPickIds.add(pick.id);
    });
  } else {
    // Deselect all
    console.log(`Clearing all selections (was ${selectedPickIds.size})`);
    selectedPickIds.clear();
  }
  console.log(`Final selection count: ${selectedPickIds.size}`);
  renderQAPicks(); // Re-render to update checkboxes
  updateSelectionUI();
}

function filterQAPicksArray() {
  // Helper function to get filtered picks without rendering
  if (currentQAFilter === 'all') {
    return qaPicks;
  } else if (currentQAFilter === 'draft') {
    return qaPicks.filter(p => 
      (p.status === 'draft' || p.status === 'pending') && 
      p.originalCollection !== 'scoring'
    );
  } else if (currentQAFilter === 'live') {
    return qaPicks.filter(p => p.status === 'live' || p.originalCollection === 'live_picks');
  } else if (currentQAFilter === 'rejected') {
    return qaPicks.filter(p => p.status === 'rejected');
  } else if (currentQAFilter === 'scoring') {
    return qaPicks.filter(p => 
      p.originalCollection === 'scoring' || 
      p.status === 'hit' || 
      p.status === 'miss' ||
      (p.status === 'pending' && p.originalCollection === 'scoring')
    );
  } else if (currentQAFilter === 'deleted') {
    return qaPicks.filter(p => p.originalCollection === 'deleted_picks');
  } else {
    return qaPicks.filter(p => p.status === currentQAFilter);
  }
}

function updateSelectionUI() {
  const count = selectedPickIds.size;
  const countEl = document.getElementById('qaSelectionCount');
  const selectAllEl = document.getElementById('qaSelectAll');
  const approveBtn = document.getElementById('qaBulkApprove');
  const rejectBtn = document.getElementById('qaBulkReject');
  const deleteBtn = document.getElementById('qaBulkDelete');
  
  // Update count
  if (countEl) {
    countEl.textContent = count === 0 ? '0 selected' : `${count} selected`;
    countEl.style.color = count > 0 ? '#4CAF50' : '#888';
    countEl.style.fontWeight = count > 0 ? '600' : '400';
  }
  
  // Update Select All checkbox
  if (selectAllEl) {
    const filteredPicks = filterQAPicksArray();
    const allSelected = filteredPicks.length > 0 && filteredPicks.every(p => selectedPickIds.has(p.id));
    selectAllEl.checked = allSelected;
    selectAllEl.indeterminate = count > 0 && !allSelected;
  }
  
  // Enable/disable bulk action buttons
  const hasSelection = count > 0;
  if (approveBtn) approveBtn.disabled = !hasSelection;
  if (rejectBtn) rejectBtn.disabled = !hasSelection;
  if (deleteBtn) deleteBtn.disabled = !hasSelection;
}

async function bulkApprove() {
  const count = selectedPickIds.size;
  if (count === 0) return;
  
  const confirmed = confirm(`Approve and make ${count} pick(s) live?`);
  if (!confirmed) return;
  
  console.log(`üìã Bulk approving ${count} picks...`);
  
  let successCount = 0;
  let errorCount = 0;
  
  for (const pickId of selectedPickIds) {
    try {
      await approveAndMakeLive(pickId);
      successCount++;
    } catch (e) {
      console.error(`Error approving pick ${pickId}:`, e);
      errorCount++;
    }
  }
  
  alert(`‚úÖ Approved ${successCount} pick(s)${errorCount > 0 ? `, ${errorCount} failed` : ''}`);
  
  // Clear selection and reload
  selectedPickIds.clear();
  await loadQAPicks();
}

async function bulkReject() {
  const count = selectedPickIds.size;
  if (count === 0) return;
  
  const confirmed = confirm(`Reject ${count} pick(s)?`);
  if (!confirmed) return;
  
  console.log(`üìã Bulk rejecting ${count} picks...`);
  
  let successCount = 0;
  let errorCount = 0;
  
  for (const pickId of selectedPickIds) {
    try {
      await rejectPick(pickId);
      successCount++;
    } catch (e) {
      console.error(`Error rejecting pick ${pickId}:`, e);
      errorCount++;
    }
  }
  
  alert(`‚úÖ Rejected ${successCount} pick(s)${errorCount > 0 ? `, ${errorCount} failed` : ''}`);
  
  // Clear selection and reload
  selectedPickIds.clear();
  await loadQAPicks();
}

async function bulkDelete() {
  const count = selectedPickIds.size;
  if (count === 0) return;
  
  const confirmed = confirm(`‚ö†Ô∏è Move ${count} pick(s) to deleted items? They can be recovered later.`);
  if (!confirmed) return;
  
  console.log(`üìã Bulk soft-deleting ${count} picks...`);
  console.log('Selected IDs to delete:', Array.from(selectedPickIds));
  
  // Convert Set to Array to avoid modification during iteration
  const idsToDelete = Array.from(selectedPickIds);
  
  let successCount = 0;
  let errorCount = 0;
  
  console.log('üöÄ Starting bulk delete loop...');
  
  for (const pickId of idsToDelete) {
    try {
      console.log(`üóëÔ∏è Deleting pick ${pickId} with skipConfirm=true`);
      // Call deletePick with skipConfirm=true to avoid individual confirmations
      await deletePick(pickId, true);
      successCount++;
      console.log(`‚úÖ Successfully deleted pick ${pickId}`);
    } catch (e) {
      console.error(`‚ùå Error during bulk delete for pick ${pickId}:`, e);
      errorCount++;
    }
  }
  
  console.log(`üéØ Bulk delete loop completed. Success: ${successCount}, Errors: ${errorCount}`);
  
  alert(`‚úÖ Bulk delete completed. ${successCount} pick(s) moved to deleted items${errorCount > 0 ? `, ${errorCount} failed` : ''}`);
  
  // Clear selection and reload
  selectedPickIds.clear();
  await loadQAPicks();
}

// Bulk scoring functions
async function markSelectedHits() {
  const count = selectedPickIds.size;
  if (count === 0) return;
  
  const confirmed = confirm(`Mark ${count} pick(s) as HITS?`);
  if (!confirmed) return;
  
  console.log(`üìã Bulk marking ${count} picks as hits...`);
  
  let successCount = 0;
  let errorCount = 0;
  
  for (const pickId of selectedPickIds) {
    try {
      const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js');
      
      await updateDoc(doc(window.db, 'scoring', pickId), {
        status: 'hit',
        scoredAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      });
      
      successCount++;
    } catch (e) {
      console.error(`Error marking pick ${pickId} as hit:`, e);
      errorCount++;
    }
  }
  
  alert(`‚úÖ Marked ${successCount} pick(s) as hits${errorCount > 0 ? `, ${errorCount} failed` : ''}`);
  
  // Clear selection and reload
  selectedPickIds.clear();
  await loadQAPicks();
  
  // Refresh scorecard if it's currently visible
  refreshScorecard();
  
  // Refresh completed scores if scoring tab is active
  if (currentQAFilter === 'scoring') {
    loadCompletedScores();
  }
}

async function markSelectedMisses() {
  const count = selectedPickIds.size;
  if (count === 0) return;
  
  const confirmed = confirm(`Mark ${count} pick(s) as MISSES?`);
  if (!confirmed) return;
  
  console.log(`üìã Bulk marking ${count} picks as misses...`);
  
  let successCount = 0;
  let errorCount = 0;
  
  for (const pickId of selectedPickIds) {
    try {
      const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js');
      
      await updateDoc(doc(window.db, 'scoring', pickId), {
        status: 'miss',
        scoredAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      });
      
      successCount++;
    } catch (e) {
      console.error(`Error marking pick ${pickId} as miss:`, e);
      errorCount++;
    }
  }
  
  alert(`‚úÖ Marked ${successCount} pick(s) as misses${errorCount > 0 ? `, ${errorCount} failed` : ''}`);
  
  // Clear selection and reload
  selectedPickIds.clear();
  await loadQAPicks();
  
  // Refresh scorecard if it's currently visible
  refreshScorecard();
  
  // Refresh completed scores if scoring tab is active
  if (currentQAFilter === 'scoring') {
    loadCompletedScores();
  }
}

function clearScoringSelections() {
  selectedPickIds.clear();
  updateSelectionUI();
  renderQAPicks();
  console.log('üßπ Cleared all scoring selections');
}

// Debug function to test save functionality
window.debugSaveEdit = function(pickId) {
  console.log('üîç Debug Save Edit for:', pickId);
  console.log('Current editing pick ID:', window.editingPickId);
  console.log('Form elements exist:');
  console.log('- editAwayTeam:', !!document.getElementById(`editAwayTeam_${pickId}`));
  console.log('- editHomeTeam:', !!document.getElementById(`editHomeTeam_${pickId}`));
  console.log('- editPick:', !!document.getElementById(`editPick_${pickId}`));
  console.log('- editOdds:', !!document.getElementById(`editOdds_${pickId}`));
  console.log('- editConfidence:', !!document.getElementById(`editConfidence_${pickId}`));
  console.log('- editGameTime:', !!document.getElementById(`editGameTime_${pickId}`));
  console.log('- editReasoning:', !!document.getElementById(`editReasoning_${pickId}`));
  console.log('- editInjuryAlerts:', !!document.getElementById(`editInjuryAlerts_${pickId}`));
  
  if (document.getElementById(`editAwayTeam_${pickId}`)) {
    console.log('Form values:');
    console.log('- Away Team:', document.getElementById(`editAwayTeam_${pickId}`).value);
    console.log('- Home Team:', document.getElementById(`editHomeTeam_${pickId}`).value);
    console.log('- Pick:', document.getElementById(`editPick_${pickId}`).value);
    console.log('- Odds:', document.getElementById(`editOdds_${pickId}`).value);
    console.log('- Confidence:', document.getElementById(`editConfidence_${pickId}`).value);
    console.log('- Game Time:', document.getElementById(`editGameTime_${pickId}`).value);
    console.log('- Reasoning:', document.getElementById(`editReasoning_${pickId}`).value);
    console.log('- Injury Alerts:', document.getElementById(`editInjuryAlerts_${pickId}`).value);
  }
};

// Debug functions for QA Dashboard
window.debugQA = function() {
  console.log('üîç QA Dashboard Debug Info:');
  console.log('Firebase ready:', window.firebaseReady);
  console.log('Database available:', !!window.db);
  console.log('QA picks array:', qaPicks);
  console.log('Current filter:', currentQAFilter);
  console.log('QA picks list element:', document.getElementById('qaPicksList'));
  
  // Test creating a sample pick
  console.log('üß™ Testing sample pick creation...');
  const samplePick = {
    id: 'test_' + Date.now(),
    awayTeam: 'Yankees',
    homeTeam: 'Red Sox',
    pick: 'Yankees ML',
    odds: '-110',
    confidence: 85,
    gameTime: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
    reasoning: 'Test pick for debugging',
    injuryAlerts: '',
    status: 'draft',
    createdAt: new Date().toISOString(),
    createdBy: 'debug'
  };
  
  qaPicks.push(samplePick);
  updateQAStats();
  renderQAPicks();
  console.log('‚úÖ Sample pick added to QA dashboard');
};

window.clearQAPicks = function() {
  qaPicks = [];
  updateQAStats();
  renderQAPicks();
  console.log('üóëÔ∏è QA picks cleared');
};

window.forceRenderQA = function() {
  console.log('üîÑ Force rendering QA picks...');
  renderQAPicks();
  updateQAStats();
};

window.testFirebaseWrite = async function() {
  console.log('üß™ Testing Firebase write permissions...');
  
  if (!window.db) {
    console.error('‚ùå Firebase not available');
    return;
  }

  try {
    const { collection, addDoc } = await import('https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js');
    
    // Test write to qa_picks
    const testPick = {
      awayTeam: 'Test Team',
      homeTeam: 'Test Home',
      prediction: 'Test Pick',
      confidence: 0.5,
      startTime: new Date().toISOString(),
      reasoning: 'Test reasoning',
      createdAt: new Date().toISOString(),
      status: 'draft'
    };
    
    const docRef = await addDoc(collection(window.db, 'qa_picks'), testPick);
    console.log('‚úÖ Write test successful! Document ID:', docRef.id);
    
    // Clean up - delete the test document
    const { doc, deleteDoc } = await import('https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js');
    await deleteDoc(doc(window.db, 'qa_picks', docRef.id));
    console.log('‚úÖ Test document cleaned up');
    
  } catch (error) {
    console.error('‚ùå Write test failed:', error);
    console.log('This means you need to update Firebase security rules');
  }
};

window.debugFirebaseData = async function() {
  console.log('üîç Debugging Firebase data...');
  
  if (!window.db) {
    console.error('‚ùå Firebase not available');
    return;
  }

  try {
    const { collection, getDocs } = await import('https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js');
    const snapshot = await getDocs(collection(window.db, 'qa_picks'));
    
    console.log(`üìä Total documents in qa_picks: ${snapshot.size}`);
    
    snapshot.forEach((doc, index) => {
      const data = doc.data();
      console.log(`Document ${index + 1} (${doc.id}):`, {
        awayTeam: data.awayTeam,
        homeTeam: data.homeTeam,
        prediction: data.prediction,
        confidence: data.confidence,
        status: data.status,
        createdAt: data.createdAt,
        hasCreatedAt: !!data.createdAt
      });
    });
    
  } catch (error) {
    console.error('‚ùå Debug failed:', error);
  }
};

window.fixPickStatuses = async function() {
  console.log('üîß Fixing pick statuses...');
  
  if (!window.db) {
    console.error('‚ùå Firebase not available');
    return;
  }

  try {
    const { collection, getDocs, doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js');
    const snapshot = await getDocs(collection(window.db, 'qa_picks'));
    
    let fixedCount = 0;
    
    for (const docSnapshot of snapshot.docs) {
      const data = docSnapshot.data();
      
      // If no status field, add it as 'draft'
      if (!data.status) {
        await updateDoc(doc(window.db, 'qa_picks', docSnapshot.id), {
          status: 'draft',
          createdAt: data.createdAt || new Date().toISOString()
        });
        fixedCount++;
        console.log(`‚úÖ Fixed pick: ${data.awayTeam} vs ${data.homeTeam} - set to DRAFT`);
      } else {
        console.log(`üìã Pick already has status: ${data.awayTeam} vs ${data.homeTeam} - ${data.status}`);
      }
    }
    
    console.log(`üéâ Fixed ${fixedCount} picks with missing status`);
    
    // Reload QA picks to show updated statuses
    loadQAPicks();
    
  } catch (error) {
    console.error('‚ùå Fix failed:', error);
  }
};

window.standardizePickStatuses = async function() {
  console.log('üîß Standardizing all pick statuses to DRAFT...');
  
  if (!window.db) {
    console.error('‚ùå Firebase not available');
    return;
  }

  try {
    const { collection, getDocs, doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js');
    const snapshot = await getDocs(collection(window.db, 'qa_picks'));
    
    let updatedCount = 0;
    
    for (const docSnapshot of snapshot.docs) {
      const data = docSnapshot.data();
      
      // Update all picks to have 'draft' status
      await updateDoc(doc(window.db, 'qa_picks', docSnapshot.id), {
        status: 'draft'
      });
      updatedCount++;
      console.log(`‚úÖ Updated pick: ${data.awayTeam} vs ${data.homeTeam} - set to DRAFT`);
    }
    
    console.log(`üéâ Standardized ${updatedCount} picks to DRAFT status`);
    
    // Reload QA picks to show updated statuses
    loadQAPicks();
    
  } catch (error) {
    console.error('‚ùå Standardization failed:', error);
  }
};

window.debugQATab = function() {
  console.log('üîç QA Tab Debug Info:');
  console.log('QA tab element:', document.getElementById('adminQA'));
  console.log('QA tab classes:', document.getElementById('adminQA')?.className);
  console.log('QA tab display style:', window.getComputedStyle(document.getElementById('adminQA')).display);
  console.log('QA tab visibility:', window.getComputedStyle(document.getElementById('adminQA')).visibility);
  console.log('QA tab hidden class:', document.getElementById('adminQA')?.classList.contains('hidden'));
  
  // Force show the QA tab
  document.getElementById('adminQA').classList.remove('hidden');
  console.log('‚úÖ QA tab forced to show');
  
  // Update tab button
  document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
  document.getElementById('adminTabQA').classList.add('active');
  console.log('‚úÖ QA tab button activated');
};



// Firebase Data Loading (replaces static picks with Firebase data)
async function loadFirebaseData() {
  if (!window.firebaseReady || !window.db) {
    console.log('Firebase not ready, using static data');
    return;
  }

  try {
    console.log('üîÑ Loading Firebase data...');
    const { collection, getDocs, query, where } = await import('https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js');
    
    // Only load approved/live picks for the main website from live_picks collection
    const approvedQuery = query(collection(window.db, 'live_picks'), where('status', 'in', ['approved', 'live']));
    const snapshot = await getDocs(approvedQuery);
    
    if (!snapshot.empty) {
      // Convert Firebase data to app format and replace static picks
      const firebasePicks = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        console.log('üîç Processing Firebase pick:', doc.id);
        console.log('üìä Full data object:', JSON.stringify(data, null, 2));
        
        // Get proper odds from Firebase data - simplified mapping
        let oddsAmerican = -110; // Default fallback
        
        // First check if oddsAmerican is directly stored (NFL picks)
        if (data.oddsAmerican !== undefined && data.oddsAmerican !== null) {
          oddsAmerican = data.oddsAmerican;
        } 
        // Otherwise, check odds array (UFC picks)
        else if (data.odds && Array.isArray(data.odds) && data.odds.length > 0) {
          const odds = data.odds[0]; // Get first odds object
          
          // For H2H markets, determine which fighter is predicted and use corresponding odds
          if (data.market === 'h2h') {
            // If prediction matches awayTeam, use awayOdds; if homeTeam, use homeOdds
            if (data.prediction === data.awayTeam) {
              oddsAmerican = odds.awayOdds;
            } else if (data.prediction === data.homeTeam) {
              oddsAmerican = odds.homeOdds;
            }
          } 
          // For total markets, determine if it's Over or Under and use corresponding odds
          else if (data.market === 'total') {
            if (data.prediction.startsWith('Over')) {
              oddsAmerican = odds.awayOdds; // Over is typically awayOdds
            } else if (data.prediction.startsWith('Under')) {
              oddsAmerican = odds.homeOdds; // Under is typically homeOdds
            }
          }
          // For SGP markets, use the combined odds
          else if (data.market === 'sgp2' && odds.combinedUS) {
            oddsAmerican = odds.combinedUS;
          }
        }
        
        console.log('üéØ Final odds:', oddsAmerican, 'for prediction:', data.prediction);
        console.log('üí≠ Final reasoning:', data.llmPredictions?.openai?.reasoning || data.reasoning || 'No reasoning provided');
        console.log('üìà Odds array:', data.odds);
        console.log('üè∑Ô∏è Market:', data.market);
        
        firebasePicks.push({
          id: doc.id,
          league: data.sport || 'UFC',
          marketType: data.market === 'h2h' ? 'moneyline' : 
                     data.market === 'total' ? 'totals' : 
                     data.market === 'sgp2' ? 'parlay' :
                     data.market || 'moneyline',
          pickDesc: data.market === 'sgp2' ? `${data.fight || 'Match'} - ${data.prediction}` :
                   data.market === 'h2h' ? `${data.prediction} to WIN vs ${data.homeTeam || 'Opponent'}` :
                   data.market === 'total' ? `${data.fight || 'Match'} - ${data.prediction}` :
                   data.prediction || `${data.awayTeam || 'Away'} vs ${data.homeTeam || 'Home'}`,
          oddsAmerican: oddsAmerican,
          modelConfidence: Math.round(parseFloat(data.confidence || 0) * 100),
          commenceTime: data.commenceTime || data.startTime || data.gameTime || new Date().toISOString(),
          tier: data.tier || 'public',
          riskTag: data.riskTag || 'safe',
          reasoning: data.llmPredictions?.openai?.reasoning || data.reasoning || 'No reasoning provided'
        });
      });
      
      // Replace static picks with Firebase data
      picksLive = firebasePicks;
      picksResults = []; // Clear old results
      picksAll = picksLive.concat(picksResults); // Update picksAll to only include Firebase data
      console.log(`‚úÖ Replaced static picks with ${firebasePicks.length} Firebase picks`);
      console.log('New picksLive array:', picksLive);
      console.log('Updated picksAll array:', picksAll);
      
      // Re-render the picks display
      try {
        render();
        console.log('‚úÖ Re-rendered with Firebase data');
        
        // Also try to force update the list element directly
        setTimeout(() => {
          var list = document.getElementById('list');
          if (list) {
            console.log('üîç Debug info:');
            console.log('state.auth:', state.auth);
            console.log('All picksAll:', picksAll);
            console.log('Firebase picks:', picksLive);
            
            var arr = picksAll.filter(function(p){ 
              var visible = canSee(p);
              console.log('Pick', p.id, 'tier:', p.tier, 'visible:', visible);
              return visible;
            });
            
            console.log('Filtered picks:', arr);
            
            if (arr.length > 0) {
              list.innerHTML = arr.map(cardHTML).join('');
              console.log('‚úÖ Direct list update completed with', arr.length, 'picks');
            }
          }
        }, 100);
        
      } catch (error) {
        console.error('Error re-rendering:', error);
      }
    }
  } catch (error) {
    console.error('Firebase data loading failed:', error);
  }
}

// Force reload Firebase data
window.forceReloadFirebaseData = async function() {
  console.log('üîÑ Force reloading Firebase data...');
  await loadFirebaseData();
};

// Automatically move completed games to scoring
async function moveCompletedGamesToScoring() {
  if (!window.firebaseReady || !window.db) {
    console.log('Firebase not ready for auto-scoring');
    return;
  }

  try {
    console.log('üîÑ Checking for completed games...');
    const { collection, getDocs, addDoc, deleteDoc, doc, query, where } = await import('https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js');
    
    const now = new Date();
    console.log('Current time:', now.toISOString());
    
    // Get all live picks that should have started
    const liveQuery = query(collection(window.db, 'live_picks'));
    const liveSnapshot = await getDocs(liveQuery);
    
    let movedCount = 0;
    let checkedCount = 0;
    
    for (const liveDoc of liveSnapshot.docs) {
      const data = liveDoc.data();
      checkedCount++;
      
      const startTime = new Date(data.startTime);
      console.log(`Checking ${data.fight}: Start time ${startTime.toISOString()}, Current time ${now.toISOString()}`);
      
      // If game has started (startTime is in the past)
      if (startTime < now) {
        console.log(`‚úÖ Game completed: ${data.fight} - Moving to scoring`);
        
        // Add to scoring collection with pending status
        const scoringData = {
          ...data,
          status: 'pending', // Will be updated to 'hit' or 'miss' when results are in
          movedToScoringAt: new Date().toISOString(),
          originalCollection: 'live_picks',
          originalDocId: liveDoc.id
        };
        
        await addDoc(collection(window.db, 'scoring'), scoringData);
        
        // Remove from live_picks
        await deleteDoc(doc(window.db, 'live_picks', liveDoc.id));
        
        movedCount++;
        console.log(`‚úÖ Moved ${data.fight} to scoring collection`);
      }
    }
    
    console.log(`üèÜ Auto-scoring complete: Checked ${checkedCount} games, moved ${movedCount} to scoring`);
    
    if (movedCount > 0) {
      showMessage(`Moved ${movedCount} completed games to scoring!`, 'success');
      // Reload data to reflect changes
      await loadFirebaseData();
    }
    
  } catch (error) {
    console.error('‚ùå Error in auto-scoring:', error);
    showMessage('Error moving completed games to scoring', 'error');
  }
}

// Auto-scoring timer - runs every 5 minutes
let autoScoringInterval = null;

function startAutoScoring() {
  if (autoScoringInterval) {
    clearInterval(autoScoringInterval);
  }
  
  // DISABLED: Old UFC auto-scoring system, replaced by unified pick system
  console.log('‚èπÔ∏è Auto-scoring disabled (using unified pick system)');
  // autoScoringInterval = setInterval(moveCompletedGamesToScoring, 5 * 60 * 1000); // 5 minutes
  
  // Also run immediately
  // moveCompletedGamesToScoring();
}

function stopAutoScoring() {
  if (autoScoringInterval) {
    clearInterval(autoScoringInterval);
    autoScoringInterval = null;
    console.log('‚èπÔ∏è Auto-scoring stopped');
  }
}

// Manual trigger for auto-scoring
window.manualScoringCheck = async function() {
  console.log('üîÑ Manual scoring check triggered');
  await moveCompletedGamesToScoring();
};

// Refresh scorecard data
window.refreshScorecard = async function() {
  console.log('üîÑ Refreshing scorecard...');
  if (location.hash === '#scorecard') {
    await renderScorecard();
  }
};

// Helper function to get proper fight title
function getFightTitle(score) {
  // For test data
  if (score.prediction === 'test' || score.prediction === 'test3') {
    return 'Test Match';
  }
  
  // For real UFC data, use fight field or build from teams
  if (score.fight) {
    return score.fight;
  } else if (score.awayTeam && score.homeTeam) {
    return `${score.awayTeam} vs ${score.homeTeam}`;
  }
  
  return 'Unknown Match';
}

// Helper function to get proper pick description
function getPickDescription(score) {
  // For test data with generic prediction
  if (score.prediction === 'test' || score.prediction === 'test3') {
    return score.prediction; // Just show the test prediction
  }
  
  // For real UFC data, build proper description
  if (score.market === 'h2h') {
    return `${score.prediction} to WIN`;
  } else if (score.market === 'total') {
    return `${score.prediction}`;
  } else if (score.market === 'sgp2') {
    return score.prediction; // SGP predictions are usually already descriptive
  }
  
  // Fallback to prediction or pick
  return score.prediction || score.pick || 'No pick';
}

// Helper function to extract display odds from score data
function getDisplayOdds(score) {
  console.log('üé≤ DEBUG getDisplayOdds for score:', score.id, score.prediction);
  console.log('üìä Odds data:', score.odds);
  console.log('üìä Odds type:', typeof score.odds);
  console.log('üìä Is array:', Array.isArray(score.odds));
  
  // Handle direct odds value (string/number)
  if (score.odds && !Array.isArray(score.odds)) {
    console.log('‚úÖ Direct odds value found:', score.odds);
    return score.odds.toString();
  }
  
  // Handle odds array format
  if (!score.odds || !Array.isArray(score.odds) || score.odds.length === 0) {
    console.log('‚ùå No odds array found');
    return 'N/A';
  }
  
  const odds = score.odds[0]; // Get first odds object
  console.log('üéØ First odds object:', odds);
  
  // For test data, return the correct odds based on prediction
  if (score.prediction === 'test') {
    console.log('üß™ Test data detected, returning -330 odds');
    return '-330';
  } else if (score.prediction === 'test3') {
    console.log('üß™ Test3 data detected, returning -300 odds');
    return '-300';
  }
  
  // For H2H markets, determine which fighter is predicted and use corresponding odds
  if (score.market === 'h2h') {
    console.log('ü•ä H2H market detected');
    if (score.prediction === score.awayTeam) {
      console.log('üèÉ Away team prediction, using awayOdds:', odds.awayOdds);
      return odds.awayOdds || 'N/A';
    } else if (score.prediction === score.homeTeam) {
      console.log('üè† Home team prediction, using homeOdds:', odds.homeOdds);
      return odds.homeOdds || 'N/A';
    }
  } 
  // For total markets, determine if it's Over or Under and use corresponding odds
  else if (score.market === 'total') {
    console.log('üìä Total market detected');
    if (score.prediction && score.prediction.startsWith('Over')) {
      console.log('‚¨ÜÔ∏è Over prediction, using awayOdds:', odds.awayOdds);
      return odds.awayOdds || 'N/A'; // Over is typically awayOdds
    } else if (score.prediction && score.prediction.startsWith('Under')) {
      console.log('‚¨áÔ∏è Under prediction, using homeOdds:', odds.homeOdds);
      return odds.homeOdds || 'N/A'; // Under is typically homeOdds
    }
  }
  // For SGP markets, use the combined odds
  else if (score.market === 'sgp2' && odds.combinedUS) {
    console.log('üéØ SGP market detected, using combinedUS:', odds.combinedUS);
    return odds.combinedUS;
  }
  
  // Fallback to any available odds
  const fallbackOdds = odds.awayOdds || odds.homeOdds || odds.combinedUS || 'N/A';
  console.log('üîÑ Using fallback odds:', fallbackOdds);
  return fallbackOdds;
}

// Load and display completed scores (hit/miss)
async function loadCompletedScores() {
  if (!window.firebaseReady || !window.db) {
    console.log('Firebase not ready for completed scores');
    return;
  }

  try {
    console.log('üîÑ Loading completed scores...');
    const { collection, getDocs, query, where } = await import('https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js');
    
    // Get all scored picks (hit or miss) from scoring collection
    const scoringQuery = query(collection(window.db, 'scoring'), where('status', 'in', ['hit', 'miss']));
    const snapshot = await getDocs(scoringQuery);
    
    const completedScoresList = document.getElementById('completedScoresList');
    if (!completedScoresList) return;
    
    if (snapshot.empty) {
      completedScoresList.innerHTML = '<div style="text-align:center;color:#888;padding:20px;">No completed scores yet.</div>';
      return;
    }
    
    const scores = [];
    snapshot.forEach(doc => {
      const data = doc.data();
      console.log('üîç DEBUG: Raw Firebase data for score:', doc.id);
      console.log('üìä Full data object:', JSON.stringify(data, null, 2));
      console.log('üéØ Specific fields:');
      console.log('  - prediction:', data.prediction);
      console.log('  - pick:', data.pick);
      console.log('  - pickDesc:', data.pickDesc);
      console.log('  - odds:', data.odds);
      console.log('  - awayTeam:', data.awayTeam);
      console.log('  - homeTeam:', data.homeTeam);
      console.log('  - reasoning:', data.reasoning);
      console.log('  - llmPredictions:', data.llmPredictions);
      console.log('  - market:', data.market);
      console.log('  - confidence:', data.confidence);
      
      scores.push({
        id: doc.id,
        ...data,
        result: data.status === 'hit' ? 'W' : 'L',
        scoredAt: data.scoredAt || data.movedToScoringAt || data.startTime
      });
    });
    
    // Sort by scored date (most recent first)
    scores.sort((a, b) => new Date(b.scoredAt) - new Date(a.scoredAt));
    
    // Display completed scores
    completedScoresList.innerHTML = scores.map(score => {
      const badgeClass = score.result === 'W' ? 'success' : 'danger';
      const badgeIcon = score.result === 'W' ? '‚úÖ' : '‚ùå';
      const scoreDate = new Date(score.scoredAt).toLocaleString();
      
      return `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:8px;margin-bottom:8px;background:rgba(255,255,255,.02);border-radius:4px;border-left:3px solid ${score.result === 'W' ? '#4caf50' : '#f44336'};">
          <div style="flex:1;">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
              <span style="padding:2px 6px;border-radius:3px;font-size:10px;font-weight:500;background:${score.result === 'W' ? 'rgba(76,175,80,0.2)' : 'rgba(244,67,54,0.2)'};color:${score.result === 'W' ? '#4caf50' : '#f44336'};border:1px solid ${score.result === 'W' ? '#4caf50' : '#f44336'};">${badgeIcon} ${score.result}</span>
              <span style="font-weight:500;">${getFightTitle(score)}</span>
            </div>
            <div style="font-size:12px;color:#888;">
              ${getPickDescription(score)} | Odds: ${getDisplayOdds(score)} | Confidence: ${Math.round((score.confidence || 0) * 100)}%
            </div>
            <div style="font-size:11px;color:#666;margin-top:2px;">
              Scored: ${scoreDate}
            </div>
            ${score.reasoning ? `<div style="font-size:11px;color:#888;margin-top:4px;font-style:italic;">"${score.reasoning}"</div>` : ''}
          </div>
          <div style="display:flex;gap:4px;align-items:center;">
            <button type="button" class="btn enhanced" style="padding:2px 6px;font-size:10px;background:#666;border:1px solid #888;" onclick="editCompletedScore('${score.id}')">‚úèÔ∏è Edit</button>
            <button type="button" class="btn enhanced" style="padding:2px 6px;font-size:10px;background:#5a2d2d;border:1px solid #f44336;" onclick="deleteCompletedScore('${score.id}')">üóëÔ∏è</button>
          </div>
        </div>
      `;
    }).join('');
    
    console.log(`‚úÖ Loaded ${scores.length} completed scores`);
    
  } catch (error) {
    console.error('‚ùå Error loading completed scores:', error);
    const completedScoresList = document.getElementById('completedScoresList');
    if (completedScoresList) {
      completedScoresList.innerHTML = '<div style="text-align:center;color:#f44336;padding:20px;">Error loading completed scores.</div>';
    }
  }
}

// Toggle completed scores visibility
function toggleCompletedScores() {
  const completedScoresList = document.getElementById('completedScoresList');
  const toggleBtn = document.getElementById('toggleCompletedScores');
  
  if (!completedScoresList || !toggleBtn) return;
  
  if (completedScoresList.classList.contains('hidden')) {
    completedScoresList.classList.remove('hidden');
    toggleBtn.textContent = '‚ñ≤ Hide';
  } else {
    completedScoresList.classList.add('hidden');
    toggleBtn.textContent = '‚ñº Show';
  }
}

// Edit completed score
window.editCompletedScore = async function(scoreId) {
  try {
    console.log('‚úèÔ∏è Editing completed score:', scoreId);
    
    // Get the current score data
    const { doc, getDoc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js');
    const scoreDoc = await getDoc(doc(window.db, 'scoring', scoreId));
    
    if (!scoreDoc.exists()) {
      alert('Score not found');
      return;
    }
    
    const scoreData = scoreDoc.data();
    
    // Prompt for new result
    const newResult = prompt('Change result:\n\nEnter "W" for Win (Hit) or "L" for Loss (Miss)', scoreData.status === 'hit' ? 'W' : 'L');
    
    if (newResult === null) return; // User cancelled
    
    if (newResult !== 'W' && newResult !== 'L') {
      alert('Please enter "W" for Win or "L" for Loss');
      return;
    }
    
    const newStatus = newResult === 'W' ? 'hit' : 'miss';
    
    // Update the score
    await updateDoc(doc(window.db, 'scoring', scoreId), {
      status: newStatus,
      scoredAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    });
    
    console.log(`‚úÖ Updated score ${scoreId} to ${newStatus}`);
    showMessage('Score updated successfully!', 'success');
    
    // Refresh displays
    loadCompletedScores();
    refreshScorecard();
    
  } catch (error) {
    console.error('‚ùå Error editing completed score:', error);
    showMessage('Error updating score. Check console for details.', 'error');
  }
};

// Delete completed score
window.deleteCompletedScore = async function(scoreId) {
  try {
    console.log('üóëÔ∏è Deleting completed score:', scoreId);
    
    const confirmed = confirm('Are you sure you want to delete this completed score? This action cannot be undone.');
    if (!confirmed) return;
    
    const { doc, deleteDoc } = await import('https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js');
    
    await deleteDoc(doc(window.db, 'scoring', scoreId));
    
    console.log(`‚úÖ Deleted score ${scoreId}`);
    showMessage('Score deleted successfully!', 'success');
    
    // Refresh displays
    loadCompletedScores();
    refreshScorecard();
    
  } catch (error) {
    console.error('‚ùå Error deleting completed score:', error);
    showMessage('Error deleting score. Check console for details.', 'error');
  }
};

// Debug specific scoring picks odds
window.debugScoringOdds = async function() {
  if (!window.firebaseReady || !window.db) {
    console.log('Firebase not ready');
    return;
  }

  try {
    console.log('üîç DEBUGGING: Checking scoring picks odds...');
    const { collection, getDocs, query, where } = await import('https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js');
    
    // Check scoring collection specifically for odds
    const scoringQuery = query(collection(window.db, 'scoring'));
    const scoringSnapshot = await getDocs(scoringQuery);
    
    console.log('üìä SCORING COLLECTION ODDS ANALYSIS:');
    scoringSnapshot.forEach(doc => {
      const data = doc.data();
      console.log(`Document ${doc.id}:`);
      console.log('  - prediction:', data.prediction);
      console.log('  - odds:', data.odds);
      console.log('  - market:', data.market);
      console.log('  - awayTeam:', data.awayTeam);
      console.log('  - homeTeam:', data.homeTeam);
      if (data.odds && data.odds.length > 0) {
        console.log('  - odds[0]:', data.odds[0]);
      }
      console.log('---');
    });
    
  } catch (error) {
    console.error('‚ùå Error debugging scoring odds:', error);
  }
};

// Debug Firebase data structure
window.debugFirebaseData = async function() {
  if (!window.firebaseReady || !window.db) {
    console.log('Firebase not ready');
    return;
  }

  try {
    console.log('üîç DEBUGGING: Checking Firebase data structure...');
    const { collection, getDocs, query, where } = await import('https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js');
    
    // Check scoring collection
    const scoringQuery = query(collection(window.db, 'scoring'));
    const scoringSnapshot = await getDocs(scoringQuery);
    
    console.log('üìä SCORING COLLECTION:');
    scoringSnapshot.forEach(doc => {
      const data = doc.data();
      console.log(`Document ${doc.id}:`, data);
    });
    
    // Check live_picks collection
    const liveQuery = query(collection(window.db, 'live_picks'));
    const liveSnapshot = await getDocs(liveQuery);
    
    console.log('üìä LIVE_PICKS COLLECTION:');
    liveSnapshot.forEach(doc => {
      const data = doc.data();
      console.log(`Document ${doc.id}:`, data);
    });
    
  } catch (error) {
    console.error('‚ùå Error debugging Firebase data:', error);
  }
};

// Test Firebase connection
async function testFirebaseConnection() {
  if (!window.firebaseReady || !window.db) {
    console.log('Firebase not ready');
    return false;
  }

  try {
    const { collection, getDocs, limit, query } = await import('https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js');
    const testQuery = query(collection(window.db, 'qa_picks'), limit(1));
    const testDoc = await getDocs(testQuery);
    console.log(`‚úÖ Firebase connected! Found ${testDoc.size} documents`);
    return true;
  } catch (error) {
    console.error('Firebase connection failed:', error);
    return false;
  }
}

/* INIT */
try{ route(); }catch(e){ console.error('route()', e); }
try{ render(); }catch(e){ console.error('render()', e); }

// Test Firebase connection after app loads
setTimeout(() => {
  if (window.firebaseReady) {
    testFirebaseConnection();
    loadFirebaseData();
    // Also load scorecard data if we're on the scorecard page
    if (location.hash === '#scorecard') {
      renderScorecard();
    }
  } else {
    console.log('Firebase not ready after 2 seconds');
  }
}, 2000);

// Manual function to test Firebase data loading
window.testFirebasePicks = function() {
  console.log('üß™ Manual test: Loading Firebase picks...');
  loadFirebaseData();
};

// Manual function to test scorecard data loading
window.testScorecardData = async function() {
  console.log('üß™ Manual test: Loading scorecard data...');
  await renderScorecard();
  console.log('‚úÖ Scorecard render completed');
};

// Force update picks display
window.forceUpdatePicks = function() {
  console.log('üîÑ Force updating picks display...');
  console.log('Current picksLive:', picksLive);
  console.log('Current picksAll:', picksAll);
  
  // Force re-render
  try {
    render();
    console.log('‚úÖ Force render completed');
  } catch (error) {
    console.error('Force render error:', error);
  }
};

// Authentication Functions
async function signUp(email, password) {
  try {
    const { createUserWithEmailAndPassword } = await import('https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js');
    const userCredential = await createUserWithEmailAndPassword(window.auth, email, password);
    console.log('‚úÖ User signed up:', userCredential.user.email);
    return userCredential.user;
  } catch (error) {
    console.error('Sign up error:', error);
    throw error;
  }
}

async function signIn(email, password) {
  try {
    const { signInWithEmailAndPassword } = await import('https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js');
    const userCredential = await signInWithEmailAndPassword(window.auth, email, password);
    console.log('‚úÖ User signed in:', userCredential.user.email);
    return userCredential.user;
  } catch (error) {
    console.error('Sign in error:', error);
    throw error;
  }
}

async function signOut() {
  try {
    const { signOut } = await import('https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js');
    await signOut(window.auth);
    console.log('‚úÖ User signed out');
  } catch (error) {
    console.error('Sign out error:', error);
    throw error;
  }
}

// Make auth functions available globally
window.signUp = signUp;
window.signIn = signIn;
window.signOut = signOut;

// ============================================================================
// STRIPE CONFIGURATION - PRODUCTION MODE
// ============================================================================
// 
// üöÄ PRODUCTION MODE (Current):
//    - Uses live publishable key (pk_live_...)
//    - Real payment processing enabled
//    - Webhook endpoint needed for payment confirmations
//
// ‚ö†Ô∏è IMPORTANT NEXT STEPS:
//    1. Create a live mode price in Stripe Dashboard
//    2. Update priceId below with your live price ID
//    3. Set up webhook endpoint: https://confident-picks.com/api/stripe-webhook
//    4. Configure webhook to listen for: checkout.session.completed
//    5. Add webhook signing secret to your backend
//
// üìö Documentation: https://stripe.com/docs/payments/checkout
// ============================================================================

const stripeConfig = {
  publishableKey: 'pk_live_51SF4js02IY0KoVm6AxcpbreXtU28vvWkdMseKkry69DhDtdqDI8z1d5MZrfIznAYljsnfwrVAIf1UEladjV2CK7H00qFnhZbkH',
  priceId: 'price_1SMKGg02IY0KoVm6FGWNLbrg', // Monthly: $15/month
  // yearlyPriceId: 'price_1SMKIZ02IY0KoVm6xH4HS5i3', // Yearly: $156/year (for future use)
  mode: 'production' // 'sandbox' or 'production'
};

// Initialize Stripe
let stripe;
if (window.Stripe) {
  stripe = Stripe(stripeConfig.publishableKey);
  console.log('üí≥ Stripe initialized');
} else {
  console.error('Stripe not loaded');
}

// Stripe Functions - Client-side checkout session creation
async function createCheckoutSession(priceId) {
  try {
    // For sandbox testing, we'll create a simple checkout session
    // In production, this would be done on your backend
    const sessionData = {
      line_items: [{
        price: priceId,
        quantity: 1,
      }],
      mode: 'subscription',
      success_url: window.location.origin + '?success=true',
      cancel_url: window.location.origin + '?canceled=true',
      customer_email: window.auth?.currentUser?.email || 'test@example.com',
      metadata: {
        userId: window.auth?.currentUser?.uid || 'test-user'
      }
    };
    
    console.log('Creating checkout session with data:', sessionData);
    
    // For now, we'll simulate a successful session creation
    // In production, you'd call your backend endpoint
    return {
      id: 'cs_test_' + Math.random().toString(36).substr(2, 9),
      url: 'https://checkout.stripe.com/test-session'
    };
  } catch (error) {
    console.error('Error creating checkout session:', error);
    throw error;
  }
}

async function redirectToCheckout(priceId) {
  try {
    console.log('üöÄ Initiating Stripe checkout...');
    
    if (!stripe) {
      throw new Error('Stripe is not initialized');
    }
    
    if (!window.auth?.currentUser) {
      alert('Please sign in to upgrade your account.');
      return;
    }
    
    // Create checkout session via Stripe Checkout
    // Note: For production, you should create the session on your backend
    // and return the session ID to avoid exposing your price ID
    const { error } = await stripe.redirectToCheckout({
      lineItems: [{
        price: priceId,
        quantity: 1
      }],
      mode: 'subscription',
      successUrl: window.location.origin + '/?session_id={CHECKOUT_SESSION_ID}&success=true',
      cancelUrl: window.location.origin + '/?canceled=true',
      customerEmail: window.auth.currentUser.email,
      clientReferenceId: window.auth.currentUser.uid
    });
    
    if (error) {
      console.error('Stripe checkout error:', error);
      alert('Sorry, there was an error redirecting to checkout. Please try again.');
    }
    
  } catch (error) {
    console.error('Checkout error:', error);
    alert('Sorry, there was an error processing your payment. Please try again.');
  }
}

// Make Stripe functions available globally
window.redirectToCheckout = redirectToCheckout;

// Test Stripe integration
window.testStripe = function() {
  console.log('üß™ Testing Stripe integration...');
  console.log('Stripe object:', stripe);
  console.log('Publishable key:', stripeConfig.publishableKey);
  console.log('Price ID:', stripeConfig.priceId);
  
  if (stripe) {
    console.log('‚úÖ Stripe initialized successfully');
    console.log('üí≥ Ready to process payments');
  } else {
    console.error('‚ùå Stripe not initialized');
  }
};

// Handle upgrade button clicks
async function handleUpgrade() {
  console.log('üöÄ User clicked upgrade button');
  console.log('Current auth state:', state.auth);
  console.log('Firebase user:', window.auth?.currentUser);
  
  // Check if user is authenticated with Firebase
  if (!window.auth?.currentUser) {
    console.log('User not authenticated with Firebase, redirecting to sign up');
    location.hash = '#account';
    route();
    return;
  }
  
  // User is authenticated with Firebase, redirect to Stripe checkout
  try {
    console.log('üöÄ Starting Stripe checkout process...');
    await redirectToCheckout(stripeConfig.priceId);
  } catch (error) {
    console.error('Checkout failed:', error);
    alert('Sorry, there was an error processing your upgrade. Please try again.');
  }
}

// Make upgrade function available globally
window.handleUpgrade = handleUpgrade;

// Subscription Management Functions
async function updateUserSubscription(userId, subscriptionData) {
  try {
    const { doc, setDoc } = await import('https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js');
    const userRef = doc(window.db, 'users', userId);
    
    await setDoc(userRef, {
      subscription: subscriptionData,
      updatedAt: new Date().toISOString()
    }, { merge: true });
    
    console.log('‚úÖ User subscription updated:', subscriptionData);
  } catch (error) {
    console.error('Error updating subscription:', error);
  }
}

async function getUserSubscription(userId) {
  try {
    const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js');
    const userRef = doc(window.db, 'users', userId);
    const userSnap = await getDoc(userRef);
    
    if (userSnap.exists()) {
      const userData = userSnap.data();
      return userData.subscription || { status: 'free', tier: 'free' };
    }
    
    return { status: 'free', tier: 'free' };
  } catch (error) {
    console.error('Error getting subscription:', error);
    return { status: 'free', tier: 'free' };
  }
}

// Make subscription functions available globally
window.updateUserSubscription = updateUserSubscription;
window.getUserSubscription = getUserSubscription;

// Sync local auth with Firebase
async function syncAuthWithFirebase() {
  // Listen for Firebase auth state changes
  if (window.auth) {
    window.auth.onAuthStateChanged(async (user) => {
      if (user) {
        console.log('‚úÖ Firebase user signed in:', user.email);
        
        try {
          // Fetch user data from Firestore to check role and subscription
          const userData = await getUserData(user.uid);
          console.log('üìä User data from Firebase:', userData);
          
          // Check role first (admin has highest priority)
          if (userData?.role === 'admin') {
            console.log('üëë Admin user detected from Firebase!');
            setAuth('admin');
            
            // Store user info in localStorage
            localStorage.setItem('userEmail', user.email);
            localStorage.setItem('emailVerified', user.emailVerified ? 'true' : 'false');
            localStorage.setItem('lastLoginAt', new Date().toISOString());
            if (!localStorage.getItem('userCreatedAt')) {
              localStorage.setItem('userCreatedAt', new Date().toISOString());
            }
          } 
          // Check subscription status
          else if (userData?.subscription?.status === 'active' && userData?.subscription?.tier === 'premium') {
            console.log('üíé Premium subscriber detected from Firebase!');
            setAuth('paid');
            
            // Store subscription info
            localStorage.setItem('userEmail', user.email);
            localStorage.setItem('emailVerified', user.emailVerified ? 'true' : 'false');
            localStorage.setItem('subPlan', userData.subscription.plan || 'monthly');
            localStorage.setItem('subCurrentPeriodEnd', userData.subscription.expiresAt || '');
            localStorage.setItem('autoRenew', 'true');
            localStorage.setItem('lastLoginAt', new Date().toISOString());
            if (!localStorage.getItem('userCreatedAt')) {
              localStorage.setItem('userCreatedAt', userData.subscription.startedAt || new Date().toISOString());
            }
          } 
          // Default to free tier
          else {
            console.log('üÜì Free tier user');
            setAuth('free');
            
            // Store basic user info
            localStorage.setItem('userEmail', user.email);
            localStorage.setItem('emailVerified', user.emailVerified ? 'true' : 'false');
            localStorage.setItem('lastLoginAt', new Date().toISOString());
            if (!localStorage.getItem('userCreatedAt')) {
              localStorage.setItem('userCreatedAt', new Date().toISOString());
            }
          }
        } catch (error) {
          console.error('Error fetching user data from Firebase:', error);
          // Fallback to free tier if there's an error
          setAuth('free');
          localStorage.setItem('userEmail', user.email);
          localStorage.setItem('emailVerified', user.emailVerified ? 'true' : 'false');
        }
      } else {
        console.log('‚ùå Firebase user signed out');
        // Reset to anonymous when signed out
        if (state.auth !== 'anon') {
          setAuth('anon');
        }
      }
    });
  }
}

// Helper function to get user data from Firestore
async function getUserData(userId) {
  try {
    const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js');
    const userRef = doc(window.db, 'users', userId);
    const userSnap = await getDoc(userRef);
    
    if (userSnap.exists()) {
      return userSnap.data();
    } else {
      console.log('No user document found in Firestore');
      return null;
    }
  } catch (error) {
    console.error('Error getting user data:', error);
    return null;
  }
}

// Initialize auth sync
setTimeout(() => {
  if (window.auth) {
    syncAuthWithFirebase();
  }
}, 1000);

// Handle payment success/cancel URLs
function handlePaymentResult() {
  const urlParams = new URLSearchParams(window.location.search);
  
  if (urlParams.get('success') === 'true') {
    console.log('üéâ Payment successful!');
    alert('üéâ Payment successful! Welcome to Premium!');
    
    // Update user subscription status
    if (window.auth?.currentUser) {
      updateUserSubscription(window.auth.currentUser.uid, {
        status: 'active',
        tier: 'premium',
        priceId: stripeConfig.priceId,
        startedAt: new Date().toISOString(),
        expiresAt: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString() // 30 days
      });
      
      // Update local auth state
      setAuth('paid');
    }
    
    // Clean up URL
    window.history.replaceState({}, document.title, window.location.pathname);
  }
  
  if (urlParams.get('canceled') === 'true') {
    console.log('‚ùå Payment canceled');
    alert('Payment was canceled. You can try again anytime.');
    
    // Clean up URL
    window.history.replaceState({}, document.title, window.location.pathname);
  }
}

// Check for payment results on page load
setTimeout(handlePaymentResult, 500);

// Add direct event listener to upgrade button
setTimeout(() => {
  const upgradeBtn = document.getElementById('upgradeNowBtn');
  if (upgradeBtn) {
    console.log('üîß Adding direct event listener to upgrade button');
    upgradeBtn.addEventListener('click', function(e) {
      console.log('üéØ Direct event listener triggered!');
      e.preventDefault();
      e.stopPropagation();
      handleUpgrade();
    });
  }
}, 2000);

// Update copyright year dynamically
try {
  var yearSpan = document.getElementById('copyrightYear');
  if (yearSpan) {
    yearSpan.textContent = new Date().getFullYear();
  }
} catch(e){ console.error('copyright year update', e); }
try{ renderScorecard(); }catch(e){ console.error('renderScorecard()', e); }
try{ renderAccount(); }catch(e){ console.error('renderAccount()', e); }
try{ renderProfile(); }catch(e){ console.error('renderProfile()', e); }
try{ reflectAuthButtons(); }catch(e){ console.error('reflectAuthButtons()', e); }
try{ updateHeaderUI(); }catch(e){ console.error('updateHeaderUI()', e); }
try{ updateMobileBanner(); }catch(e){ console.error('updateMobileBanner()', e); }

// Financial Dashboard Functions
async function refreshFinancialData() {
  console.log('üí∞ Refreshing financial data...');
  
  try {
    // Mock data for now - in production, this would fetch from Firebase
    const financialData = await calculateFinancialMetrics();
    
    // Update the UI with real data
    updateFinancialUI(financialData);
    
    console.log('‚úÖ Financial data refreshed successfully');
  } catch (error) {
    console.error('‚ùå Error refreshing financial data:', error);
    alert('‚ùå Failed to refresh financial data: ' + error.message);
  }
}

async function calculateFinancialMetrics() {
  // Mock data - replace with real Firebase queries
  const mockData = {
    totalUsers: 1, // Would query Firebase Auth users
    paidUsers: 0,  // Would query users with active subscriptions
    freeUsers: 1,  // Total - paid
    trialUsers: 0, // Users in trial period
    monthlyRevenue: 0, // Sum of active subscriptions
    conversionRate: 0, // (paid / total) * 100
    churnRate: 0, // Users who cancelled this month
    currentMonthRevenue: 0,
    annualProjection: 0
  };
  
  // In production, you would:
  // 1. Query Firebase Auth for total users
  // 2. Query users collection for subscription status
  // 3. Calculate revenue from active subscriptions
  // 4. Track conversion rates and churn
  
  return mockData;
}

function updateFinancialUI(data) {
  console.log('üí∞ Updating financial UI with data:', data);
  
  // Helper function to safely update element
  function safeUpdate(id, value) {
    const el = document.getElementById(id);
    if (el) {
      el.textContent = value;
      console.log(`‚úÖ Updated ${id}:`, value);
    } else {
      console.warn(`‚ö†Ô∏è Element not found: ${id}`);
    }
  }
  
  // Update all financial metrics
  safeUpdate('totalUsersCount', data.totalUsers);
  safeUpdate('paidUsersCount', data.paidUsers);
  safeUpdate('freeUsersCount', data.freeUsers);
  safeUpdate('trialUsersCount', data.trialUsers);
  safeUpdate('monthlyRevenue', `$${data.monthlyRevenue}`);
  safeUpdate('conversionRate', `${data.conversionRate}%`);
  safeUpdate('churnRate', `${data.churnRate}%`);
  safeUpdate('currentMonthRevenue', `$${data.currentMonthRevenue}`);
  safeUpdate('annualProjection', `$${data.annualProjection}`);
  
  // Calculate team payouts
  console.log('üí∞ Calculating team payouts...');
  calculateTeamPayouts();
}

function calculateTeamPayouts() {
  const monthlyRevenue = parseFloat(document.getElementById('currentMonthRevenue').textContent.replace('$', '')) || 0;
  const ownerShare = parseInt(document.getElementById('ownerShare').value) || 70;
  const teamShare = parseInt(document.getElementById('teamShare').value) || 30;
  
  // Ensure shares add up to 100%
  if (ownerShare + teamShare !== 100) {
    const total = ownerShare + teamShare;
    const normalizedOwnerShare = Math.round((ownerShare / total) * 100);
    const normalizedTeamShare = 100 - normalizedOwnerShare;
    
    document.getElementById('ownerShare').value = normalizedOwnerShare;
    document.getElementById('teamShare').value = normalizedTeamShare;
  }
  
  const ownerMonthly = (monthlyRevenue * ownerShare) / 100;
  const teamMonthly = (monthlyRevenue * teamShare) / 100;
  const annualProjection = monthlyRevenue * 12;
  
  document.getElementById('ownerMonthlyPayout').textContent = `$${ownerMonthly.toFixed(2)}`;
  document.getElementById('teamMonthlyPayout').textContent = `$${teamMonthly.toFixed(2)}`;
  document.getElementById('annualProjection').textContent = `$${annualProjection.toFixed(2)}`;
}

function exportFinancialReport() {
  const reportData = {
    generatedAt: new Date().toISOString(),
    metrics: {
      totalUsers: document.getElementById('totalUsersCount').textContent,
      paidUsers: document.getElementById('paidUsersCount').textContent,
      monthlyRevenue: document.getElementById('monthlyRevenue').textContent,
      conversionRate: document.getElementById('conversionRate').textContent
    },
    teamPayouts: {
      ownerShare: document.getElementById('ownerShare').value + '%',
      teamShare: document.getElementById('teamShare').value + '%',
      ownerMonthly: document.getElementById('ownerMonthlyPayout').textContent,
      teamMonthly: document.getElementById('teamMonthlyPayout').textContent,
      annualProjection: document.getElementById('annualProjection').textContent
    },
    pricing: {
      monthly: document.getElementById('monthlyPrice').value,
      annual: document.getElementById('annualPrice').value
    }
  };
  
  const dataStr = JSON.stringify(reportData, null, 2);
  const dataBlob = new Blob([dataStr], {type: 'application/json'});
  const url = URL.createObjectURL(dataBlob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `financial-report-${new Date().toISOString().split('T')[0]}.json`;
  link.click();
  URL.revokeObjectURL(url);
  
  alert('‚úÖ Financial report exported!');
}

function viewUserDetails() {
  // This would open a detailed user breakdown
  alert('üë• User details view - Coming soon!\n\nThis will show:\n‚Ä¢ Individual user subscription status\n‚Ä¢ Payment history\n‚Ä¢ Usage analytics\n‚Ä¢ Churn predictions');
}

function updateSubscriptionPricing() {
  const monthlyPrice = parseFloat(document.getElementById('monthlyPrice').value);
  const annualPrice = parseFloat(document.getElementById('annualPrice').value);
  
  if (!monthlyPrice || !annualPrice) {
    alert('‚ùå Please enter valid prices');
    return;
  }
  
  // In production, this would update Stripe pricing
  console.log('üí∞ Updating subscription pricing:', { monthlyPrice, annualPrice });
  
  // Store in localStorage for now
  localStorage.setItem('subscriptionPricing', JSON.stringify({
    monthly: monthlyPrice,
    annual: annualPrice,
    updatedAt: new Date().toISOString()
  }));
  
  alert('‚úÖ Subscription pricing updated!\n\nNote: This updates local settings. In production, this would update your payment processor.');
}

// Initialize financial dashboard when tab is loaded
function initializeFinancialDashboard() {
  console.log('üí∞ Initializing Financial Dashboard...');
  
  try {
    // Load saved pricing
    const savedPricing = localStorage.getItem('subscriptionPricing');
    if (savedPricing) {
      const pricing = JSON.parse(savedPricing);
      const monthlyPriceEl = document.getElementById('monthlyPrice');
      const annualPriceEl = document.getElementById('annualPrice');
      if (monthlyPriceEl) monthlyPriceEl.value = pricing.monthly || 15;
      if (annualPriceEl) annualPriceEl.value = pricing.annual || 150;
    }
    
    // Load saved team split
    const savedSplit = localStorage.getItem('teamSplit');
    if (savedSplit) {
      const split = JSON.parse(savedSplit);
      const ownerShareEl = document.getElementById('ownerShare');
      const teamShareEl = document.getElementById('teamShare');
      if (ownerShareEl) ownerShareEl.value = split.owner || 70;
      if (teamShareEl) teamShareEl.value = split.team || 30;
    }
    
    // Add event listeners for real-time calculations (only if elements exist)
    const ownerShareEl = document.getElementById('ownerShare');
    const teamShareEl = document.getElementById('teamShare');
    const monthlyPriceEl = document.getElementById('monthlyPrice');
    const annualPriceEl = document.getElementById('annualPrice');
    
    if (ownerShareEl) ownerShareEl.addEventListener('input', calculateTeamPayouts);
    if (teamShareEl) teamShareEl.addEventListener('input', calculateTeamPayouts);
    if (monthlyPriceEl) monthlyPriceEl.addEventListener('input', calculateTeamPayouts);
    if (annualPriceEl) annualPriceEl.addEventListener('input', calculateTeamPayouts);
    
    console.log('‚úÖ Event listeners attached');
    
    // Load initial data
    console.log('üîÑ Loading initial financial data...');
    refreshFinancialData();
  } catch (error) {
    console.error('‚ùå Error initializing financial dashboard:', error);
    alert('‚ùå Error initializing financial dashboard: ' + error.message);
  }
}
</script>
</body>
</html>
