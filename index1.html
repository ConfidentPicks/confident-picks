<!DOCTYPE html>
<!-- saved from url=(0051)file:///D:/cursor/confident-picks/index3.html#picks -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Confident Picks - Expert Sports Betting Analysis</title>

<!-- Asset links removed - will be added when assets are ready -->
<meta name="theme-color" content="#0B0F14">

<meta name="description" content="Get confident sports betting picks with real-time results tracking. Expert analysis and performance metrics to improve your betting strategy.">
<meta property="og:title" content="Confident Picks - Expert Sports Betting Analysis">
<meta property="og:description" content="Get confident sports betting picks with real-time results tracking. Expert analysis and performance metrics to improve your betting strategy.">
<meta property="og:type" content="website">
<!-- <meta property="og:image" content="/og-image.png"> -->
<meta property="og:url" content="https://confident-picks.com">
<meta name="twitter:card" content="summary_large_image">

<!-- Firebase SDK -->
<script src="./js/firebase-app-compat.js"></script>
<script src="./js/firebase-firestore-compat.js"></script>
<script src="./js/firebase-auth-compat.js"></script>

<!-- Firebase Config -->
<script src="./js/firebase-config.js"></script>

<style>
:root{
  --bg:#0B0F14; --card:#121820; --text:#E6EDF3; --sub:#98A6B3;
  --blue:#4DA3FF; --green:#22C55E; --red:#FF6B6B; --border:#ffffff18; --r:12px;

  --select-popup-bg:#0B0F14;
  --select-popup-text:#E6EDF3;
}
:root[data-theme="light"]{
  --bg:#ffffff; --card:#F4F6F8; --text:#0B0F14; --sub:#475569; --border:#00000014;
  --select-popup-bg:#ffffff;
  --select-popup-text:#0B0F14;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial;background:var(--bg);color:var(--text); color-scheme: dark;}
:root[data-theme="light"] body{ color-scheme: light; }

.container{max-width:1024px;margin:0 auto;padding:16px}
.hidden{display:none}
.header{position:sticky;top:0;background:rgba(0,0,0,.2);backdrop-filter:blur(8px);border-bottom:1px solid var(--border);z-index:1000}
.row{display:flex;gap:12px;align-items:center;justify-content:space-between}
.logo{display:flex;align-items:center;gap:8px}
.logo .brandmark{ width:32px; height:32px; display:inline-block; object-fit:contain; }
.logo strong{ letter-spacing:.2px; }

.btn{padding:8px 12px;border-radius:var(--r);border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--text);cursor:pointer}
.btn.primary{background:var(--blue);color:#0B0F14;border-color:transparent}
.btn.danger{border-color:var(--red);color:var(--red);background:transparent}
.btn.ghost{background:transparent}
.btn:disabled{opacity:.5;cursor:not-allowed;}

/* Loading states */
.btn.loading{position:relative;pointer-events:none}
.btn.loading::after{content:'';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:16px;height:16px;border:2px solid currentColor;border-top:2px solid transparent;border-radius:50%;animation:spin 1s linear infinite}
.btn.loading .btn-text{opacity:0}
@keyframes spin{to{transform:translate(-50%,-50%) rotate(360deg)}}

/* Theme toggle icon styling */
.theme-icon {
  font-size: 18px;
  line-height: 1;
}
.theme-icon::before {
  content: '☽';
  color: #ffffff;
}
:root[data-theme="light"] .theme-icon::before {
  content: '☀';
  color: #0B0F14;
}

/* Help modal styling */
.help-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 3000;
  padding: 20px;
}
.help-modal.active {
  display: flex;
}
.help-content {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 24px;
  max-width: 500px;
  width: 100%;
  max-height: 80vh;
  overflow-y: auto;
}
.help-shortcuts {
  display: grid;
  gap: 12px;
  margin-top: 16px;
}
.help-shortcut {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
}
.help-shortcut:last-child {
  border-bottom: none;
}
.kbd {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 2px 8px;
  font-family: monospace;
  font-size: 12px;
  font-weight: 600;
}

/* Enhanced button styling for key actions */
.btn.enhanced {
  border-radius: 999px;
  transition: all 0.2s ease;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  font-weight: 600;
}
.btn.enhanced:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}
.btn.enhanced.primary {
  box-shadow: 0 3px 8px rgba(77,163,255,0.3);
}
.btn.enhanced.primary:hover {
  box-shadow: 0 4px 12px rgba(77,163,255,0.4);
}

/* Error state styling */
.error {
  color: var(--red);
  text-align: center;
  padding: 20px;
}
.error h3 {
  margin-bottom: 10px;
}
.error button {
  margin-top: 15px;
}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;margin-left:6px}
.badge.win{color:var(--green);border-color:var(--green)}
.badge.loss{color:var(--red);border-color:var(--red)}
.badge.push{color:var(--sub)}
.card{background:var(--card);border-radius:var(--r);border:1px solid var(--border);padding:12px}
.grid{display:grid;gap:12px}
.chip{position:relative; padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border)}
.chip.safe{color:var(--green);border-color:var(--green)}
.chip.degen{color:var(--red);border-color:var(--red)}
.text-sub{color:var(--sub);font-size:14px}
.kbd{font-family:ui-monospace, Menlo, Monaco, Consolas, "Courier New", monospace; background:rgba(255,255,255,.06); padding:2px 6px; border-radius:6px; border:1px solid var(--border);}
.star{
  width:20px;height:20px;display:inline-block;border-radius:8px;
  border:1px solid var(--border);background:rgba(255,255,255,.06);cursor:pointer;
  transition: all 0.2s ease;
  transform: scale(1);
}
.star:hover{
  background:rgba(255,255,255,.12);
  transform: scale(1.1);
}
.star:active{
  transform: scale(0.95);
}
.star.on{
  background:var(--blue);
  box-shadow: 0 2px 8px rgba(77,163,255,0.3);
}
.tabs,.smalltabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{
  padding:8px 12px;border:1px solid var(--border);border-radius:999px;
  background:rgba(255,255,255,.06);cursor:pointer;
  transition: all 0.2s ease;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.tab:hover{
  background:rgba(255,255,255,.12);
  transform: translateY(-1px);
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}
.tab.active{
  background:var(--blue);color:#0B0F14;border-color:transparent;
  box-shadow: 0 3px 8px rgba(77,163,255,0.3);
}

/* Pick Cards - Target Design */
.pick-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
  position: relative;
  min-height: 120px;
  z-index: 1; /* Ensure cards don't overlay filters */
}

.pick-sport-market {
  color: var(--sub);
  font-size: 14px;
  margin-bottom: 8px;
}

.pick-main {
  font-size: 18px;
  font-weight: bold;
  color: var(--text);
  margin-bottom: 8px;
}

.pick-prediction {
  font-size: 16px;
  font-weight: 600;
  color: var(--blue);
  margin-bottom: 8px;
}

.pick-reasoning-container {
  margin-bottom: 8px;
}

.pick-reasoning-preview {
  color: var(--sub);
  font-size: 14px;
  line-height: 1.4;
  margin-bottom: 4px;
}

.pick-reasoning-toggle {
  background: none;
  border: none;
  color: var(--blue);
  font-size: 12px;
  cursor: pointer;
  padding: 0;
  text-decoration: underline;
}

.pick-reasoning-toggle:hover {
  color: var(--text);
}

.pick-reasoning-full {
  color: var(--sub);
  font-size: 14px;
  line-height: 1.4;
  margin-top: 8px;
  padding: 8px;
  background: rgba(255,255,255,0.05);
  border-radius: 6px;
}

.pick-details {
  display: flex;
  gap: 16px;
  margin-bottom: 8px;
}

.pick-confidence {
  background: var(--green);
  color: #0B0F14;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 500;
}

.pick-odds {
  color: var(--text);
  font-size: 14px;
}

.pick-reasoning {
  color: var(--sub);
  font-size: 14px;
  margin-bottom: 8px;
  line-height: 1.4;
}

.pick-time {
  color: var(--sub);
  font-size: 14px;
}

.pick-badge {
  position: absolute;
  top: 16px;
  right: 16px;
  background: var(--green);
  color: #0B0F14;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: bold;
  z-index: 2; /* Ensure badge stays on top */
}

/* Ensure proper spacing for picks display */
#picks-display {
  margin-top: 20px; /* Add space below filters */
  position: relative;
  z-index: 1;
}

/* Favorites button - only for subscribed members */
.pick-favorite-btn {
  position: absolute;
  top: 50px; /* Position under the SAFE badge */
  right: 16px;
  width: 32px;
  height: 32px;
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid var(--border);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 16px;
  transition: all 0.2s ease;
  opacity: 0.7;
  z-index: 2;
}

.pick-favorite-btn:hover {
  background: rgba(255, 255, 255, 0.2);
  opacity: 1;
  transform: scale(1.1);
}

.pick-favorite-btn.active {
  background: var(--blue);
  border-color: var(--blue);
  opacity: 1;
  box-shadow: 0 2px 8px rgba(77, 163, 255, 0.3);
}

/* Parlay Button Styling */
.parlay-btn {
  position: absolute;
  bottom: 16px;
  right: 16px;
  padding: 6px 12px;
  font-size: 12px;
  font-weight: 500;
  background: transparent;
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--sub);
  cursor: pointer;
  transition: all 0.2s ease;
  z-index: 2;
}

.parlay-btn:hover {
  background: rgba(77, 163, 255, 0.1);
  border-color: var(--blue);
  color: var(--blue);
}

.parlay-btn.selected {
  background: var(--blue);
  border-color: var(--blue);
  color: #0B0F14;
}

/* Hide favorites button for non-subscribers */
.non-subscriber .pick-favorite-btn {
  display: none;
}
.nav a{color:var(--text); text-decoration:none; opacity:.85}
.nav a.active{opacity:1; font-weight:600; text-decoration:underline; text-decoration-color: var(--blue)}

/* 🔲 Section frame */
.panel{
  background: var(--card);
  border: 1px solid #ffffff26;
  border-radius: 16px;
  padding: 16px;
  box-shadow: 0 0 0 1px rgba(255,255,255,0.03) inset;
}
:root[data-theme="light"] .panel{
  background:#ffffff;
  border-color:#00000022;
  box-shadow:none;
}

/* Filters */
.filters{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
@media (max-width:800px){
  .container { padding: 12px; }
  .filters{grid-template-columns:1fr 1fr}
  .filters input, .filters select { padding: 14px; font-size: 16px; }
  
  /* Enhanced mobile touch targets */
  .btn { padding: 12px 16px; min-height: 44px; }
  .tab { padding: 12px 16px; min-height: 44px; }
  .star { width: 32px; height: 32px; }
  .minconf .step { width: 32px; height: 20px; font-size: 14px; }
  input, select, textarea { padding: 14px; min-height: 44px; }
}

/* Additional mobile optimizations for smaller screens */
@media (max-width: 480px) {
  .container { padding: 8px; }
  .filters { grid-template-columns: 1fr; gap: 8px; }
  .filters input, .filters select { padding: 12px; font-size: 16px; }
  .card { padding: 10px; }
  .header .row { padding: 0 8px; }
}
input,select,textarea{width:100%;padding:10px;border-radius:var(--r);border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--text);font-family:inherit}
.filters input, .filters select{ background: rgba(255,255,255,.12); border-color: #ffffff2e; color: var(--text); font-weight: 600; }
.filters input::placeholder{ color: var(--text); opacity:.9; }
.filters .text-sub{ color: var(--text); opacity:.9; font-weight:600; }

/* dropdown popup legibility */
.filters select{ color-scheme: dark; }
:root[data-theme="light"] .filters select{ color-scheme: light; }
.filters select option, .filters select optgroup{
  background-color: var(--select-popup-bg) !important;
  color: var(--select-popup-text) !important;
  font-weight:600;
}

/* Settings dropdowns - match filters styling */
.settings-select{ 
  background: rgba(255,255,255,.12) !important; 
  border-color: #ffffff2e !important; 
  color: var(--text) !important; 
  font-weight: 600 !important;
  color-scheme: dark;
}
:root[data-theme="light"] .settings-select{ color-scheme: light; }
.settings-select option, .settings-select optgroup{
  background-color: var(--select-popup-bg) !important;
  color: var(--select-popup-text) !important;
  font-weight:600;
}

/* Contact form dropdown styling */
#contactSubject { 
  background: rgba(255,255,255,.12) !important; 
  border-color: #ffffff2e !important; 
  color: var(--text) !important; 
  font-weight: 600 !important;
  color-scheme: dark;
}
:root[data-theme="light"] #contactSubject { color-scheme: light; }
#contactSubject option, #contactSubject optgroup {
  background-color: var(--select-popup-bg) !important;
  color: var(--select-popup-text) !important;
  font-weight: 600;
}
:focus-visible { outline:2px solid var(--blue); outline-offset:2px; border-radius:6px; }

/* Pick List Format Styling */
.picks-container {
  display: flex !important;
  flex-direction: column !important;
  gap: 16px !important;
  grid-template-columns: none !important;
}

/* Ensure pick cards match other tabs exactly */
.pick-list-item,
.pick-card {
  background: var(--card) !important;
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 16px;
  transition: all 0.2s ease;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.pick-list-item {
  width: 100% !important;
}

.pick-list-item:hover {
  background: rgba(255,255,255,.02);
  border-color: var(--blue);
}

.pick-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 8px;
}

.pick-league {
  color: var(--sub);
  font-size: 14px;
  font-weight: 600;
}

.pick-team {
  color: var(--text);
  font-size: 16px;
  flex: 1;
}

.pick-status {
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
  border: 1px solid;
}

.pick-status.safe {
  color: var(--green);
  border-color: var(--green);
  background: rgba(34, 197, 94, 0.1);
}

.pick-details {
  display: flex;
  gap: 8px;
  margin-bottom: 8px;
  color: var(--sub);
  font-size: 14px;
}

.pick-confidence {
  color: var(--text);
}

.pick-reasoning {
  color: var(--sub);
  font-size: 14px;
  line-height: 1.4;
  margin-bottom: 8px;
}

.pick-meta {
  color: var(--sub);
  font-size: 12px;
}

/* Existing styles continue below */
.minconf {
  position: relative;
  display: inline-block;
}
.minconf input {
  width: 100%;
  padding: 10px 44px 10px 10px;
  border-radius: var(--r);
  border: 1px solid var(--border);
  background: rgba(255,255,255,.12);
  border-color: #ffffff2e;
  color: var(--text);
  font-weight: 600;
}
.minconf .steppers {
  position: absolute;
  right: 6px;
  top: 6px;
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.minconf .step {
  width: 20px;
  height: 12px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,.06);
  border-radius: 4px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  line-height: 1;
  color: var(--text);
}
.minconf .step:hover {
  background: rgba(255,255,255,.12);
}
.minconf .caption {
  font-size: 11px;
  color: var(--sub);
  margin-top: 4px;
}
:root[data-theme="light"] .minconf input {
  background: #ffffff;
  border-color: #00000022;
}

/* keep native spinners hidden for other inputs */
input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button{ -webkit-appearance:none; margin:0; }
input[type=number]{ -moz-appearance:textfield; appearance:textfield; }

/* Scorecard metrics side-by-side */
.metrics{ display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin:12px 0; }
.metrics .card{ background: rgba(255,255,255,.04); border: 1px solid var(--border); border-radius: 12px; }
.metrics .label{ color: var(--sub); font-size: 14px; margin-bottom: 6px; }
.metrics .value{ font-size: 28px; font-weight: 800; letter-spacing: .3px; }
@media (max-width: 720px){ .metrics{ grid-template-columns: 1fr; } }

/* locked teaser */
.locked-card{ position:relative; overflow:hidden; border:1px solid var(--border); border-radius:var(--r); background:var(--card); }
.locked-inner{ filter: blur(6px); opacity:.65; pointer-events:none; z-index:1; position:relative; }
.locked-veil{ position:absolute; inset:0; background:linear-gradient(180deg, rgba(11,15,20,0.25), rgba(11,15,20,0.55)); backdrop-filter: blur(2px); z-index:2; pointer-events:none; }
.locked-cta{ position:absolute; inset:auto 12px 12px 12px; display:flex; gap:8px; align-items:center; justify-content:space-between; z-index:3; }
.locked-label{ font-size:12px; color:var(--sub); position:absolute; top:8px; left:12px; padding:2px 6px; border:1px solid var(--border); border-radius:999px; background:rgba(255,255,255,.06); z-index:3; }

/* mobile banner */
.mobile-banner{ display:none; position:fixed; bottom:0; left:0; right:0; z-index:10; background:var(--card); border-top:1px solid var(--border); padding:12px; }
@media (max-width:800px){ 
  .mobile-banner.visible{ display:flex; align-items:center; justify-content:space-between; gap:12px; } 
  body{ padding-bottom:70px; }
  
  /* Ensure content fills mobile viewport properly */
  .container { max-width: 100%; }
  .card { margin: 0; }
  .filters { margin: 0; }
}

/* maintenance banner */
.site-banner{ display:flex; align-items:center; gap:12px; background:linear-gradient(180deg, rgba(77,163,255,.18), rgba(34,197,94,.18)); border:1px solid var(--border); border-radius:10px; padding:10px 12px; margin:12px 0; }
.site-banner .label{ font-weight:700; }
.site-banner .dismiss{ margin-left:auto; }

/* Account page small bits */
.account-wrap{ max-width:720px; margin: 0 auto; }
.authTabs{ display:flex; gap:8px; margin-top:8px; }
.authTabs .tab{ flex:0 0 auto; }
.divider{ display:flex; align-items:center; gap:10px; margin:10px 0; }
.divider:before, .divider:after{ content:""; height:1px; background:var(--border); flex:1; }
.helper{ font-size:12px; color:var(--sub); margin-top:6px; }

.result-list{margin-top:12px}
.result-row,.out-row{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 12px;border:1px solid var(--border);border-radius:10px;margin-top:8px;background:rgba(255,255,255,.04)}
.reasoning{margin-top:6px;color:var(--sub);font-size:14px;line-height:1.35}

footer{color:var(--sub);font-size:14px;padding:24px 0;text-align:center}
footer a{ color:var(--sub); text-decoration:underline }
/* Password gate (temporary) */
#gate{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.6); z-index:2000; }
#gate .box{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; width:min(420px,92vw); }
#gate .title{ font-weight:700; margin-bottom:8px; }
#gate .sub{ color:var(--sub); font-size:14px; margin-bottom:12px; }
html.gated #gate{ display:flex; }
html.gated body > *:not(#gate){ display:none !important; }

/* Admin Portal Styles */
.tabs {
  display: flex;
  gap: 4px;
  border-bottom: 1px solid rgba(255,255,255,.1);
  margin-bottom: 16px;
}

.tab {
  background: none;
  border: none;
  color: var(--text-sub);
  padding: 8px 16px;
  cursor: pointer;
  border-radius: 8px 8px 0 0;
  transition: all 0.2s ease;
  border-bottom: 2px solid transparent;
}

.tab:hover {
  background: rgba(255,255,255,.05);
  color: var(--text);
}

.tab.active {
  background: rgba(255,255,255,.1);
  color: var(--text);
  border-bottom-color: var(--primary);
}

.admin-tab-content {
  animation: fadeIn 0.3s ease;
}

.metrics {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 12px;
}

.metrics .card {
  padding: 12px;
  text-align: center;
  background: rgba(255,255,255,.02);
}

.metrics .label {
  font-size: 12px;
  color: var(--text-sub);
  margin-bottom: 4px;
}

.metrics .value {
  font-size: 24px;
  font-weight: bold;
  color: var(--primary);
}

/* Navigation Tab Highlighting */
.nav a[data-nav] {
  position: relative;
  transition: all 0.2s ease;
  border-radius: 6px;
  padding: 6px 12px;
}

.nav a[data-nav]:hover {
  background: rgba(255,255,255,.08);
  color: var(--text);
}

.nav a[data-nav].active {
  background: rgba(77,163,255,.15);
  color: var(--primary);
  font-weight: 600;
}

.nav a[data-nav].active::before {
  content: '';
  position: absolute;
  bottom: -2px;
  left: 50%;
  transform: translateX(-50%);
  width: 20px;
  height: 2px;
  background: var(--primary);
  border-radius: 1px;
}



/* Parlay Button Styling */
.parlay-btn {
  display: inline-block;
  padding: 4px 8px;
  margin-left: 8px;
  font-size: 12px;
  font-weight: 500;
  background: transparent;
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--sub);
  cursor: pointer;
  transition: all 0.2s ease;
}

.parlay-btn:hover {
  background: rgba(77, 163, 255, 0.1);
  border-color: var(--blue);
  color: var(--blue);
}

.parlay-btn.selected {
  background: var(--blue);
  border-color: var(--blue);
  color: #0B0F14;
}

/* Pick Card Styles */
.picks-container {
  display: grid;
  gap: 1.5rem;
  grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
}

.pick-card {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  padding: 1.5rem;
  transition: all 0.3s;
}

.pick-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
  border-color: rgba(0, 212, 170, 0.3);
}

.pick-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.pick-teams {
  font-size: 1.1rem;
  font-weight: 600;
}

.pick-confidence {
  background: linear-gradient(135deg, #00D4AA, #00B8FF);
  color: #0B0F14;
  padding: 0.25rem 0.75rem;
  border-radius: 20px;
  font-size: 0.9rem;
  font-weight: 600;
}

.pick-details {
  margin-bottom: 1rem;
}

.pick-market {
  font-size: 0.9rem;
  color: #A0A3A9;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 0.5rem;
}

.pick-prediction {
  font-size: 1.2rem;
  font-weight: 700;
  color: #00D4AA;
  margin-bottom: 0.5rem;
}

.pick-odds {
  display: flex;
  gap: 1rem;
  margin-bottom: 1rem;
}

.odds-item {
  background: rgba(255, 255, 255, 0.05);
  padding: 0.5rem 1rem;
  border-radius: 6px;
  text-align: center;
  flex: 1;
}

.odds-name {
  font-size: 0.8rem;
  color: #A0A3A9;
  margin-bottom: 0.25rem;
}

.odds-price {
  font-weight: 600;
  color: #E8E9EA;
}

.pick-reasoning {
  font-size: 0.9rem;
  color: #A0A3A9;
  line-height: 1.5;
}

.pick-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  font-size: 0.8rem;
  color: #A0A3A9;
}

/* Loading and empty states */
.loading {
  text-align: center;
  padding: 3rem;
  color: #A0A3A9;
}

.empty-state {
  text-align: center;
  padding: 3rem;
  color: #A0A3A9;
}

.empty-state h3 {
  margin-bottom: 1rem;
  color: #E8E9EA;
}

/* Status indicators */
.status-pending {
  color: #FFA500;
}

.status-won {
  color: #00D4AA;
}

.status-lost {
  color: #FF6B6B;
}






</style>
<script>
(function(){
  try {
    var ok = localStorage.getItem('cp_gate_ok') === '1';
    if (!ok) document.documentElement.classList.add('gated');
  } catch(e){ document.documentElement.classList.add('gated'); }
})();
</script>
</head>
<body>



<div class="header">
      <div class="container row" style="align-items: center; display: flex; flex-direction: row; gap: 0; justify-content: center;">
      <div style="display: flex; align-items: center; gap: 8px;">
        <div class="logo" id="logoHome" style="cursor: pointer; aria-label="Return to home; display: flex;">
          <div style="display: flex; align-items: center; gap: 4px;">
            <img src="./logo.png" alt="Confident Picks Logo" style="height:40px; width:auto;">
            <div style="display: flex; flex-direction: row; align-items: center; gap: 4px;">
              <div style="color: white; font-weight: bold; font-size: 16px;">Confident</div>
              <div style="color: white; font-weight: bold; font-size: 16px;">Picks</div>
            </div>
          </div>
        </div>
        <div class="row nav" style="gap:8px; align-items: center; display: flex; flex-direction: row;">
      <a href="#picks" data-nav="" class="active">Picks</a>
      <a href="#scorecard" data-nav="">Scorecard</a>
      <a href="#outcomes" data-nav="">Outcomes</a>
      <a href="#favorites" data-nav="">Favorites</a>
      <a href="#account" data-nav="" id="navAccount">Account</a>
      <a href="#admin" data-nav="" id="navAdmin" class="hidden">Admin</a>
      <button type="button" id="themeBtn" class="btn enhanced" aria-label="Toggle theme"><span class="theme-icon" aria-hidden="true"></span></button>
      <button type="button" id="authBtn" class="btn primary enhanced">Sign out</button>
      <button type="button" id="upgradeBtn" class="btn primary enhanced hidden">Upgrade</button>
    </div>
  </div>
</div>

<div class="container">



  <!-- PICKS -->
  <section id="view-picks">
    <div class="filters">
      <select id="leagueSel">
        <option value="">All Leagues</option>
        <option>MLB</option>
        <option>NFL</option>
        <option>NBA</option>
        <option>NHL</option>
        <option>CFB</option>
        <option>CBB</option>
        <option>MLS</option>
        <option>UFC</option>
      </select>
      
      <select id="marketSel">
        <option value="">All Markets</option>
        <option value="moneyline">Moneyline</option>
        <option value="spread">Spread</option>
        <option value="totals">Totals</option>
        <option value="props">Props</option>
        <option value="player-props">Player Props</option>
        <option value="team-props">Team Props</option>
        <option value="alt-lines">Alt Lines</option>
      </select>
      
      <select id="sortSel">
        <option value="commence">Sort: Commence Time</option>
        <option value="confidence">Sort: Confidence</option>
      </select>
      <input id="searchInp" placeholder="Search team/player…">

      <!-- Min Confidence with compact v38 steppers -->
      <div class="minconf">
        <input id="minConf" type="number" min="0" max="100" value="70" placeholder="Min Confidence" aria-label="Minimum confidence threshold">
        <div class="steppers">
          <div class="step" data-step="5" aria-label="Increase confidence by 5">+</div>
          <div class="step" data-step="-5" aria-label="Decrease confidence by 5">-</div>
        </div>
        <div class="caption">Min Confidence</div>
      </div>
    </div>

    <!-- Firebase Controls - REMOVED -->
    <!-- <div class="row" style="gap:8px; margin-top:12px; justify-content:center;">
      <button class="btn primary enhanced" onclick="testButtonClick()">Test Button</button>
      <button class="btn primary enhanced" onclick="generateNewPicks()">Generate New Picks</button>
      <button class="btn enhanced" onclick="loadPicksFromFirebase()">Refresh Picks</button>
      <button class="btn enhanced" onclick="testFirebaseConnection()">Test Connection</button>
    </div> -->

    <!-- Picks Display -->
    <div id="picks-display" style="display: block;">
    <div class="picks-container">
      <div class="pick-list-item">
        <div class="pick-header">
          <span class="pick-league">NFL • spread</span>
          <span class="pick-team"><strong>Eagles -7 vs NYG</strong></span>
          <span class="pick-status safe">SAFE</span>
        </div>
        <div class="pick-details">
          <span class="pick-confidence">Confidence: <span style="color:var(--green)">88%</span></span>
          <span class="pick-odds">• Odds: -110</span>
        </div>
        <div class="pick-reasoning">Reasoning: —</div>
        <div class="pick-meta">Commences: Jul 24, 2025, 8:48 PM</div>
        <div class="pick-subscription">(Favorites for subscribers)</div>
      </div>

      <div class="pick-list-item">
        <div class="pick-header">
          <span class="pick-league">MLB • moneyline</span>
          <span class="pick-team"><strong>Rays ML vs Yankees</strong></span>
          <span class="pick-status safe">SAFE</span>
        </div>
        <div class="pick-details">
          <span class="pick-confidence">Confidence: <span style="color:var(--green)">85%</span></span>
          <span class="pick-odds">• Odds: -120</span>
        </div>
        <div class="pick-reasoning">Reasoning: Rays bullpen rested; model edge ~1.9%.</div>
        <div class="pick-meta">Commences: Sep 3, 2025, 1:36 AM</div>
        <div class="pick-subscription">(Favorites for subscribers)</div>
      </div>

      <div class="pick-list-item">
        <div class="pick-header">
          <span class="pick-league">UFC • moneyline</span>
          <span class="pick-team"><strong>Jon Jones ML vs Stipe</strong></span>
          <span class="pick-status safe">SAFE</span>
        </div>
        <div class="pick-details">
          <span class="pick-confidence">Confidence: <span style="color:var(--green)">95%</span></span>
          <span class="pick-odds">• Odds: -180</span>
        </div>
        <div class="pick-reasoning">Reasoning: Jones 18-1 in title fights, reach advantage, superior ground game.</div>
        <div class="pick-meta">Commences: Sep 3, 2025, 8:48 AM</div>
        <div class="pick-subscription">(Favorites for subscribers)</div>
      </div>
    </div>

    <!-- Sign up message -->
    <div class="signup-message" style="margin-top: 16px; text-align: center; color: var(--sub); font-size: 14px;">
      Sign up for free to see 3 more picks.
    </div>

    <!-- Locked pick section -->
    <div class="locked-pick" style="margin-top: 16px; background: var(--card); border: 1px solid var(--border); border-radius: var(--r); padding: 16px; opacity: 0.6; filter: blur(2px);">
      <div class="pick-header">
        <span class="pick-league">Locked Pick</span>
        <span class="pick-team"><strong>Premium Content</strong></span>
        <span class="pick-status safe">SAFE</span>
      </div>
      <div class="pick-details">
        <span class="pick-confidence">Confidence: <span style="color:var(--green)">92%</span></span>
        <span class="pick-odds">• Odds: -150</span>
      </div>
      <div class="pick-reasoning">Reasoning: Premium analysis and advanced metrics...</div>
      <div class="pick-meta">Commences: Sep 4, 2025, 6:25 PM</div>
      <div style="text-align: center; margin-top: 12px;">
        <button class="btn primary" style="background: var(--blue); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer;">Sign up for free</button>
      </div>
    </div>
  </div>

    <div id="gatingNote" class="card text-sub hidden" style="margin-top:12px"></div>

    <div id="verifyBanner" class="card hidden" style="margin-top: 8px; align-items: center; justify-content: space-between; gap: 8px; display: none;">
      <div><strong>Verify your email</strong> to unlock free extras.</div>
      <div style="display:flex; gap:8px">
        <button id="sendVerifyBtn" class="btn" aria-label="Send email verification">Send verification</button>
        <button id="markVerifiedBtn" class="btn primary" aria-label="Mark email as verified">Mark verified</button>
      </div>
    </div>

    <div id="list" class="grid" style="margin-top: 12px; display: none;"><div class="card"><div class="text-sub">NFL • spread</div><div class="row" style="gap:8px"><div><strong>Eagles -7 vs NYG</strong></div><div class="chip safe">SAFE</div></div><div class="text-sub">Confidence: <span class="confidence-high" style="color:var(--green)">80%</span> • Odds: -110</div><div class="reasoning">Reasoning: —</div><div class="row" style="margin-top:6px;gap:8px"><div class="text-sub">Commences: Jul 24, 2025, 6:25 AM</div><div class="star " title="Favorite" role="button" aria-pressed="false" tabindex="0" data-fav="r11"></div></div></div><div class="card"><div class="text-sub">MLB • moneyline</div><div class="row" style="gap:8px"><div><strong>Astros ML vs TEX</strong></div><div class="chip safe">SAFE</div></div><div class="text-sub">Confidence: <span class="confidence-high" style="color:var(--green)">94%</span> • Odds: -150</div><div class="reasoning">Reasoning: —</div><div class="row" style="margin-top:6px;gap:8px"><div class="text-sub">Commences: Jul 29, 2025, 6:25 AM</div><div class="star " title="Favorite" role="button" aria-pressed="false" tabindex="0" data-fav="r10"></div></div></div><div class="card"><div class="text-sub">MLB • totals</div><div class="row" style="gap:8px"><div><strong>Under 7.5 LAD@SF</strong></div><div class="chip safe">SAFE</div></div><div class="text-sub">Confidence: <span class="confidence-medium" style="color:var(--blue)">77%</span> • Odds: -102</div><div class="reasoning">Reasoning: Marine layer; model 7.0.</div><div class="row" style="margin-top:6px;gap:8px"><div class="text-sub">Commences: Aug 13, 2025, 6:25 AM</div><div class="star " title="Favorite" role="button" aria-pressed="false" tabindex="0" data-fav="r9"></div></div></div><div class="card"><div class="text-sub">MLS • moneyline</div><div class="row" style="gap:8px"><div><strong>Inter Miami ML vs Atlanta</strong></div><div class="chip safe">SAFE</div></div><div class="text-sub">Confidence: <span class="confidence-medium" style="color:var(--blue)">78%</span> • Odds: -125</div><div class="reasoning">Reasoning: Messi effect + home field advantage in playoffs.</div><div class="row" style="margin-top:6px;gap:8px"><div class="text-sub">Commences: Aug 27, 2025, 6:25 AM</div><div class="star " title="Favorite" role="button" aria-pressed="false" tabindex="0" data-fav="r6"></div></div></div><div class="card"><div class="text-sub">CBB • spread</div><div class="row" style="gap:8px"><div><strong>Gonzaga -8.5 vs Saint Marys</strong></div><div class="chip safe">SAFE</div></div><div class="text-sub">Confidence: <span class="confidence-medium" style="color:var(--blue)">78%</span> • Odds: -105</div><div class="reasoning">Reasoning: Gonzaga 8-2 ATS as road favorites this season.</div><div class="row" style="margin-top:6px;gap:8px"><div class="text-sub">Commences: Aug 28, 2025, 6:25 AM</div><div class="star " title="Favorite" role="button" aria-pressed="false" tabindex="0" data-fav="r5"></div></div></div><div class="card"><div class="text-sub">UFC • team-props</div><div class="row" style="gap:8px"><div><strong>Fight Goes Distance</strong></div><div class="chip safe">SAFE</div></div><div class="text-sub">Confidence: <span class="confidence-medium" style="color:var(--blue)">77%</span> • Odds: -135</div><div class="reasoning">Reasoning: Both fighters cardio-heavy, defensive styles.</div><div class="row" style="margin-top:6px;gap:8px"><div class="text-sub">Commences: Aug 31, 2025, 6:25 AM</div><div class="star " title="Favorite" role="button" aria-pressed="false" tabindex="0" data-fav="r2"></div></div></div><div class="card"><div class="text-sub">MLB • moneyline</div><div class="row" style="gap:8px"><div><strong>Dodgers ML vs Mets</strong></div><div class="chip safe">SAFE</div></div><div class="text-sub">Confidence: <span class="confidence-high" style="color:var(--green)">88%</span> • Odds: -135</div><div class="reasoning">Reasoning: LAD #2 vs RHP last 30d; fair -146.</div><div class="row" style="margin-top:6px;gap:8px"><div class="text-sub">Commences: Aug 31, 2025, 6:25 PM</div><div class="star " title="Favorite" role="button" aria-pressed="false" tabindex="0" data-fav="r7"></div></div></div><div class="card"><div class="text-sub">MLB • moneyline</div><div class="row" style="gap:8px"><div><strong>Rays ML vs Yankees</strong></div><div class="chip safe">SAFE</div></div><div class="text-sub">Confidence: <span class="confidence-high" style="color:var(--green)">81%</span> • Odds: -120</div><div class="reasoning">Reasoning: Rays bullpen rested; model edge ~1.9%.</div><div class="row" style="margin-top:6px;gap:8px"><div class="text-sub">Commences: Sep 2, 2025, 11:13 AM</div><div class="star " title="Favorite" role="button" aria-pressed="false" tabindex="0" data-fav="7"></div></div></div><div class="card"><div class="text-sub">UFC • moneyline</div><div class="row" style="gap:8px"><div><strong>Jon Jones ML vs Stipe</strong></div><div class="chip safe">SAFE</div></div><div class="text-sub">Confidence: <span class="confidence-high" style="color:var(--green)">95%</span> • Odds: -180</div><div class="reasoning">Reasoning: Jones 18-1 in title fights, reach advantage, superior ground game.</div><div class="row" style="margin-top:6px;gap:8px"><div class="text-sub">Commences: Sep 2, 2025, 6:25 PM</div><div class="star " title="Favorite" role="button" aria-pressed="false" tabindex="0" data-fav="2"></div></div></div><div class="card"><div class="text-sub">CFB • spread</div><div class="row" style="gap:8px"><div><strong>Alabama -14 vs Tennessee</strong></div><div class="chip safe">SAFE</div></div><div class="text-sub">Confidence: <span class="confidence-high" style="color:var(--green)">81%</span> • Odds: -110</div><div class="reasoning">Reasoning: Alabama 9-1 ATS as home favorites, Tennessee missing key OL.</div><div class="row" style="margin-top:6px;gap:8px"><div class="text-sub">Commences: Sep 3, 2025, 6:25 AM</div><div class="star " title="Favorite" role="button" aria-pressed="false" tabindex="0" data-fav="4"></div></div></div></div>
  </section>

  <!-- SCORECARD -->
  <section id="view-scorecard" class="hidden">
    <div class="panel">
      <div class="row" style="gap:8px">
        <div><strong>Scorecard</strong> <span id="gradeBadge" class="grade b">Grade: B</span></div>
        <div class="tabs" role="tablist" aria-label="Scorecard Timeframe">
          <button type="button" class="tab score-tab active" role="tab" aria-selected="true" data-tf="7">Last 7 Days</button>
          <button type="button" class="tab score-tab" role="tab" aria-selected="false" data-tf="30">Last 30 Days</button>
          <button type="button" class="tab score-tab" role="tab" aria-selected="false" data-tf="180">Last 180 Days</button>
          <button type="button" class="tab score-tab" role="tab" aria-selected="false" data-tf="all">All-Time</button>
        </div>
      </div>

      <div class="metrics">
        <div class="card"><div class="label">Record</div><div class="value" id="mRecord">5-3-0</div></div>
        <div class="card"><div class="label">Win %</div><div class="value" id="mWinpct">62.5%</div></div>
      </div>

      <div id="resultsWrap" class="result-list"><div class="out-row" data-row="r1"><div><div><strong>Stephen Curry Over 4.5 Threes</strong> <span class="badge win">W</span></div><div class="text-sub">NBA • player-props • Odds +120 • Aug 31, 2025, 11:13 PM</div><div class="reasoning">Reasoning: Curry 7/10 overs vs this defense, pace advantage.</div></div><div class="text-sub">Aug 31, 2025, 6:25 PM</div></div><div class="out-row" data-row="r7"><div><div><strong>Dodgers ML vs Mets</strong> <span class="badge win">W</span></div><div class="text-sub">MLB • moneyline • Odds -135 • Aug 31, 2025, 11:13 PM</div><div class="reasoning">Reasoning: LAD #2 vs RHP last 30d; fair -146.</div></div><div class="text-sub">Aug 31, 2025, 6:25 PM</div></div><div class="out-row" data-row="r2"><div><div><strong>Fight Goes Distance</strong> <span class="badge loss">L</span></div><div class="text-sub">UFC • team-props • Odds -135 • Aug 31, 2025, 8:49 AM</div><div class="reasoning">Reasoning: Both fighters cardio-heavy, defensive styles.</div></div><div class="text-sub">Aug 31, 2025, 6:25 AM</div></div><div class="out-row" data-row="r8"><div><div><strong>Over 47.5 KC@BUF</strong> <span class="badge loss">L</span></div><div class="text-sub">NFL • totals • Odds -105 • Aug 31, 2025, 8:49 AM</div><div class="reasoning">Reasoning: Pace-up; both top-8 pass rate.</div></div><div class="text-sub">Aug 31, 2025, 6:25 AM</div></div><div class="out-row" data-row="r3"><div><div><strong>Connor McDavid Over 1.5 Points (Alt)</strong> <span class="badge win">W</span></div><div class="text-sub">NHL • alt-lines • Odds +165 • Aug 30, 2025, 11:13 AM</div><div class="reasoning">Reasoning: McDavid 15 points in last 8 games, matchup advantage.</div></div><div class="text-sub">Aug 30, 2025, 6:25 AM</div></div><div class="out-row" data-row="r4"><div><div><strong>Under 52.5 Points</strong> <span class="badge win">W</span></div><div class="text-sub">CFB • totals • Odds -110 • Aug 29, 2025, 8:49 AM</div><div class="reasoning">Reasoning: Weather conditions, both teams run-heavy offense.</div></div><div class="text-sub">Aug 29, 2025, 6:25 AM</div></div><div class="out-row" data-row="r5"><div><div><strong>Gonzaga -8.5 vs Saint Marys</strong> <span class="badge loss">L</span></div><div class="text-sub">CBB • spread • Odds -105 • Aug 28, 2025, 8:49 AM</div><div class="reasoning">Reasoning: Gonzaga 8-2 ATS as road favorites this season.</div></div><div class="text-sub">Aug 28, 2025, 6:25 AM</div></div><div class="out-row" data-row="r6"><div><div><strong>Inter Miami ML vs Atlanta</strong> <span class="badge win">W</span></div><div class="text-sub">MLS • moneyline • Odds -125 • Aug 27, 2025, 11:13 AM</div><div class="reasoning">Reasoning: Messi effect + home field advantage in playoffs.</div></div><div class="text-sub">Aug 27, 2025, 6:25 AM</div></div></div>
      <div id="resultsNote" class="text-sub" style="margin-top:10px"></div>

      <details id="scoreHelp" class="text-sub" style="margin-top:12px">
        <summary style="cursor:pointer">Grading guide</summary>
        <div class="helper">
          <strong>F</strong> &lt; 45% • <strong>D</strong> 45–49.9% • <strong>C</strong> 50–54.9% •
          <strong>B</strong> 55–64.9% • <strong>A</strong> ≥ 65%.
          For A-tier, add a <strong>+</strong> every +8% above 65 (capped at A+++):
          <strong>A+</strong> 73–80.9%, <strong>A++</strong> 81–88.9%, <strong>A+++</strong> ≥ 89%.
        </div>
      </details>
    </div>
  </section>

  <!-- OUTCOMES -->
  <section id="view-outcomes" class="hidden">
    <div class="panel" id="outcomesContainer">
      <!-- Content will be populated by renderOutcomes() -->
    </div>
  </section>

  <!-- Favorites -->
  <section id="view-favorites" class="hidden">
    <div class="panel">
      <div class="row" style="gap:8px; justify-content:space-between; align-items:center">
        <div><strong>My Favorites</strong></div>
        <button id="readFavoritesBtn" class="btn hidden">🔊 <span id="readFavoritesText">Read Favorites Aloud</span></button>
      </div>
      
      <!-- Parlay Calculator -->
      <div id="parlayCalculator" class="card" style="margin-top: 12px; background: rgba(77,163,255,0.1); border-color: var(--blue);">
        <div class="row" style="gap:8px; align-items:center; margin-bottom: 8px;">
          <div><strong>Parlay Calculator</strong></div>
          <div class="text-sub">Click "Add To Parlay" buttons to see combined odds</div>
        </div>
        <div id="parlayResult" class="text-sub" style="text-align: center; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; display: none;">
          <div><strong>Parlay Odds:</strong></div>
          <div id="parlayOdds" style="font-size: 18px; margin-top: 4px;"></div>
        </div>
      </div>
      <div id="favGate" style="margin-top:8px"></div>
      <div id="favList" class="grid" style="margin-top:12px"></div>
    </div>
  </section>

  <!-- ACCOUNT -->
  <section id="view-account" class="hidden">
    <div class="account-wrap" id="accountContainer"><div class="card account-wrap"><h3 style="margin:0 0 6px 0">Account</h3><div class="text-sub">You are signed in.</div><div class="text-sub">Email: google_user@example.com (verified)</div><div style="margin-top:8px"><strong>Status:</strong> Subscriber</div><div class="grid" style="grid-template-columns:1fr 1fr; gap:8px; margin-top:8px"><div class="card"><div class="text-sub">Member since</div><div><strong>Aug 31, 2025, 6:06 AM</strong></div></div><div class="card"><div class="text-sub">Last sign-in</div><div><strong>Sep 2, 2025, 3:07 AM</strong></div></div><div class="card"><div class="text-sub">Plan</div><div><strong>Monthly</strong></div></div><div class="card"><div class="text-sub">Renews on</div><div><strong>Oct 2, 2025, 3:07 AM</strong></div></div></div><div class="row" style="gap:8px; margin-top:12px"><button id="goPicksBtn" class="btn enhanced">Back to picks</button><button id="signOutBtn" class="btn danger enhanced">Sign out</button></div></div><div class="card" style="margin-top:12px">  <h4 style="margin:0 0 8px 0">Settings</h4>  <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px">    <div>      <div class="text-sub">Language</div>      <select id="languageSelect" class="input settings-select" style="margin-top:4px">        <option value="en">English</option>        <option value="es">Español</option>        <option value="fr">Français</option>        <option value="de">Deutsch</option>      </select>    </div>    <div>      <div class="text-sub">Theme</div>      <select id="themeSelect" class="input settings-select" style="margin-top:4px">        <option value="dark">Dark</option>        <option value="light">Light</option>        <option value="auto">Auto</option>      </select>    </div>  </div>  <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px">    <div>      <div class="text-sub">Voice Speed</div>      <select id="voiceSpeedSelect" class="input settings-select" style="margin-top:4px">        <option value="0.8">Slow</option>        <option value="1.0" selected="">Normal</option>        <option value="1.2">Fast</option>        <option value="1.4">Very Fast</option>      </select>    </div>    <div>      <div class="text-sub">Currency</div>      <select id="currencySelect" class="input settings-select" style="margin-top:4px">        <option value="USD">USD ($)</option>        <option value="EUR">EUR (€)</option>        <option value="GBP">GBP (£)</option>        <option value="CAD">CAD (C$)</option>      </select>    </div>  </div>  <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px">    <div>      <div class="text-sub">Enable Voice Reading</div>      <select id="voiceEnabledSelect" class="input settings-select" style="margin-top:4px">        <option value="false">Disabled</option>        <option value="true">Enabled</option>      </select>    </div>    <div></div>  </div>  <div class="row" style="gap:8px">    <button id="saveSettingsBtn" class="btn primary enhanced">Save Settings</button>    <button id="resetSettingsBtn" class="btn enhanced">Reset to Default</button>  </div></div><div class="card" style="margin-top:12px">  <div class="text-sub">Dev shortcut (local-only):</div>  <button id="enableAdminBtn" class="btn">Enable Admin on this device (mock)</button>  <button id="disableAdminBtn" class="btn hidden">Disable Admin on this device</button></div></div>
  </section>

  <!-- ADMIN PORTAL -->
  <section id="view-admin" class="hidden">
    <!-- Admin Navigation Tabs -->
    <div class="tabs" style="margin-bottom: 16px;">
      <button class="tab active" id="adminTabOverview" data-admin-tab="overview">Overview</button>
      <button class="tab" id="adminTabBanners" data-admin-tab="banners">Banners</button>
      <button class="tab" id="adminTabContent" data-admin-tab="content">Content</button>
      <button class="tab" id="adminTabUsers" data-admin-tab="users">Users</button>
      <button class="tab" id="adminTabSystem" data-admin-tab="system">System</button>
    </div>

    <!-- Overview Tab -->
    <div id="adminOverview" class="admin-tab-content">
    <div class="card">
        <h3 style="margin:0 0 16px 0">Admin Dashboard</h3>
      <div id="profileInfo"><div class="row"><div><strong>Status:</strong> Subscriber</div></div><div class="text-sub">Email: google_user@example.com</div><div class="text-sub">Verified: Yes</div></div>
        
        <div class="metrics" style="margin-top: 16px;">
          <div class="card">
            <div class="label">Total Users</div>
            <div class="value" id="adminUserCount">1</div>
      </div>
          <div class="card">
            <div class="label">Active Subscriptions</div>
            <div class="value" id="adminSubCount">1</div>
      </div>
      </div>
        
        <div class="text-sub" style="margin-top: 16px;">Quick Actions:</div>
        <div class="grid" style="grid-template-columns:repeat(3,1fr);margin-top:8px;gap:8px">
          <button type="button" class="btn enhanced" id="btnAnon">Switch to Anon</button>
          <button type="button" class="btn enhanced" id="btnFree">Switch to Free</button>
          <button type="button" class="btn enhanced primary" id="btnPaid">Switch to Paid</button>
        </div>
        <div class="grid" style="grid-template-columns:repeat(3,1fr);margin-top:8px;gap:8px">
          <button type="button" class="btn enhanced" id="btnAdmin">Switch to Admin</button>
          <button id="adminOffBtn" class="btn danger enhanced">Exit Admin</button>
        <div></div>
      </div>
      </div>
    </div>

    <!-- Banner Management Tab -->
    <div id="adminBanners" class="admin-tab-content hidden">
      <div class="card">
        <h4 style="margin:0 0 16px 0">Banner Management</h4>
        
        <!-- Current Banner Status -->
        <div class="card" style="background: rgba(255,255,255,.04); margin-bottom: 16px;">
          <div class="text-sub">Current Banner Status:</div>
          <div id="bannerStatus" style="margin-top: 8px;">
            <strong id="bannerStatusText" style="color: var(--text-sub);">No active banner</strong>
          </div>
        </div>
        
        <!-- Banner Creator -->
        <div style="margin-bottom: 16px;">
          <div class="text-sub" style="margin-bottom: 8px;">Create/Edit Banner:</div>
          <select id="bannerType" class="input enhanced" style="margin-bottom: 8px;">
            <option value="maintenance">Maintenance Notice</option>
            <option value="announcement">Announcement</option>
            <option value="warning">Warning</option>
            <option value="info">Information</option>
          </select>
          <input id="bannerTitle" class="input" placeholder="Banner title..." style="margin-bottom: 8px;">
          <textarea id="bannerMessage" class="input" placeholder="Banner message..." style="min-height: 80px; margin-bottom: 8px;"></textarea>
          <div class="row" style="gap: 8px;">
            <button id="previewBannerBtn" class="btn enhanced">Preview</button>
            <button id="activateBannerBtn" class="btn primary enhanced">Activate Banner</button>
            <button id="hideBannerBtn" class="btn danger enhanced">Hide Banner</button>
          </div>
        </div>
        
        <!-- Banner Templates -->
        <div class="text-sub" style="margin-bottom: 8px;">Quick Templates:</div>
        <div class="grid" style="grid-template-columns:repeat(2,1fr);gap:8px">
          <button class="btn enhanced" id="maintenanceTemplateBtn">Maintenance Template</button>
          <button class="btn enhanced" id="updateTemplateBtn">Update Announcement</button>
        </div>
      </div>
    </div>

    <!-- Content Management Tab -->
    <div id="adminContent" class="admin-tab-content hidden">
      <div class="card">
        <h4 style="margin:0 0 16px 0">Content Management</h4>
        
        <!-- Legal Pages Editor -->
        <div style="margin-bottom: 20px;">
          <div class="text-sub" style="margin-bottom: 8px;">Legal Pages:</div>
          <div class="row" style="gap: 8px; margin-bottom: 12px;">
            <button class="btn enhanced" id="editTermsBtn">Edit Terms of Service</button>
            <button class="btn enhanced" id="editPrivacyBtn">Edit Privacy Policy</button>
          </div>
          
          <div id="legalEditor" class="hidden">
            <div class="text-sub" style="margin-bottom: 8px;">Editing: <span id="editingPageTitle">Terms of Service</span></div>
            <textarea id="legalContent" class="input" style="min-height: 200px; margin-bottom: 8px;" placeholder="Legal page content..."></textarea>
            <div class="row" style="gap: 8px;">
              <button id="saveLegalBtn" class="btn primary enhanced">Save Changes</button>
              <button id="cancelLegalBtn" class="btn enhanced">Cancel</button>
            </div>
          </div>
        </div>
        
        <!-- System Messages -->
        <div>
          <div class="text-sub" style="margin-bottom: 8px;">System Messages:</div>
          <div class="grid" style="grid-template-columns:1fr 1fr;gap:12px;">
            <div>
              <label class="text-sub" style="font-size: 12px;">Gate Message:</label>
              <textarea id="gateMessage" class="input" placeholder="Enter site password message..." style="min-height: 60px;"></textarea>
            </div>
            <div>
              <label class="text-sub" style="font-size: 12px;">Upgrade CTA:</label>
              <textarea id="upgradeCTA" class="input" placeholder="Upgrade call-to-action text..." style="min-height: 60px;"></textarea>
            </div>
          </div>
          <button id="saveMessagesBtn" class="btn primary enhanced" style="margin-top: 8px;">Save Messages</button>
        </div>
      </div>
    </div>

    <!-- User Management Tab -->
    <div id="adminUsers" class="admin-tab-content hidden">
      <div class="card">
        <h4 style="margin:0 0 16px 0">User Management</h4>
        
        <!-- Current User Info -->
        <div class="card" style="background: rgba(255,255,255,.04); margin-bottom: 16px;">
          <div class="text-sub">Current User Session:</div>
          <div style="margin-top: 8px;">
            <div><strong>Status:</strong> <span id="currentUserStatus">Administrator</span></div>
            <div><strong>Email:</strong> <span id="currentUserEmail">admin@confident-picks.com</span></div>
            <div><strong>Created:</strong> <span id="currentUserCreated">Today</span></div>
          </div>
        </div>
        
        <!-- User Actions -->
        <div style="margin-bottom: 16px;">
          <div class="text-sub" style="margin-bottom: 8px;">User Actions:</div>
          <div class="grid" style="grid-template-columns:repeat(3,1fr);gap:8px">
            <button id="markVerifiedBtn" class="btn enhanced">Mark Verified</button>
            <button id="unverifyBtn" class="btn enhanced">Remove Verification</button>
            <button id="grantSubBtn" class="btn enhanced">Grant Subscription</button>
          </div>
          <div class="grid" style="grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px">
            <button id="revokeSubBtn" class="btn enhanced">Revoke Subscription</button>
            <button id="resetUserBtn" class="btn danger enhanced">Reset User Data</button>
        <div></div>
      </div>
      </div>
      
        <!-- Bulk Operations -->
        <div>
          <div class="text-sub" style="margin-bottom: 8px;">Development Tools:</div>
          <div class="grid" style="grid-template-columns:repeat(3,1fr);gap:8px">
            <button id="seedOutcomesBtn" class="btn enhanced">Seed Demo Data</button>
            <button id="clearFavsBtn" class="btn danger enhanced">Clear All Favorites</button>
            <button id="resetAllDataBtn" class="btn danger enhanced">Reset All Data</button>
          </div>
        </div>
      </div>
    </div>

    <!-- System Management Tab -->
    <div id="adminSystem" class="admin-tab-content hidden">
      <div class="card">
        <h4 style="margin:0 0 16px 0">System Management</h4>
        
        <!-- Feature Flags -->
        <div style="margin-bottom: 20px;">
          <div class="text-sub" style="margin-bottom: 8px;">Feature Flags:</div>
          <div class="grid" style="grid-template-columns:1fr 1fr;gap:12px;">
            <div>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="gateEnabledFlag" checked="">
                <span>Password Gate Enabled</span>
              </label>
            </div>
            <div>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="subscriptionEnabledFlag" checked="">
                <span>Subscriptions Enabled</span>
              </label>
            </div>
            <div>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="contactEnabledFlag" checked="">
                <span>Contact Form Enabled</span>
              </label>
            </div>
            <div>
              <label style="display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="favoritesEnabledFlag" checked="">
                <span>Favorites Enabled</span>
              </label>
            </div>
          </div>
          <button id="saveFlagsBtn" class="btn primary enhanced" style="margin-top: 8px;">Save Feature Flags</button>
        </div>
        
        <!-- System Info -->
        <div style="margin-bottom: 20px;">
          <div class="text-sub" style="margin-bottom: 8px;">System Information:</div>
          <div class="card" style="background: rgba(255,255,255,.04);">
            <div><strong>Version:</strong> 1.0.0</div>
            <div><strong>Environment:</strong> Development</div>
            <div><strong>Last Updated:</strong> <span id="lastUpdateTime">Just now</span></div>
            <div><strong>Storage Used:</strong> <span id="storageUsed">~50KB</span></div>
          </div>
        </div>
        
        <!-- System Actions -->
        <div>
          <div class="text-sub" style="margin-bottom: 8px;">System Actions:</div>
          <div class="grid" style="grid-template-columns:repeat(3,1fr);gap:8px">
            <button id="clearCacheBtn" class="btn enhanced">Clear Cache</button>
            <button id="exportDataBtn" class="btn enhanced">Export Data</button>
            <button id="importDataBtn" class="btn enhanced">Import Data</button>
          </div>
          <div class="grid" style="grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px">
            <button id="systemResetBtn" class="btn danger enhanced">System Reset</button>
            <button id="backupDataBtn" class="btn enhanced">Backup Data</button>
            <div></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Subscribe -->
  <section id="view-subscribe" class="hidden">
    <div class="card">
      <div class="row" style="justify-content:space-between; align-items:flex-end">
        <div>
          <h3 style="margin:0 0 6px 0">Become a Subscriber</h3>
          <div class="text-sub">Unlock full picks, Favorites, and Outcomes.</div>
        </div>
        <div class="chip">21+</div>
      </div>
      <div class="row" style="gap:10px; margin-top:12px">
        <div class="row" style="gap:8px; align-items:baseline">
          <div id="planName"><strong>Confident Picks — Monthly</strong></div>
          <div class="h1" id="planPrice" style="font-size:22px">$15</div>
          <div id="planInterval" class="text-sub">USD / month</div>
        </div>
        <div class="space"></div>
        <div class="row" style="gap:8px">
          <button id="planMonthlyBtn" class="btn primary">Monthly</button>
          <button id="planYearlyBtn" class="btn">Yearly</button>
        </div>
      </div>
      <div class="row" style="gap:8px; margin-top:8px">
        <input id="couponCode" class="input" placeholder="Have a code? (try SAVE20)">
        <button id="applyCouponBtn" class="btn">Apply</button>
      </div>
      <div id="subscribeNote" class="text-sub" style="margin-top:8px"></div>
      <div class="row" style="gap:10px; margin-top:12px">
        <button id="upgradeNowBtn" class="btn primary">Complete subscription — $15/mo</button>
        <button id="backToPicksBtn" class="btn">Back to picks</button>
      </div>
    </div>
  </section>

  <!-- Favorites -->
  <section id="view-favorites" class="hidden">
    <div class="card">
      <h3 style="margin:0 0 8px 0">My Favorites</h3>
      <div class="text-sub" style="margin-bottom:12px">Your saved picks and watchlist</div>
      
      <!-- Subscription Gate -->
      <div id="favGate"></div>
      
      <!-- Favorites List -->
      <div id="favList"></div>
      
      <!-- Read Aloud Button (Subscribers Only) -->
      <div style="margin-top: 16px; text-align: center;">
        <button id="readFavoritesBtn" class="btn enhanced hidden">
          <span id="readFavoritesText">Read Favorites Aloud</span>
        </button>
      </div>
      
      <!-- Parlay Calculator (Subscribers Only) -->
      <div id="parlayCalculator" class="hidden" style="margin-top: 16px;">
        <div class="card" style="background: rgba(255,255,255,.04);">
          <h4 style="margin:0 0 12px 0">Parlay Calculator</h4>
          <div class="text-sub" style="margin-bottom: 8px;">Select picks to calculate parlay odds:</div>
          <div id="parlayResult" style="display: none;">
            <div style="font-size: 18px; font-weight: bold; color: var(--green);">
              Parlay Odds: <span id="parlayOdds">+150</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Legal pages -->


  

  <!-- Contact Form -->
  <section id="view-contact" class="hidden">
    <div class="card">
      <h3 style="margin:0 0 8px 0" id="contactTitle">Contact Us</h3>
      <div class="text-sub" style="margin-bottom:12px">Have questions or feedback? We'd love to hear from you!</div>
      
      <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px">
        <div>
          <div class="text-sub" id="nameLabel">Name</div>
          <input id="contactName" class="input" style="margin-top:4px" placeholder="Your name">
        </div>
        <div>
          <div class="text-sub" id="emailLabel">Email</div>
          <input id="contactEmail" type="email" class="input" style="margin-top:4px; background:var(--card); opacity:0.7" placeholder="Auto-filled from your account" readonly="">
        </div>
      </div>
      
      <div style="margin-bottom:12px">
        <div class="text-sub" id="subjectLabel">Subject</div>
        <select id="contactSubject" class="input" style="margin-top:4px">
          <option value="">Select a topic...</option>
          <option value="general">General Inquiry</option>
          <option value="account">Account Issues</option>
          <option value="billing">Billing/Subscription</option>
          <option value="picks">Picks/Data Questions</option>
          <option value="technical">Technical Support</option>
          <option value="feedback">Feedback/Suggestions</option>
          <option value="partnership">Partnership/Business</option>
          <option value="other">Other</option>
        </select>
      </div>
      
      <div style="margin-bottom:12px">
        <div class="text-sub" id="messageLabel">Message</div>
        <textarea id="contactMessage" class="input" style="margin-top:4px; min-height:100px; resize:vertical" placeholder="Tell us more..."></textarea>
      </div>
      
      <div class="row" style="gap:8px">
        <button id="sendContactBtn" class="btn primary enhanced">Send Message</button>
        <button id="clearContactBtn" class="btn enhanced">Clear Form</button>
      </div>
    </div>
  </section>

  <!-- RESPONSIBLE GAMING -->
  <section id="view-responsible" class="hidden">
    <div class="container">
      <h2>Responsible Gambling</h2>
      
      <div class="card" style="margin-bottom: 20px;">
        <h3>Our Commitment</h3>
        <p>Confident Picks is committed to promoting responsible gambling practices. Our content is provided for entertainment and educational purposes only.</p>
      </div>
      
      <div class="card" style="margin-bottom: 20px;">
        <h3>Important Guidelines</h3>
        <ul style="margin: 12px 0; padding-left: 20px; color: var(--text);">
          <li>Never bet more than you can afford to lose</li>
          <li>Set limits on time and money spent on gambling activities</li>
          <li>Don't chase losses with bigger bets</li>
          <li>Take regular breaks from gambling activities</li>
          <li>Seek help if gambling becomes problematic</li>
        </ul>
      </div>
      
      <div class="card" style="margin-bottom: 20px;">
        <h3>Age Restrictions</h3>
        <p>You must be 21 years or older (or the legal gambling age in your jurisdiction) to use our services. We do not knowingly provide services to minors.</p>
      </div>
      
      <div class="card" style="margin-bottom: 20px;">
        <h3>Problem Gambling Resources</h3>
        <p>If you or someone you know has a gambling problem, help is available:</p>
        <ul style="margin: 12px 0; padding-left: 20px; color: var(--text);">
          <li><strong>National Problem Gambling Helpline:</strong> 1-800-522-4700</li>
          <li><strong>Gamblers Anonymous:</strong> <a href="https://www.gamblersanonymous.org/" target="_blank" style="color: var(--blue);">gamblersanonymous.org</a></li>
          <li><strong>National Council on Problem Gambling:</strong> <a href="https://www.ncpgambling.org/" target="_blank" style="color: var(--blue);">ncpgambling.org</a></li>
          <li><strong>Gam-Anon (for families):</strong> <a href="https://www.gam-anon.org/" target="_blank" style="color: var(--blue);">gam-anon.org</a></li>
        </ul>
      </div>
      
      <div class="card">
        <h3>Self-Exclusion</h3>
        <p>If you wish to exclude yourself from our services, please contact us at support@confident-picks.com. We will process your request within 24 hours.</p>
      </div>
    </div>
  </section>

  <!-- TERMS OF SERVICE -->
  <section id="view-terms" class="hidden">
    <div class="container">
      <h2>Terms of Service</h2>
      
      <div class="card" style="margin-bottom: 20px;">
        <h3>1. Acceptance of Terms</h3>
        <p>By accessing and using Confident Picks, you accept and agree to be bound by the terms and provision of this agreement.</p>
      </div>
      
      <div class="card" style="margin-bottom: 20px;">
        <h3>2. Service Description</h3>
        <p>Confident Picks provides sports betting analysis, predictions, and educational content for entertainment purposes only. We do not operate as a sportsbook or gambling platform.</p>
      </div>
      
      <div class="card" style="margin-bottom: 20px;">
        <h3>3. Disclaimer</h3>
        <p>All predictions and analysis are for entertainment and educational purposes only. Past performance does not guarantee future results. We are not responsible for any losses incurred from following our analysis.</p>
      </div>
      
      <div class="card" style="margin-bottom: 20px;">
        <h3>4. User Responsibilities</h3>
        <ul style="margin: 12px 0; padding-left: 20px; color: var(--text);">
          <li>You must be 21+ or the legal age in your jurisdiction</li>
          <li>You are responsible for complying with local laws</li>
          <li>You agree to use the service responsibly</li>
          <li>You will not share account credentials</li>
        </ul>
      </div>
      
      <div class="card" style="margin-bottom: 20px;">
        <h3>5. Intellectual Property</h3>
        <p>All content, analysis, and materials on Confident Picks are proprietary and protected by copyright laws. Unauthorized reproduction or distribution is prohibited.</p>
      </div>
      
      <div class="card" style="margin-bottom: 20px;">
        <h3>6. Limitation of Liability</h3>
        <p>Confident Picks shall not be liable for any direct, indirect, incidental, or consequential damages arising from the use of our service.</p>
      </div>
      
      <div class="card">
        <h3>7. Contact Information</h3>
        <p>For questions about these terms, contact us at legal@confident-picks.com</p>
        <p><strong>Last updated:</strong> January 2025</p>
      </div>
    </div>
  </section>

  <!-- PRIVACY POLICY -->
  <section id="view-privacy" class="hidden">
    <div class="container">
      <h2>Privacy Policy</h2>
      
      <div class="card" style="margin-bottom: 20px;">
        <h3>1. Information We Collect</h3>
        <p>We collect information you provide directly to us, such as when you create an account, subscribe to our service, or contact us for support.</p>
        <ul style="margin: 12px 0; padding-left: 20px; color: var(--text);">
          <li>Email address and account credentials</li>
          <li>Payment information (processed securely by third parties)</li>
          <li>Communication preferences</li>
          <li>Usage data and analytics</li>
        </ul>
      </div>
      
      <div class="card" style="margin-bottom: 20px;">
        <h3>2. How We Use Your Information</h3>
        <ul style="margin: 12px 0; padding-left: 20px; color: var(--text);">
          <li>Provide and improve our services</li>
          <li>Send you updates and promotional content</li>
          <li>Process payments and subscriptions</li>
          <li>Respond to your inquiries and support requests</li>
          <li>Comply with legal obligations</li>
        </ul>
      </div>
      
      <div class="card" style="margin-bottom: 20px;">
        <h3>3. Information Sharing</h3>
        <p>We do not sell, trade, or rent your personal information to third parties. We may share information in these limited circumstances:</p>
        <ul style="margin: 12px 0; padding-left: 20px; color: var(--text);">
          <li>With service providers who assist in our operations</li>
          <li>When required by law or to protect our rights</li>
          <li>In connection with a business transfer or merger</li>
        </ul>
      </div>
      
      <div class="card" style="margin-bottom: 20px;">
        <h3>4. Data Security</h3>
        <p>We implement appropriate security measures to protect your personal information against unauthorized access, alteration, disclosure, or destruction.</p>
      </div>
      
      <div class="card" style="margin-bottom: 20px;">
        <h3>5. Cookies and Tracking</h3>
        <p>We use cookies and similar technologies to improve your experience, analyze usage patterns, and provide personalized content.</p>
      </div>
      
      <div class="card" style="margin-bottom: 20px;">
        <h3>6. Your Rights</h3>
        <ul style="margin: 12px 0; padding-left: 20px; color: var(--text);">
          <li>Access and review your personal information</li>
          <li>Request corrections to inaccurate data</li>
          <li>Delete your account and associated data</li>
          <li>Opt out of marketing communications</li>
        </ul>
      </div>
      
      <div class="card">
        <h3>7. Contact Us</h3>
        <p>For questions about this privacy policy or to exercise your rights, contact us at privacy@confident-picks.com</p>
        <p><strong>Last updated:</strong> January 2025</p>
      </div>
    </div>
  </section>

  <footer>
    For entertainment and educational purposes only. Not gambling advice. If you or someone you know has a gambling problem, seek help.
    <br><br>
    <a href="file:///D:/cursor/confident-picks/index3.html#responsible" data-nav="">Responsible gambling</a> ·
    <a href="file:///D:/cursor/confident-picks/index3.html#terms" data-nav="">Terms</a> ·
    <a href="file:///D:/cursor/confident-picks/index3.html#privacy" data-nav="">Privacy</a> ·
    <a href="file:///D:/cursor/confident-picks/index3.html#contact" data-nav="">Contact</a> ·
    <strong>21+ where applicable</strong>
    <br><br>
    © <span id="copyrightYear">2025</span> Confident Picks. All rights reserved.
</footer>
</div>

<div id="mobileBanner" class="mobile-banner">
  <div>
    <div id="mobileBannerTitle"><strong>Upgrade to unlock all picks</strong></div>
    <div id="mobileBannerSubtext" class="text-sub">$15 USD / month</div>
  </div>
  <button id="mobileUpgradeBtn" class="btn primary enhanced">Upgrade</button>
</div>

<!-- Keyboard Shortcuts Help Modal -->
<div id="helpModal" class="help-modal">
  <div class="help-content">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
      <h3 style="margin: 0;">Keyboard Shortcuts</h3>
      <button id="closeHelpBtn" class="btn" style="padding: 4px 8px;">✕</button>
    </div>
    <div class="text-sub" style="margin-bottom: 16px;">Use these shortcuts to navigate faster:</div>
    
    <div class="help-shortcuts">
      <div class="help-shortcut">
        <span>Focus search</span>
        <kbd>/</kbd>
      </div>
      <div class="help-shortcut">
        <span>Toggle theme</span>
        <kbd>t</kbd>
      </div>
      <div class="help-shortcut">
        <span>Navigate to Picks</span>
        <kbd>1</kbd>
      </div>
      <div class="help-shortcut">
        <span>Navigate to Scorecard</span>
        <kbd>2</kbd>
      </div>
      <div class="help-shortcut">
        <span>Navigate to Outcomes</span>
        <kbd>3</kbd>
      </div>
      <div class="help-shortcut">
        <span>Navigate to Favorites</span>
        <kbd>4</kbd>
      </div>
      <div class="help-shortcut">
        <span>Navigate to Account</span>
        <kbd>5</kbd>
      </div>
      <div class="help-shortcut">
        <span>Navigate to Admin</span>
        <kbd>6</kbd>
      </div>
      <div class="help-shortcut">
        <span>Clear search</span>
        <kbd>Esc</kbd>
      </div>
      <div class="help-shortcut">
        <span>Show this help</span>
        <kbd>?</kbd>
      </div>
      <div class="help-shortcut">
        <span>Toggle favorite (on pick card)</span>
        <kbd>Enter</kbd> or <kbd>Space</kbd>
      </div>
    </div>
    
    <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border); text-align: center;">
      <div class="text-sub" style="font-size: 12px;">
        Press <kbd>Esc</kbd> or click outside to close
      </div>
    </div>
  </div>
</div>

<script>
// PASSWORD GATE (temporary)
(function(){
	var PASS = 'getmoney'; // change this to your temporary password
	var gate = document.getElementById('gate');
	if (!gate) return;
	var ok = false;
	try { ok = localStorage.getItem('cp_gate_ok') === '1'; } catch(e){}
	if (ok){
		document.documentElement.classList.remove('gated');
		gate.remove();
		return;
	}
	function unlock(){
		try { localStorage.setItem('cp_gate_ok','1'); } catch(e){}
		document.documentElement.classList.remove('gated');
		gate.remove();
		try{ render(); route(); }catch(e){}
	}
	var btn = document.getElementById('gateBtn');
	var inp = document.getElementById('gateInput');
	if (btn && inp){
		btn.addEventListener('click', function(){
			var v = (inp.value||'').trim();
			if (v === PASS) unlock();
			else alert('Incorrect password.');
		});
		inp.addEventListener('keydown', function(e){ if (e.key==='Enter') btn.click(); });
	}
})();

// THEME
(function(){
  var saved = localStorage.getItem('theme') || 'dark';
  if(saved==='light') document.documentElement.setAttribute('data-theme','light');
  document.getElementById('themeBtn').addEventListener('click', function () {
    var cur = document.documentElement.getAttribute('data-theme');
    var next = (cur==='light') ? '' : 'light';
    if (next) document.documentElement.setAttribute('data-theme', next);
    else document.documentElement.removeAttribute('data-theme');
    localStorage.setItem('theme', next||'dark');
    render();
  });
})();

// ROUTER + ADMIN NAV
var navLinks = Array.prototype.slice.call(document.querySelectorAll('[data-nav]'));
function show(el, on){ if(!el) return; if(on) el.classList.remove('hidden'); else el.classList.add('hidden'); }

function updateHeaderUI(){
  var upg = document.getElementById('upgradeBtn');
  if (upg) (state.auth === 'free') ? upg.classList.remove('hidden') : upg.classList.add('hidden');
  updateMobileBanner();
  updateAdminUI();
}
function updateAdminUI(){
  var navAdmin = document.getElementById('navAdmin');
  show(navAdmin, state.isAdmin);
}
function route(){
  var hash = location.hash || '#picks';
  navLinks.forEach(function(a){ a.classList.toggle('active', a.getAttribute('href')===hash); });
  document.getElementById('view-picks').classList.toggle('hidden', hash !== '#picks');
  document.getElementById('view-scorecard').classList.toggle('hidden', hash !== '#scorecard');
  document.getElementById('view-outcomes').classList.toggle('hidden', hash !== '#outcomes');
  document.getElementById('view-favorites').classList.toggle('hidden', hash !== '#favorites');
  document.getElementById('view-account').classList.toggle('hidden', hash !== '#account');
  document.getElementById('view-admin').classList.toggle('hidden', hash !== '#admin');
  document.getElementById('view-subscribe').classList.toggle('hidden', hash !== '#subscribe');
  document.getElementById('view-terms').classList.toggle('hidden', hash !== '#terms');
  document.getElementById('view-privacy').classList.toggle('hidden', hash !== '#privacy');
  document.getElementById('view-responsible').classList.toggle('hidden', hash !== '#responsible');
  document.getElementById('view-contact').classList.toggle('hidden', hash !== '#contact');

  if (hash === '#admin' && !state.isAdmin){
    alert('Admin is disabled on this device (mock). Enable it from Account.');
    location.hash = '#account';
    return;
  }

  if (hash === '#favorites') renderFavorites();
  if (hash === '#account') renderAccount();
  if (hash === '#admin') renderProfile();
  if (hash === '#scorecard') renderScorecard();
  if (hash === '#outcomes') renderOutcomes();
  if (hash === '#subscribe') renderSubscribe();
  if (hash === '#contact') renderContact();
  maybeShowVerifyBanner();
}
window.addEventListener('hashchange', route);

// TRANSLATION DATA (Top 4 Languages)
var translations = {
  en: {
    picks: 'Picks', scorecard: 'Scorecard', outcomes: 'Outcomes', 
    favorites: 'Favorites', account: 'Account', admin: 'Admin',
    signUp: 'Sign up for free', signOut: 'Sign out', upgrade: 'Upgrade',
    resetSettings: 'Reset to Default',
    readFavorites: 'Read Favorites Aloud', stopReading: 'Stop Reading',
    settings: 'Settings', language: 'Language', theme: 'Theme', 
    voiceSpeed: 'Voice Speed', currency: 'Currency', voiceEnabled: 'Enable Voice Reading',
    darkTheme: 'Dark', lightTheme: 'Light', autoTheme: 'Auto',
    saveSettings: 'Save Settings', resetToDefault: 'Reset to Default',
    contact: 'Contact', contactUs: 'Contact Us', name: 'Name', email: 'Email',
    subject: 'Subject', message: 'Message', sendMessage: 'Send Message'
  },
  es: {
    picks: 'Selecciones', scorecard: 'Puntuación', outcomes: 'Resultados',
    favorites: 'Favoritos', account: 'Cuenta', admin: 'Administrador',
    signUp: 'Registrarse gratis', signOut: 'Cerrar sesión', upgrade: 'Actualizar',
    resetSettings: 'Restablecer por Defecto',
    readFavorites: 'Leer Favoritos en Voz Alta', stopReading: 'Detener Lectura',
    settings: 'Configuración', language: 'Idioma', theme: 'Tema',
    voiceSpeed: 'Velocidad de Voz', currency: 'Moneda', voiceEnabled: 'Habilitar Lectura de Voz',
    darkTheme: 'Oscuro', lightTheme: 'Claro', autoTheme: 'Automático',
    saveSettings: 'Guardar Configuración', resetToDefault: 'Restablecer por Defecto',
    contact: 'Contacto', contactUs: 'Contáctanos', name: 'Nombre', email: 'Correo',
    subject: 'Asunto', message: 'Mensaje', sendMessage: 'Enviar Mensaje'
  },
  fr: {
    picks: 'Sélections', scorecard: 'Tableau de Bord', outcomes: 'Résultats',
    favorites: 'Favoris', account: 'Compte', admin: 'Administrateur',
    signUp: 'Inscription gratuite', signOut: 'Déconnexion', upgrade: 'Améliorer',
    resetSettings: 'Réinitialiser par Défaut',
    readFavorites: 'Lire les Favoris à Voix Haute', stopReading: 'Arrêter la Lecture',
    settings: 'Paramètres', language: 'Langue', theme: 'Thème',
    voiceSpeed: 'Vitesse de la Voix', currency: 'Devise', voiceEnabled: 'Activer la Lecture Vocale',
    darkTheme: 'Sombre', lightTheme: 'Clair', autoTheme: 'Automatique',
    saveSettings: 'Sauvegarder les Paramètres', resetToDefault: 'Réinitialiser par Défaut',
    contact: 'Contact', contactUs: 'Nous Contacter', name: 'Nom', email: 'Email',
    subject: 'Sujet', message: 'Message', sendMessage: 'Envoyer le Message'
  },
  de: {
    picks: 'Auswahl', scorecard: 'Bewertung', outcomes: 'Ergebnisse',
    favorites: 'Favoriten', account: 'Konto', admin: 'Administrator',
    signUp: 'Kostenlos anmelden', signOut: 'Abmelden', upgrade: 'Upgrade',
    resetSettings: 'Auf Standard Zurücksetzen',
    readFavorites: 'Favoriten Vorlesen', stopReading: 'Vorlesen Stoppen',
    settings: 'Einstellungen', language: 'Sprache', theme: 'Design',
    voiceSpeed: 'Sprachgeschwindigkeit', currency: 'Währung', voiceEnabled: 'Sprachausgabe Aktivieren',
    darkTheme: 'Dunkel', lightTheme: 'Hell', autoTheme: 'Automatisch',
    saveSettings: 'Einstellungen Speichern', resetToDefault: 'Auf Standard Zurücksetzen',
    contact: 'Kontakt', contactUs: 'Kontaktieren Sie uns', name: 'Name', email: 'E-Mail',
    subject: 'Betreff', message: 'Nachricht', sendMessage: 'Nachricht Senden'
  }
};

// TRANSLATION FUNCTION
function t(key) {
  var lang = state.settings.language || 'en';
  return translations[lang] && translations[lang][key] ? translations[lang][key] : translations.en[key] || key;
}

// STATE
var state = {
  auth: safeGetStorage('auth', 'anon'),
  favorites: (function() {
    try {
      return JSON.parse(safeGetStorage('favorites', '[]'));
    } catch (e) {
      console.warn('Invalid favorites data in localStorage, resetting to empty array');
      return [];
    }
  })(),
  parlayPicks: (function() {
    try {
      return JSON.parse(safeGetStorage('parlayPicks', '[]'));
    } catch (e) {
      console.warn('Invalid parlayPicks data in localStorage, resetting to empty array');
      return [];
    }
  })(),
  tf: safeGetStorage('tf', '7'),
  otf: safeGetStorage('otf', '30'),
  selectedOut: [],
  isAdmin: safeGetStorage('isAdmin') === '1',
  accTab: safeGetStorage('accTab', 'signup'),
  settings: (function() {
    try {
      return JSON.parse(safeGetStorage('userSettings', '{"language":"en","theme":"dark","voiceSpeed":"1.0","currency":"USD","voiceEnabled":"false"}'));
    } catch (e) {
      console.warn('Invalid settings data in localStorage, using defaults');
      return {"language":"en","theme":"dark","voiceSpeed":"1.0","currency":"USD","voiceEnabled":"false"};
    }
  })(),
  isReading: false
};
// Normalize any legacy favorites (ids -> {id})
(function normalizeFavorites(){
  var changed = false;
  state.favorites = (state.favorites || []).map(function(f){
    if (typeof f === 'string') { changed = true; return { id: f }; }
    if (f && typeof f === 'object' && f.id) return f;
    return null;
  }).filter(Boolean);
  if (changed) localStorage.setItem('favorites', JSON.stringify(state.favorites));
})();

var authBtn = document.getElementById('authBtn');
function setAuth(mode){
  state.auth = mode;
  localStorage.setItem('auth', mode);
  authBtn.textContent = mode==='anon' ? 'Sign up for free' : 'Sign out';
  render(); renderAccount(); renderProfile(); reflectAuthButtons(); updateHeaderUI();
}
authBtn.addEventListener('click', function(){
  if (state.auth==='anon'){ location.hash = '#account'; route(); }
  else { setAuth('anon'); location.hash = '#picks'; route(); }
});
var _upgEl = document.getElementById('upgradeBtn'); if (_upgEl) { _upgEl.addEventListener('click', function(){ location.hash = '#subscribe'; route(); }); }

function setAdmin(on){
  state.isAdmin = !!on;
  try { localStorage.setItem('isAdmin', on ? '1' : '0'); } catch(e){}
  updateAdminUI();
  if (!on && location.hash==='#admin'){ location.hash = '#account'; }
}

// Global state object
var state = {
  auth: 'anon',
  favorites: [],
  parlayPicks: [],
  selectedOut: [],
  tf: '7',
  otf: '7',
  accTab: 'signup',
  settings: {
    language: 'en',
    theme: 'dark',
    voiceSpeed: '1.0',
    currency: 'USD',
    voiceEnabled: 'false'
  },
  isAdmin: false,
  isReading: false
};

// Initialize state from localStorage
(function() {
  try {
    // Load auth state
    var auth = localStorage.getItem('auth') || 'anon';
    state.auth = auth;
    
    // Load favorites
    var favorites = localStorage.getItem('favorites');
    if (favorites) {
      try {
        state.favorites = JSON.parse(favorites);
      } catch(e) {
        state.favorites = [];
      }
    }
    
    // Load parlay picks
    var parlayPicks = localStorage.getItem('parlayPicks');
    if (parlayPicks) {
      try {
        state.parlayPicks = JSON.parse(parlayPicks);
      } catch(e) {
        state.parlayPicks = [];
      }
    }
    
    // Load settings
    var settings = localStorage.getItem('userSettings');
    if (settings) {
      try {
        state.settings = JSON.parse(settings);
      } catch(e) {
        // Use defaults
      }
    }
    
    // Load admin state
    state.isAdmin = localStorage.getItem('isAdmin') === '1';
    
    // Load other state
    state.tf = localStorage.getItem('tf') || '7';
    state.otf = localStorage.getItem('otf') || '7';
    state.accTab = localStorage.getItem('accTab') || 'signup';
    
  } catch(e) {
    console.error('Error loading state from localStorage:', e);
  }
})();

// Helper function to set auth state
function setAuth(auth) {
  state.auth = auth;
  localStorage.setItem('auth', auth);
  updateHeaderUI();
  render();
  renderFavorites();
  renderOutcomes();
}

// Helper function to set admin state
function setAdmin(on) {
  state.isAdmin = !!on;
  try { localStorage.setItem('isAdmin', on ? '1' : '0'); } catch(e){}
  updateAdminUI();
  if (!on && location.hash==='#admin'){ location.hash = '#account'; }
}

// DATA
function daysAgo(n){ var d = new Date(Date.now() - n*86400000); return d.toISOString(); }
var picksLive = [
  {id:'1', league:'NBA', marketType:'player-props', pickDesc:'LeBron James Over 25.5 Points', oddsAmerican:-115, modelConfidence:78, commenceTime:daysAgo(-0.2), tier:'public', riskTag:'safe', reasoning:'LeBron averaging 28.2 PPG vs this matchup, 7/10 recent overs.'},
  {id:'2', league:'UFC', marketType:'moneyline', pickDesc:'Jon Jones ML vs Stipe', oddsAmerican:-180, modelConfidence:85, commenceTime:daysAgo(-0.5), tier:'public', riskTag:'safe', reasoning:'Jones 18-1 in title fights, reach advantage, superior ground game.'},
  {id:'3', league:'NHL', marketType:'totals', pickDesc:'Over 6.5 Goals EDM@VGK', oddsAmerican:105, modelConfidence:72, commenceTime:daysAgo(-0.1), tier:'public', riskTag:'degen', reasoning:'Both teams averaging 3.8 goals/game, weak goaltending matchup.'},
  {id:'4', league:'CFB', marketType:'spread', pickDesc:'Alabama -14 vs Tennessee', oddsAmerican:-110, modelConfidence:81, commenceTime:daysAgo(-1), tier:'free', riskTag:'safe', reasoning:'Alabama 9-1 ATS as home favorites, Tennessee missing key OL.'},
  {id:'5', league:'CBB', marketType:'team-props', pickDesc:'Duke Team Total Over 78.5', oddsAmerican:-105, modelConfidence:74, commenceTime:daysAgo(-0.3), tier:'paid', riskTag:'safe', reasoning:'Duke averaging 84.2 PPG at home, opponent allows 81.5 PPG.'},
  {id:'6', league:'MLS', marketType:'alt-lines', pickDesc:'LAFC -0.5 (Alt Line)', oddsAmerican:140, modelConfidence:69, commenceTime:daysAgo(-0.7), tier:'free', riskTag:'degen', reasoning:'LAFC 12-3-1 at home, but Seattle strong on road defense.'},
  {id:'7', league:'MLB', marketType:'moneyline', pickDesc:'Rays ML vs Yankees', oddsAmerican:-120, modelConfidence:82, commenceTime:daysAgo(-0.2), tier:'public', riskTag:'safe', reasoning:'Rays bullpen rested; model edge ~1.9%.'},
  {id:'8', league:'NFL', marketType:'props', pickDesc:'Mahomes Over 2.5 TD', oddsAmerican:140, modelConfidence:71, commenceTime:daysAgo(-22), tier:'public', riskTag:'degen', reasoning:'RZ pass rate up; opponent man-heavy.'}
];
var picksResults = [
  {id:'r1', league:'NBA', marketType:'player-props', pickDesc:'Stephen Curry Over 4.5 Threes', oddsAmerican:120, modelConfidence:76, commenceTime:daysAgo(1.5), tier:'paid', riskTag:'safe', result:'W', settledAt:daysAgo(1.3), reasoning:'Curry 7/10 overs vs this defense, pace advantage.'},
  {id:'r2', league:'UFC', marketType:'team-props', pickDesc:'Fight Goes Distance', oddsAmerican:-135, modelConfidence:82, commenceTime:daysAgo(2), tier:'paid', riskTag:'safe', result:'L', settledAt:daysAgo(1.9), reasoning:'Both fighters cardio-heavy, defensive styles.'},
  {id:'r3', league:'NHL', marketType:'alt-lines', pickDesc:'Connor McDavid Over 1.5 Points (Alt)', oddsAmerican:165, modelConfidence:71, commenceTime:daysAgo(3), tier:'paid', riskTag:'degen', result:'W', settledAt:daysAgo(2.8), reasoning:'McDavid 15 points in last 8 games, matchup advantage.'},
  {id:'r4', league:'CFB', marketType:'totals', pickDesc:'Under 52.5 Points', oddsAmerican:-110, modelConfidence:79, commenceTime:daysAgo(4), tier:'paid', riskTag:'safe', result:'W', settledAt:daysAgo(3.9), reasoning:'Weather conditions, both teams run-heavy offense.'},
  {id:'r5', league:'CBB', marketType:'spread', pickDesc:'Gonzaga -8.5 vs Saint Marys', oddsAmerican:-105, modelConfidence:73, commenceTime:daysAgo(5), tier:'free', riskTag:'safe', result:'L', settledAt:daysAgo(4.9), reasoning:'Gonzaga 8-2 ATS as road favorites this season.'},
  {id:'r6', league:'MLS', marketType:'moneyline', pickDesc:'Inter Miami ML vs Atlanta', oddsAmerican:-125, modelConfidence:68, commenceTime:daysAgo(6), tier:'free', riskTag:'safe', result:'W', settledAt:daysAgo(5.8), reasoning:'Messi effect + home field advantage in playoffs.'},
  {id:'r7', league:'MLB', marketType:'moneyline', pickDesc:'Dodgers ML vs Mets', oddsAmerican:-135, modelConfidence:83, commenceTime:daysAgo(1.5), tier:'paid', riskTag:'safe', result:'W', settledAt:daysAgo(1.3), reasoning:'LAD #2 vs RHP last 30d; fair -146.'},
  {id:'r8', league:'NFL', marketType:'totals', pickDesc:'Over 47.5 KC@BUF', oddsAmerican:-105, modelConfidence:72, commenceTime:daysAgo(2), tier:'paid', riskTag:'degen', result:'L', settledAt:daysAgo(1.9), reasoning:'Pace-up; both top-8 pass rate.'},
  {id:'r9', league:'MLB', marketType:'totals', pickDesc:'Under 7.5 LAD@SF', oddsAmerican:-102, modelConfidence:70, commenceTime:daysAgo(20), tier:'free', riskTag:'safe', result:'W', settledAt:daysAgo(19.8), reasoning:'Marine layer; model 7.0.'},
  {id:'r10', league:'MLB', marketType:'moneyline', pickDesc:'Astros ML vs TEX', oddsAmerican:-150, modelConfidence:90, commenceTime:daysAgo(35), tier:'paid', riskTag:'safe', result:'W', settledAt:daysAgo(34.8), reasoning:''},
  {id:'r11', league:'NFL', marketType:'spread', pickDesc:'Eagles -7 vs NYG', oddsAmerican:-110, modelConfidence:85, commenceTime:daysAgo(40), tier:'public', riskTag:'safe', result:'W', settledAt:daysAgo(39.8), reasoning:''}
];
var picksAll = picksLive.concat(picksResults);

// HELPERS
function formatDate(iso){ var d = new Date(iso); return d.toLocaleString([], { dateStyle:'medium', timeStyle:'short' }); }
function byCommence(a,b){ return new Date(a.commenceTime) - new Date(b.commenceTime); }
function byConfidence(a,b){ return (b.modelConfidence - a.modelConfidence) || (b.oddsAmerican - a.oddsAmerican); }
function oddsString(a){ return a >= 0 ? ('+'+a) : String(a); }

// Parlay Calculator Functions
function calculateParlayOdds(oddsArray) {
  if (!oddsArray || oddsArray.length === 0) return null;
  
  // Convert American odds to Decimal odds first
  var decimalOdds = oddsArray.map(function(odds) {
    if (odds >= 0) {
      // Positive American odds: divide by 100, then add 1
      return (odds / 100) + 1;
    } else {
      // Negative American odds: divide 100 by absolute value, then add 1
      return (100 / Math.abs(odds)) + 1;
    }
  });
  
  // Calculate parlay: multiply all decimal odds together
  var parlayDecimal = decimalOdds.reduce(function(total, odds) {
    return total * odds;
  }, 1);
  
  // Convert back to American odds
  if (parlayDecimal >= 2) {
    // Decimal >= 2 means positive American odds
    return Math.round((parlayDecimal - 1) * 100);
  } else {
    // Decimal < 2 means negative American odds
    return Math.round(-100 / (parlayDecimal - 1));
  }
}

function updateParlayCalculator() {
  console.log('🔄 Updating parlay calculator...');
  
  var parlayResult = document.getElementById('parlayResult');
  var parlayOdds = document.getElementById('parlayOdds');
  if (!parlayResult || !parlayOdds) {
    console.log('❌ Parlay calculator elements not found');
    return;
  }
  
  console.log('📊 Current parlay picks:', state.parlayPicks);
  
  // Get selected parlay picks from state
  var selectedOdds = [];
  
  // Try to get odds from Firebase picks first
  if (window.currentPicks && window.currentPicks.length > 0) {
    console.log('🔥 Using Firebase picks for odds calculation');
    state.parlayPicks.forEach(function(pickId) {
      var pick = window.currentPicks.find(function(p) { return p.id === pickId; });
      if (pick) {
        // Extract odds from vegasOdds array
        var odds = pick.vegasOdds && pick.vegasOdds.length > 0 ? pick.vegasOdds[0].price : -110;
        selectedOdds.push(odds);
        console.log(`📈 Pick ${pickId}: ${odds} odds`);
      }
    });
  } else {
    console.log('📚 Using static picks for odds calculation');
    // Fallback to static picks
    state.parlayPicks.forEach(function(pickId) {
      var pick = picksAll.find(function(p) { return p.id === pickId; });
      if (pick && pick.oddsAmerican) {
        selectedOdds.push(pick.oddsAmerican);
        console.log(`📈 Pick ${pickId}: ${pick.oddsAmerican} odds`);
      }
    });
  }
  
  console.log('🎯 Selected odds for parlay:', selectedOdds);
  
  if (selectedOdds.length > 1) {
    var parlayOddsValue = calculateParlayOdds(selectedOdds);
    console.log('🧮 Calculated parlay odds:', parlayOddsValue);
    parlayOdds.textContent = oddsString(parlayOddsValue);
    parlayResult.style.display = 'block';
    console.log('✅ Parlay calculator updated successfully');
  } else {
    parlayResult.style.display = 'none';
    console.log('⚠️ Not enough picks for parlay (need 2+)');
  }
}

function toggleParlayPick(pickId) {
  // Toggle parlay selection
  var index = state.parlayPicks.indexOf(pickId);
  if (index > -1) {
    // Remove from parlay
    state.parlayPicks.splice(index, 1);
  } else {
    // Add to parlay
    state.parlayPicks.push(pickId);
  }
  
  // Save to localStorage
  safeSetStorage('parlayPicks', JSON.stringify(state.parlayPicks));
  
  // Update parlay calculator display
  updateParlayCalculator();
  
  // Update button states in current display
  var parlayButtons = document.querySelectorAll('.parlay-btn[data-pick-id="' + pickId + '"]');
  parlayButtons.forEach(function(btn) {
    if (state.parlayPicks.includes(pickId)) {
      btn.classList.add('selected');
      btn.textContent = 'Remove From Parlay';
    } else {
      btn.classList.remove('selected');
      btn.textContent = 'Add To Parlay';
    }
  });
  
  console.log('Parlay picks updated:', state.parlayPicks);
}
function esc(s){ if (s==null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;'); }
function isVerified(){ return localStorage.getItem('emailVerified') === 'true'; }
function nowIso(){ return new Date().toISOString(); }
function addMonthsISO(iso, n){ var d = new Date(iso); d.setMonth(d.getMonth()+n); return d.toISOString(); }
function fmt(iso){ return iso ? new Date(iso).toLocaleString([], {dateStyle:'medium', timeStyle:'short'}) : '—'; }

// Better message system to replace alert()
function showMessage(message, type = 'info') {
  // Remove existing messages
  var existing = document.querySelector('.app-message');
  if (existing) existing.remove();
  
  var msgEl = document.createElement('div');
  msgEl.className = 'app-message';
  msgEl.style.cssText = 
    'position: fixed; top: 20px; right: 20px; z-index: 10000;' +
    'padding: 12px 16px; border-radius: 8px; color: white;' +
    'background: ' + (type === 'error' ? '#FF6B6B' : type === 'success' ? '#22C55E' : '#4DA3FF') + ';' +
    'box-shadow: 0 4px 12px rgba(0,0,0,0.3);' +
    'transform: translateX(100%); transition: transform 0.3s ease;' +
    'max-width: 300px; word-wrap: break-word;';
  msgEl.textContent = message;
  document.body.appendChild(msgEl);
  
  // Animate in
  setTimeout(function() { msgEl.style.transform = 'translateX(0)'; }, 10);
  
  // Auto remove after 4 seconds
  setTimeout(function() {
    msgEl.style.transform = 'translateX(100%)';
    setTimeout(function() { msgEl.remove(); }, 300);
  }, 4000);
}

// Loading state helpers
function setButtonLoading(buttonId, loading) {
  var btn = document.getElementById(buttonId);
  if (!btn) return;
  
  if (loading) {
    btn.classList.add('loading');
    btn.disabled = true;
    // Wrap existing text in span for fade effect
    if (!btn.querySelector('.btn-text')) {
      btn.innerHTML = '<span class="btn-text">' + btn.textContent + '</span>';
    }
  } else {
    btn.classList.remove('loading');
    btn.disabled = false;
  }
}

// Safe localStorage helpers
function safeGetStorage(key, fallback) {
  try {
    return localStorage.getItem(key) || fallback || null;
  } catch (e) {
    console.warn('localStorage access failed for key:', key, e);
    return fallback || null;
  }
}

function safeSetStorage(key, value) {
  try {
    localStorage.setItem(key, value);
    return true;
  } catch (e) {
    console.warn('localStorage write failed for key:', key, e);
    return false;
  }
}

function getUserEmail() {
  var email = safeGetStorage('userEmail');
  if (!email && state.auth !== 'anon') {
    console.warn('User appears logged in but no email found in storage');
  }
  return email;
}

// SETTINGS HELPER FUNCTIONS
function updateAllTranslations() {
  var navLinks = document.querySelectorAll('[data-nav]');
  navLinks.forEach(function(link) {
    var href = link.getAttribute('href');
    if (href === '#picks') link.textContent = t('picks');
    else if (href === '#scorecard') link.textContent = t('scorecard');
    else if (href === '#outcomes') link.textContent = t('outcomes');
    else if (href === '#favorites') link.textContent = t('favorites');
    else if (href === '#account') link.textContent = t('account');
    else if (href === '#admin') link.textContent = t('admin');
  });
  
  var authBtn = document.getElementById('authBtn');
  if (authBtn) {
    authBtn.textContent = state.auth === 'anon' ? t('signUp') : t('signOut');
  }
  
  // Update read button text
  updateReadButton();
  
  renderAccount();
  renderContact();
}

function readFavoritesAloud() {
  // If currently reading, stop it
  if (state.isReading) {
    speechSynthesis.cancel();
    state.isReading = false;
    updateReadButton();
    return;
  }
  
  if (state.settings.voiceEnabled !== 'true') {
    alert('Voice reading is disabled. Enable it in Settings first.');
    return;
  }
  
  if (state.favorites.length === 0) {
    alert('No favorites to read!');
    return;
  }
  
  if (!window.speechSynthesis) {
    alert('Speech synthesis not supported in this browser.');
    return;
  }
  
  var textToRead = t('favorites') + ': ';
  
  // Get favorites in the same order as displayed (sorted by commence time)
  var ids = state.favorites.map(function(f){ return f.id; });
  var favs = picksAll.filter(function(p){ return ids.indexOf(p.id) >= 0 && canSee(p); });
  var sortedFavs = favs.sort(byCommence);
  
  sortedFavs.forEach(function(pick, index) {
    textToRead += (index + 1) + '. ' + pick.pickDesc + '. ';
  });
  
  var utterance = new SpeechSynthesisUtterance(textToRead);
  utterance.rate = parseFloat(state.settings.voiceSpeed) || 1.0;
  utterance.lang = state.settings.language === 'es' ? 'es-ES' : 
                   state.settings.language === 'fr' ? 'fr-FR' :
                   state.settings.language === 'de' ? 'de-DE' : 'en-US';
  
  // Set reading state
  state.isReading = true;
  updateReadButton();
  
  // Handle when reading finishes
  utterance.onend = function() {
    state.isReading = false;
    updateReadButton();
  };
  
  utterance.onerror = function() {
    state.isReading = false;
    updateReadButton();
  };
  
  speechSynthesis.speak(utterance);
}

function updateReadButton() {
  var btn = document.getElementById('readFavoritesBtn');
  if (btn) {
    if (state.isReading) {
      btn.innerHTML = '⏹️ ' + t('stopReading');
      btn.classList.add('danger');
    } else {
      btn.innerHTML = '🔊 ' + t('readFavorites');
      btn.classList.remove('danger');
    }
  }
}

function toggleAutoRenew() {
  var currentRenew = localStorage.getItem('autoRenew') === 'true';
  var newRenew = !currentRenew;
  localStorage.setItem('autoRenew', newRenew.toString());
  alert('Auto-renew ' + (newRenew ? 'enabled' : 'disabled') + ' (mock)');
  renderAccount();
}

function loadSettingsValues() {
  setTimeout(function() {
    var languageSelect = document.getElementById('languageSelect');
    var themeSelect = document.getElementById('themeSelect');
    var voiceSpeedSelect = document.getElementById('voiceSpeedSelect');
    var currencySelect = document.getElementById('currencySelect');
    var voiceEnabledSelect = document.getElementById('voiceEnabledSelect');
    
    if (languageSelect) languageSelect.value = state.settings.language || 'en';
    if (themeSelect) themeSelect.value = state.settings.theme || 'dark';
    if (voiceSpeedSelect) voiceSpeedSelect.value = state.settings.voiceSpeed || '1.0';
    if (currencySelect) currencySelect.value = state.settings.currency || 'USD';
    if (voiceEnabledSelect) voiceEnabledSelect.value = state.settings.voiceEnabled || 'false';
  }, 100);
}

// LOGIC
function maybeShowVerifyBanner(){
  var banner = document.getElementById('verifyBanner');
  if (!banner) return;
  if (state.auth === 'free' && !isVerified()){
    banner.classList.remove('hidden'); banner.style.display = 'flex';
  } else {
    banner.classList.add('hidden'); banner.style.display = 'none';
  }
}
function letterFromWins(wins, n){
  var p = n>0 ? wins/n : 0;
  if (p < 0.45) return ['F','f'];
  if (p < 0.50) return ['D','d'];
  if (p < 0.55) return ['C','c'];
  if (p < 0.65) return ['B','b'];
  var pluses = Math.max(0, Math.floor((p - 0.65)/0.08));
  var capped = Math.min(pluses, 3);
  return ['A' + new Array(capped+1).join('+'), 'a'];
}
function canSee(p){
  if (state.auth==='paid') return true;
  if (state.auth==='free') return p.tier==='public' || p.tier==='free';
  return p.tier==='public';
}
function updateMobileBanner(){
  var banner = document.getElementById('mobileBanner');
  var title = document.getElementById('mobileBannerTitle');
  var subtext = document.getElementById('mobileBannerSubtext');
  var button = document.getElementById('mobileUpgradeBtn');
  
  if (!banner || !title || !subtext || !button) return;
  
  if (state.auth === 'anon') {
    // Anonymous user - show sign up (they don't have top upgrade button)
    title.innerHTML = '<strong>Sign up for free picks</strong>';
    subtext.textContent = 'Get started with confident picks';
    button.textContent = 'Sign Up Free';
    button.onclick = function() { location.hash = '#account'; };
    banner.classList.add('visible');
  } else {
    // Free and paid users - hide banner (upgrade button available at top)
    banner.classList.remove('visible');
  }
}

// FAVORITES (paid only)
function toggleFavorite(id){
  if (state.auth !== 'paid') {
    alert('Favorites are for subscribers (prototype).');
    location.hash = '#subscribe';
    route();
    return;
  }
  var idx = state.favorites.findIndex(function(f){ return f && f.id === id; });
  if (idx === -1) {
    var snap = picksAll.find(function(p){ return p.id === id; }) || {};
    state.favorites.push({ id: id, snap: snap });
  } else {
    state.favorites.splice(idx, 1);
  }
  localStorage.setItem('favorites', JSON.stringify(state.favorites));
  render(); renderFavorites(); renderOutcomes();
}

// RENDERERS
function cardHTML(p, showParlayButton = false) {
  var confColor, confClass, confLevel;
  if (p.modelConfidence >= 80) {
    confColor = 'var(--green)';
    confClass = 'confidence-high';
    confLevel = 'Very High';
  } else if (p.modelConfidence >= 65) {
    confColor = 'var(--blue)';
    confClass = 'confidence-medium';
    confLevel = 'High';
  } else {
    confColor = '#ffa500';
    confClass = 'confidence-low';
    confLevel = 'Medium';
  }
  
  var on = state.favorites.find(function(f){ return f.id===p.id; }) ? 'on' : '';
  var risk = p.riskTag ? p.riskTag.toUpperCase() : '';
  var star = (state.auth==='paid')
    ? ('<div class="star '+on+'" title="Favorite" role="button" aria-pressed="'+(on?'true':'false')+'" tabindex="0" data-fav="'+p.id+'"></div>')
    : '<div class="text-sub">(Favorites for subscribers)</div>';
  
  // Only show parlay button if showParlayButton is true (Favorites page)
  var parlayButtonHTML = '';
  if (showParlayButton) {
    var isParlaySelected = state.parlayPicks && state.parlayPicks.includes(p.id);
    var parlayBtnClass = isParlaySelected ? 'parlay-btn selected' : 'parlay-btn';
    parlayButtonHTML = ' <button class="'+parlayBtnClass+'" onclick="toggleParlayPick(\''+p.id+'\')" data-pick-id="'+p.id+'">Add To Parlay</button>';
  }
  
  return '<div class="card">'
    + '<div class="text-sub">'+p.league+' • '+p.marketType+parlayButtonHTML+'</div>'
    + '<div class="row" style="gap:8px"><div><strong>'+p.pickDesc+'</strong></div><div class="chip '+(p.riskTag==='safe'?'safe':'degen')+'">'+risk+'</div></div>'
    + '<div class="text-sub">Confidence: <span class="' + confClass + '" style="color:'+confColor+'">' + p.modelConfidence + '%</span> • Odds: '+oddsString(p.oddsAmerican)+'</div>'
    + '<div class="reasoning">Reasoning: '+esc(p.reasoning || '—')+'</div>'
    + '<div class="row" style="margin-top:6px;gap:8px"><div class="text-sub">Commences: '+formatDate(p.commenceTime)+'</div>'+star+'</div>'
    + '</div>';
}
function resultRowHTML(x){
  var badge = x.result==='W'?'win':(x.result==='L'?'loss':'push');
  var right = (x.commenceTime ? formatDate(x.commenceTime) : '');
  var checked = state.selectedOut.indexOf(x.id) >= 0 ? 'checked' : '';
  return '<div class="out-row" data-row="'+x.id+'">'
    + '<div>'
    +   '<div><strong>'+esc(x.pickDesc||'—')+'</strong> <span class="badge '+badge+'">'+x.result+'</span></div>'
    +   '<div class="text-sub">'+esc(x.league||'—')+' • '+esc(x.marketType||'—')+' • Odds '+oddsString(x.oddsAmerican||0)+' • '+(x.settledAt?formatDate(x.settledAt):'')+'</div>'
    +   (x.reasoning ? '<div class="reasoning">Reasoning: '+esc(x.reasoning)+'</div>' : '')
    + '</div>'
    + '<div class="row" style="gap:8px">'
    +   '<input type="checkbox" data-sel="'+x.id+'" '+checked+' />'
    +   '<div class="text-sub">'+right+'</div>'
    + '</div>'
    + '</div>';
}
function scoreRowHTML(x){
  var badge = x.result==='W'?'win':(x.result==='L'?'loss':'push');
  var right = (x.commenceTime ? formatDate(x.commenceTime) : '');
  return '<div class="out-row" data-row="'+x.id+'">'
    + '<div>'
    +   '<div><strong>'+esc(x.pickDesc||'—')+'</strong> <span class="badge '+badge+'">'+x.result+'</span></div>'
    +   '<div class="text-sub">'+esc(x.league||'—')+' • '+esc(x.marketType||'—')+' • Odds '+oddsString(x.oddsAmerican||0)+' • '+(x.settledAt?formatDate(x.settledAt):'')+'</div>'
    +   (x.reasoning ? '<div class="reasoning">Reasoning: '+esc(x.reasoning)+'</div>' : '')
    + '</div>'
    + '<div class="text-sub">'+right+'</div>'
    + '</div>';
}
function teaserCardHTML(i){
  var isAnon = state.auth === 'anon';
  var ctaText = isAnon ? 'Sign up to unlock' : 'Upgrade to unlock';
  var btnText = isAnon ? 'Sign up for free' : 'Upgrade';
  var btnAction = isAnon ? 'data-goto-signup' : 'data-goto-subscribe';
  
  // Dynamic teaser content for variety
  var leagues = ['MLB', 'NFL', 'NBA', 'NHL'];
  var markets = ['moneyline', 'spread', 'totals', 'props'];
  var risks = ['SAFE', 'DEGEN'];
  var teams = ['████████ vs █████', '███████ vs ██████', '██████ vs ███████', '█████ vs ████████'];
  
  var league = leagues[i % leagues.length];
  var market = markets[Math.floor(Math.random() * markets.length)];
  var risk = risks[Math.floor(Math.random() * risks.length)];
  var team = teams[i % teams.length];
  var confidence = 70 + Math.floor(Math.random() * 20); // 70-89
  var odds = Math.floor(Math.random() * 300) - 150; // -150 to +150
  
  return '<div class="locked-card card">'
    + '<div class="locked-label">Locked pick</div>'
    + '<div class="locked-inner">'
    +   '<div class="text-sub">' + league + ' • ' + market + '</div>'
    +   '<div class="row" style="gap:8px"><div><strong>' + team + '</strong></div><div class="chip ' + (risk==='SAFE'?'safe':'degen') + '">' + risk + '</div></div>'
    +   '<div class="text-sub">Confidence: ' + confidence + '█ • Odds: ' + (odds >= 0 ? '+' : '') + odds + '█</div>'
    +   '<div class="reasoning">Reasoning: ████████████████████████████████</div>'
    +   '<div class="row" style="margin-top:6px;gap:8px"><div class="text-sub">Commences: ███ ██, ████</div></div>'
    + '</div>'
    + '<div class="locked-veil"></div>'
    + '<div class="locked-cta"><div class="text-sub">' + ctaText + '</div><button type="button" class="btn primary" ' + btnAction + '>' + btnText + '</button></div>'
    + '</div>';
}

// VIEW RENDERERS
function render(){
  var note = document.getElementById('gatingNote');
  if (state.auth==='anon') {
    note.textContent = 'Sign up for free to see 3 more picks.';
    note.classList.remove('hidden');
  } else if (state.auth==='free') {
    note.innerHTML = 'Upgrade to see all picks & unlock Favorites/Outcomes <strong>($15/mo)</strong>. <button type="button" class="btn primary enhanced" data-goto-subscribe>Upgrade</button>';
    note.classList.remove('hidden');
  } else {
    note.classList.add('hidden');
  }
  var league = (document.getElementById('leagueSel')).value;
  var market = (document.getElementById('marketSel')).value;
  
  var sort = (document.getElementById('sortSel')).value;
  var min = Number((document.getElementById('minConf')).value || 0);
  var search = (document.getElementById('searchInp')).value.trim().toLowerCase();

  var arr = picksAll.filter(function(p){ return canSee(p); });
  
  if (league) arr = arr.filter(function(p){ return p.league===league; });
  if (market) arr = arr.filter(function(p){ return p.marketType===market; });
  
  if (min>0) arr = arr.filter(function(p){ 
    // Handle both old format (modelConfidence) and new format (confidence as decimal string)
    const confidence = p.modelConfidence || (p.confidence ? Math.round(parseFloat(p.confidence) * 100) : 0);
    return confidence >= min; 
  });
  if (search) arr = arr.filter(function(p){ return p.pickDesc.toLowerCase().includes(search); });
  arr.sort(sort==='confidence' ? byConfidence : byCommence);

  var list = document.getElementById('list');
  if (arr.length > 0) list.innerHTML = arr.map(function(p) { return cardHTML(p, false); }).join('');
  else {
    var hasFilters = league || market || min > 0;
    var message = search ? 
      'No picks found for "' + search + '". Try different keywords or <button onclick="clearSearch()" class="btn ghost" style="padding:2px 6px;font-size:inherit;">clear search</button>.' :
      hasFilters ? 
        'No picks match your current filters. Try <button onclick="clearAllFilters()" class="btn ghost" style="padding:2px 6px;font-size:inherit;">clearing filters</button> or adjusting your criteria.' :
        'No picks available right now. Check back soon for expert analysis! 🏆';
    
    list.innerHTML = '<div class="card text-sub" style="text-align:center;padding:32px;">' +
                    '<div style="font-size:48px;margin-bottom:16px;">🏈</div>' +
                    '<div>' + message + '</div>' +
                    '</div>';
  }

  var _authBtn = document.getElementById('authBtn');
  if (_authBtn) _authBtn.textContent = state.auth==='anon' ? 'Sign up for free' : 'Sign out';

  if (state.auth==='anon'){
    var teasers = 5;
    list.innerHTML += Array.from({length:teasers}, function(_,_i){ return teaserCardHTML(_i); }).join('');
  } else if (state.auth==='free'){
    var teasers = 3;
    list.innerHTML += Array.from({length:teasers}, function(_,_i){ return teaserCardHTML(_i); }).join('');
  }
  maybeShowVerifyBanner();
}

function inTimeframeRes(p, tf){ if (tf==='all') return true; var cutoff = Date.now() - Number(tf)*86400000; return p.settledAt && new Date(p.settledAt).getTime() >= cutoff; }
function computeStats(tf){
  var graded = picksResults.filter(function(p){ return inTimeframeRes(p, tf); });
  var w=0,l=0,pu=0;
  graded.forEach(function(p){ if (p.result==='W') w++; else if (p.result==='L') l++; else pu++; });
  var n = w+l; var winPct = n ? (w*100/n) : 0;
  var res = letterFromWins(w,n);
  return { w:w,l:l,pu:pu, winPct:winPct, letter:res[0], cls:res[1], graded:graded };
}
function renderScorecard(){
  var tf = state.tf;
  Array.prototype.forEach.call(document.querySelectorAll('.score-tab'), function(t){
    var isActive = t.getAttribute('data-tf') === tf;
    t.classList.toggle('active', isActive);
    t.setAttribute('aria-selected', isActive);
  });
  var stats = computeStats(tf);
  document.getElementById('mRecord').textContent = stats.w+'-'+stats.l+'-'+stats.pu;
  document.getElementById('mWinpct').textContent = (stats.winPct||0).toFixed(1)+'%';
  var grade = document.getElementById('gradeBadge');
  grade.textContent = 'Grade: ' + stats.letter;
  grade.className = 'grade ' + stats.cls;

  var wrap = document.getElementById('resultsWrap');
  var note = document.getElementById('resultsNote');
  if (tf==='7' || tf==='30'){
    wrap.innerHTML = stats.graded.sort(function(a,b){ return new Date(b.settledAt) - new Date(a.settledAt); }).map(scoreRowHTML).join('') || '<div class="text-sub">No graded picks yet.</div>';
    note.textContent = '';
  } else {
    wrap.innerHTML = '';
    note.textContent = 'Detailed picks are hidden for longer ranges (180d/All-Time).';
  }
}

function renderFavorites(){
  var gate = document.getElementById('favGate');
  var wrap = document.getElementById('favList');
  var readBtn = document.getElementById('readFavoritesBtn');
  
  // Show/hide Read Aloud button and parlay calculator based on subscription
  if (readBtn) {
    readBtn.classList.toggle('hidden', state.auth !== 'paid');
  }
  
  var parlayCalc = document.getElementById('parlayCalculator');
  if (parlayCalc) {
    parlayCalc.classList.toggle('hidden', state.auth !== 'paid');
  }
  
  if (state.auth !== 'paid') { 
    gate.innerHTML = (state.auth==='free' ? '<div class="card">Subscribers only. Upgrade to save favorites <strong>($15/mo)</strong>. <div style="margin-top:8px"><button type="button" class="btn primary enhanced" data-goto-subscribe>Upgrade</button></div></div>' : '<div class="card">Subscribers only. <a href="#account" data-nav>Sign up</a> to get started.</div>'); 
    wrap.innerHTML=''; 
    return; 
  }
  gate.innerHTML = '';
  
  // Get favorites from localStorage
  var favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
  
  if (favorites.length > 0) {
    // Try to get picks from Firebase and filter for favorites
    if (typeof db !== 'undefined' && db) {
      // Load favorites from Firebase
      loadFavoritesFromFirebase(favorites, wrap);
    } else {
      // Fallback if Firebase not available
      wrap.innerHTML = '<div class="card text-sub" style="text-align:center;padding:32px;">' +
                      '<div style="font-size:48px;margin-bottom:16px;">⭐</div>' +
                      '<div><strong>Favorites Saved!</strong></div>' +
                      '<div style="margin-top:8px">You have ' + favorites.length + ' favorited picks.</div>' +
                      '<div style="margin-top:8px;font-size:12px;">Loading favorites...</div>' +
                      '</div>';
    }
  } else {
    wrap.innerHTML = '<div class="card text-sub" style="text-align:center;padding:32px;">' +
                    '<div style="font-size:48px;margin-bottom:16px;">☆</div>' +
                    '<div><strong>No favorites yet</strong></div>' +
                    '<div style="margin-top:8px">Start building your watchlist by favoriting picks you like!</div>' +
                    '</div>';
  }
  
  // Update parlay calculator
  updateParlayCalculator();
  
  console.log('Favorites rendered successfully');
}

function inOutTf(iso, tf){ if (tf==='all' || !iso) return true; var cutoff = Date.now()-Number(tf)*86400000; return new Date(iso).getTime() >= cutoff; }
function updateSelectionUI(){ var btn = document.getElementById('clearSelectedBtn'); if(btn) btn.disabled = (state.selectedOut.length===0); }
function renderOutcomes(){
  var container = document.getElementById('outcomesContainer');
  if (!container) return;
  
  var tf = state.otf;
  
  // For non-subscribers, show only the upgrade message
  if (state.auth !== 'paid') {
    container.innerHTML = '<div><strong>My Outcomes</strong> <span class="text-sub">— results for your favorited picks</span></div>' +
      '<div style="margin-top:12px">' + 
      (state.auth==='free' ? 
        '<div class="card">Subscribers only. Upgrade to view your outcomes <strong>($15/mo)</strong>. <div style="margin-top:8px"><button type="button" class="btn primary enhanced" data-goto-subscribe>Upgrade</button></div></div>' : 
        '<div class="card">Subscribers only. <a href="#account" data-nav>Sign up</a> to get started.</div>') +
      '</div>';
    return;
  }
  
  // For subscribers, build the full interface
  var tabsHTML = '<div class="row" style="gap:8px; justify-content:space-between; align-items:center">' +
    '<div><strong>My Outcomes</strong> <span class="text-sub">— results for your favorited picks</span></div>' +
    '<div class="smalltabs" role="tablist" aria-label="Outcomes Timeframe">' +
    '<button type="button" class="tab out-tab' + (tf==='7'?' active':'') + '" role="tab" aria-selected="' + (tf==='7') + '" data-otf="7">7d</button>' +
    '<button type="button" class="tab out-tab' + (tf==='30'?' active':'') + '" role="tab" aria-selected="' + (tf==='30') + '" data-otf="30">30d</button>' +
    '<button type="button" class="tab out-tab' + (tf==='180'?' active':'') + '" role="tab" aria-selected="' + (tf==='180') + '" data-otf="180">180d</button>' +
    '<button type="button" class="tab out-tab' + (tf==='all'?' active':'') + '" role="tab" aria-selected="' + (tf==='all') + '" data-otf="all">All</button>' +
    '</div></div>';
    
  var summaryHTML = '<div id="outSummary" class="text-sub" style="margin-top:8px"></div>';
  
  var actionsHTML = '<div class="row" id="outActions" style="gap:8px;margin-top:8px">' +
    '<button type="button" id="selectAllBtn" class="btn">Select all</button>' +
    '<button type="button" id="clearSelectedBtn" class="btn danger" disabled>Delete selected</button>' +
    '<button type="button" id="clearVisibleBtn" class="btn danger">Delete visible</button>' +
    '</div>';
    
  var listHTML = '<div id="outList" class="result-list"></div>';
  
  container.innerHTML = tabsHTML + summaryHTML + actionsHTML + listHTML;
  
  // Now populate the data
  state.selectedOut = [];
  var merged = state.favorites.map(function(f){
    var latest = picksResults.find(function(p){ return p.id===f.id; }) || {};
    var result = latest.result || f.result || null;
    var settledAt = latest.settledAt || f.settledAt || null;
    var snap = f.snap || picksAll.find(function(p){ return p.id===f.id; }) || {};
    var base = (snap && typeof snap==='object') ? snap : {};
    return Object.assign({}, base, { id:f.id, result:result, settledAt:settledAt });
  });
  var filtered = merged.filter(function(x){ return x.result && inOutTf(x.settledAt, tf); }).sort(function(a,b){ return new Date(b.settledAt)-new Date(a.settledAt); });
  var w=0,l=0,p=0; filtered.forEach(function(x){ if (x.result==='W') w++; else if (x.result==='L') l++; else p++; });
  var n = w+l, winPct = n ? (w*100/n).toFixed(1)+'%' : '—';
  
  var outSummary = document.getElementById('outSummary');
  var outList = document.getElementById('outList');
  if (outSummary) outSummary.textContent = 'Record: '+w+'-'+l+'-'+p+' • Win%: '+winPct;
  if (outList) {
    if (filtered.length > 0) {
      outList.innerHTML = filtered.map(resultRowHTML).join('');
    } else {
      outList.innerHTML = '<div class="card text-sub" style="text-align:center;padding:32px;">' +
                          '<div style="font-size:48px;margin-bottom:16px;">📊</div>' +
                          '<div><strong>No outcomes yet</strong></div>' +
                          '<div style="margin-top:8px">Your favorited picks will appear here once they settle!</div>' +
                          '</div>';
    }
  }
  updateSelectionUI();
}

// ACCOUNT views
function accountSignedOutHTML(){
  return '<div class="card account-wrap">'
    + '<h3 style="margin:0 0 6px 0">Account</h3>'
    + '<div class="text-sub">Create an account or sign in.</div>'
    + '<div class="authTabs" role="tablist" aria-label="Auth tabs">'
    + '  <button id="accTabSignup" class="tab '+(state.accTab==='signup'?'active':'')+'" role="tab" aria-selected="'+(state.accTab==='signup')+'">Sign up</button>'
    + '  <button id="accTabSignin" class="tab '+(state.accTab==='signin'?'active':'')+'" role="tab" aria-selected="'+(state.accTab==='signin')+'">Sign in</button>'
    + '</div>'
    + (state.accTab==='signup'
        ? ('<div style="margin-top:10px">'
          + '<button id="googleSignup" class="btn enhanced">Sign up with Google</button>'
          + '<div class="divider"><span class="text-sub">or</span></div>'
          + '<input id="emailInp" class="input" placeholder="Email" aria-label="Email for signup"/>'
          + '<input id="pwInp" class="input" placeholder="Password (8+ chars, letters & numbers)" type="password" aria-label="Password for signup"/>'
          + '<button id="emailSignupBtn" class="btn primary enhanced">Sign up with email</button>'
          + '<div class="helper">By creating an account you agree to our <a href="#terms" data-nav>Terms</a> and <a href="#privacy" data-nav>Privacy Policy</a>.</div>'
          + '</div>')
        : ('<div style="margin-top:10px">'
          + '<button id="googleSignin" class="btn enhanced">Sign in with Google</button>'
          + '<div class="divider"><span class="text-sub">or</span></div>'
          + '<input id="emailInpLogin" class="input" placeholder="Email" aria-label="Email for signin"/>'
          + '<input id="pwInpLogin" class="input" placeholder="Password" type="password" aria-label="Password for signin"/>'
          + '<button id="emailSigninBtn" class="btn enhanced">Sign in with email</button>'
          + '<button id="forgotBtn" class="btn ghost enhanced">Forgot password (mock)</button>'
          + '</div>')
      )
    + '</div>'
    + '<div id="turnstileSignin" class="card hidden" style="margin-top:8px">Bot check failed — try again (mock)</div>'
    + '<div class="card" style="margin-top:12px">'
    + '  <div class="text-sub">Dev shortcut (local-only):</div>'
    + '  <button id="enableAdminBtn" class="btn">Enable Admin on this device (mock)</button>'
    + '  <button id="disableAdminBtn" class="btn hidden">Disable Admin on this device</button>'
    + '</div>';
}
function accountSignedInHTML(){
  var email = getUserEmail();
  var verified = isVerified();
  var createdAt = safeGetStorage('userCreatedAt');
  var lastLoginAt = safeGetStorage('lastLoginAt');
  var plan = safeGetStorage('subPlan', 'free');
  var renew = safeGetStorage('subCurrentPeriodEnd');
  var autoRenew = safeGetStorage('autoRenew') === 'true';
  var status = (state.auth==='paid') ? 'Subscriber' : 'Signed-in (Free)';
  
  // Handle missing email case
  if (!email && state.auth !== 'anon') {
    email = 'Error: Email not found';
    console.error('User is logged in but email is missing from localStorage');
  }

  var planCards = (state.auth==='paid')
    ? ('<div class="card"><div class="text-sub">Plan</div><div><strong>'+ (plan==='yearly'?'Yearly':'Monthly') +'</strong></div></div>'
      + '<div class="card"><div class="text-sub">'+(autoRenew?'Renews on':'Ends on')+'</div><div><strong>'+fmt(renew)+'</strong></div></div>')
    : '';

  return '<div class="card account-wrap">'
    + '<h3 style="margin:0 0 6px 0">Account</h3>'
    + '<div class="text-sub">You are signed in.</div>'
    + (email ? '<div class="text-sub">Email: '+email+' ('+(verified?'verified':'unverified')+')</div>' : '')
    + '<div style="margin-top:8px"><strong>Status:</strong> '+status+'</div>'
    + '<div class="grid" style="grid-template-columns:1fr 1fr; gap:8px; margin-top:8px">'
    +   '<div class="card"><div class="text-sub">Member since</div><div><strong>'+fmt(createdAt)+'</strong></div></div>'
    +   '<div class="card"><div class="text-sub">Last sign-in</div><div><strong>'+fmt(lastLoginAt)+'</strong></div></div>'
    +   planCards
    + '</div>'
    + '<div class="row" style="gap:8px; margin-top:12px">'
    +   (state.auth==='free' ? '<button id="goUpgradeBtn" class="btn primary enhanced">Upgrade — $15/mo</button>' : '')
    +   '<button id="goPicksBtn" class="btn enhanced">Back to picks</button>'
    +   '<button id="signOutBtn" class="btn danger enhanced">Sign out</button>'
    + '</div>'
    + '</div>'
    + '<div class="card" style="margin-top:12px">'
    + '  <h4 style="margin:0 0 8px 0">' + t('settings') + '</h4>'
    + '  <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px">'
    + '    <div>'
    + '      <div class="text-sub">' + t('language') + '</div>'
    + '      <select id="languageSelect" class="input settings-select" style="margin-top:4px">'
    + '        <option value="en">English</option>'
    + '        <option value="es">Español</option>'
    + '        <option value="fr">Français</option>'
    + '        <option value="de">Deutsch</option>'
    + '      </select>'
    + '    </div>'
    + '    <div>'
    + '      <div class="text-sub">' + t('theme') + '</div>'
    + '      <select id="themeSelect" class="input settings-select" style="margin-top:4px">'
    + '        <option value="dark">' + t('darkTheme') + '</option>'
    + '        <option value="light">' + t('lightTheme') + '</option>'
    + '        <option value="auto">' + t('autoTheme') + '</option>'
    + '      </select>'
    + '    </div>'
    + '  </div>'
    + '  <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px">'
    + '    <div>'
    + '      <div class="text-sub">' + t('voiceSpeed') + '</div>'
    + '      <select id="voiceSpeedSelect" class="input settings-select" style="margin-top:4px">'
    + '        <option value="0.8">Slow</option>'
    + '        <option value="1.0" selected>Normal</option>'
    + '        <option value="1.2">Fast</option>'
    + '        <option value="1.4">Very Fast</option>'
    + '      </select>'
    + '    </div>'
    + '    <div>'
    + '      <div class="text-sub">' + t('currency') + '</div>'
    + '      <select id="currencySelect" class="input settings-select" style="margin-top:4px">'
    + '        <option value="USD">USD ($)</option>'
    + '        <option value="EUR">EUR (€)</option>'
    + '        <option value="GBP">GBP (£)</option>'
    + '        <option value="CAD">CAD (C$)</option>'
    + '      </select>'
    + '    </div>'
    + '  </div>'
    + '  <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px">'
    + '    <div>'
    + '      <div class="text-sub">' + t('voiceEnabled') + '</div>'
    + '      <select id="voiceEnabledSelect" class="input settings-select" style="margin-top:4px">'
    + '        <option value="false">Disabled</option>'
    + '        <option value="true">Enabled</option>'
    + '      </select>'
    + '    </div>'
    + '    <div></div>'
    + '  </div>'
    + '  <div class="row" style="gap:8px">'
    + '    <button id="saveSettingsBtn" class="btn primary enhanced">' + t('saveSettings') + '</button>'
    + '    <button id="resetSettingsBtn" class="btn enhanced">Reset to Default</button>'
    + '  </div>'
    + '</div>'
    + '<div class="card" style="margin-top:12px">'
    + '  <div class="text-sub">Dev shortcut (local-only):</div>'
    + '  <button id="enableAdminBtn" class="btn'+(state.isAdmin?' hidden':'')+'">Enable Admin on this device (mock)</button>'
    + '  <button id="disableAdminBtn" class="btn'+(state.isAdmin?'':' hidden')+'">Disable Admin on this device</button>'
    + '</div>';
}
function renderAccount(){
  var wrap = document.getElementById('accountContainer');
  if (!wrap) return;
  wrap.innerHTML = (state.auth==='anon') ? accountSignedOutHTML() : accountSignedInHTML();
  var en = document.getElementById('enableAdminBtn');
  var dis = document.getElementById('disableAdminBtn');
  if (en && dis){ en.classList.toggle('hidden', state.isAdmin); dis.classList.toggle('hidden', !state.isAdmin); }
  
  // Load settings values after rendering
  loadSettingsValues();
}

function reflectAuthButtons(){
  ['btnAnon','btnFree','btnPaid','btnAdmin'].forEach(function(id){ var el = document.getElementById(id); if (el) el.classList.remove('primary'); });
  ({ anon:['btnAnon'], free:['btnFree'], paid:['btnPaid'], admin:['btnAdmin'] }[state.auth]||[]).forEach(function(id){ var el = document.getElementById(id); if (el) el.classList.add('primary'); });
}
function renderProfile(){
  var el = document.getElementById('profileInfo');
  var map = { anon:'Anonymous', free:'Signed-in (Free)', paid:'Subscriber', admin:'Administrator' };
  var email = getUserEmail();
  var emailRow = email ? '<div class="text-sub">Email: '+email+'</div>' : '';
  
  // Show warning if user appears logged in but no email
  if (!email && state.auth !== 'anon') {
    emailRow = '<div class="text-sub" style="color: var(--red);">Email: Missing (localStorage error)</div>';
  }
  
  var ver = (state.auth!=='anon') ? ('<div class="text-sub">Verified: '+(isVerified()?'Yes':'No')+'</div>') : '';
  el.innerHTML = '<div class="row"><div><strong>Status:</strong> '+map[state.auth]+'</div></div>' + emailRow + ver;
  reflectAuthButtons();
}
function renderSubscribe(){}

function renderContact(){
  var title = document.getElementById('contactTitle');
  var nameLabel = document.getElementById('nameLabel');
  var emailLabel = document.getElementById('emailLabel');
  var subjectLabel = document.getElementById('subjectLabel');
  var messageLabel = document.getElementById('messageLabel');
  var sendBtn = document.getElementById('sendContactBtn');
  var clearBtn = document.getElementById('clearContactBtn');
  
  if (title) title.textContent = t('contactUs');
  if (nameLabel) nameLabel.textContent = t('name');
  if (emailLabel) emailLabel.textContent = t('email');
  if (subjectLabel) subjectLabel.textContent = t('subject');
  if (messageLabel) messageLabel.textContent = t('message');
  if (sendBtn) sendBtn.textContent = t('sendMessage');
  
  // Auto-fill email from logged-in account
  var emailInput = document.getElementById('contactEmail');
  var userEmail = getUserEmail();
  if (emailInput) {
    if (userEmail) {
      emailInput.value = userEmail;
    } else if (state.auth !== 'anon') {
      emailInput.placeholder = 'Email missing from storage';
      emailInput.style.color = 'var(--red)';
    }
  }
  if (clearBtn) clearBtn.textContent = 'Clear Form';
}

// DELEGATED CLICKS
document.addEventListener('click', function(e){
  var target = e.target;

  // Favorite toggle
  var favEl = target.closest && target.closest('[data-fav]');
  if (favEl){ toggleFavorite(favEl.getAttribute('data-fav')); return; }

  // Account tabs
  if (target.id==='accTabSignup'){ state.accTab='signup'; localStorage.setItem('accTab','signup'); renderAccount(); }
  if (target.id==='accTabSignin'){ state.accTab='signin'; localStorage.setItem('accTab','signin'); renderAccount(); }

  // tabs
  var scoreTab = target.closest && target.closest('.score-tab');
  if (scoreTab){ state.tf = scoreTab.getAttribute('data-tf'); localStorage.setItem('tf', state.tf); renderScorecard(); }

  var outTab = target.closest && target.closest('.out-tab');
  if (outTab){ state.otf = outTab.getAttribute('data-otf'); localStorage.setItem('otf', state.otf); renderOutcomes(); }

  // admin toggle (from Account)
  if (target.id==='enableAdminBtn'){ setAdmin(true); alert('Admin enabled on this device (mock).'); updateAdminUI(); renderAccount(); }
  if (target.id==='disableAdminBtn'){ setAdmin(false); alert('Admin disabled on this device.'); updateAdminUI(); renderAccount(); }

  // admin page actions
  if (target.id==='btnAnon') setAuth('anon');
  if (target.id==='btnFree') setAuth('free');
  if (target.id==='btnPaid') setAuth('paid');
  if (target.id==='btnAdmin') {
    setAuth('admin');
    adminUnlocked = true; // Grant admin access when switching to admin mode
    checkAdminAccess();
  }

  // Admin Portal Tab Navigation
  if (target.dataset && target.dataset.adminTab) {
    switchAdminTab(target.dataset.adminTab);
  }
  
  // Banner Management
  if (target.id==='previewBannerBtn') previewBanner();
  if (target.id==='activateBannerBtn') activateBanner();
  if (target.id==='hideBannerBtn') hideBanner();
  if (target.id==='maintenanceTemplateBtn') loadMaintenanceTemplate();
  if (target.id==='updateTemplateBtn') loadUpdateTemplate();
  
  // Content Management
  if (target.id==='editTermsBtn') editLegalPage('terms');
  if (target.id==='editPrivacyBtn') editLegalPage('privacy');
  if (target.id==='saveLegalBtn') saveLegalPage();
  if (target.id==='cancelLegalBtn') cancelLegalEdit();
  if (target.id==='saveMessagesBtn') saveSystemMessages();
  
  // User Management - Legacy handlers
  if (target.id==='markVerifiedBtn'){ alert('Email marked as verified (mock)'); render(); }
  if (target.id==='unverifyBtn'){ alert('Email marked as unverified (mock)'); render(); }
  if (target.id==='clearFavsBtn'){ if(confirm('Clear favorites?')){ state.favorites=[]; setStorage('favorites',state.favorites); render(); } }
  if (target.id==='seedOutcomesBtn') seedTestOutcomes();
  
  // Logo click to return home
  if (target.id==='logoHome' || target.closest('#logoHome')) {
    location.hash = '#picks';
    route();
    return;
  }
  
  // Multi-select filter handlers removed (no longer needed)
  
  // User Management - New handlers
  if (target.id==='grantSubBtn') grantSubscription();
  if (target.id==='revokeSubBtn') revokeSubscription();
  if (target.id==='resetUserBtn') resetUserData();
  if (target.id==='resetAllDataBtn') resetAllData();
  
  // System Management
  if (target.id==='saveFlagsBtn') saveFeatureFlags();
  if (target.id==='clearCacheBtn') clearSystemCache();
  if (target.id==='exportDataBtn') exportSystemData();
  if (target.id==='importDataBtn') importSystemData();
  if (target.id==='systemResetBtn') performSystemReset();
  if (target.id==='backupDataBtn') backupSystemData();
  
  // Auth buttons with loading states
  if (target.id==='googleSignup' || target.id==='googleSignin') {
    setButtonLoading(target.id, true);
    setTimeout(function() {
      setButtonLoading(target.id, false);
      setAuth('free');
      showMessage('Signed in with Google! (mock)', 'success');
    }, 2000);
  }
  
  if (target.id==='emailSignupBtn') {
    var email = document.getElementById('emailInp');
    var pw = document.getElementById('pwInp');
    if (!email || !pw || !email.value.trim() || !pw.value.trim()) {
      alert('Please fill in email and password.');
      return;
    }
    setButtonLoading('emailSignupBtn', true);
    setTimeout(function() {
      setButtonLoading('emailSignupBtn', false);
      if (!safeSetStorage('userEmail', email.value.trim())) {
        showMessage('Warning: Could not save email to storage', 'error');
      }
      setAuth('free');
      showMessage('Account created successfully!', 'success');
    }, 2500);
  }
  
  if (target.id==='emailSigninBtn') {
    var email = document.getElementById('emailInpLogin');
    var pw = document.getElementById('pwInpLogin');
    if (!email || !pw || !email.value.trim() || !pw.value.trim()) {
      alert('Please fill in email and password.');
      return;
    }
    setButtonLoading('emailSigninBtn', true);
    setTimeout(function() {
      setButtonLoading('emailSigninBtn', false);
      if (!safeSetStorage('userEmail', email.value.trim())) {
        showMessage('Warning: Could not save email to storage', 'error');
      }
      setAuth('free');
      showMessage('Signed in successfully!', 'success');
    }, 2000);
  }

  if (target.id==='seedOutcomesBtn' || target.id==='seedDemoBtn'){
    if (state.auth!=='paid') return alert('Subscriber required (mock)');
    var demo = picksResults.slice(0,4).map(function(p){ return ({ id: p.id, snap: p, result: p.result, settledAt: p.settledAt }); });
    state.favorites = demo;
    localStorage.setItem('favorites', JSON.stringify(state.favorites));
    renderFavorites(); renderOutcomes(); render();
  }
  if (target.id==='clearFavsBtn'){
    state.favorites = [];
    localStorage.setItem('favorites', JSON.stringify(state.favorites));
    renderFavorites(); renderOutcomes(); render();
    alert('Favorites cleared.');
  }
  if (target.id==='adminOffBtn'){ setAdmin(false); }

  // outcomes select/delete
  var sel = target.closest && target.closest('input[type="checkbox"][data-sel]');
  if (sel){
    var sid = sel.getAttribute('data-sel');
    if (sel.checked) { if (state.selectedOut.indexOf(sid)===-1) state.selectedOut.push(sid); }
    else { state.selectedOut = state.selectedOut.filter(function(x){ return x !== sid; }); }
    updateSelectionUI();
  }
  if (target.id==='selectAllBtn'){
    var boxes = Array.prototype.slice.call(document.querySelectorAll('#outList [data-sel]'));
    state.selectedOut = boxes.map(function(b){ return b.getAttribute('data-sel'); });
    boxes.forEach(function(b){ b.checked = true; });
    updateSelectionUI();
  }
  if (target.id==='clearSelectedBtn'){
    if (state.auth!=='paid') return;
    if (state.selectedOut.length===0) return;
    if (!confirm('Delete all selected outcomes from your saved favorites?')) return;
    state.favorites = state.favorites.filter(function(f){ return state.selectedOut.indexOf(f.id)===-1; });
    state.selectedOut = [];
    localStorage.setItem('favorites', JSON.stringify(state.favorites));
    renderFavorites(); renderOutcomes(); render();
  }
  if (target.id==='clearVisibleBtn'){
    if (state.auth!=='paid') return;
    if (!confirm('Delete ONLY outcomes in the current timeframe view? This cannot be undone.')) return;
    var tf = state.otf;
    state.favorites = state.favorites.filter(function(f){
      var t = f.settledAt ? new Date(f.settledAt).getTime() : 0;
      var keep = (tf==='all') ? false : (Date.now() - t) > Number(tf)*86400000;
      return keep;
    });
    state.selectedOut = [];
    localStorage.setItem('favorites', JSON.stringify(state.favorites));
    renderFavorites(); renderOutcomes(); render();
  }

  // CTAs
  var toSignup = target.closest && target.closest('[data-goto-signup]');
  if (toSignup){ location.hash = '#account'; route(); }
  var toSubscribe = target.closest && target.closest('[data-goto-subscribe]');
  if (toSubscribe){ location.hash = '#subscribe'; route(); }
  if (target.id==='upgradeBtn' || target.id==='mobileUpgradeBtn' || target.id==='goUpgradeBtn'){ location.hash = '#subscribe'; route(); }

  if (target.id==='upgradeNowBtn'){
    var plan = document.getElementById('planYearlyBtn').classList.contains('primary') ? 'yearly' : 'monthly';
    var start = nowIso();
    var end = (plan === 'yearly') ? addMonthsISO(start, 12) : addMonthsISO(start, 1);
    localStorage.setItem('subPlan', plan);
    localStorage.setItem('subStatus', 'active');
    localStorage.setItem('subStartedAt', start);
    localStorage.setItem('subCurrentPeriodEnd', end);
    localStorage.setItem('autoRenew', 'true');

    setAuth('paid');
    alert('Upgraded to Subscriber (prototype).');
    location.hash = '#picks'; route();
  }

  if (target.id==='backToPicksBtn' || target.id==='goPicksBtn'){ location.hash = '#picks'; route(); }

  // coupons
  if (target.id==='applyCouponBtn'){
    var inp = document.getElementById('couponCode');
    var code = (inp && inp.value ? inp.value : '').trim().toUpperCase();
    var note = document.getElementById('subscribeNote');
    var upgBtn = document.getElementById('upgradeNowBtn');
    if (!code){ alert('Enter a code first.'); return; }
    if (code === 'SAVE20'){
      if (note) note.textContent = 'Coupon applied: SAVE20 — New price $12 USD / month';
      if (upgBtn) upgBtn.textContent = 'Complete subscription — $12/mo';
      alert('Coupon applied.');
    } else {
      alert('Invalid code (mock). Try SAVE20.');
    }
  }
  if (target.id==='planMonthlyBtn') {
    target.classList.add('primary');
    document.getElementById('planYearlyBtn').classList.remove('primary');
    document.getElementById('planPrice').textContent = '$15';
    document.getElementById('planInterval').textContent = 'USD / month';
    document.getElementById('planName').innerHTML = '<strong>Confident Picks — Monthly</strong>';
    document.getElementById('upgradeNowBtn').textContent = 'Complete subscription — $15/mo';
  }
  if (target.id==='planYearlyBtn') {
    target.classList.add('primary');
    document.getElementById('planMonthlyBtn').classList.remove('primary');
    document.getElementById('planPrice').textContent = '$150';
    document.getElementById('planInterval').textContent = 'USD / year';
    document.getElementById('planName').innerHTML = '<strong>Confident Picks — Yearly</strong>';
    document.getElementById('upgradeNowBtn').textContent = 'Complete subscription — $150/yr';
  }

  // auth (Account)
  if (target.id==='googleSignup'){
    setAuth('free');
    localStorage.setItem('userEmail', 'google_user@example.com');
    localStorage.setItem('emailVerified','true');
    localStorage.setItem('userCreatedAt', localStorage.getItem('userCreatedAt') || nowIso());
    localStorage.setItem('lastLoginAt', nowIso());
    alert('Signed up with Google (prototype).');
    location.hash = '#picks'; route();
  }
  if (target.id==='googleSignin'){
    setAuth('free');
    localStorage.setItem('userEmail', 'google_user@example.com');
    localStorage.setItem('emailVerified','true');
    localStorage.setItem('lastLoginAt', nowIso());
    alert('Signed in with Google (prototype).');
    location.hash = '#picks'; route();
  }
  if (target.id==='emailSignupBtn'){
    var email = (document.getElementById('emailInp')||{}).value || '';
    var pw = (document.getElementById('pwInp')||{}).value || '';
    if (!email || email.indexOf('@')===-1) { alert('Please enter a valid email.'); return; }
    if (!pw || pw.length < 8 || !/[A-Za-z]/.test(pw) || !/[0-9]/.test(pw)) { alert('Password must be 8+ chars, include letters and numbers.'); return; }
    localStorage.setItem('userEmail', email);
    localStorage.setItem('userPw', pw);
    localStorage.setItem('emailVerified','false');
    localStorage.setItem('userCreatedAt', localStorage.getItem('userCreatedAt') || nowIso());
    localStorage.setItem('lastLoginAt', nowIso());
    setAuth('free');
    alert('Account created! Please verify your email to unlock extras (mock).');
    location.hash = '#picks'; route();
  }
  if (target.id==='emailSigninBtn'){
    var email2 = (document.getElementById('emailInpLogin')||{}).value || '';
    var pw2 = (document.getElementById('pwInpLogin')||{}).value || '';
    var savedEmail = localStorage.getItem('userEmail');
    var savedPw = localStorage.getItem('userPw');
    var fails = Number(localStorage.getItem('loginFails')||'0');
    if (!email2 || !pw2) { alert('Check your email or password.'); return; }
    if (email2===savedEmail && pw2===savedPw){
      setAuth('free');
      localStorage.setItem('loginFails','0');
      localStorage.setItem('lastLoginAt', nowIso());
      alert('Signed in!');
      location.hash = '#picks'; route();
    } else {
      fails += 1;
      localStorage.setItem('loginFails', String(fails));
      if (fails >= 3){
        var t = document.getElementById('turnstileSignin'); if (t) t.classList.remove('hidden');
      }
      alert('Check your email or password.');
    }
  }
  if (target.id==='forgotBtn'){ alert('Password reset link sent (mock).'); }
  if (target.id==='signOutBtn'){ setAuth('anon'); location.hash = '#picks'; route(); }

  // email verify controls
  if (target.id==='sendVerifyBtn'){ alert('Verification email sent (mock).'); }
  if (target.id==='markVerifiedBtn'){
    localStorage.setItem('emailVerified','true');
    alert('Email marked as verified (mock). Your account is now active.');
    renderAccount(); maybeShowVerifyBanner();
  }
  if (target.id==='unverifyBtn'){
    localStorage.setItem('emailVerified','false');
    alert('Marked unverified (mock).');
    renderProfile(); maybeShowVerifyBanner();
  }

  // Reset maintenance banner
  if (target.id==='resetBannerBtn'){
    try { localStorage.removeItem(BANNER_KEY); } catch (e) {}
    var b = document.getElementById('maintBanner'); if (b) b.style.display = 'flex';
    alert('Banner reset (v2).');
  }



  // Settings functionality
  if (target.id==='saveSettingsBtn'){
    var newSettings = {
      language: document.getElementById('languageSelect').value,
      theme: document.getElementById('themeSelect').value,
      voiceSpeed: document.getElementById('voiceSpeedSelect').value,
      currency: document.getElementById('currencySelect').value,
      voiceEnabled: document.getElementById('voiceEnabledSelect').value
    };
    state.settings = newSettings;
    localStorage.setItem('userSettings', JSON.stringify(newSettings));
    
    // Apply theme immediately
    if (newSettings.theme === 'light') {
      document.documentElement.setAttribute('data-theme', 'light');
    } else if (newSettings.theme === 'dark') {
      document.documentElement.removeAttribute('data-theme');
    }
    localStorage.setItem('theme', newSettings.theme);
    
    updateAllTranslations();
    alert(t('saveSettings') + ' - Settings saved successfully!');
  }

  if (target.id==='resetSettingsBtn'){
    if (confirm('Reset all settings to default (English)? This cannot be undone.')) {
      var defaultSettings = {"language":"en","theme":"dark","voiceSpeed":"1.0","currency":"USD","voiceEnabled":"false"};
      state.settings = defaultSettings;
      localStorage.setItem('userSettings', JSON.stringify(defaultSettings));
      document.documentElement.removeAttribute('data-theme');
      localStorage.setItem('theme', 'dark');
      updateAllTranslations();
      renderAccount();
      alert('Settings reset to default!');
    }
  }

  if (target.id==='readFavoritesBtn'){
    readFavoritesAloud();
  }

  // Min Confidence steppers
  var stepBtn = target.closest && target.closest('[data-step]');
  if (stepBtn){
    var delta = Number(stepBtn.getAttribute('data-step')||0);
    changeMinConf(delta);
  }
});

// keyboard support for star toggle
document.addEventListener('keydown', function(e){
  var tgt = e.target;
  if (tgt && tgt.hasAttribute && tgt.hasAttribute('data-fav') && (e.key==='Enter' || e.key===' ')){
    e.preventDefault();
    var id = tgt.getAttribute('data-fav');
    if (id) toggleFavorite(id);
  }
});

// Global keyboard shortcuts
document.addEventListener('keydown', function(e){
  // Skip if user is typing in input
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
  
  switch(e.key.toLowerCase()) {
    case '/':
      e.preventDefault();
      var searchInput = document.getElementById('searchInp');
      if (searchInput) searchInput.focus();
      break;
    case 't':
      if (e.ctrlKey || e.metaKey) return; // Don't interfere with browser shortcuts
      e.preventDefault();
      document.getElementById('themeBtn').click();
      break;
    case '1': case '2': case '3': case '4': case '5': case '6':
      var navIndex = parseInt(e.key) - 1;
      var navLinks = document.querySelectorAll('[data-nav]');
      if (navLinks[navIndex]) navLinks[navIndex].click();
      break;
    case '?':
      e.preventDefault();
      document.getElementById('helpModal').classList.add('active');
      break;
    case 'escape':
      // Close help modal first, then clear search
      var helpModal = document.getElementById('helpModal');
      if (helpModal && helpModal.classList.contains('active')) {
        helpModal.classList.remove('active');
        break;
      }
      // Clear any active modals or reset search
      var searchInput = document.getElementById('searchInp');
      if (searchInput && searchInput.value) {
        searchInput.value = '';
        render();
      }
      break;
  }
});

// Help modal handlers
document.addEventListener('click', function(e){
  var helpModal = document.getElementById('helpModal');
  
  // Close help modal
  if (e.target.id === 'closeHelpBtn' || 
      (e.target === helpModal && helpModal.classList.contains('active'))) {
    helpModal.classList.remove('active');
    return;
  }
});

// Contact form handlers
document.addEventListener('click', function(e){
  if (e.target.id === 'sendContactBtn') {
    // Check if user is logged in first
    if (state.auth === 'anon') {
      alert('Please log in to submit a support ticket.\n\nThis helps us:\n• Track your request\n• Provide better support\n• Follow up with updates\n\nClick "Account" to sign in or create an account.');
      return;
    }
    
    // Show loading state
    setButtonLoading('sendContactBtn', true);
    
    var name = document.getElementById('contactName').value.trim();
    var email = document.getElementById('contactEmail').value.trim();
    var subject = document.getElementById('contactSubject').value;
    var message = document.getElementById('contactMessage').value.trim();
    
    // Auto-fill email from logged-in account
    var userEmail = getUserEmail();
    if (userEmail && email !== userEmail) {
      document.getElementById('contactEmail').value = userEmail;
      email = userEmail;
    } else if (!userEmail && state.auth !== 'anon') {
      setButtonLoading('sendContactBtn', false);
      alert('Error: Your email address is missing from storage. Please sign out and sign back in.');
      return;
    }
    
    // Validation
    if (!name || !subject || !message) {
      setButtonLoading('sendContactBtn', false);
      alert('Please fill in all required fields.');
      return;
    }
    
    // Email is auto-filled from account, so no manual validation needed
    
    // Gather user data for support context
    var supportData = {
      userMessage: {
        name: name,
        email: email,
        subject: subject,
        message: message,
        accountStatus: 'logged-in'
      },
      userContext: {
        auth: state.auth,
        favoritesCount: state.favorites.length,
        settings: state.settings,
        userAgent: navigator.userAgent,
        timestamp: nowIso(),
        currentPage: location.hash || '#picks'
      },
      localStorage: {
        userEmail: safeGetStorage('userEmail'),
        emailVerified: safeGetStorage('emailVerified'),
        subPlan: safeGetStorage('subPlan'),
        theme: safeGetStorage('theme')
      }
    };
    
    // In real app, this would POST supportData to your server
    console.log('Support Request Data:', supportData);
    
    // Simulate async operation
    setTimeout(function() {
      setButtonLoading('sendContactBtn', false);
    alert('Thank you for your message! We\'ll get back to you soon.\n\n(Debug: Check console for support data)');
    
    // Clear form
    document.getElementById('contactName').value = '';
    document.getElementById('contactEmail').value = '';
    document.getElementById('contactSubject').value = '';
    document.getElementById('contactMessage').value = '';
    }, 1500); // 1.5 second delay to show loading state
  }
  
  if (e.target.id === 'clearContactBtn') {
    document.getElementById('contactName').value = '';
    document.getElementById('contactEmail').value = '';
    document.getElementById('contactSubject').value = '';
    document.getElementById('contactMessage').value = '';
  }
});

// Collapsible guide persistence
(function(){
  var sh = document.getElementById('scoreHelp');
  if (!sh) return;
  var saved = localStorage.getItem('scoreHelpOpen');
  if (saved !== null) sh.open = saved === '1';
  sh.addEventListener('toggle', function(){
    localStorage.setItem('scoreHelpOpen', sh.open ? '1' : '0');
  });
})();

// Maintenance banner v2
var BANNER_KEY = 'maintBannerDismissed_v2';
(function(){
  var banner = document.getElementById('maintBanner');
  if (!banner) return;
  var params = new URLSearchParams(location.search);
  var forceShow = params.get('showBanner') === '1';
  var forceHide = params.get('showBanner') === '0';
  var dismissed = false;
  try { dismissed = localStorage.getItem(BANNER_KEY) === '1'; } catch (e) {}
  banner.style.display = (forceHide ? 'none' : ((forceShow || !dismissed) ? 'flex' : 'none'));
})();
function dismissMaintBanner(){
  var banner = document.getElementById('maintBanner');
  if (banner) banner.style.display = 'none';
  try { localStorage.setItem(BANNER_KEY,'1'); } catch (e) {}
}

/* Min Confidence helpers */
function clampMinConf(val){
  val = Math.round(Number(val) || 0);
  if (val < 0) val = 0; if (val > 100) val = 100;
  return val;
}
function changeMinConf(delta){
  var el = document.getElementById('minConf'); if (!el) return;
  el.value = clampMinConf((Number(el.value)||0) + delta);
  render();
}

/* filter listeners */
['leagueSel','marketSel','sortSel'].forEach(function(id){
  var el = document.getElementById(id);
  if (el) el.addEventListener('change', render);
});
['searchInp','minConf'].forEach(function(id){
  var el = document.getElementById(id);
  if (el) el.addEventListener('input', function(){
    if (id==='minConf') {
      this.value = clampMinConf(this.value);
      // Check if we're displaying Firebase picks
      const currentPicks = window.currentPicks || [];
      if (currentPicks.length > 0) {
        console.log('🎛️ Min confidence changed to:', this.value, '- filtering Firebase picks');
        updatePicksDisplay(currentPicks);
        return; // Don't call render() for Firebase picks
      } else {
        console.log('🎛️ Min confidence changed to:', this.value, '- filtering static picks');
        // Show static picks and apply filter
        showStaticPicks();
      }
    }
    // Only call render() for static picks or when no Firebase picks are displayed
    render();
  });
});

/* ADMIN PORTAL FUNCTIONS */

// Admin Tab Management
function switchAdminTab(tabName) {
  // Hide all tab contents
  document.querySelectorAll('.admin-tab-content').forEach(function(el) {
    el.classList.add('hidden');
  });
  
  // Show selected tab content
  var targetTab = document.getElementById('admin' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
  if (targetTab) targetTab.classList.remove('hidden');
  
  // Update tab button states
  document.querySelectorAll('.tab').forEach(function(el) {
    el.classList.remove('active');
  });
  
  var activeButton = document.querySelector('[data-admin-tab="' + tabName + '"]');
  if (activeButton) activeButton.classList.add('active');
  
  // Update admin dashboard data when switching to overview
  if (tabName === 'overview') updateAdminMetrics();
}

// Update admin overview metrics
function updateAdminMetrics() {
  var userCount = 1; // Mock data - would come from Firebase
  var subCount = (state.auth === 'paid') ? 1 : 0;
  
  var userCountEl = document.getElementById('adminUserCount');
  var subCountEl = document.getElementById('adminSubCount');
  
  if (userCountEl) userCountEl.textContent = userCount;
  if (subCountEl) subCountEl.textContent = subCount;
}

// Banner Management Functions
function previewBanner() {
  var type = document.getElementById('bannerType').value;
  var title = document.getElementById('bannerTitle').value || 'Sample Title';
  var message = document.getElementById('bannerMessage').value || 'Sample message text';
  
  alert('BANNER PREVIEW\\n\\nType: ' + type + '\\nTitle: ' + title + '\\nMessage: ' + message);
}

function activateBanner() {
  var type = document.getElementById('bannerType').value;
  var title = document.getElementById('bannerTitle').value;
  var message = document.getElementById('bannerMessage').value;
  
  if (!title || !message) {
    alert('Please enter both title and message');
    return;
  }
  
  // Store banner data
  var bannerData = { type: type, title: title, message: message, active: true };
  safeSetStorage('adminBanner', JSON.stringify(bannerData));
  
  // Update the actual banner on the page
  updateLiveBanner();
  
  // Update status display
  updateBannerStatus();
  alert('Banner activated successfully!');
}

function hideBanner() {
  safeSetStorage('adminBanner', JSON.stringify({ active: false }));
  
  // Hide the actual banner on the page
  updateLiveBanner();
  
  updateBannerStatus();
  alert('Banner hidden successfully!');
}

// Update the actual visible banner on the page
function updateLiveBanner() {
  var bannerData = JSON.parse(safeGetStorage('adminBanner', '{"active":false}'));
  var banner = document.getElementById('maintBanner');
  
  if (!banner) return;
  
  if (bannerData.active && bannerData.title && bannerData.message) {
    // Show and update banner content
    var labelEl = banner.querySelector('.label');
    var textEl = banner.querySelector('.text-sub');
    
    if (labelEl) labelEl.textContent = bannerData.title + ':';
    if (textEl) textEl.textContent = bannerData.message;
    
    // Apply styling based on banner type
    var bgClass = {
      'maintenance': 'linear-gradient(180deg, rgba(255,193,7,.18), rgba(255,87,34,.18))',
      'announcement': 'linear-gradient(180deg, rgba(77,163,255,.18), rgba(34,197,94,.18))',
      'warning': 'linear-gradient(180deg, rgba(255,87,34,.18), rgba(244,67,54,.18))',
      'info': 'linear-gradient(180deg, rgba(77,163,255,.18), rgba(156,39,176,.18))'
    };
    
    banner.style.background = bgClass[bannerData.type] || bgClass.announcement;
    banner.style.display = 'flex';
    
    // Clear any dismissed state
    try { localStorage.removeItem(BANNER_KEY); } catch (e) {}
  } else {
    // Hide banner
    banner.style.display = 'none';
  }
}

function updateBannerStatus() {
  var bannerData = JSON.parse(safeGetStorage('adminBanner', '{"active":false}'));
  var statusEl = document.getElementById('bannerStatusText');
  
  if (statusEl) {
    if (bannerData.active) {
      statusEl.textContent = 'Active: ' + (bannerData.title || 'Untitled Banner');
      statusEl.style.color = 'var(--green)';
    } else {
      statusEl.textContent = 'No active banner';
      statusEl.style.color = 'var(--text-sub)';
    }
  }
}

function loadMaintenanceTemplate() {
  document.getElementById('bannerType').value = 'maintenance';
  document.getElementById('bannerTitle').value = 'Scheduled Maintenance';
  document.getElementById('bannerMessage').value = 'We are performing scheduled maintenance. The site will be back online shortly. Thank you for your patience.';
}

function loadUpdateTemplate() {
  document.getElementById('bannerType').value = 'announcement';
  document.getElementById('bannerTitle').value = 'New Features Available';
  document.getElementById('bannerMessage').value = 'We have exciting new features and improvements available! Check out the latest updates to enhance your experience.';
}

// Content Management Functions
var currentEditingPage = '';

function editLegalPage(pageType) {
  currentEditingPage = pageType;
  var editor = document.getElementById('legalEditor');
  var titleEl = document.getElementById('editingPageTitle');
  var contentEl = document.getElementById('legalContent');
  
  var titles = { terms: 'Terms of Service', privacy: 'Privacy Policy' };
  var defaultContent = {
    terms: 'TERMS OF SERVICE\\n\\nLast updated: ' + new Date().toDateString() + '\\n\\n1. Acceptance of Terms\\nBy using this service, you agree to these terms...\\n\\n2. Use License\\nPermission is granted to temporarily use this service...\\n\\n3. Disclaimer\\nThis service is provided as-is for entertainment purposes...',
    privacy: 'PRIVACY POLICY\\n\\nLast updated: ' + new Date().toDateString() + '\\n\\n1. Information We Collect\\nWe collect information you provide directly...\\n\\n2. How We Use Information\\nWe use the information to provide and improve...\\n\\n3. Information Sharing\\nWe do not sell or rent personal information...'
  };
  
  if (titleEl) titleEl.textContent = titles[pageType] || pageType;
  if (contentEl) contentEl.value = safeGetStorage('legal_' + pageType, defaultContent[pageType] || '');
  if (editor) editor.classList.remove('hidden');
}

function saveLegalPage() {
  if (!currentEditingPage) return;
  
  var content = document.getElementById('legalContent').value;
  safeSetStorage('legal_' + currentEditingPage, content);
  
  alert('Legal page saved successfully!');
  cancelLegalEdit();
}

function cancelLegalEdit() {
  var editor = document.getElementById('legalEditor');
  if (editor) editor.classList.add('hidden');
  currentEditingPage = '';
}

function saveSystemMessages() {
  var gateMsg = document.getElementById('gateMessage').value;
  var upgradeMsg = document.getElementById('upgradeCTA').value;
  
  if (gateMsg) safeSetStorage('gateMessage', gateMsg);
  if (upgradeMsg) safeSetStorage('upgradeCTA', upgradeMsg);
  
  alert('System messages saved successfully!');
}

// User Management Functions
function grantSubscription() {
  if (confirm('Grant subscription to current user?')) {
    setAuth('paid');
    alert('Subscription granted successfully!');
  }
}

function revokeSubscription() {
  if (confirm('Revoke subscription from current user?')) {
    setAuth('free');
    alert('Subscription revoked successfully!');
  }
}

function resetUserData() {
  if (confirm('Reset current user data? This will clear favorites and settings.')) {
    state.favorites = [];
    safeSetStorage('favorites', JSON.stringify(state.favorites));
    safeSetStorage('userSettings', '{}');
    render();
    alert('User data reset successfully!');
  }
}

function resetAllData() {
  if (confirm('DANGER: Reset ALL system data? This cannot be undone!')) {
    if (confirm('Are you absolutely sure? This will clear everything!')) {
      ['favorites', 'userSettings', 'adminBanner', 'legal_terms', 'legal_privacy', 'gateMessage', 'upgradeCTA'].forEach(function(key) {
        localStorage.removeItem(key);
      });
      state.favorites = [];
      render();
      alert('All system data reset successfully!');
    }
  }
}

// System Management Functions
function saveFeatureFlags() {
  var flags = {
    gateEnabled: document.getElementById('gateEnabledFlag').checked,
    subscriptionEnabled: document.getElementById('subscriptionEnabledFlag').checked,
    contactEnabled: document.getElementById('contactEnabledFlag').checked,
    favoritesEnabled: document.getElementById('favoritesEnabledFlag').checked
  };
  
  safeSetStorage('featureFlags', JSON.stringify(flags));
  alert('Feature flags saved successfully!');
}

function clearSystemCache() {
  // Clear any cached data (mock implementation)
  alert('System cache cleared successfully!');
}

function exportSystemData() {
  var data = {
    favorites: state.favorites,
    settings: JSON.parse(safeGetStorage('userSettings', '{}')),
    flags: JSON.parse(safeGetStorage('featureFlags', '{}')),
    legal: {
      terms: safeGetStorage('legal_terms', ''),
      privacy: safeGetStorage('legal_privacy', '')
    },
    messages: {
      gate: safeGetStorage('gateMessage', ''),
      upgrade: safeGetStorage('upgradeCTA', '')
    },
    banner: JSON.parse(safeGetStorage('adminBanner', '{}'))
  };
  
  var blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'confident-picks-data-' + new Date().toISOString().split('T')[0] + '.json';
  a.click();
  URL.revokeObjectURL(url);
}

function importSystemData() {
  var input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = function(e) {
    var file = e.target.files[0];
    if (file) {
      var reader = new FileReader();
      reader.onload = function(e) {
        try {
          var data = JSON.parse(e.target.result);
          
          if (data.favorites) { state.favorites = data.favorites; safeSetStorage('favorites', JSON.stringify(data.favorites)); }
          if (data.settings) safeSetStorage('userSettings', JSON.stringify(data.settings));
          if (data.flags) safeSetStorage('featureFlags', JSON.stringify(data.flags));
          if (data.legal) {
            if (data.legal.terms) safeSetStorage('legal_terms', data.legal.terms);
            if (data.legal.privacy) safeSetStorage('legal_privacy', data.legal.privacy);
          }
          if (data.messages) {
            if (data.messages.gate) safeSetStorage('gateMessage', data.messages.gate);
            if (data.messages.upgrade) safeSetStorage('upgradeCTA', data.messages.upgrade);
          }
          if (data.banner) safeSetStorage('adminBanner', JSON.stringify(data.banner));
          
          render();
          alert('Data imported successfully!');
        } catch (err) {
          alert('Error importing data: ' + err.message);
        }
      };
      reader.readAsText(file);
    }
  };
  input.click();
}

function performSystemReset() {
  if (confirm('DANGER: Perform complete system reset? This will delete everything!')) {
    if (confirm('Final confirmation: Delete all data and settings?')) {
      localStorage.clear();
      location.reload();
    }
  }
}

function backupSystemData() {
  exportSystemData(); // Same as export for now
  alert('Backup created and downloaded!');
}

// Initialize admin portal when page loads
if (typeof initAdminPortal === 'undefined') {
  var initAdminPortal = function() {
    // Set up initial admin state
    updateBannerStatus();
    updateAdminMetrics();
    
    // Update live banner from stored data
    updateLiveBanner();
    
    // Load current system messages
    var gateEl = document.getElementById('gateMessage');
    var upgradeEl = document.getElementById('upgradeCTA');
    if (gateEl) gateEl.value = safeGetStorage('gateMessage', '');
    if (upgradeEl) upgradeEl.value = safeGetStorage('upgradeCTA', '');
    
    // Load feature flags
    var flags = JSON.parse(safeGetStorage('featureFlags', '{}'));
    if (document.getElementById('gateEnabledFlag')) document.getElementById('gateEnabledFlag').checked = flags.gateEnabled !== false;
    if (document.getElementById('subscriptionEnabledFlag')) document.getElementById('subscriptionEnabledFlag').checked = flags.subscriptionEnabled !== false;
    if (document.getElementById('contactEnabledFlag')) document.getElementById('contactEnabledFlag').checked = flags.contactEnabled !== false;
    if (document.getElementById('favoritesEnabledFlag')) document.getElementById('favoritesEnabledFlag').checked = flags.favoritesEnabled !== false;
  };
  
  // Call on page load and when switching to admin
  setTimeout(initAdminPortal, 100);
}

// Initialize banner system on page load
setTimeout(function() {
  updateLiveBanner();
}, 200);

/* NAVIGATION HIGHLIGHTING & ADMIN PROTECTION */

// Track current view and update navigation highlights
function updateNavHighlights() {
  // Get current view from URL hash or default to 'picks'
  var currentView = location.hash.replace('#', '') || 'picks';
  
  // Update nav link highlights
  document.querySelectorAll('.nav a[data-nav]').forEach(function(link) {
    var linkView = link.getAttribute('href').replace('#', '');
    if (linkView === currentView) {
      link.classList.add('active');
    } else {
      link.classList.remove('active');
    }
  });
}

// Admin protection system
var adminPassword = 'getmoney'; // [[memory:6876140]] For consistency with site password
var adminUnlocked = false;

function checkAdminAccess() {
  var navAdmin = document.getElementById('navAdmin');
  if (!navAdmin) return;
  
  // Check if admin is unlocked or if user has admin auth
  if (adminUnlocked || state.auth === 'admin') {
    navAdmin.classList.remove('hidden');
  } else {
    navAdmin.classList.add('hidden');
  }
}

function promptAdminPassword() {
  var password = prompt('Enter admin password:');
  if (password === adminPassword) {
    adminUnlocked = true;
    checkAdminAccess();
    alert('Admin access granted!');
    return true;
  } else if (password !== null) {
    alert('Incorrect password!');
  }
  return false;
}

// Handle navigation clicks
document.addEventListener('click', function(e) {
  var target = e.target;
  
  // Handle navigation links
  if (target.matches('.nav a[data-nav]')) {
    var view = target.getAttribute('href').replace('#', '');
    
    // Special handling for admin view
    if (view === 'admin' && !adminUnlocked && state.auth !== 'admin') {
      e.preventDefault();
      if (promptAdminPassword()) {
        location.hash = '#admin';
      }
      return;
    }
    
    // Update highlights after a brief delay to let hash change
    setTimeout(updateNavHighlights, 10);
  }
});

// Handle hash changes (back/forward buttons, direct URL access)
window.addEventListener('hashchange', function() {
  var view = location.hash.replace('#', '');
  
  // Protect admin view access
  if (view === 'admin' && !adminUnlocked && state.auth !== 'admin') {
    if (!promptAdminPassword()) {
      // Redirect to picks if password incorrect
      location.hash = '#picks';
      return;
    }
  }
  
  updateNavHighlights();
});

// Initialize navigation on page load
setTimeout(function() {
  updateNavHighlights();
  checkAdminAccess();
}, 300);

// Helper functions for better UX
function clearSearch() {
  document.getElementById('searchInp').value = '';
  render();
}

function clearFilters() {
  document.getElementById('leagueSel').value = '';
  document.getElementById('marketSel').value = '';
  document.getElementById('minConf').value = '0';
  render();
}

function clearAllFilters() {
  clearFilters();
  clearSearch();
}

// Enhanced confidence calculation
function calculateRealisticConfidence(league, marketType, riskTag, odds) {
  var baseConfidence = 50;
  
  // League reliability bonus
  var leagueBonus = {
    'NFL': 12, 'NBA': 8, 'NHL': 7, 'MLB': 6,
    'CFB': 5, 'CBB': 4, 'MLS': 3, 'UFC': 10
  };
  baseConfidence += leagueBonus[league] || 0;
  
  // Market type difficulty
  var marketBonus = {
    'moneyline': 15, 'spread': 10, 'totals': 8,
    'props': 5, 'player-props': 3, 'team-props': 6, 'alt-lines': 4
  };
  baseConfidence += marketBonus[marketType] || 0;
  
  // Risk assessment
  if (riskTag === 'safe') baseConfidence += 12;
  if (riskTag === 'degen') baseConfidence -= 8;
  
  // Odds impact (favorites vs underdogs)
  if (odds <= -150) baseConfidence += 8;
  if (odds >= 200) baseConfidence -= 5;
  
  // Add realistic variance (±7%)
  var variance = Math.floor(Math.random() * 15) - 7;
  
  return Math.max(45, Math.min(95, baseConfidence + variance));
}

// Apply realistic confidence to existing picks on page load
setTimeout(function() {
  picksLive.forEach(function(pick) {
    pick.modelConfidence = calculateRealisticConfidence(
      pick.league, pick.marketType, pick.riskTag, pick.oddsAmerican
    );
  });
  
  picksResults.forEach(function(pick) {
    pick.modelConfidence = calculateRealisticConfidence(
      pick.league, pick.marketType, pick.riskTag, pick.oddsAmerican
    );
  });
  
  // Re-render picks if we're on the picks view
  if (location.hash === '#picks' || location.hash === '') {
    render();
  }
}, 1000);





/* FIREBASE & N8N INTEGRATION READY */
// Firebase configuration is loaded from firebase-config.js

// Global variables
let currentPicks = [];
let db, auth;
let firebaseInitialized = false;

// Initialize Firebase with retry logic
async function initializeFirebase() {
  if (firebaseInitialized) return;
  
  try {
    console.log('🚀 Initializing Firebase...');
    
    // Wait for Firebase SDK to be available
    let attempts = 0;
    while (typeof firebase === 'undefined' && attempts < 10) {
      console.log(`Waiting for Firebase SDK... attempt ${attempts + 1}`);
      await new Promise(resolve => setTimeout(resolve, 500));
      attempts++;
    }
    
    if (typeof firebase === 'undefined') {
      throw new Error('Firebase SDK failed to load after 5 seconds');
    }
    
    // Wait for firebaseConfig to be available
    attempts = 0;
    while (typeof firebaseConfig === 'undefined' && attempts < 10) {
      console.log(`Waiting for Firebase config... attempt ${attempts + 1}`);
      await new Promise(resolve => setTimeout(resolve, 500));
      attempts++;
    }
    
    if (typeof firebaseConfig === 'undefined') {
      throw new Error('Firebase config failed to load after 5 seconds');
    }
    
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    auth = firebase.auth();
    
    firebaseInitialized = true;
    console.log('✅ Firebase initialized successfully');
    
    // Load picks after successful initialization
    await loadPicksFromFirebase();
    
  } catch (error) {
    console.error('❌ Firebase initialization failed:', error);
    const picksDisplay = document.getElementById('picks-display');
    if (picksDisplay) {
      picksDisplay.innerHTML = `
        <div class="error">
          <h3>Firebase initialization failed</h3>
          <p>${error.message}</p>
          <button onclick="initializeFirebase()" class="btn primary">Retry Firebase</button>
        </div>
      `;
    }
  }
}

// Load picks from Firebase on page load
document.addEventListener('DOMContentLoaded', function() {
  console.log('🚀 Page loaded, starting Firebase initialization...');
  initializeFirebase();
});

// Debug: Check if our functions are defined
console.log('Firebase functions defined:', {
  generateNewPicks: typeof generateNewPicks,
  loadPicksFromFirebase: typeof loadPicksFromFirebase,
  testFirebaseConnection: typeof testFirebaseConnection
});

// Simple test function to check if buttons work
function testButtonClick() {
  console.log('Button clicked!');
  alert('Button is working!');
}

// Test Firebase connection
async function testFirebaseConnection() {
  try {
    if (!firebaseInitialized) {
      await initializeFirebase();
    }
    
    console.log('🧪 Testing Firebase connection...');
    const testDoc = await db.collection('test').doc('connection').get();
    console.log('✅ Firebase connection successful!');
    alert('Firebase connection successful!');
  } catch (error) {
    console.error('❌ Firebase connection failed:', error);
    alert('Firebase connection failed: ' + error.message);
  }
}

// Load picks from Firebase
async function loadPicksFromFirebase() {
  try {
    if (!firebaseInitialized) {
      await initializeFirebase();
    }
    
    console.log('📊 Loading picks from Firebase...');
    const picksDisplay = document.getElementById('picks-display');
    if (picksDisplay) {
      picksDisplay.innerHTML = '<div class="loading">Loading picks from database...</div>';
    }

    const picksSnapshot = await db.collection('mlb-picks')
      .orderBy('createdAt', 'desc')
      .limit(20)
      .get();

    if (picksSnapshot.empty) {
      if (picksDisplay) {
        picksDisplay.innerHTML = `
          <div class="empty-state">
            <h3>No picks found</h3>
            <p>Generate some picks to get started!</p>
          </div>
        `;
      }
      return;
    }

    const picks = [];
    picksSnapshot.forEach(doc => {
      picks.push({ id: doc.id, ...doc.data() });
    });

    currentPicks = picks;
    updatePicksDisplay(picks);
    console.log(`✅ Loaded ${picks.length} picks from Firebase`);

  } catch (error) {
    console.error('❌ Error loading picks:', error);
    const picksDisplay = document.getElementById('picks-display');
    if (picksDisplay) {
      picksDisplay.innerHTML = `
        <div class="empty-state">
          <h3>Error loading picks</h3>
          <p>${error.message}</p>
        </div>
      `;
    }
  }
}

        // Generate new picks
        async function generateNewPicks() {
          try {
            console.log('🎯 Generating new picks...');
            const btn = event?.target || document.querySelector('button[onclick="generateNewPicks()"]');
            if (btn) {
              btn.disabled = true;
              btn.textContent = 'Generating...';
            }

    // Call Firebase Function
    console.log('📡 Calling Cloud Function...');
    const response = await fetch('https://us-central1-confident-picks-app-8-25.cloudfunctions.net/generateMLBPicksManual', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    });

    console.log('📥 Response received:', response.status, response.statusText);
    const result = await response.json();
    console.log('📊 Function result:', result);
    
    if (result.success) {
      console.log('✅ Picks generated successfully!');
      
      // Handle different response formats
      const picksCount = result.picksCount || result.summary?.totalPicks || result.totalPicks || 'some';
      console.log(`📈 Generated ${picksCount} picks`);
      alert(`Picks generated successfully! Generated ${picksCount} picks.`);

      // Display picks directly from the response instead of loading from Firestore
      if (result.summary && result.summary.samplePicks) {
        console.log('📋 Displaying picks from response...');
        // Store picks globally for filtering
        window.currentPicks = result.summary.samplePicks;
        updatePicksDisplay(window.currentPicks);
      } else {
        console.log('⚠️ No picks found in response');
        alert('No picks found in response');
      }
    } else {
      throw new Error(result.error || 'Failed to generate picks');
    }

  } catch (error) {
    console.error('❌ Error generating picks:', error);
    alert('Error generating picks: ' + error.message);
              } finally {
              const btn = event?.target || document.querySelector('button[onclick="generateNewPicks()"]');
              if (btn) {
                btn.disabled = false;
                btn.textContent = 'Generate New Picks';
              }
            }
}

        // Show static picks (original functionality)
        function showStaticPicks() {
          const picksDisplay = document.getElementById('picks-display');
          const listDisplay = document.getElementById('list');
          
          if (picksDisplay) {
            picksDisplay.innerHTML = '<div class="loading">Loading picks...</div>';
          }
          
          if (listDisplay) {
            listDisplay.style.display = 'grid';
          }
          
          // Clear Firebase picks from memory
          window.currentPicks = [];
        }

        // Update picks display
        function updatePicksDisplay(picks) {
          const picksDisplay = document.getElementById('picks-display');
          const listDisplay = document.getElementById('list');

          if (!picksDisplay) {
            console.log('⚠️ picks-display element not found');
            return;
          }

          // Hide the static list when showing Firebase picks
          if (listDisplay) {
            listDisplay.style.display = 'none';
          }

          if (!picks || picks.length === 0) {
            picksDisplay.innerHTML = `
              <div class="empty-state">
                <h3>No picks available</h3>
                <p>Generate some picks to get started!</p>
              </div>
            `;
            return;
          }

  // Apply minimum confidence filter
  const minConfInput = document.getElementById('minConf');
  const minConfidence = minConfInput ? Number(minConfInput.value) : 0;
  let filteredPicks = picks;
  
  console.log('🔍 Filtering picks:', {
    totalPicks: picks.length,
    minConfidence: minConfidence,
    minConfInputValue: minConfInput ? minConfInput.value : 'not found',
    originalPicks: picks.map(p => ({
      teams: `${p.awayTeam} vs ${p.homeTeam}`,
      confidence: Math.round(parseFloat(p.confidence) * 100),
      prediction: p.consensus?.prediction || p.prediction
    }))
  });
  
  if (minConfidence > 0) {
    filteredPicks = picks.filter(pick => {
      const confidence = Math.round(parseFloat(pick.confidence) * 100);
      const passes = confidence >= minConfidence;
      console.log(`📊 ${pick.awayTeam} vs ${pick.homeTeam}: ${confidence}% ${passes ? '✅' : '❌'} (min: ${minConfidence}%)`);
      return passes;
    });
    
    console.log(`🎯 Filtering complete: ${filteredPicks.length} picks passed the ${minConfidence}% threshold`);
  }

  if (filteredPicks.length === 0) {
    picksDisplay.innerHTML = `
      <div class="empty-state">
        <h3>No picks meet your confidence threshold</h3>
        <p>Try lowering your minimum confidence filter or generate new picks.</p>
      </div>
    `;
    return;
  }

            const picksHTML = filteredPicks.map(pick => {
            const confidencePercent = Math.round(parseFloat(pick.confidence) * 100);
            const prediction = pick.consensus?.prediction || pick.prediction || 'N/A';
            const reasoning = pick.llmPredictions?.openai?.reasoning || '';
            const truncatedReasoning = reasoning.length > 100 ? reasoning.substring(0, 100) + '...' : reasoning;
            
            // Format odds string
            const oddsString = pick.vegasOdds ? pick.vegasOdds.map(odd => 
              `${odd.name} ${odd.price > 0 ? '+' : ''}${odd.price}`
            ).join(', ') : 'N/A';
            
            // Determine confidence color and level
            let confColor, confLevel;
            if (confidencePercent >= 80) {
              confColor = 'var(--green)';
              confLevel = 'Very High';
            } else if (confidencePercent >= 65) {
              confColor = 'var(--blue)';
              confLevel = 'High';
            } else {
              confColor = '#ffa500';
              confLevel = 'Medium';
            }

            return '<div class="card">'
              + '<div class="text-sub">' + pick.sport + ' • ' + pick.market + '</div>'
              + '<div class="row" style="gap:8px"><div><strong>' + prediction + '</strong></div><div class="chip safe">SAFE</div></div>'
              + '<div class="text-sub">Confidence: <span style="color:' + confColor + '">' + confidencePercent + '%</span> • Odds: ' + oddsString + '</div>'
              + '<div class="reasoning">Reasoning: ' + (truncatedReasoning || '—') + '</div>'
              + '<div class="row" style="margin-top:6px;gap:8px"><div class="text-sub">Commences: ' + new Date(pick.startTime).toLocaleDateString() + '</div></div>'
              + '</div>';
          }).join('');

  picksDisplay.innerHTML = `
    <div class="picks-container">
      ${picksHTML}
    </div>
  `;
}

// N8N webhook endpoints (replace with your URLs)
var n8nEndpoints = {
  // contact: 'https://your-n8n-instance.com/webhook/contact',
  // picks: 'https://your-n8n-instance.com/webhook/picks',
  // analytics: 'https://your-n8n-instance.com/webhook/analytics'
};

// Firebase initialization (commented out - using active initialization above)
/*
if (typeof firebase !== 'undefined' && firebaseConfig.apiKey) {
  firebase.initializeApp(firebaseConfig);
  var db = firebase.firestore();
  var auth = firebase.auth();
  
  // Replace mock auth with real Firebase Auth
  function authenticateWithGoogle() {
    var provider = new firebase.auth.GoogleAuthProvider();
    return auth.signInWithPopup(provider);
  }
  
  function authenticateWithEmail(email, password) {
    return auth.signInWithEmailAndPassword(email, password);
  }
  
  function createUserWithEmail(email, password) {
    return auth.createUserWithEmailAndPassword(email, password);
  }
}
*/

// N8N webhook functions (ready to use)
async function sendToN8N(endpoint, data) {
  if (!n8nEndpoints[endpoint]) {
    console.warn('N8N endpoint not configured:', endpoint);
    // Fallback for contact form
    if (endpoint === 'contact') {
      alert('Thank you for your message! We\'ll get back to you soon.');
    }
    return null;
  }
  
  try {
    var response = await fetch(n8nEndpoints[endpoint], {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    });
    return await response.json();
  } catch (error) {
    console.error('N8N webhook error:', error);
    showMessage('Connection error. Please try again.', 'error');
    return null;
  }
}

// Ready for real data feeds
async function fetchPicksFromAPI() {
  // Replace static data with real API calls
  return sendToN8N('picks', {action: 'fetch'});
}

async function submitContactToN8N(formData) {
  return sendToN8N('contact', formData);
}



// Simple function to show all available picks with detailed debugging
async function generateNewPicks() {
  console.log('=== STARTING PICK LOADING DEBUG ===');
  console.log('1. Function called');
  
  try {
    // Check if Firebase is loaded
    console.log('2. Checking Firebase...');
    if (!window.firebase) {
      console.error('❌ Firebase not loaded - window.firebase is undefined');
      showMessage('Firebase not loaded', 'error');
      return;
    }
    console.log('✅ Firebase is loaded');
    
    // Check if Firestore is available
    console.log('3. Checking Firestore...');
    if (!firebase.firestore) {
      console.error('❌ Firestore not available - firebase.firestore is undefined');
      showMessage('Firestore not available', 'error');
      return;
    }
    console.log('✅ Firestore is available');
    
    // Get Firestore reference
    console.log('4. Getting Firestore reference...');
    const db = firebase.firestore();
    console.log('✅ Firestore reference obtained');
    
    // Try to get picks from mlb_picks collection directly
    console.log('5. Attempting to fetch mlb_picks collection...');
    try {
      const picksSnapshot = await db.collection('mlb_picks').get();
      console.log('✅ mlb_picks collection accessed');
      
      if (!picksSnapshot.empty) {
        console.log(`✅ Found picks in mlb_picks collection`);
        
        // Convert to array and filter for future games only
        const allPicks = [];
        picksSnapshot.forEach(doc => {
          const pickData = {
            id: doc.id,
            ...doc.data()
          };
          allPicks.push(pickData);
        });
        
        // Filter for future games only
        const now = new Date();
        const futurePicks = allPicks.filter(pick => {
          const gameTime = new Date(pick.startTime);
          return gameTime > now;
        });
        
        const pastPicks = allPicks.filter(pick => {
          const gameTime = new Date(pick.startTime);
          return gameTime <= now;
        });
        
        console.log(`📊 Total picks: ${allPicks.length}`);
        console.log(`📊 Future games: ${futurePicks.length}`);
        console.log(`📊 Past games: ${pastPicks.length}`);
        
        // Move past games to scoring database - TEMPORARILY DISABLED
        // if (pastPicks.length > 0) {
        //   console.log('🔄 Moving past games to scoring database...');
        //   await movePastGamesToScoring(pastPicks);
        // }
        
        // Display ALL picks (temporarily disable future-only filtering)
        console.log(`✅ Loaded ${allPicks.length} total picks`);
        
        // Check if display function exists
        if (typeof displayPicks !== 'function') {
          console.error('❌ displayPicks function not found');
          showMessage('Display function not found', 'error');
          return;
        }
        
        // Display ALL picks (not just future ones)
        displayPicks(allPicks);
        showMessage(`${allPicks.length} picks loaded`, 'success');
        
      } else {
        console.log('❌ mlb_picks collection is empty');
        showMessage('No picks available in mlb_picks collection', 'info');
      }
    } catch (error) {
      console.error('❌ Error accessing mlb_picks collection:', error);
      showMessage('Failed to access mlb_picks collection: ' + error.message, 'error');
    }
    
  } catch (error) {
    console.error('❌ ERROR in generateNewPicks:', error);
    showMessage('Failed to load picks: ' + error.message, 'error');
  }
}

// Function to move past games to scoring database
async function movePastGamesToScoring(pastPicks) {
  console.log(`🔄 Moving ${pastPicks.length} past games to scoring...`);
  
  try {
    const db = firebase.firestore();
    const batch = db.batch();
    
    for (const pick of pastPicks) {
      // Add to scoring collection
      const scoringRef = db.collection('scoring').doc(pick.id);
      batch.set(scoringRef, {
        ...pick,
        movedToScoring: new Date().toISOString(),
        originalCollection: 'mlb_picks'
      });
      
      // Delete from mlb_picks collection
      const pickRef = db.collection('mlb_picks').doc(pick.id);
      batch.delete(pickRef);
    }
    
    await batch.commit();
    console.log(`✅ Successfully moved ${pastPicks.length} games to scoring database`);
    
  } catch (error) {
    console.error('❌ Error moving past games to scoring:', error);
  }
}

// Function to display picks in the UI with proper formatting
function displayPicks(picks, showParlayButtons = false) {
  const picksDisplay = document.getElementById('picks-display');
  if (!picksDisplay) {
    console.error('Picks display element not found');
    return;
  }
  
  // Generate HTML for picks with proper formatting
  const picksHTML = picks.map(pick => {
    // Get the actual prediction from consensus or fallback
    const prediction = pick.consensus?.prediction || 
                     pick.llmPredictions?.openai?.prediction || 
                     pick.llmPredictions?.claude?.prediction || 
                     'N/A';
    
    // Format confidence as percentage (convert from decimal to percentage)
    const confidenceDecimal = parseFloat(pick.confidence) || 0;
    const confidencePercentage = Math.round(confidenceDecimal * 100);
    
    // Get market display name
    const marketDisplay = pick.market === 'h2h' ? 'moneyline' : 
                         pick.market === 'spreads' ? 'spread' : 
                         pick.market === 'totals' ? 'totals' : 
                         pick.market?.toLowerCase() || 'moneyline';
    
    // Format the game time
    const gameTime = new Date(pick.startTime);
    const timeString = gameTime.toLocaleString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric',
      hour: 'numeric',
      minute: '2-digit',
      hour12: true
    });
    
    // Get reasoning (placeholder for now)
    const reasoning = pick.llmPredictions?.openai?.reasoning || 
                    pick.llmPredictions?.claude?.reasoning || 
                    '—';
    
    // Get proper game name and odds
    const awayTeam = pick.awayTeam || 'Unknown';
    const homeTeam = pick.homeTeam || 'Unknown';
    const gameName = `${awayTeam} vs ${homeTeam}`;
    
    // Get odds from vegasOdds array
    let oddsDisplay = '-110'; // Default fallback
    if (pick.vegasOdds && pick.vegasOdds.length > 0) {
      const selectedOdds = pick.vegasOdds.find(odd => 
        odd.name === prediction || 
        odd.name.toLowerCase().includes(prediction.toLowerCase())
      );
      if (selectedOdds) {
        oddsDisplay = selectedOdds.price > 0 ? `+${selectedOdds.price}` : selectedOdds.price.toString();
      } else {
        oddsDisplay = pick.vegasOdds[0].price > 0 ? `+${pick.vegasOdds[0].price}` : pick.vegasOdds[0].price.toString();
      }
    }
    
    // Format prediction based on market type
    let predictionDisplay = prediction;
    if (pick.market === 'spread' && pick.vegasOdds && pick.vegasOdds.length > 0) {
      const spread = pick.vegasOdds[0].point;
      predictionDisplay = `${prediction} ${spread > 0 ? '+' : ''}${spread}`;
    } else if (pick.market === 'totals') {
      predictionDisplay = `${prediction} ${pick.vegasOdds?.[0]?.point || 'N/A'}`;
    }
    
    // Only show parlay button if showParlayButtons is true (favorites page)
    const parlayButtonHTML = showParlayButtons ? 
      `<button class="parlay-btn" data-pick-id="${pick.id}" title="Add to parlay">Add To Parlay</button>` : '';
    
    return `
      <div class="pick-card">
        <div class="pick-sport-market">${pick.sport || 'MLB'} • ${marketDisplay}</div>
        <div class="pick-main">${predictionDisplay}</div>
        <div class="pick-details">
          <span class="pick-confidence">Confidence: ${confidencePercentage}%</span>
          <span class="pick-odds">Odds: ${oddsDisplay}</span>
        </div>
        <div class="pick-reasoning-container">
          <div class="pick-reasoning-preview">${reasoning.length > 100 ? reasoning.substring(0, 100) + '...' : reasoning}</div>
          ${reasoning.length > 100 ? '<button class="pick-reasoning-toggle" onclick="toggleReasoning(this)">Show More</button>' : ''}
          <div class="pick-reasoning-full" style="display: none;">${reasoning}</div>
        </div>
        <div class="pick-time">Commences: ${timeString}</div>
        <div class="pick-badge">SAFE</div>
        <div class="pick-favorite-btn" data-pick-id="${pick.id}" title="Add to favorites">☆</div>
        ${parlayButtonHTML}
      </div>
    `;
  }).join('');
  
  picksDisplay.innerHTML = picksHTML;
  picksDisplay.style.display = 'block';
  
  // Add event listeners for favorites buttons
  const favoriteButtons = picksDisplay.querySelectorAll('.pick-favorite-btn');
  favoriteButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      const pickId = this.getAttribute('data-pick-id');
      toggleFavorite(pickId, this);
    });
    
    // Check if this pick is already favorited
    const pickId = btn.getAttribute('data-pick-id');
    const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
    if (favorites.includes(pickId)) {
      btn.classList.add('active');
      btn.textContent = '★'; // Filled star
    }
  });
  
  // Add event listeners for parlay buttons (only if showParlayButtons is true)
  if (showParlayButtons) {
    const parlayButtons = picksDisplay.querySelectorAll('.parlay-btn');
    parlayButtons.forEach(btn => {
      btn.addEventListener('click', function() {
        const pickId = this.getAttribute('data-pick-id');
        toggleParlayPick(pickId);
      });
      
      // Check if this pick is already in parlay
      const pickId = btn.getAttribute('data-pick-id');
      if (state.parlayPicks.includes(pickId)) {
        btn.classList.add('selected');
        btn.textContent = 'Remove From Parlay';
      }
    });
  }
  
  console.log('Picks displayed successfully');
}

// Function to toggle favorite status
function toggleFavorite(pickId, button) {
  // Check if user is subscribed (you can implement your own logic here)
  const isSubscribed = checkSubscriptionStatus();
  
  if (!isSubscribed) {
    alert('Favorites feature is only available for subscribed members.');
    return;
  }
  
  // Toggle the active state
  button.classList.toggle('active');
  
  // Change star from empty to filled
  if (button.classList.contains('active')) {
    button.textContent = '★'; // Filled star
  } else {
    button.textContent = '☆'; // Empty star
  }
  
  // Save to localStorage or send to server
  const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
  
  if (button.classList.contains('active')) {
    // Add to favorites
    if (!favorites.includes(pickId)) {
      favorites.push(pickId);
    }
  } else {
    // Remove from favorites
    const index = favorites.indexOf(pickId);
    if (index > -1) {
      favorites.splice(index, 1);
    }
  }
  
  localStorage.setItem('favorites', JSON.stringify(favorites));
  console.log('Favorites updated:', favorites);
  
  // Update favorites display if we're on the favorites page
  if (location.hash === '#favorites') {
    renderFavorites();
  }
}

// Function to load favorites from Firebase and display them
async function loadFavoritesFromFirebase(favoriteIds, container) {
  try {
    console.log('🔥 Loading favorites from Firebase:', favoriteIds);
    console.log('🔥 Number of favorite IDs:', favoriteIds.length);
    
    // Show loading state
    container.innerHTML = '<div class="card text-sub" style="text-align:center;padding:32px;">' +
                        '<div style="font-size:48px;margin-bottom:16px;">⏳</div>' +
                        '<div><strong>Loading favorites...</strong></div>' +
                        '<div style="margin-top:8px">Fetching ' + favoriteIds.length + ' favorited picks</div>' +
                        '</div>';
    
    // Get all picks from mlb_picks collection
    const picksSnapshot = await db.collection('mlb_picks').get();
    
    if (picksSnapshot.empty) {
      console.log('❌ No picks found in mlb_picks collection');
      container.innerHTML = '<div class="card text-sub" style="text-align:center;padding:32px;">' +
                          '<div style="font-size:48px;margin-bottom:16px;">⚠️</div>' +
                          '<div><strong>No picks found</strong></div>' +
                          '<div style="margin-top:8px">No picks available in database</div>' +
                          '</div>';
      return;
    }
    
    // Filter picks to only show favorites
    const allPicks = [];
    picksSnapshot.forEach(doc => {
      allPicks.push({ id: doc.id, ...doc.data() });
    });
    
    console.log('📊 Total picks in database:', allPicks.length);
    console.log('📊 Available pick IDs:', allPicks.map(p => p.id));
    console.log('📊 Looking for favorite IDs:', favoriteIds);
    
    const favoritedPicks = allPicks.filter(pick => favoriteIds.includes(pick.id));
    
    console.log('✅ Found favorited picks:', favoritedPicks.length);
    console.log('✅ Matched pick IDs:', favoritedPicks.map(p => p.id));
    
    if (favoritedPicks.length === 0) {
      console.log('❌ No favorites found in database - clearing stale favorites');
      
      // AUTOMATICALLY CLEAR STALE FAVORITES
      clearStaleFavorites(favoriteIds, allPicks);
      
      container.innerHTML = '<div class="card text-sub" style="text-align:center;padding:32px;">' +
                          '<div style="font-size:48px;margin-bottom:16px;">🔄</div>' +
                          '<div><strong>Favorites Updated</strong></div>' +
                          '<div style="margin-top:8px">Your favorites have been refreshed to match current picks</div>' +
                          '<div style="margin-top:8px;font-size:12px;">Previous: ' + favoriteIds.length + ' favorites</div>' +
                          '<div style="margin-top:8px;font-size:12px;">Available: ' + allPicks.length + ' picks</div>' +
                          '<div style="margin-top:16px;">' +
                          '<button class="btn primary" onclick="location.reload()">Refresh Page</button>' +
                          '</div>' +
                          '</div>';
      return;
    }
    
    // Display favorited picks using the same format as main picks
    const picksHTML = favoritedPicks.map(pick => {
      // Get prediction from consensus or fallback
      const prediction = pick.consensus?.prediction || 
                        pick.llmPredictions?.openai?.prediction || 
                        pick.llmPredictions?.claude?.prediction || 
                        'Unknown';
      
      // Get confidence as percentage
      const confidence = pick.consensus?.confidence || 
                        pick.llmPredictions?.openai?.confidence || 
                        pick.llmPredictions?.claude?.confidence || 
                        pick.confidence || 0;
      const confidencePercentage = Math.round(parseFloat(confidence) * 100);
      
      // Get market display
      const market = pick.market || 'moneyline';
      const marketDisplay = market.charAt(0).toUpperCase() + market.slice(1);
      
      // Get time string
      const startTime = new Date(pick.startTime);
      const timeString = startTime.toLocaleString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
      });
      
      // Get reasoning
      const reasoning = pick.llmPredictions?.openai?.reasoning || 
                      pick.llmPredictions?.claude?.reasoning || 
                      '—';
      
      // Get proper game name and odds
      const awayTeam = pick.awayTeam || 'Unknown';
      const homeTeam = pick.homeTeam || 'Unknown';
      const gameName = `${awayTeam} vs ${homeTeam}`;
      
      // Get odds from vegasOdds array
      let oddsDisplay = '-110'; // Default fallback
      if (pick.vegasOdds && pick.vegasOdds.length > 0) {
        const selectedOdds = pick.vegasOdds.find(odd => 
          odd.name === prediction || 
          odd.name.toLowerCase().includes(prediction.toLowerCase())
        );
        if (selectedOdds) {
          oddsDisplay = selectedOdds.price > 0 ? `+${selectedOdds.price}` : selectedOdds.price.toString();
        } else {
          oddsDisplay = pick.vegasOdds[0].price > 0 ? `+${pick.vegasOdds[0].price}` : pick.vegasOdds[0].price.toString();
        }
      }
      
      // Format prediction based on market type
      let predictionDisplay = prediction;
      if (market === 'spread' && pick.vegasOdds && pick.vegasOdds.length > 0) {
        const spread = pick.vegasOdds[0].point;
        predictionDisplay = `${prediction} ${spread > 0 ? '+' : ''}${spread}`;
      } else if (market === 'totals') {
        predictionDisplay = `${prediction} ${pick.vegasOdds?.[0]?.point || 'N/A'}`;
      }
      
      // Show parlay button for favorites page
      const parlayButtonHTML = `<button class="parlay-btn" data-pick-id="${pick.id}" title="Add to parlay">Add To Parlay</button>`;
      
      return `
        <div class="pick-card">
          <div class="pick-sport-market">${pick.sport || 'MLB'} • ${marketDisplay}</div>
          <div class="pick-main">${predictionDisplay}</div>
          <div class="pick-details">
            <span class="pick-confidence">Confidence: ${confidencePercentage}%</span>
            <span class="pick-odds">Odds: ${oddsDisplay}</span>
          </div>
          <div class="pick-reasoning-container">
            <div class="pick-reasoning-preview">${reasoning.length > 100 ? reasoning.substring(0, 100) + '...' : reasoning}</div>
            ${reasoning.length > 100 ? '<button class="pick-reasoning-toggle" onclick="toggleReasoning(this)">Show More</button>' : ''}
            <div class="pick-reasoning-full" style="display: none;">${reasoning}</div>
          </div>
          <div class="pick-time">Commences: ${timeString}</div>
          <div class="pick-badge">SAFE</div>
          <div class="pick-favorite-btn active" data-pick-id="${pick.id}" title="Remove from favorites">★</div>
          ${parlayButtonHTML}
        </div>
      `;
    }).join('');
    
    container.innerHTML = picksHTML;
    
    // Add event listeners for favorites buttons
    const favoriteButtons = container.querySelectorAll('.pick-favorite-btn');
    favoriteButtons.forEach(btn => {
      btn.addEventListener('click', function() {
        const pickId = this.getAttribute('data-pick-id');
        toggleFavorite(pickId, this);
      });
    });
    
    // Add event listeners for parlay buttons
    const parlayButtons = container.querySelectorAll('.parlay-btn');
    parlayButtons.forEach(btn => {
      btn.addEventListener('click', function() {
        const pickId = this.getAttribute('data-pick-id');
        toggleParlayPick(pickId);
      });
      
      // Check if this pick is already in parlay
      const pickId = btn.getAttribute('data-pick-id');
      if (state.parlayPicks.includes(pickId)) {
        btn.classList.add('selected');
        btn.textContent = 'Remove From Parlay';
      }
    });
    
    console.log('Favorites displayed successfully');
    
    // Update parlay calculator after displaying picks
    updateParlayCalculator();
    
  } catch (error) {
    console.error('Error loading favorites:', error);
    container.innerHTML = '<div class="card text-sub" style="text-align:center;padding:32px;">' +
                        '<div style="font-size:48px;margin-bottom:16px;">❌</div>' +
                        '<div><strong>Error loading favorites</strong></div>' +
                        '<div style="margin-top:8px">' + error.message + '</div>' +
                        '</div>';
  }
}

// Function to check subscription status (implement your own logic)
function checkSubscriptionStatus() {
  // For now, return true to show the button
  // You can implement your own subscription check here
  return true;
}

/* INIT */
// Auto-load picks on page load
document.addEventListener('DOMContentLoaded', function() {
  console.log('Page loaded - loading picks from Firebase...');
  
  // Wait for Firebase to initialize, then load picks
  setTimeout(function() {
    try {
      if (typeof generateNewPicks === 'function') {
        console.log('Calling generateNewPicks...');
        generateNewPicks();
      } else {
        console.error('generateNewPicks function not found');
      }
    } catch(e) {
      console.error('Error loading picks:', e);
    }
  }, 1000);
});

// Enable routing functions for navigation
try{ 
  console.log('Running original route()...');
  route();
}catch(e){ 
  console.error('route() error:', e); 
}
try{ 
  console.log('Running original render()...');
  render();
}catch(e){ 
  console.error('render() error:', e); 
}

// Update copyright year dynamically
try {
  var yearSpan = document.getElementById('copyrightYear');
  if (yearSpan) {
    yearSpan.textContent = new Date().getFullYear();
  }
} catch(e){ console.error('copyright year update', e); }
try{ renderScorecard(); }catch(e){ console.error('renderScorecard()', e); }
try{ renderAccount(); }catch(e){ console.error('renderAccount()', e); }
try{ renderProfile(); }catch(e){ console.error('renderProfile()', e); }
try{ reflectAuthButtons(); }catch(e){ console.error('reflectAuthButtons()', e); }
try{ updateHeaderUI(); }catch(e){ console.error('updateHeaderUI()', e); }
try{ updateMobileBanner(); }catch(e){ console.error('updateMobileBanner()', e); }

// Convert American odds to decimal odds
function americanToDecimal(americanOdds) {
  if (americanOdds > 0) {
    return (americanOdds / 100) + 1;
  } else {
    return (100 / Math.abs(americanOdds)) + 1;
  }
}

// Convert decimal odds back to American odds
function decimalToAmerican(decimalOdds) {
  if (decimalOdds >= 2) {
    return Math.round((decimalOdds - 1) * 100);
  } else {
    return Math.round(-100 / (decimalOdds - 1));
  }
}

// Calculate parlay odds using American odds
function calculateParlayOdds(americanOddsArray) {
  console.log('🧮 Calculating parlay odds for:', americanOddsArray);
  
  if (americanOddsArray.length < 2) {
    console.log('⚠️ Need at least 2 picks for parlay');
    return null;
  }
  
  // Step 1: Convert each American odds to decimal
  var decimalOddsArray = americanOddsArray.map(function(odds) {
    var decimal = americanToDecimal(odds);
    console.log(`📊 American ${odds} → Decimal ${decimal.toFixed(3)}`);
    return decimal;
  });
  
  // Step 2: Multiply all decimal odds together
  var totalDecimalOdds = decimalOddsArray.reduce(function(product, odds) {
    return product * odds;
  }, 1);
  
  console.log(`📈 Total decimal odds: ${totalDecimalOdds.toFixed(3)}`);
  
  // Step 3: Convert back to American odds
  var parlayAmericanOdds = decimalToAmerican(totalDecimalOdds);
  
  console.log(`🎯 Final parlay odds: ${parlayAmericanOdds}`);
  return parlayAmericanOdds;
}

// Format odds as string with + or - sign
function oddsString(odds) {
  if (odds === null || odds === undefined) return '';
  if (odds > 0) {
    return '+' + odds;
  } else {
    return odds.toString();
  }
}

// Update parlay calculator display
function updateParlayCalculator() {
  console.log('🔄 Updating parlay calculator...');
  
  var parlayResult = document.getElementById('parlayResult');
  var parlayOdds = document.getElementById('parlayOdds');
  if (!parlayResult || !parlayOdds) {
    console.log('❌ Parlay calculator elements not found');
    return;
  }
  
  console.log('📊 Current parlay picks:', state.parlayPicks);
  
  // Get selected parlay picks from state
  var selectedOdds = [];
  
  // Try to get odds from Firebase picks first
  if (window.currentPicks && window.currentPicks.length > 0) {
    console.log('🔥 Using Firebase picks for odds calculation');
    console.log('🔥 Available picks:', window.currentPicks.length);
    
    state.parlayPicks.forEach(function(pickId) {
      var pick = window.currentPicks.find(function(p) { return p.id === pickId; });
      if (pick) {
        console.log('📊 Found pick:', pick);
        console.log('📊 Pick vegasOdds:', pick.vegasOdds);
        
        // Extract odds from vegasOdds array
        var odds = -110; // Default fallback
        if (pick.vegasOdds && pick.vegasOdds.length > 0) {
          odds = pick.vegasOdds[0].price;
          console.log(`📈 Using vegasOdds[0].price: ${odds}`);
        } else if (pick.oddsAmerican) {
          odds = pick.oddsAmerican;
          console.log(`📈 Using oddsAmerican: ${odds}`);
        } else if (pick.odds) {
          odds = pick.odds;
          console.log(`📈 Using odds: ${odds}`);
        } else {
          console.log(`📈 Using default odds: ${odds}`);
        }
        
        selectedOdds.push(odds);
        console.log(`📈 Pick ${pickId}: ${odds} odds`);
      } else {
        console.log(`❌ Pick ${pickId} not found in currentPicks`);
      }
    });
  } else {
    console.log('📚 No Firebase picks available, using static fallback');
    // Simple fallback with static odds for testing
    state.parlayPicks.forEach(function(pickId, index) {
      // Use different odds for testing
      var testOdds = [-110, +150, -120, +200][index % 4];
      selectedOdds.push(testOdds);
      console.log(`📈 Test pick ${pickId}: ${testOdds} odds`);
    });
  }
  
  console.log('🎯 Selected odds for parlay:', selectedOdds);
  
  if (selectedOdds.length > 1) {
    var parlayOddsValue = calculateParlayOdds(selectedOdds);
    console.log('🧮 Calculated parlay odds:', parlayOddsValue);
    if (parlayOddsValue !== null) {
      parlayOdds.textContent = oddsString(parlayOddsValue);
      parlayResult.style.display = 'block';
      console.log('✅ Parlay calculator updated successfully');
    } else {
      parlayResult.style.display = 'none';
      console.log('❌ Parlay calculation failed');
    }
  } else {
    parlayResult.style.display = 'none';
    console.log('⚠️ Not enough picks for parlay (need 2+)');
  }
}

// Toggle parlay pick selection
function toggleParlayPick(pickId) {
  console.log('🎯 Toggling parlay pick:', pickId);
  
  // Toggle parlay selection
  var index = state.parlayPicks.indexOf(pickId);
  if (index > -1) {
    // Remove from parlay
    state.parlayPicks.splice(index, 1);
    console.log('❌ Removed from parlay');
  } else {
    // Add to parlay
    state.parlayPicks.push(pickId);
    console.log('✅ Added to parlay');
  }
  
  // Save to localStorage
  safeSetStorage('parlayPicks', JSON.stringify(state.parlayPicks));
  
  // Update parlay calculator display
  updateParlayCalculator();
  
  // Update button states in current display
  var parlayButtons = document.querySelectorAll('.parlay-btn[data-pick-id="' + pickId + '"]');
  parlayButtons.forEach(function(btn) {
    if (state.parlayPicks.includes(pickId)) {
      btn.classList.add('selected');
      btn.textContent = 'Remove From Parlay';
    } else {
      btn.classList.remove('selected');
      btn.textContent = 'Add To Parlay';
    }
  });
  
  console.log('Parlay picks updated:', state.parlayPicks);
}

// Test parlay calculator manually
function testParlayCalculator() {
  console.log('🧪 Testing parlay calculator...');
  
  // Add some test picks to parlay
  state.parlayPicks = ['test1', 'test2'];
  safeSetStorage('parlayPicks', JSON.stringify(state.parlayPicks));
  
  // Call update function
  updateParlayCalculator();
  
  console.log('🧪 Test complete - check console for results');
}

// Clear stale favorites automatically
function clearStaleFavorites(staleFavoriteIds, availablePicks) {
  console.log('🔄 Clearing stale favorites...');
  console.log('🗑️ Stale favorites to remove:', staleFavoriteIds);
  console.log('✅ Available picks:', availablePicks.map(p => p.id));
  
  // Clear all favorites from state and localStorage
  state.favorites = [];
  state.parlayPicks = [];
  localStorage.removeItem('favorites');
  localStorage.removeItem('parlayPicks');
  
  console.log('✅ Stale favorites cleared');
}

// Toggle reasoning display
function toggleReasoning(button) {
  const container = button.parentElement;
  const preview = container.querySelector('.pick-reasoning-preview');
  const full = container.querySelector('.pick-reasoning-full');
  
  if (full.style.display === 'none') {
    full.style.display = 'block';
    button.textContent = 'Show Less';
  } else {
    full.style.display = 'none';
    button.textContent = 'Show More';
  }
}

// Clear all favorites (for debugging)
function clearAllFavorites() {
  console.log('🗑️ Clearing all favorites...');
  
  // Clear from state
  state.favorites = [];
  state.parlayPicks = [];
  
  // Clear from localStorage
  localStorage.removeItem('favorites');
  localStorage.removeItem('parlayPicks');
  
  // Re-render favorites
  renderFavorites();
  
  console.log('✅ All favorites cleared');
}
</script>


</body></html>